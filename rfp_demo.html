<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RFP Intelligence Platform - Live Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a24;
            --text-primary: #e4e4e7;
            --text-secondary: #a1a1aa;
            --accent-blue: #3b82f6;
            --accent-green: #22c55e;
            --accent-red: #ef4444;
            --accent-yellow: #eab308;
            --accent-purple: #a855f7;
            --border-color: #27272a;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 30px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
        }

        .logo-text h1 {
            font-size: 20px;
            font-weight: 600;
        }

        .logo-text span {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .status-badges {
            display: flex;
            gap: 10px;
        }

        .badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .badge.connected {
            background: rgba(34, 197, 94, 0.15);
            color: var(--accent-green);
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .badge.disconnected {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .badge-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        /* Main Layout */
        .main-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 24px;
        }

        /* Sidebar */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* RFP Selector */
        .rfp-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .rfp-item {
            background: var(--bg-tertiary);
            border: 2px solid transparent;
            border-radius: 10px;
            padding: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .rfp-item:hover {
            border-color: var(--accent-blue);
        }

        .rfp-item.selected {
            border-color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.1);
        }

        .rfp-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .rfp-item-name {
            font-size: 14px;
            font-weight: 600;
            line-height: 1.3;
        }

        .rfp-item-value {
            font-size: 13px;
            font-weight: 600;
            color: var(--accent-green);
        }

        .rfp-item-client {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .rfp-item-tags {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .tag {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }

        .tag-industry {
            background: rgba(168, 85, 247, 0.2);
            color: var(--accent-purple);
        }

        .tag-difficulty-high {
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent-red);
        }

        .tag-difficulty-medium {
            background: rgba(234, 179, 8, 0.2);
            color: var(--accent-yellow);
        }

        .tag-difficulty-very-high {
            background: rgba(239, 68, 68, 0.3);
            color: #ff6b6b;
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            transition: all 0.2s;
        }

        .upload-area:hover {
            border-color: var(--accent-blue);
            background: rgba(59, 130, 246, 0.05);
        }

        .upload-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .upload-text {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Analyze Button */
        .analyze-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .analyze-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3);
        }

        .analyze-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Main Content */
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Processing Window */
        .processing-window {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }

        .processing-header {
            background: var(--bg-tertiary);
            padding: 14px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }

        .processing-title {
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .processing-status {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .processing-log {
            height: 300px;
            overflow-y: auto;
            padding: 16px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            line-height: 1.6;
        }

        .log-entry {
            padding: 4px 0;
            display: flex;
            gap: 12px;
        }

        .log-time {
            color: var(--text-secondary);
            min-width: 70px;
        }

        .log-phase {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            min-width: 90px;
            text-align: center;
        }

        .log-phase.processing { background: rgba(59, 130, 246, 0.2); color: var(--accent-blue); }
        .log-phase.requirements { background: rgba(168, 85, 247, 0.2); color: var(--accent-purple); }
        .log-phase.tribunal { background: rgba(234, 179, 8, 0.2); color: var(--accent-yellow); }
        .log-phase.consensus { background: rgba(34, 197, 94, 0.2); color: var(--accent-green); }
        .log-phase.report { background: rgba(59, 130, 246, 0.2); color: var(--accent-blue); }

        .log-message {
            flex: 1;
        }

        /* Tribunal Panel */
        .tribunal-panel {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .tribunal-vote {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .vote-model {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .vote-model-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .vote-model-icon.claude { background: linear-gradient(135deg, #d97706, #f59e0b); }
        .vote-model-icon.gpt { background: linear-gradient(135deg, #10b981, #34d399); }
        .vote-model-icon.grok { background: linear-gradient(135deg, #6366f1, #8b5cf6); }

        .vote-verdict {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .vote-verdict.bid { color: var(--accent-green); }
        .vote-verdict.no-bid { color: var(--accent-red); }
        .vote-verdict.conditional { color: var(--accent-yellow); }
        .vote-verdict.waiting { color: var(--text-secondary); }

        .vote-confidence {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .vote-thinking {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            color: var(--text-secondary);
        }

        .thinking-dots span {
            animation: blink 1.4s infinite both;
            font-size: 20px;
        }

        .thinking-dots span:nth-child(2) { animation-delay: 0.2s; }
        .thinking-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes blink {
            0%, 80%, 100% { opacity: 0; }
            40% { opacity: 1; }
        }

        /* Analysis Report */
        .analysis-report {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            display: none;
        }

        .analysis-report.visible {
            display: block;
        }

        .report-header {
            background: var(--bg-tertiary);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }

        .report-verdict {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .verdict-badge {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 700;
        }

        .verdict-badge.bid {
            background: rgba(34, 197, 94, 0.2);
            color: var(--accent-green);
            border: 2px solid var(--accent-green);
        }

        .verdict-badge.no-bid {
            background: rgba(239, 68, 68, 0.2);
            color: var(--accent-red);
            border: 2px solid var(--accent-red);
        }

        .verdict-badge.conditional {
            background: rgba(234, 179, 8, 0.2);
            color: var(--accent-yellow);
            border: 2px solid var(--accent-yellow);
        }

        .verdict-confidence {
            text-align: right;
        }

        .verdict-confidence-value {
            font-size: 28px;
            font-weight: 700;
        }

        .verdict-confidence-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .report-body {
            padding: 20px;
        }

        .report-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .report-section {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 16px;
        }

        .report-section-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
            text-transform: uppercase;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .metric-row:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .metric-value {
            font-weight: 600;
            font-size: 14px;
        }

        .metric-value.good { color: var(--accent-green); }
        .metric-value.warning { color: var(--accent-yellow); }
        .metric-value.bad { color: var(--accent-red); }

        .risk-item, .opportunity-item {
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .risk-item {
            background: rgba(239, 68, 68, 0.1);
            border-left: 3px solid var(--accent-red);
        }

        .risk-item.medium {
            background: rgba(234, 179, 8, 0.1);
            border-left-color: var(--accent-yellow);
        }

        .opportunity-item {
            background: rgba(34, 197, 94, 0.1);
            border-left: 3px solid var(--accent-green);
        }

        .next-steps {
            list-style: none;
        }

        .next-steps li {
            padding: 8px 0;
            padding-left: 20px;
            position: relative;
            font-size: 13px;
            border-bottom: 1px solid var(--border-color);
        }

        .next-steps li:before {
            content: ">";
            position: absolute;
            left: 0;
            color: var(--accent-blue);
            font-weight: bold;
        }

        .next-steps li:last-child {
            border-bottom: none;
        }

        /* LLM Rationale */
        .rationale-section {
            grid-column: span 2;
        }

        .rationale-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }

        .rationale-tab {
            padding: 8px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .rationale-tab:hover, .rationale-tab.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
        }

        .rationale-content {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 16px;
            font-size: 13px;
            line-height: 1.6;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        /* Spinner */
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">AT</div>
                <div class="logo-text">
                    <h1>RFP Intelligence Platform</h1>
                    <span>Powered by Atomic Trust Kernel</span>
                </div>
            </div>
            <div class="status-badges" id="llmStatus">
                <div class="badge disconnected" id="badge-claude">
                    <span class="badge-dot"></span>
                    Claude
                </div>
                <div class="badge disconnected" id="badge-gpt">
                    <span class="badge-dot"></span>
                    GPT-4
                </div>
                <div class="badge disconnected" id="badge-grok">
                    <span class="badge-dot"></span>
                    Grok
                </div>
            </div>
        </header>

        <!-- Main Grid -->
        <div class="main-grid">
            <!-- Sidebar -->
            <aside class="sidebar">
                <!-- RFP Selector -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Select RFP</span>
                    </div>
                    <div class="rfp-list" id="rfpList">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Upload Area -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Or Upload Custom</span>
                    </div>
                    <div class="upload-area">
                        <div class="upload-icon">+</div>
                        <div class="upload-text">
                            Drop PDF/DOCX or click to upload<br>
                            <small style="color: var(--text-secondary);">(Demo mode - uses sample data)</small>
                        </div>
                    </div>
                </div>

                <!-- Analyze Button -->
                <button class="analyze-btn" id="analyzeBtn" disabled>
                    <span>Analyze RFP</span>
                </button>
            </aside>

            <!-- Main Content -->
            <main class="main-content">
                <!-- Processing Window -->
                <div class="processing-window">
                    <div class="processing-header">
                        <div class="processing-title">
                            <div class="spinner" id="processingSpinner" style="display: none;"></div>
                            <span>Analysis Pipeline</span>
                        </div>
                        <div class="processing-status" id="processingStatus">Ready</div>
                    </div>
                    <div class="processing-log" id="processingLog">
                        <div class="empty-state">
                            <div class="empty-state-icon">&#128203;</div>
                            <div>Select an RFP and click "Analyze" to begin</div>
                        </div>
                    </div>
                </div>

                <!-- Tribunal Panel -->
                <div class="tribunal-panel">
                    <div class="tribunal-vote" id="vote-claude">
                        <div class="vote-model">
                            <div class="vote-model-icon claude">C</div>
                            Claude Sonnet
                        </div>
                        <div class="vote-verdict waiting" id="verdict-claude">--</div>
                        <div class="vote-confidence" id="confidence-claude">Awaiting analysis</div>
                    </div>
                    <div class="tribunal-vote" id="vote-gpt">
                        <div class="vote-model">
                            <div class="vote-model-icon gpt">G</div>
                            GPT-4o
                        </div>
                        <div class="vote-verdict waiting" id="verdict-gpt">--</div>
                        <div class="vote-confidence" id="confidence-gpt">Awaiting analysis</div>
                    </div>
                    <div class="tribunal-vote" id="vote-grok">
                        <div class="vote-model">
                            <div class="vote-model-icon grok">X</div>
                            Grok-2
                        </div>
                        <div class="vote-verdict waiting" id="verdict-grok">--</div>
                        <div class="vote-confidence" id="confidence-grok">Awaiting analysis</div>
                    </div>
                </div>

                <!-- Analysis Report -->
                <div class="analysis-report" id="analysisReport">
                    <div class="report-header">
                        <div class="report-verdict">
                            <div class="verdict-badge" id="finalVerdict">--</div>
                            <div>
                                <div style="font-size: 14px; font-weight: 600;" id="reportRfpName">--</div>
                                <div style="font-size: 12px; color: var(--text-secondary);" id="reportClient">--</div>
                            </div>
                        </div>
                        <div class="verdict-confidence">
                            <div class="verdict-confidence-value" id="finalConfidence">--%</div>
                            <div class="verdict-confidence-label">Tribunal Confidence</div>
                        </div>
                    </div>
                    <div class="report-body">
                        <div class="report-grid">
                            <!-- Capability Analysis -->
                            <div class="report-section">
                                <div class="report-section-title">Capability Analysis</div>
                                <div class="metric-row">
                                    <span class="metric-label">Overall Fit</span>
                                    <span class="metric-value" id="metricOverallFit">--%</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">MUST Requirements</span>
                                    <span class="metric-value" id="metricMustFit">--%</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">Capability Gaps</span>
                                    <span class="metric-value" id="metricGaps">--</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">Total Requirements</span>
                                    <span class="metric-value" id="metricTotal">--</span>
                                </div>
                            </div>

                            <!-- Risks -->
                            <div class="report-section">
                                <div class="report-section-title">Risk Assessment</div>
                                <div id="risksList">
                                    <div class="risk-item">No risks identified</div>
                                </div>
                            </div>

                            <!-- Opportunities -->
                            <div class="report-section">
                                <div class="report-section-title">Opportunities</div>
                                <div id="opportunitiesList">
                                    <div class="opportunity-item">Analysis pending</div>
                                </div>
                            </div>

                            <!-- Next Steps -->
                            <div class="report-section">
                                <div class="report-section-title">Recommended Next Steps</div>
                                <ul class="next-steps" id="nextStepsList">
                                    <li>Analysis pending</li>
                                </ul>
                            </div>

                            <!-- LLM Rationale -->
                            <div class="report-section rationale-section">
                                <div class="report-section-title">LLM Analysis Details</div>
                                <div class="rationale-tabs" id="rationaleTabs">
                                    <div class="rationale-tab active" data-model="claude">Claude</div>
                                    <div class="rationale-tab" data-model="gpt">GPT-4</div>
                                    <div class="rationale-tab" data-model="grok">Grok</div>
                                </div>
                                <div class="rationale-content" id="rationaleContent">
                                    Select an LLM to view its detailed analysis...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // State
        let selectedRfp = null;
        let sampleRfps = [];
        let analysisResults = null;
        let voteRationales = {};

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await checkLLMStatus();
            await loadSampleRfps();
            setupEventListeners();
        });

        // Check LLM API status
        async function checkLLMStatus() {
            try {
                const resp = await fetch('/');
                const data = await resp.json();

                updateBadge('badge-claude', data.llm_status.claude === 'configured');
                updateBadge('badge-gpt', data.llm_status.gpt4 === 'configured');
                updateBadge('badge-grok', data.llm_status.grok === 'configured');
            } catch (e) {
                console.error('Failed to check LLM status:', e);
            }
        }

        function updateBadge(id, connected) {
            const badge = document.getElementById(id);
            badge.className = `badge ${connected ? 'connected' : 'disconnected'}`;
        }

        // Load sample RFPs
        async function loadSampleRfps() {
            try {
                const resp = await fetch('/api/sample-rfps');
                sampleRfps = await resp.json();
                renderRfpList();
            } catch (e) {
                console.error('Failed to load RFPs:', e);
            }
        }

        function renderRfpList() {
            const list = document.getElementById('rfpList');
            list.innerHTML = sampleRfps.map(rfp => `
                <div class="rfp-item" data-id="${rfp.id}">
                    <div class="rfp-item-header">
                        <div class="rfp-item-name">${rfp.name}</div>
                        <div class="rfp-item-value">${rfp.value}</div>
                    </div>
                    <div class="rfp-item-client">${rfp.client}</div>
                    <div class="rfp-item-tags">
                        <span class="tag tag-industry">${rfp.industry}</span>
                        <span class="tag tag-difficulty-${rfp.difficulty.toLowerCase().replace(' ', '-')}">${rfp.difficulty}</span>
                    </div>
                </div>
            `).join('');

            // Add click handlers
            list.querySelectorAll('.rfp-item').forEach(item => {
                item.addEventListener('click', () => selectRfp(item.dataset.id));
            });
        }

        function selectRfp(rfpId) {
            selectedRfp = sampleRfps.find(r => r.id === rfpId);

            // Update UI
            document.querySelectorAll('.rfp-item').forEach(item => {
                item.classList.toggle('selected', item.dataset.id === rfpId);
            });

            document.getElementById('analyzeBtn').disabled = false;
        }

        // Event listeners
        function setupEventListeners() {
            document.getElementById('analyzeBtn').addEventListener('click', startAnalysis);

            // Rationale tabs
            document.getElementById('rationaleTabs').addEventListener('click', (e) => {
                if (e.target.classList.contains('rationale-tab')) {
                    document.querySelectorAll('.rationale-tab').forEach(t => t.classList.remove('active'));
                    e.target.classList.add('active');
                    showRationale(e.target.dataset.model);
                }
            });
        }

        function showRationale(model) {
            const content = document.getElementById('rationaleContent');
            content.textContent = voteRationales[model] || 'No analysis available for this model.';
        }

        // Analysis
        async function startAnalysis() {
            if (!selectedRfp) return;

            // Reset UI
            resetAnalysisUI();
            document.getElementById('processingSpinner').style.display = 'block';
            document.getElementById('processingStatus').textContent = 'Analyzing...';
            document.getElementById('analyzeBtn').disabled = true;

            const log = document.getElementById('processingLog');
            log.innerHTML = '';

            try {
                const eventSource = new EventSource(`/api/analyze/${selectedRfp.id}`);

                eventSource.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    handleAnalysisEvent(data);

                    if (data.phase === 'done') {
                        eventSource.close();
                        document.getElementById('processingSpinner').style.display = 'none';
                        document.getElementById('processingStatus').textContent = 'Complete';
                        document.getElementById('analyzeBtn').disabled = false;
                    }
                };

                eventSource.onerror = () => {
                    eventSource.close();
                    addLogEntry('error', 'Connection lost');
                    document.getElementById('processingSpinner').style.display = 'none';
                    document.getElementById('processingStatus').textContent = 'Error';
                    document.getElementById('analyzeBtn').disabled = false;
                };
            } catch (e) {
                console.error('Analysis failed:', e);
                document.getElementById('analyzeBtn').disabled = false;
            }
        }

        function resetAnalysisUI() {
            // Reset votes
            ['claude', 'gpt', 'grok'].forEach(model => {
                document.getElementById(`verdict-${model}`).textContent = '--';
                document.getElementById(`verdict-${model}`).className = 'vote-verdict waiting';
                document.getElementById(`confidence-${model}`).textContent = 'Awaiting analysis';
            });

            // Hide report
            document.getElementById('analysisReport').classList.remove('visible');
            voteRationales = {};
        }

        function handleAnalysisEvent(data) {
            const log = document.getElementById('processingLog');
            const time = new Date().toLocaleTimeString('en-US', { hour12: false });

            switch (data.phase) {
                case 'processing':
                    addLogEntry(data.phase, data.message);
                    break;

                case 'requirements':
                    if (data.step === 'analyze') {
                        const req = data.requirement;
                        const scoreClass = req.match_score >= 70 ? 'good' : req.match_score >= 50 ? 'warning' : 'bad';
                        addLogEntry(data.phase, `[${req.requirement_id}] ${req.type} - Score: ${req.match_score}% ${req.gap ? '(Gap: ' + req.gap + ')' : ''}`);
                    } else if (data.step === 'summary') {
                        addLogEntry(data.phase, `Summary: Avg ${data.avg_score}%, MUST ${data.must_avg}%, Gaps: ${data.gap_count}`);
                    } else {
                        addLogEntry(data.phase, data.message);
                    }
                    break;

                case 'tribunal':
                    if (data.step === 'voting') {
                        const modelKey = data.model.includes('claude') ? 'claude' : data.model.includes('gpt') ? 'gpt' : 'grok';
                        document.getElementById(`confidence-${modelKey}`).innerHTML = '<div class="vote-thinking"><span>Thinking</span><span class="thinking-dots"><span>.</span><span>.</span><span>.</span></span></div>';
                        addLogEntry(data.phase, `${data.model} is analyzing...`);
                    } else if (data.step === 'vote') {
                        const vote = data.vote;
                        const modelKey = vote.model.includes('claude') ? 'claude' : vote.model.includes('gpt') ? 'gpt' : 'grok';

                        const verdictEl = document.getElementById(`verdict-${modelKey}`);
                        const confEl = document.getElementById(`confidence-${modelKey}`);

                        verdictEl.textContent = formatVerdict(vote.verdict);
                        verdictEl.className = `vote-verdict ${vote.verdict.toLowerCase().includes('bid') && !vote.verdict.includes('NO') ? 'bid' : vote.verdict.includes('NO') ? 'no-bid' : 'conditional'}`;
                        confEl.textContent = `${(vote.confidence * 100).toFixed(0)}% confidence`;

                        voteRationales[modelKey] = vote.raw_response || vote.rationale;

                        addLogEntry(data.phase, `${vote.model}: ${vote.verdict} (${(vote.confidence * 100).toFixed(0)}%)`);
                    } else if (data.step === 'error') {
                        const modelKey = data.model.includes('claude') ? 'claude' : data.model.includes('gpt') ? 'gpt' : 'grok';
                        document.getElementById(`confidence-${modelKey}`).textContent = 'API Error';
                        addLogEntry(data.phase, `${data.model}: Error - ${data.error}`);
                    }
                    break;

                case 'consensus':
                    if (data.step === 'result') {
                        const c = data.consensus;
                        addLogEntry(data.phase, `Consensus: ${c.verdict} (${(c.confidence * 100).toFixed(0)}% conf, ${c.unanimous ? 'UNANIMOUS' : c.vote_count + ' votes'})`);
                    } else {
                        addLogEntry(data.phase, data.message);
                    }
                    break;

                case 'report':
                    if (data.step === 'complete') {
                        analysisResults = data.report;
                        renderReport(data.report);
                    } else {
                        addLogEntry(data.phase, data.message);
                    }
                    break;

                case 'done':
                    addLogEntry('report', 'Analysis pipeline complete');
                    break;
            }

            // Auto-scroll log
            log.scrollTop = log.scrollHeight;
        }

        function addLogEntry(phase, message) {
            const log = document.getElementById('processingLog');
            const time = new Date().toLocaleTimeString('en-US', { hour12: false });

            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `
                <span class="log-time">${time}</span>
                <span class="log-phase ${phase}">${phase.toUpperCase()}</span>
                <span class="log-message">${message}</span>
            `;
            log.appendChild(entry);
        }

        function formatVerdict(verdict) {
            return verdict.replace(/_/g, ' ');
        }

        function renderReport(report) {
            const reportEl = document.getElementById('analysisReport');

            // Header
            const verdictBadge = document.getElementById('finalVerdict');
            verdictBadge.textContent = formatVerdict(report.recommendation);
            verdictBadge.className = `verdict-badge ${report.recommendation.toLowerCase().includes('bid') && !report.recommendation.includes('NO') ? 'bid' : report.recommendation.includes('NO') ? 'no-bid' : 'conditional'}`;

            document.getElementById('reportRfpName').textContent = report.rfp.name;
            document.getElementById('reportClient').textContent = `${report.rfp.client} | ${report.rfp.industry} | ${report.rfp.value}`;
            document.getElementById('finalConfidence').textContent = `${(report.tribunal.confidence * 100).toFixed(0)}%`;

            // Metrics
            const overallFit = report.analysis.overall_fit;
            const mustFit = report.analysis.must_requirement_fit;

            const overallEl = document.getElementById('metricOverallFit');
            overallEl.textContent = `${overallFit}%`;
            overallEl.className = `metric-value ${overallFit >= 70 ? 'good' : overallFit >= 50 ? 'warning' : 'bad'}`;

            const mustEl = document.getElementById('metricMustFit');
            mustEl.textContent = `${mustFit}%`;
            mustEl.className = `metric-value ${mustFit >= 70 ? 'good' : mustFit >= 50 ? 'warning' : 'bad'}`;

            const gapsEl = document.getElementById('metricGaps');
            gapsEl.textContent = report.analysis.gap_count;
            gapsEl.className = `metric-value ${report.analysis.gap_count <= 1 ? 'good' : report.analysis.gap_count <= 3 ? 'warning' : 'bad'}`;

            document.getElementById('metricTotal').textContent = report.analysis.total_requirements;

            // Risks
            const risksEl = document.getElementById('risksList');
            if (report.risks.length > 0) {
                risksEl.innerHTML = report.risks.map(r =>
                    `<div class="risk-item ${r.level.toLowerCase()}">${r.description}</div>`
                ).join('');
            } else {
                risksEl.innerHTML = '<div class="opportunity-item">No significant risks identified</div>';
            }

            // Opportunities
            const oppsEl = document.getElementById('opportunitiesList');
            if (report.opportunities.length > 0) {
                oppsEl.innerHTML = report.opportunities.map(o =>
                    `<div class="opportunity-item">${o}</div>`
                ).join('');
            } else {
                oppsEl.innerHTML = '<div class="risk-item medium">Limited opportunities identified</div>';
            }

            // Next Steps
            const stepsEl = document.getElementById('nextStepsList');
            stepsEl.innerHTML = report.next_steps.map(s => `<li>${s}</li>`).join('');

            // Show first rationale
            showRationale('claude');

            // Show report
            reportEl.classList.add('visible');

            // Scroll to report
            reportEl.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>
