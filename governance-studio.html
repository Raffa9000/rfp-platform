<!DOCTYPE html>
<!-- saved from url=(0042)http://localhost:8080/atomic-lab-demo.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Δtomic Trust™ System — Live Kernel</title>
  <meta name="description" content="Interactive demonstration of the Δtomic Trust™ System: patented ΦΨΔIPT mathematical operators for trust computation in governance. Reference implementation by Rafael Velado.">
  <meta name="keywords" content="trust computation, governance, ΦΨΔIPT operators, patent demo, Rafael Velado, Byzantine consensus">
  <meta name="author" content="Rafael Velado">
  <link rel="preconnect" href="https://fonts.googleapis.com/">
  <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="">
  <link href="./Δtomic Trust™ System — Reference Implementation Demo_files/css2" rel="stylesheet">
  
  <!-- jsPDF for PDF attestation certificates -->
  <script src="./Δtomic Trust™ System — Reference Implementation Demo_files/jspdf.umd.min.js.download"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      /* Atomic Trust Brand Colors */
      --deep-navy: #1A1A2E;
      --steel-blue: #0F4C75;
      --bright-blue: #3282B8;
      --trust-teal: #00D4AA;
      
      /* UI Colors */
      --bg-primary: #ffffff;
      --bg-secondary: #f8f9fb;
      --bg-tertiary: #e8ecf1;
      --bg-dark: #1A1A2E;
      --border-light: #d0d7e2;
      --border-medium: #b0bac9;
      --text-primary: #1A1A2E;
      --text-secondary: #4a5568;
      --text-tertiary: #8896a8;
      --brand: #3282B8;
      --brand-dark: #0F4C75;
      --brand-light: rgba(50, 130, 184, 0.12);
      
      /* Operator Colors - Premium Glyph Palette */
      --phi: #10B981;       /* Emerald green for Performance/Zero-start */
      --psi: #F59E0B;       /* Amber/gold for Credential Decay */
      --delta: #EF4444;     /* Red for Divergence */
      --ip: #1A1A2E;        /* Deep navy for Integrity Proof */
      --trust: #0F4C75;     /* Steel blue for Trust composite */
      
      /* Status Colors */
      --green: #00D4AA;
      --green-light: rgba(0, 212, 170, 0.15);
      --amber: #e6a23c;
      --amber-light: rgba(230, 162, 60, 0.15);
      --red: #dc2626;
      --red-light: rgba(220, 38, 38, 0.12);
      
      /* Shadows - Enhanced */
      --shadow-xs: 0 1px 2px rgba(26, 26, 46, 0.04);
      --shadow-sm: 0 2px 4px rgba(26, 26, 46, 0.06), 0 1px 2px rgba(26, 26, 46, 0.03);
      --shadow-md: 0 4px 8px rgba(26, 26, 46, 0.08), 0 2px 4px rgba(26, 26, 46, 0.04);
      --shadow-lg: 0 12px 24px rgba(26, 26, 46, 0.12), 0 4px 8px rgba(26, 26, 46, 0.06);
      --shadow-xl: 0 20px 40px rgba(26, 26, 46, 0.16), 0 8px 16px rgba(26, 26, 46, 0.08);
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes scaleIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }

    @keyframes shimmer {
      0% { background-position: -1000px 0; }
      100% { background-position: 1000px 0; }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    @keyframes slideInRight {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOutRight {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 14px;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* App Layout */
    .app {
      display: grid;
      grid-template-columns: 260px 1fr;
      grid-template-rows: 64px 1fr;
      height: 100vh;
      overflow: hidden;
    }

    /* ===== TOPBAR - PREMIUM ===== */
    .topbar {
      grid-column: 1 / -1;
      background: linear-gradient(to bottom, #ffffff 0%, #fafbfc 100%);
      border-bottom: 1px solid var(--border-light);
      display: flex;
      align-items: center;
      padding: 0 24px;
      gap: 24px;
      z-index: 100;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
    }

    .topbar:hover {
      box-shadow: var(--shadow-md);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 700;
      font-size: 16px;
      min-width: 220px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .logo:hover {
      transform: scale(1.02);
    }

    .logo-mark {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--steel-blue) 0%, var(--deep-navy) 100%);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: white;
      font-weight: 700;
      box-shadow: 0 4px 12px rgba(15, 76, 117, 0.3);
      transition: all 0.3s ease;
    }

    .logo:hover .logo-mark {
      box-shadow: 0 6px 16px rgba(15, 76, 117, 0.4);
      transform: translateY(-1px);
    }

    .logo-text {
      font-size: 16px;
      letter-spacing: -0.02em;
    }

    .logo-text span {
      color: var(--deep-navy);
    }

    .tagline {
      font-size: 11px;
      color: var(--text-tertiary);
      font-style: italic;
      font-weight: 500;
      letter-spacing: 0.01em;
      opacity: 0.8;
      transition: opacity 0.2s ease;
    }

    .tagline:hover {
      opacity: 1;
    }

    /* Time Travel - Enhanced */
    .time-travel {
      flex: 1;
      max-width: 500px;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 16px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-light);
      border-radius: 12px;
      transition: all 0.3s ease;
    }

    .time-travel:hover {
      background: white;
      border-color: var(--brand);
      box-shadow: var(--shadow-md);
    }

    .time-travel-icon {
      width: 20px;
      height: 20px;
      color: var(--brand);
      flex-shrink: 0;
      transition: transform 0.3s ease;
    }

    .time-travel:hover .time-travel-icon {
      transform: rotate(180deg);
    }

    .time-travel-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      white-space: nowrap;
    }

    .time-slider {
      flex: 1;
      height: 6px;
      border-radius: 3px;
      background: linear-gradient(to right, var(--brand-light) 0%, var(--brand) 100%);
      appearance: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .time-slider::-webkit-slider-thumb {
      appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--brand);
      border: 3px solid white;
      box-shadow: var(--shadow-md);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .time-slider::-webkit-slider-thumb:hover {
      transform: scale(1.2);
      box-shadow: var(--shadow-lg);
    }

    .time-slider::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--brand);
      border: 3px solid white;
      box-shadow: var(--shadow-md);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .time-slider::-moz-range-thumb:hover {
      transform: scale(1.2);
      box-shadow: var(--shadow-lg);
    }

    .time-display {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-primary);
      font-family: 'IBM Plex Mono', monospace;
      white-space: nowrap;
    }

    .snapshot-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: var(--ip);
      color: white;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      font-family: 'IBM Plex Mono', monospace;
      white-space: nowrap;
      box-shadow: var(--shadow-sm);
      transition: all 0.2s ease;
    }

    .snapshot-badge:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    /* Buttons - Premium */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      border: none;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--brand) 0%, var(--brand-dark) 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(50, 130, 184, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(50, 130, 184, 0.4);
    }

    .btn-primary:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(50, 130, 184, 0.3);
    }

    .btn-secondary {
      background: white;
      color: var(--text-primary);
      border: 1px solid var(--border-light);
      box-shadow: var(--shadow-xs);
    }

    .btn-secondary:hover {
      background: var(--bg-secondary);
      border-color: var(--brand);
      box-shadow: var(--shadow-sm);
      transform: translateY(-1px);
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-secondary);
    }

    .btn-ghost:hover {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    /* ===== ADVANCED FEATURES - PREMIUM ===== */
    .advanced-features {
      display: flex;
      gap: 12px;
      margin-left: auto;
      margin-right: 16px;
    }

    .feature-indicator {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 14px;
      background: linear-gradient(135deg, var(--bg-secondary) 0%, white 100%);
      border: 1px solid var(--border-light);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-xs);
    }

    .feature-indicator:hover {
      border-color: var(--brand);
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }

    .feature-icon {
      position: relative;
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .feature-icon svg {
      width: 18px;
      height: 18px;
      position: relative;
      z-index: 1;
    }

    .collab-icon {
      background: linear-gradient(135deg, #10B981 0%, #059669 100%);
      color: white;
    }

    .collab-icon svg {
      stroke: white;
    }

    .feature-pulse {
      position: absolute;
      top: 2px;
      right: 2px;
      width: 8px;
      height: 8px;
      background: white;
      border-radius: 50%;
      animation: pulse-feature 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    @keyframes pulse-feature {
      0%, 100% {
        opacity: 1;
        transform: scale(1);
      }
      50% {
        opacity: 0.5;
        transform: scale(1.2);
      }
    }

    .consensus-icon {
      background: linear-gradient(135deg, var(--brand), var(--brand-dark));
      color: white;
    }

    .consensus-icon svg {
      stroke: white;
    }

    .consensus-checkmark {
      position: absolute;
      top: -2px;
      right: -2px;
      width: 14px;
      height: 14px;
      background: var(--green);
      border-radius: 50%;
      color: white;
      font-size: 9px;
      font-weight: 800;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .byzantine-icon {
      background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
      color: white;
    }

    .byzantine-icon svg {
      stroke: white;
    }

    .alert-count {
      position: absolute;
      top: -4px;
      right: -4px;
      min-width: 18px;
      height: 18px;
      background: var(--red);
      border-radius: 10px;
      color: white;
      font-size: 10px;
      font-weight: 800;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid white;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      padding: 0 4px;
      font-family: 'IBM Plex Mono', monospace;
    }

    /* ===== ATOMIC AI COPILOT ===== */
    .atomic-ai-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 14px;
      background: linear-gradient(135deg, var(--bg-secondary) 0%, white 100%);
      border: 2px solid var(--border-light);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-xs);
      position: relative;
      overflow: hidden;
    }

    .atomic-ai-toggle::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(0, 212, 170, 0.1), transparent);
      transition: left 0.5s ease;
    }

    .atomic-ai-toggle:hover::before {
      left: 100%;
    }

    .atomic-ai-toggle:hover {
      border-color: var(--trust-teal);
      box-shadow: var(--shadow-md), 0 0 20px rgba(0, 212, 170, 0.15);
      transform: translateY(-1px);
    }

    .atomic-ai-toggle.active {
      background: linear-gradient(135deg, rgba(0, 212, 170, 0.15) 0%, rgba(0, 212, 170, 0.05) 100%);
      border-color: var(--trust-teal);
      box-shadow: var(--shadow-md), 0 0 30px rgba(0, 212, 170, 0.2);
    }

    .atomic-ai-toggle.active .atomic-ai-icon {
      animation: atomicPulse 2s ease-in-out infinite;
    }

    @keyframes atomicPulse {
      0%, 100% {
        box-shadow: 0 0 0 0 rgba(0, 212, 170, 0.4);
        transform: scale(1);
      }
      50% {
        box-shadow: 0 0 20px 5px rgba(0, 212, 170, 0.2);
        transform: scale(1.05);
      }
    }

    .atomic-ai-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: linear-gradient(135deg, var(--trust-teal) 0%, #00A080 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 18px;
      font-weight: 800;
      font-family: 'IBM Plex Mono', monospace;
      box-shadow: 0 4px 12px rgba(0, 212, 170, 0.3);
      transition: all 0.3s ease;
    }

    .atomic-ai-label {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .atomic-ai-title {
      font-size: 11px;
      font-weight: 800;
      color: var(--trust-teal);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      line-height: 1;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .atomic-ai-title .delta-glyph {
      font-size: 12px;
      font-weight: 800;
    }

    .atomic-ai-status {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-secondary);
      line-height: 1;
    }

    .atomic-ai-toggle.active .atomic-ai-status {
      color: var(--trust-teal);
    }

    /* Atomic AI Copilot Panel */
    .atomic-ai-panel {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 380px;
      max-height: 500px;
      background: white;
      border-radius: 16px;
      box-shadow: var(--shadow-xl), 0 0 40px rgba(0, 212, 170, 0.15);
      border: 2px solid var(--trust-teal);
      z-index: 1000;
      display: none;
      flex-direction: column;
      overflow: hidden;
      animation: slideInUp 0.3s ease;
    }

    .atomic-ai-panel.visible {
      display: flex;
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .atomic-ai-header {
      padding: 16px 20px;
      background: linear-gradient(135deg, var(--trust-teal) 0%, #00A080 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .atomic-ai-header-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 700;
      font-size: 15px;
    }

    .atomic-ai-header-icon {
      width: 28px;
      height: 28px;
      background: rgba(255,255,255,0.2);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: 800;
    }

    .atomic-ai-close {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      background: rgba(255,255,255,0.15);
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .atomic-ai-close:hover {
      background: rgba(255,255,255,0.3);
    }

    .atomic-ai-body {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      max-height: 350px;
    }

    .atomic-ai-messages {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .atomic-ai-message {
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 13px;
      line-height: 1.5;
    }

    .atomic-ai-message.assistant {
      background: linear-gradient(135deg, rgba(0, 212, 170, 0.1) 0%, rgba(0, 212, 170, 0.05) 100%);
      border: 1px solid rgba(0, 212, 170, 0.2);
      border-left: 3px solid var(--trust-teal);
    }

    .atomic-ai-message.user {
      background: var(--bg-secondary);
      border: 1px solid var(--border-light);
      margin-left: 20px;
    }

    .atomic-ai-message .consensus-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      background: var(--trust-teal);
      color: white;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 700;
      margin-top: 8px;
    }

    .atomic-ai-input-area {
      padding: 16px;
      border-top: 1px solid var(--border-light);
      background: var(--bg-secondary);
    }

    .atomic-ai-input-wrapper {
      display: flex;
      gap: 8px;
    }

    .atomic-ai-input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid var(--border-light);
      border-radius: 10px;
      font-size: 13px;
      font-family: inherit;
      transition: all 0.2s ease;
    }

    .atomic-ai-input:focus {
      outline: none;
      border-color: var(--trust-teal);
      box-shadow: 0 0 0 3px rgba(0, 212, 170, 0.1);
    }

    .atomic-ai-send {
      padding: 12px 16px;
      background: linear-gradient(135deg, var(--trust-teal) 0%, #00A080 100%);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      transition: all 0.2s ease;
    }

    .atomic-ai-send:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 212, 170, 0.3);
    }

    .atomic-ai-send:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* Field-level AI Assist Button */
    .ai-assist-btn {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      width: 24px;
      height: 24px;
      border-radius: 6px;
      background: linear-gradient(135deg, var(--trust-teal) 0%, #00A080 100%);
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 800;
      opacity: 0;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(0, 212, 170, 0.3);
    }

    .ai-assist-btn:hover {
      transform: translateY(-50%) scale(1.1);
    }

    input:focus + .ai-assist-btn,
    textarea:focus + .ai-assist-btn,
    .ai-assist-btn:hover {
      opacity: 1;
    }

    /* Contextual Δ Button - appears on cards and list items */
    .delta-context-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 24px;
      height: 24px;
      border-radius: 6px;
      background: rgba(0, 212, 170, 0.15);
      border: 1px solid rgba(0, 212, 170, 0.4);
      color: var(--trust-teal);
      font-size: 12px;
      font-weight: 800;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0.4;
      transition: all 0.2s ease;
      z-index: 10;
    }

    /* In table cells, use static positioning */
    td .delta-context-btn {
      position: static;
      opacity: 0.4;
    }

    tr:hover td .delta-context-btn,
    .delta-context-btn:hover {
      opacity: 1;
      background: var(--trust-teal);
      color: white;
      transform: scale(1.1);
      box-shadow: 0 2px 8px rgba(0, 212, 170, 0.4);
    }

    *:hover > .delta-context-btn,
    .delta-context-btn:focus,
    .evidence-item:hover .delta-context-btn,
    .framework-item:hover .delta-context-btn,
    .equivalence-item:hover .delta-context-btn,
    .stat-card:hover .delta-context-btn,
    .card:hover .delta-context-btn {
      opacity: 1;
    }

    /* Contextual Mini Chat Popup */
    .delta-mini-chat {
      position: fixed;
      width: 320px;
      max-height: 400px;
      background: white;
      border-radius: 12px;
      box-shadow: var(--shadow-xl), 0 0 30px rgba(0, 212, 170, 0.15);
      border: 2px solid var(--trust-teal);
      z-index: 1002;
      display: none;
      flex-direction: column;
      overflow: hidden;
      animation: popIn 0.2s ease;
    }

    .delta-mini-chat.visible {
      display: flex;
    }

    @keyframes popIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .delta-mini-chat-header {
      padding: 10px 12px;
      background: linear-gradient(135deg, var(--trust-teal) 0%, #00A080 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: move;
    }

    .delta-mini-chat-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      font-weight: 700;
    }

    .delta-mini-chat-context {
      font-size: 10px;
      opacity: 0.9;
      max-width: 180px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .delta-mini-chat-close {
      width: 22px;
      height: 22px;
      border-radius: 4px;
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .delta-mini-chat-close:hover {
      background: rgba(255,255,255,0.3);
    }

    .delta-mini-chat-body {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      max-height: 250px;
      background: var(--bg-secondary);
    }

    .delta-mini-chat-messages {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .delta-mini-message {
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 11px;
      line-height: 1.5;
    }

    .delta-mini-message.user {
      background: var(--brand-light);
      color: var(--brand-dark);
      align-self: flex-end;
      max-width: 85%;
    }

    .delta-mini-message.assistant {
      background: white;
      border: 1px solid var(--border-light);
      border-left: 3px solid var(--trust-teal);
    }

    .delta-mini-chat-input {
      padding: 10px 12px;
      border-top: 1px solid var(--border-light);
      display: flex;
      gap: 8px;
      background: white;
    }

    .delta-mini-chat-input input {
      flex: 1;
      padding: 8px 10px;
      border: 1px solid var(--border-light);
      border-radius: 6px;
      font-size: 11px;
    }

    .delta-mini-chat-input input:focus {
      outline: none;
      border-color: var(--trust-teal);
    }

    .delta-mini-chat-input button {
      padding: 8px 12px;
      background: var(--trust-teal);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
    }

    .delta-mini-chat-input button:hover {
      background: #00B090;
    }

    /* Mini Chat Messages */
    .delta-mini-chat-message {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }

    .delta-mini-chat-message.user {
      justify-content: flex-end;
    }

    .delta-mini-chat-message.user .delta-mini-chat-bubble {
      background: var(--brand-light);
      color: var(--brand-dark);
      max-width: 85%;
    }

    .delta-mini-chat-message.ai .delta-mini-chat-bubble {
      background: white;
      border: 1px solid var(--border-light);
      border-left: 3px solid var(--trust-teal);
      flex: 1;
    }

    .delta-mini-chat-avatar {
      width: 22px;
      height: 22px;
      background: linear-gradient(135deg, var(--trust-teal), #00A080);
      border-radius: 6px;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 800;
      flex-shrink: 0;
    }

    .delta-mini-chat-bubble {
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 11px;
      line-height: 1.5;
    }

    .delta-mini-chat-bubble.thinking {
      background: var(--bg-secondary);
      color: var(--text-tertiary);
      font-style: italic;
    }

    .delta-mini-chat-bubble.error {
      background: var(--red-light);
      color: var(--red);
      border-left: 3px solid var(--red);
    }

    .delta-thinking-dots::after {
      content: '...';
      animation: thinkingDots 1.5s infinite;
    }

    @keyframes thinkingDots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }

    .delta-mini-chat-welcome {
      text-align: center;
      padding: 20px;
      color: var(--text-secondary);
    }

    .delta-mini-chat-welcome p {
      margin: 0;
      font-size: 11px;
    }

    .delta-mini-chat-icon {
      font-size: 14px;
      font-weight: 800;
      color: var(--trust-teal);
    }

    .delta-mini-chat-input-area {
      padding: 10px 12px;
      border-top: 1px solid var(--border-light);
      display: flex;
      gap: 8px;
      background: white;
    }

    .delta-mini-chat-input-area .delta-mini-chat-input {
      flex: 1;
      padding: 8px 10px;
      border: 1px solid var(--border-light);
      border-radius: 6px;
      font-size: 11px;
      font-family: 'Inter', sans-serif;
    }

    .delta-mini-chat-input-area .delta-mini-chat-input:focus {
      outline: none;
      border-color: var(--trust-teal);
    }

    .delta-mini-chat-send {
      width: 28px;
      height: 28px;
      background: var(--trust-teal);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .delta-mini-chat-send:hover {
      background: #00B090;
    }

    /* Atomic AI Configuration Panel */
    .atomic-ai-config {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 600px;
      max-height: 85vh;
      background: white;
      border-radius: 16px;
      box-shadow: var(--shadow-xl), 0 0 60px rgba(0, 212, 170, 0.2);
      border: 2px solid var(--trust-teal);
      z-index: 1001;
      display: none;
      flex-direction: column;
      overflow: hidden;
    }

    .atomic-ai-config.visible {
      display: flex;
    }

    .atomic-ai-config-header {
      padding: 20px 24px;
      background: linear-gradient(135deg, var(--trust-teal) 0%, #00A080 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .atomic-ai-config-body {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
      max-height: 60vh;
    }

    .config-section {
      margin-bottom: 24px;
      padding-bottom: 24px;
      border-bottom: 1px solid var(--border-light);
    }

    .config-section:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }

    .config-section-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .config-section-title .operator-badge {
      padding: 2px 8px;
      background: var(--trust-teal);
      color: white;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 700;
    }

    .llm-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .llm-option {
      padding: 12px 16px;
      border: 2px solid var(--border-light);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .llm-option:hover {
      border-color: var(--trust-teal);
      background: rgba(0, 212, 170, 0.05);
    }

    .llm-option.selected {
      border-color: var(--trust-teal);
      background: rgba(0, 212, 170, 0.1);
    }

    .llm-option input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--trust-teal);
    }

    .llm-option-info {
      flex: 1;
    }

    .llm-option-name {
      font-weight: 700;
      font-size: 13px;
      color: var(--text-primary);
    }

    .llm-option-provider {
      font-size: 11px;
      color: var(--text-tertiary);
    }

    .llm-option-weight {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 12px;
      font-weight: 700;
      color: var(--trust-teal);
    }

    .weight-slider-group {
      margin-bottom: 16px;
    }

    .weight-slider-label {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .weight-slider-name {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      font-weight: 600;
    }

    .weight-slider-value {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 14px;
      font-weight: 700;
      color: var(--trust-teal);
    }

    .weight-slider {
      width: 100%;
      height: 8px;
      border-radius: 4px;
      background: var(--border-light);
      appearance: none;
      cursor: pointer;
    }

    .weight-slider::-webkit-slider-thumb {
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--trust-teal) 0%, #00A080 100%);
      box-shadow: 0 2px 8px rgba(0, 212, 170, 0.3);
      cursor: pointer;
    }

    .system-prompt-textarea {
      width: 100%;
      min-height: 120px;
      padding: 12px 16px;
      border: 1px solid var(--border-light);
      border-radius: 10px;
      font-family: 'IBM Plex Mono', monospace;
      font-size: 12px;
      line-height: 1.5;
      resize: vertical;
      transition: all 0.2s ease;
    }

    .system-prompt-textarea:focus {
      outline: none;
      border-color: var(--trust-teal);
      box-shadow: 0 0 0 3px rgba(0, 212, 170, 0.1);
    }

    .governance-indicator {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: linear-gradient(135deg, rgba(0, 212, 170, 0.1) 0%, rgba(0, 212, 170, 0.05) 100%);
      border: 1px solid rgba(0, 212, 170, 0.2);
      border-radius: 10px;
      margin-top: 16px;
    }

    .governance-status {
      flex: 1;
    }

    .governance-status-title {
      font-size: 12px;
      font-weight: 700;
      color: var(--trust-teal);
      margin-bottom: 4px;
    }

    .governance-status-detail {
      font-size: 11px;
      color: var(--text-secondary);
    }

    .governance-toggle {
      position: relative;
      width: 48px;
      height: 26px;
      background: var(--border-light);
      border-radius: 13px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .governance-toggle.active {
      background: var(--trust-teal);
    }

    .governance-toggle::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
    }

    .governance-toggle.active::after {
      left: 25px;
    }

    .atomic-ai-config-footer {
      padding: 16px 24px;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border-light);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .config-hash {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 10px;
      color: var(--text-tertiary);
    }

    .feature-label {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .feature-title {
      font-size: 10px;
      font-weight: 700;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.03em;
      line-height: 1;
    }

    .feature-value {
      font-size: 13px;
      font-weight: 700;
      color: var(--text-primary);
      font-family: 'IBM Plex Mono', monospace;
      line-height: 1;
    }

    /* ===== SIDEBAR - POLISHED ===== */
    .sidebar {
      background: white;
      border-right: 1px solid var(--border-light);
      overflow-y: auto;
      padding: 20px 16px;
      box-shadow: var(--shadow-sm);
      display: flex;
      flex-direction: column;
    }

    .nav-section {
      margin-bottom: 24px;
    }

    .nav-section-title {
      font-size: 11px;
      font-weight: 700;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 8px;
      padding: 0 12px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      border-radius: 10px;
      cursor: pointer;
      color: var(--text-secondary);
      transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
      font-size: 13px;
      font-weight: 500;
      position: relative;
      overflow: hidden;
    }

    .nav-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 3px;
      height: 0;
      background: var(--brand);
      border-radius: 0 2px 2px 0;
      transition: height 0.2s ease;
    }

    .nav-item:hover {
      background: var(--bg-secondary);
      color: var(--text-primary);
      transform: translateX(2px);
    }

    .nav-item.active {
      background: var(--brand-light);
      color: var(--brand);
      font-weight: 600;
    }

    .nav-item.active::before {
      height: 20px;
    }

    .nav-item svg {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
      transition: transform 0.2s ease;
    }

    .nav-item:hover svg {
      transform: scale(1.1);
    }

    .nav-item .badge {
      margin-left: auto;
      padding: 2px 8px;
      background: var(--bg-tertiary);
      border-radius: 10px;
      font-size: 11px;
      font-weight: 700;
      font-family: 'IBM Plex Mono', monospace;
      transition: all 0.2s ease;
    }

    .nav-item.active .badge {
      background: var(--brand);
      color: white;
    }

    .nav-item:hover .badge {
      transform: scale(1.05);
    }

    /* Operator Legend - Enhanced */
    .operator-legend {
      padding: 16px;
      background: linear-gradient(135deg, var(--bg-secondary) 0%, white 100%);
      border: 1px solid var(--border-light);
      border-radius: 12px;
      margin-top: 12px;
      box-shadow: var(--shadow-xs);
    }

    .operator-legend-title {
      font-size: 10px;
      font-weight: 700;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 12px;
      font-family: 'IBM Plex Mono', monospace;
    }

    .operator-legend-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      margin: 0 -12px;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.2s ease;
      cursor: pointer;
      border-radius: 8px;
    }

    .operator-legend-item:hover {
      background: rgba(50, 130, 184, 0.08);
      transform: translateX(4px);
    }

    .operator-legend-item:active {
      background: rgba(50, 130, 184, 0.15);
      transform: translateX(2px);
    }

    .operator-glyph {
      width: 26px;
      height: 26px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      color: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      transition: all 0.2s ease;
      font-style: italic;
    }

    .operator-legend-item:hover .operator-glyph {
      transform: scale(1.15);
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    }

    /* User Profile & RBAC Section - Premium Stellar Styling */
    .user-profile {
      margin-top: auto;
      padding: 0;
      background: transparent;
    }

    .user-profile-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: linear-gradient(135deg, var(--bg-secondary) 0%, white 100%);
      border: 1px solid var(--border-light);
      border-radius: 12px;
      margin-bottom: 12px;
      box-shadow: var(--shadow-xs);
      transition: all 0.2s ease;
    }

    .user-profile-header:hover {
      box-shadow: var(--shadow-sm);
      border-color: var(--brand);
    }

    .user-avatar {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--brand), var(--brand-dark));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 15px;
      color: white;
      box-shadow: 0 4px 12px rgba(50, 130, 184, 0.25);
      flex-shrink: 0;
    }

    .user-info {
      flex: 1;
      min-width: 0;
    }

    .user-name {
      font-weight: 700;
      font-size: 14px;
      margin-bottom: 2px;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .user-role {
      font-size: 11px;
      color: var(--text-tertiary);
      font-weight: 600;
    }

    .role-switcher-label {
      font-size: 10px;
      font-weight: 700;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 8px;
      padding: 0 4px;
      font-family: 'IBM Plex Mono', monospace;
    }

    .role-badge {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-light);
      border-radius: 10px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 6px;
      position: relative;
      color: var(--text-primary);
    }

    .role-badge:hover {
      background: white;
      border-color: var(--brand);
      transform: translateX(4px);
      box-shadow: var(--shadow-sm);
    }

    .role-badge.active {
      background: linear-gradient(135deg, var(--brand-light) 0%, white 100%);
      border-color: var(--brand);
      box-shadow: var(--shadow-sm);
    }

    .role-badge.active::before {
      content: '';
      position: absolute;
      left: -1px;
      top: 50%;
      transform: translateY(-50%);
      width: 3px;
      height: 60%;
      background: var(--brand);
      border-radius: 0 2px 2px 0;
    }

    .role-icon {
      width: 24px;
      height: 24px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      background: white;
      border: 1px solid var(--border-light);
      flex-shrink: 0;
      transition: all 0.2s ease;
    }

    .role-badge:hover .role-icon {
      border-color: var(--brand);
      box-shadow: 0 2px 8px rgba(50, 130, 184, 0.15);
      transform: scale(1.1);
    }

    .role-badge.active .role-icon {
      background: linear-gradient(135deg, var(--brand), var(--brand-dark));
      border-color: var(--brand);
      box-shadow: 0 2px 8px rgba(50, 130, 184, 0.3);
    }

    .role-permissions {
      position: absolute;
      left: calc(100% + 12px);
      top: 0;
      background: white;
      border: 2px solid var(--brand);
      border-radius: 12px;
      padding: 16px;
      min-width: 300px;
      box-shadow: var(--shadow-xl);
      opacity: 0;
      pointer-events: none;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 10000;
      transform: translateX(-8px);
    }

    .role-badge:hover .role-permissions {
      opacity: 1;
      pointer-events: all;
      transform: translateX(0);
    }

    .role-permissions-title {
      font-weight: 800;
      font-size: 13px;
      margin-bottom: 12px;
      color: var(--brand);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--border-light);
    }

    .permission-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      padding: 6px 0;
      color: var(--text-primary);
      font-weight: 500;
    }

    .permission-item svg {
      width: 14px;
      height: 14px;
      flex-shrink: 0;
      stroke-width: 2.5;
    }

    .permission-item.granted svg {
      color: var(--green);
    }

    .permission-item.denied {
      opacity: 0.35;
      color: var(--text-tertiary);
    }

    .permission-item.denied svg {
      color: var(--red);
    }

    /* Premium Operator Glyph Colors */
    .operator-glyph.phi { 
      background: linear-gradient(135deg, #10B981 0%, #059669 100%);
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);
    }
    .operator-glyph.psi { 
      background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%);
      box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4);
    }
    .operator-glyph.delta { 
      background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
    }
    .operator-glyph.ip { 
      background: linear-gradient(135deg, #1A1A2E 0%, #0F0F1E 100%);
      box-shadow: 0 2px 8px rgba(26, 26, 46, 0.5);
    }
    .operator-glyph.trust { 
      background: linear-gradient(135deg, #0F4C75 0%, #0A3654 100%);
      box-shadow: 0 2px 8px rgba(15, 76, 117, 0.4);
    }

    /* ===== MAIN CONTENT ===== */
    .main {
      overflow-y: auto;
      padding: 32px;
      background: var(--bg-secondary);
    }

    .view {
      display: none;
    }

    .view.active {
      display: block;
      animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Page Header - Enhanced */
    .page-header {
      margin-bottom: 32px;
      animation: slideUp 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .page-title {
      font-size: 28px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
      letter-spacing: -0.02em;
    }

    .page-subtitle {
      color: var(--text-secondary);
      font-size: 15px;
      font-weight: 500;
    }

    /* Cards - Premium */
    .card {
      background: white;
      border: 1px solid var(--border-light);
      border-radius: 16px;
      box-shadow: var(--shadow-sm);
      overflow: hidden;
      transition: all 0.3s ease;
      animation: scaleIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .card:hover {
      box-shadow: var(--shadow-md);
      transform: translateY(-2px);
    }

    .card-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-light);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(to bottom, white 0%, var(--bg-secondary) 100%);
    }

    .card-title {
      font-weight: 700;
      font-size: 15px;
      letter-spacing: -0.01em;
    }

    .card-body {
      padding: 24px;
    }

    /* Grid Layouts */
    .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; }
    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; }
    .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; }

    /* ===== TRUST SCORE DISPLAY - STUNNING ===== */
    .trust-score-large {
      text-align: center;
      padding: 32px 24px;
      position: relative;
    }

    .trust-score-value {
      font-size: 72px;
      font-weight: 800;
      line-height: 1;
      margin-bottom: 12px;
      letter-spacing: -0.03em;
      font-family: 'IBM Plex Mono', monospace;
      transition: all 0.5s ease;
    }

    .trust-score-value.green { 
      color: var(--green);
      text-shadow: 0 0 30px rgba(0, 212, 170, 0.3);
    }
    .trust-score-value.amber { 
      color: var(--amber);
      text-shadow: 0 0 30px rgba(230, 162, 60, 0.3);
    }
    .trust-score-value.red { 
      color: var(--red);
      text-shadow: 0 0 30px rgba(220, 38, 38, 0.3);
    }

    .trust-score-label {
      font-size: 13px;
      color: var(--text-secondary);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    /* Operator Bars - Enhanced */
    .operator-row {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 12px 0;
      transition: all 0.2s ease;
    }

    .operator-row:hover {
      transform: translateX(4px);
    }

    .operator-label {
      font-size: 12px;
      color: var(--text-secondary);
      min-width: 120px;
      font-weight: 500;
    }

    .operator-bar {
      flex: 1;
      height: 10px;
      background: var(--bg-tertiary);
      border-radius: 5px;
      overflow: hidden;
      position: relative;
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .operator-bar-fill {
      height: 100%;
      border-radius: 5px;
      position: relative;
      overflow: hidden;
      transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .operator-bar-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, 
        transparent 0%, 
        rgba(255, 255, 255, 0.3) 50%, 
        transparent 100%
      );
      animation: shimmer 2s infinite;
    }

    /* Premium Operator Bar Gradients */
    .operator-bar-fill.phi { 
      background: linear-gradient(90deg, #10B981 0%, #059669 100%);
    }
    .operator-bar-fill.psi { 
      background: linear-gradient(90deg, #F59E0B 0%, #D97706 100%);
    }
    .operator-bar-fill.delta { 
      background: linear-gradient(90deg, #EF4444 0%, #DC2626 100%);
    }
    .operator-bar-fill.ip { 
      background: linear-gradient(90deg, #1A1A2E 0%, #0F0F1E 100%);
    }
    .operator-bar-fill.trust { 
      background: linear-gradient(90deg, #0F4C75 0%, #0A3654 100%);
    }

    .operator-value {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 13px;
      font-weight: 700;
      min-width: 45px;
      text-align: right;
    }

    /* Operator value colors */
    .operator-value.phi { color: #10B981; }
    .operator-value.psi { color: #F59E0B; }
    .operator-value.delta { color: #EF4444; }
    .operator-value.ip { color: #1A1A2E; }
    .operator-value.trust { color: #0F4C75; }

    /* ===== STAT CARDS - GORGEOUS ===== */
    .stat-card {
      background: white;
      border: 1px solid var(--border-light);
      border-radius: 16px;
      padding: 24px;
      box-shadow: var(--shadow-sm);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--brand), var(--trust-teal));
      transform: scaleX(0);
      transform-origin: left;
      transition: transform 0.3s ease;
    }

    .stat-card:hover::before {
      transform: scaleX(1);
    }

    .stat-card:hover {
      box-shadow: var(--shadow-lg);
      transform: translateY(-4px);
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-tertiary);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 12px;
    }

    .stat-value {
      font-size: 36px;
      font-weight: 800;
      color: var(--text-primary);
      margin-bottom: 8px;
      font-family: 'IBM Plex Mono', monospace;
      letter-spacing: -0.02em;
    }

    .stat-change {
      font-size: 13px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .stat-change.positive { color: var(--green); }
    .stat-change.negative { color: var(--red); }

    /* ===== DATA TABLE - REFINED ===== */
    .data-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }

    .data-table thead {
      background: var(--bg-secondary);
      border-bottom: 2px solid var(--border-light);
    }

    .data-table th {
      padding: 14px 16px;
      text-align: left;
      font-size: 11px;
      font-weight: 700;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      border-bottom: 2px solid var(--border-light);
    }

    .data-table tbody tr {
      border-bottom: 1px solid var(--border-light);
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .data-table tbody tr:hover {
      background: var(--bg-secondary);
      transform: scale(1.005);
    }

    .data-table td {
      padding: 16px;
      font-size: 13px;
    }

    .control-id {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 12px;
      font-weight: 700;
      color: var(--brand);
      padding: 4px 10px;
      background: var(--brand-light);
      border-radius: 6px;
      display: inline-block;
      transition: all 0.2s ease;
    }

    .control-id:hover {
      background: var(--brand);
      color: white;
      transform: scale(1.05);
    }

    .control-name {
      font-weight: 500;
      color: var(--text-primary);
    }

    .framework-chip {
      display: inline-block;
      padding: 3px 8px;
      background: var(--bg-tertiary);
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      color: var(--text-secondary);
      margin-right: 4px;
      margin-bottom: 4px;
      transition: all 0.2s ease;
    }

    .framework-chip:hover {
      background: var(--brand-light);
      color: var(--brand);
      transform: translateY(-1px);
    }

    .status-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      display: inline-block;
    }

    .status-badge.green {
      background: var(--green-light);
      color: var(--green);
    }

    .status-badge.amber {
      background: var(--amber-light);
      color: var(--amber);
    }

    .status-badge.red {
      background: var(--red-light);
      color: var(--red);
    }

    /* Mini Trust Display */
    .mini-trust {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .mini-trust-bar {
      flex: 1;
      height: 6px;
      background: var(--bg-tertiary);
      border-radius: 3px;
      overflow: hidden;
    }

    .mini-trust-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.5s ease;
    }

    .mini-trust-fill.green { background: var(--green); }
    .mini-trust-fill.amber { background: var(--amber); }
    .mini-trust-fill.red { background: var(--red); }

    .mini-trust-value {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 12px;
      font-weight: 700;
      min-width: 45px;
      text-align: right;
    }

    /* Hash Display */
    .hash {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 11px;
      color: var(--ip);
      background: rgba(26, 26, 46, 0.05);
      padding: 3px 8px;
      border-radius: 4px;
      border: 1px solid rgba(26, 26, 46, 0.1);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .hash:hover {
      background: var(--ip);
      color: white;
      transform: scale(1.02);
    }

    /* ===== MODALS - POLISHED ===== */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(26, 26, 46, 0.6);
      backdrop-filter: blur(8px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.2s ease;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: white;
      border-radius: 20px;
      box-shadow: var(--shadow-xl);
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      animation: scaleIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .modal-header {
      padding: 24px;
      border-bottom: 1px solid var(--border-light);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(to bottom, white, var(--bg-secondary));
    }

    .modal-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .modal-close {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--text-tertiary);
    }

    .modal-close:hover {
      background: var(--red-light);
      color: var(--red);
      transform: rotate(90deg);
    }

    .modal-body {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }

    .modal-footer {
      padding: 20px 24px;
      border-top: 1px solid var(--border-light);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      background: var(--bg-secondary);
    }

    .btn-sm {
      padding: 6px 14px;
      font-size: 13px;
    }

    /* ===== TOASTS - ELEGANT ===== */
    .toast-container {
      position: fixed;
      top: 80px;
      right: 24px;
      z-index: 2000;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .toast {
      background: white;
      border: 1px solid var(--border-light);
      border-radius: 12px;
      padding: 16px 20px;
      box-shadow: var(--shadow-lg);
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 300px;
      animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(100px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .toast-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .toast.success .toast-icon {
      background: var(--green-light);
      color: var(--green);
    }

    .toast.error .toast-icon {
      background: var(--red-light);
      color: var(--red);
    }

    .toast.info .toast-icon {
      background: var(--brand-light);
      color: var(--brand);
    }

    .toast-message {
      flex: 1;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
    }

    /* ===== DISCUSSION THREAD ===== */
    .discussion-entry {
      padding: 16px;
      border-bottom: 1px solid var(--border-light);
      transition: all 0.2s ease;
    }

    .discussion-entry:hover {
      background: var(--bg-secondary);
    }

    .discussion-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .discussion-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--brand), var(--trust-teal));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 13px;
      box-shadow: var(--shadow-sm);
    }

    .discussion-meta {
      flex: 1;
    }

    .discussion-author {
      font-weight: 600;
      font-size: 13px;
      color: var(--text-primary);
    }

    .discussion-time {
      font-size: 11px;
      color: var(--text-tertiary);
    }

    .discussion-hash {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 10px;
      color: var(--ip);
      opacity: 0.6;
    }

    .discussion-content {
      font-size: 13px;
      line-height: 1.6;
      color: var(--text-secondary);
      padding-left: 48px;
    }

    .snapshot-entry {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: rgba(26, 26, 46, 0.02);
      border-left: 3px solid var(--ip);
      border-radius: 8px;
    }

    .snapshot-entry-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: var(--ip);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 11px;
      font-family: 'IBM Plex Mono', monospace;
    }

    .snapshot-entry-content {
      flex: 1;
    }

    .snapshot-entry-title {
      font-weight: 600;
      font-size: 13px;
      color: var(--text-primary);
    }

    .snapshot-entry-meta {
      font-size: 11px;
      color: var(--text-tertiary);
    }

    /* ===== LOADING STATES ===== */
    .skeleton {
      background: linear-gradient(
        90deg,
        var(--bg-tertiary) 0%,
        var(--bg-secondary) 50%,
        var(--bg-tertiary) 100%
      );
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 8px;
    }

    .skeleton-text {
      height: 16px;
      margin-bottom: 8px;
    }

    .skeleton-title {
      height: 24px;
      width: 60%;
      margin-bottom: 12px;
    }

    /* ===== EMPTY STATES ===== */
    .empty-state {
      text-align: center;
      padding: 60px 40px;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .empty-state-description {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 24px;
    }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 1024px) {
      .app {
        grid-template-columns: 220px 1fr;
      }
      .grid-4 { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 768px) {
      .app {
        grid-template-columns: 1fr;
      }
      .sidebar {
        display: none;
      }
      .grid-2, .grid-3, .grid-4 {
        grid-template-columns: 1fr;
      }
    }

    /* ===== UTILITY CLASSES ===== */
    .mb-8 { margin-bottom: 8px; }
    .mb-16 { margin-bottom: 16px; }
    .mb-24 { margin-bottom: 24px; }
    .mb-32 { margin-bottom: 32px; }

    .text-center { text-align: center; }
    .text-right { text-align: right; }

    .flex { display: flex; }
    .items-center { align-items: center; }
    .justify-between { justify-content: space-between; }
    .gap-8 { gap: 8px; }
    .gap-12 { gap: 12px; }
    .gap-16 { gap: 16px; }
  </style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
  <!-- DEMO DISCLAIMER BANNER -->
  <div style="background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); color: white; padding: 16px 24px; text-align: center; border-bottom: 3px solid #60a5fa; font-family: &#39;IBM Plex Mono&#39;, monospace; position: relative; z-index: 100000;">
    <div style="max-width: 1200px; margin: 0 auto;">
      <div style="font-size: 11px; font-weight: 800; letter-spacing: 0.1em; margin-bottom: 6px; opacity: 0.9;">
        🧪 REFERENCE IMPLEMENTATION DEMO — ALL DATA SHOWN IS SIMULATED
      </div>
      <div style="font-size: 13px; line-height: 1.6; opacity: 0.95;">
        <strong>Working prototype</strong> demonstrating the mathematical foundation of the Δtomic Trust™ System.
        Covered by <strong>U.S. Provisional Patent Applications (November 2025)</strong>.
        <span style="opacity: 0.8; font-size: 12px; display: block; margin-top: 4px;">
          ⚠️ SIMULATED DATA ONLY • Not connected to real systems • Not a production platform • © 2025 Rafael Velado
        </span>
      </div>
    </div>
  </div>

  <div class="app">
    <!-- Top Bar -->
    <header class="topbar">
      <div class="logo" onclick="showView(&#39;dashboard&#39;)">
        <div class="logo-mark">Δ</div>
        <div class="logo-text"><span>Δtomic</span> Trust<sup style="font-size: 10px; margin-left: 2px;">™</sup></div>
      </div>
      
      <div class="tagline">
        The Git of Governance™ | Trust Decays. Credentials Lie. Δ Catches Both.
      </div>
      
      <div class="time-travel">
        <svg class="time-travel-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12,6 12,12 16,14"></polyline>
        </svg>
        <span class="time-travel-label">Time Travel</span>
        <div style="display: flex; gap: 4px; margin-right: 8px;">
          <button onclick="advanceLiveTime(1); showToast('Advanced 1 day', 'info');" style="padding: 2px 6px; font-size: 9px; background: var(--bg-tertiary); border: 1px solid var(--border-light); border-radius: 3px; cursor: pointer; font-family: 'IBM Plex Mono';">+1d</button>
          <button onclick="advanceLiveTime(7); showToast('Advanced 7 days', 'info');" style="padding: 2px 6px; font-size: 9px; background: var(--bg-tertiary); border: 1px solid var(--border-light); border-radius: 3px; cursor: pointer; font-family: 'IBM Plex Mono';">+7d</button>
          <button onclick="advanceLiveTime(30); showToast('Advanced 30 days', 'info');" style="padding: 2px 6px; font-size: 9px; background: var(--bg-tertiary); border: 1px solid var(--border-light); border-radius: 3px; cursor: pointer; font-family: 'IBM Plex Mono';">+30d</button>
        </div>
        <input type="range" class="time-slider active" id="timeSlider" min="0" max="100" value="100">
        <span class="time-display" id="timeDisplay">Nov 29 - Current State · Now</span>
        <span class="snapshot-badge" id="snapshotBadge">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
      </svg>
      Block 847
    </span>
      </div>
      
      <!-- Advanced Features -->
      <div class="advanced-features">
        <!-- Real-time Collaboration -->
        <div class="feature-indicator" onclick="showCollaboration()" title="Real-time Collaboration">
          <div class="feature-icon collab-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            <div class="feature-pulse"></div>
          </div>
          <div class="feature-label">
            <div class="feature-title">Collaboration</div>
            <div class="feature-value">3 Active</div>
          </div>
        </div>

        <!-- Multi-LLM Consensus -->
        <div class="feature-indicator" onclick="showConsensus()" title="Multi-LLM Consensus Verification">
          <div class="feature-icon consensus-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
              <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
              <line x1="12" y1="22.08" x2="12" y2="12"></line>
            </svg>
            <div class="consensus-checkmark">✓</div>
          </div>
          <div class="feature-label">
            <div class="feature-title">AI Consensus</div>
            <div class="feature-value">4/4 Agree</div>
          </div>
        </div>

        <!-- Byzantine Fault Detector -->
        <div class="feature-indicator" onclick="showByzantineDetector()" title="Byzantine Fault Detection">
          <div class="feature-icon byzantine-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
              <line x1="12" y1="9" x2="12" y2="13"></line>
              <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            <div class="alert-count">2</div>
          </div>
          <div class="feature-label">
            <div class="feature-title">Byzantine Alert</div>
            <div class="feature-value">Δ &gt; 0.15</div>
          </div>
        </div>

        <!-- Atomic AI Copilot Toggle -->
        <div id="atomicAiToggle" class="atomic-ai-toggle" onclick="toggleAtomicAI()" title="Atomic AI Copilot - Multi-LLM Consensus Assistant">
          <div class="atomic-ai-icon">Δ</div>
          <div class="atomic-ai-label">
            <div class="atomic-ai-title"><span class="delta-glyph">Δ</span>tomic AI</div>
            <div class="atomic-ai-status" id="atomicAiStatus">Click to Enable</div>
          </div>
        </div>
      </div>

      <!-- API Status Indicator - PUBLIC DEMO (Simulation Only) -->
      <div id="apiStatus" style="display: flex; align-items: center; gap: 8px; font-size: 12px; color: #94A3B8; padding: 0 16px;" title="Connected to real API backend"><span style="color: #10B981;">●</span> Connected to Backend</div>
      
      <div id="conservationIndicator" style="display: flex; align-items: center; gap: 6px; padding: 4px 10px; background: var(--bg-tertiary); border-radius: 6px; margin-right: 8px;">
        <span style="font-family: 'IBM Plex Mono'; font-size: 10px; color: var(--phi);">Σω=<span id="topSum">1.00</span></span>
        <span id="topStatus" style="font-size: 12px; color: var(--green);">✓</span>
      </div>
      <button class="btn btn-secondary" onclick="showKernelPanel()" style="margin-right: 8px;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="3"/>
          <path d="M12 1v6m0 6v10"/>
        </svg>
        Kernel
      </button>
      <button class="btn btn-primary" onclick="createSnapshot()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
          <circle cx="12" cy="13" r="4"></circle>
        </svg>
        Snapshot
      </button>
    </header>

    <!-- Sidebar -->
    <nav class="sidebar">
      <div class="nav-section">
        <div class="nav-section-title">Overview</div>
        <div class="nav-item" onclick="showView(&#39;dashboard&#39;)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="7" height="7"></rect>
            <rect x="14" y="3" width="7" height="7"></rect>
            <rect x="14" y="14" width="7" height="7"></rect>
            <rect x="3" y="14" width="7" height="7"></rect>
          </svg>
          Dashboard
        </div>
        <div class="nav-item" onclick="showView(&#39;controls&#39;)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
          </svg>
          Controls
          <span class="badge">52</span>
        </div>
        <div class="nav-item" onclick="showView(&#39;evidence&#39;)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14,2 14,8 20,8"></polyline>
          </svg>
          Evidence
          <span class="badge">124</span>
        </div>
        <div class="nav-item active" onclick="showView(&#39;clauses&#39;)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
          </svg>
          Clause Repository
          <span class="badge">847</span>
        </div>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">Workbenches</div>
        <div class="nav-item" onclick="showView(&#39;forecasting&#39;)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
          </svg>
          Get to Green
        </div>
        <div class="nav-item" onclick="showView(&#39;rfp&#39;)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
          RFP Analyzer
        </div>
        <div class="nav-item" onclick="showView(&#39;framework&#39;)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
            <path d="M2 17l10 5 10-5"></path>
            <path d="M2 12l10 5 10-5"></path>
          </svg>
          Framework Mapper
          <span class="badge">5</span>
        </div>
        <div class="nav-item" onclick="showView(&#39;attestations&#39;)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22,4 12,14.01 9,11.01"></polyline>
          </svg>
          Attestations
        </div>
        <div class="nav-item" onclick="showView(&#39;ingestion&#39;)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17,8 12,3 7,8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
          </svg>
          Framework Ingestion
          <span class="badge badge-new" style="background: var(--trust-teal); color: white;">AI</span>
        </div>
        <div class="nav-item" onclick="showView(&#39;nsxt&#39;)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
          </svg>
          NSX-T Integration
          <span class="badge badge-new active" style="background: var(--steel-blue); color: white;">VMware</span>
        </div>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">Reporting</div>
        <div class="nav-item" onclick="showView(&#39;reports&#39;)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14,2 14,8 20,8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
            <polyline points="10,9 9,9 8,9"></polyline>
          </svg>
          Reports
          <span class="badge badge-new" style="background: var(--brand); color: white;">New</span>
        </div>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">System</div>
        <div class="nav-item" onclick="showView(&#39;snapshots&#39;)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12,6 12,12 16,14"></polyline>
          </svg>
          Snapshots
          <span class="badge">847</span>
        </div>
        <div class="nav-item" onclick="showView(&#39;forensics&#39;)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <path d="M14 2v6h6"></path>
            <path d="M16 13H8"></path>
            <path d="M16 17H8"></path>
            <path d="M10 9H8"></path>
          </svg>
          Forensics
        </div>
      </div>

      <div class="operator-legend">
        <div class="operator-legend-title">ΦΨΔIPT Operators</div>
        <div class="operator-legend-item" onclick="showOperatorInfo(&#39;phi&#39;)" style="cursor: pointer;" title="Click to learn about Zero-Start operator">
          <div class="operator-glyph phi">Φ</div>
          <span>Zero-Start</span>
        </div>
        <div class="operator-legend-item" onclick="showOperatorInfo(&#39;psi&#39;)" style="cursor: pointer;" title="Click to learn about Credential-Decay operator">
          <div class="operator-glyph psi">Ψ</div>
          <span>Credential-Decay</span>
        </div>
        <div class="operator-legend-item" onclick="showOperatorInfo(&#39;delta&#39;)" style="cursor: pointer;" title="Click to learn about Divergence operator">
          <div class="operator-glyph delta">Δ</div>
          <span>Divergence</span>
        </div>
        <div class="operator-legend-item" onclick="showOperatorInfo(&#39;ip&#39;)" style="cursor: pointer;" title="Click to learn about Integrity Proof operator">
          <div class="operator-glyph ip">IP</div>
          <span>Integrity Proof</span>
        </div>
        <div class="operator-legend-item" onclick="showOperatorInfo(&#39;trust&#39;)" style="cursor: pointer;" title="Click to learn about Trust Composite operator">
          <div class="operator-glyph trust">T</div>
          <span>Trust Composite</span>
        </div>
      </div>

      <!-- User Profile & RBAC -->
      <div class="user-profile">
        <div class="user-profile-header">
          <div class="user-avatar">SC</div>
          <div class="user-info">
            <div class="user-name">Sarah Chen</div>
            <div class="user-role">Administrator</div>
          </div>
        </div>

        <div class="role-switcher-label">Role Simulator</div>

        <!-- Admin Role -->
        <div class="role-badge active">
          <div class="role-icon">👑</div>
          <span>Admin</span>
          <div class="role-permissions">
            <div class="role-permissions-title">Admin Permissions</div>
            <div class="permission-item granted">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20,6 9,17 4,12"></polyline>
              </svg>
              Full system access
            </div>
            <div class="permission-item granted">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20,6 9,17 4,12"></polyline>
              </svg>
              Manage users &amp; roles
            </div>
            <div class="permission-item granted">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20,6 9,17 4,12"></polyline>
              </svg>
              Edit controls &amp; evidence
            </div>
            <div class="permission-item granted">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20,6 9,17 4,12"></polyline>
              </svg>
              Generate all reports
            </div>
            <div class="permission-item granted">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20,6 9,17 4,12"></polyline>
              </svg>
              Modify attestations
            </div>
            <div class="permission-item granted">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20,6 9,17 4,12"></polyline>
              </svg>
              Access audit logs
            </div>
          </div>
        </div>

        <!-- CISO Role -->
        <div class="role-badge" onclick="simulateRoleSwitch(&#39;ciso&#39;)">
          <div class="role-icon">🛡️</div>
          <span>CISO</span>
          <div class="role-permissions">
            <div class="role-permissions-title">CISO Permissions</div>
            <div class="permission-item granted">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20,6 9,17 4,12"></polyline>
              </svg>
              View all controls
            </div>
            <div class="permission-item granted">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20,6 9,17 4,12"></polyline>
              </svg>
              Approve attestations
            </div>
            <div class="permission-item granted">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20,6 9,17 4,12"></polyline>
              </svg>
              Generate risk reports
            </div>
            <div class="permission-item granted">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20,6 9,17 4,12"></polyline>
              </svg>
              View audit trail
            </div>
            <div class="permission-item granted">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20,6 9,17 4,12"></polyline>
              </svg>
              Assign control owners
            </div>
            <div class="permission-item denied">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
              Modify system settings
            </div>
          </div>
        </div>

        <!-- Auditor Role -->
        <div class="role-badge" onclick="simulateRoleSwitch(&#39;auditor&#39;)">
          <div class="role-icon">📋</div>
          <span>Auditor</span>
          <div class="role-permissions">
            <div class="role-permissions-title">Auditor Permissions</div>
            <div class="permission-item granted">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20,6 9,17 4,12"></polyline>
              </svg>
              Read-only access
            </div>
            <div class="permission-item granted">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20,6 9,17 4,12"></polyline>
              </svg>
              View all evidence
            </div>
            <div class="permission-item granted">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20,6 9,17 4,12"></polyline>
              </svg>
              Generate audit reports
            </div>
            <div class="permission-item granted">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20,6 9,17 4,12"></polyline>
              </svg>
              Export snapshots
            </div>
            <div class="permission-item granted">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20,6 9,17 4,12"></polyline>
              </svg>
              Verify hashes
            </div>
            <div class="permission-item denied">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
              Edit any content
            </div>
            <div class="permission-item denied">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
              Approve attestations
            </div>
          </div>
        </div>

        <!-- Compliance Manager Role -->
        <div class="role-badge" onclick="simulateRoleSwitch(&#39;compliance&#39;)">
          <div class="role-icon">✓</div>
          <span>Compliance Mgr</span>
          <div class="role-permissions">
            <div class="role-permissions-title">Compliance Manager</div>
            <div class="permission-item granted">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20,6 9,17 4,12"></polyline>
              </svg>
              Edit controls
            </div>
            <div class="permission-item granted">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20,6 9,17 4,12"></polyline>
              </svg>
              Upload evidence
            </div>
            <div class="permission-item granted">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20,6 9,17 4,12"></polyline>
              </svg>
              Submit attestations
            </div>
            <div class="permission-item granted">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20,6 9,17 4,12"></polyline>
              </svg>
              Generate compliance reports
            </div>
            <div class="permission-item granted">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20,6 9,17 4,12"></polyline>
              </svg>
              Use Get to Green
            </div>
            <div class="permission-item denied">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
              Delete evidence
            </div>
            <div class="permission-item denied">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
              Manage users
            </div>
          </div>
        </div>

        <!-- Analyst Role -->
        <div class="role-badge" onclick="simulateRoleSwitch(&#39;analyst&#39;)">
          <div class="role-icon">📊</div>
          <span>Analyst</span>
          <div class="role-permissions">
            <div class="role-permissions-title">Analyst Permissions</div>
            <div class="permission-item granted">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20,6 9,17 4,12"></polyline>
              </svg>
              View controls &amp; evidence
            </div>
            <div class="permission-item granted">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20,6 9,17 4,12"></polyline>
              </svg>
              Generate standard reports
            </div>
            <div class="permission-item granted">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20,6 9,17 4,12"></polyline>
              </svg>
              Export data (CSV/XLSX)
            </div>
            <div class="permission-item granted">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20,6 9,17 4,12"></polyline>
              </svg>
              Use RFP Analyzer
            </div>
            <div class="permission-item denied">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
              Edit controls
            </div>
            <div class="permission-item denied">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
              Upload evidence
            </div>
            <div class="permission-item denied">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
              Approve anything
            </div>
          </div>
        </div>

        <!-- Viewer Role -->
        <div class="role-badge" onclick="simulateRoleSwitch(&#39;viewer&#39;)">
          <div class="role-icon">👁️</div>
          <span>Viewer</span>
          <div class="role-permissions">
            <div class="role-permissions-title">Viewer Permissions</div>
            <div class="permission-item granted">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20,6 9,17 4,12"></polyline>
              </svg>
              View dashboard only
            </div>
            <div class="permission-item granted">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20,6 9,17 4,12"></polyline>
              </svg>
              See public reports
            </div>
            <div class="permission-item denied">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
              View control details
            </div>
            <div class="permission-item denied">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
              View evidence
            </div>
            <div class="permission-item denied">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
              Generate reports
            </div>
            <div class="permission-item denied">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
              </svg>
              Edit anything
            </div>
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="main" id="mainContent">
    <div class="view active">
      
    <div style="padding: 12px 20px; background: linear-gradient(135deg, var(--amber-light) 0%, var(--brand-light) 100%); border-bottom: 2px solid var(--amber); display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 24px;">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--amber)" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="12"></line>
        <line x1="12" y1="16" x2="12.01" y2="16"></line>
      </svg>
      <div>
        <div style="font-size: 13px; font-weight: 700; color: var(--amber); margin-bottom: 2px;">🎭 INTERACTIVE DEMO — SIMULATION MODE</div>
        <div style="font-size: 11px; color: var(--text-secondary);">Simulated data for demonstration purposes. Not connected to production systems.</div>
      </div>
    </div>
  
      
      <div class="page-header">
        <h1 class="page-title">Clause Repository <span style="font-size: 14px; color: var(--text-tertiary); font-weight: 400; margin-left: 12px;">Universal Framework Library</span></h1>
        <p class="page-subtitle">Semantic clause index powering atomic cross-framework propagation</p>
        <button class="btn btn-primary" onclick="importFrameworkClauses()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
          </svg>
          Import Clauses
        </button>
      </div>
      
      <!-- Stats Row -->
      <div class="grid-4 mb-32">
        <div class="stat-card">
          <div class="stat-label">Total Clauses</div>
          <div class="stat-value">15</div>
          <div class="stat-change neutral">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
              <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
            </svg>
            Across 4 frameworks
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-label">Semantic Concepts</div>
          <div class="stat-value">5</div>
          <div class="stat-change positive">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <circle cx="12" cy="12" r="6"></circle>
              <circle cx="12" cy="12" r="2"></circle>
            </svg>
            Categories indexed
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-label">Equivalence Links</div>
          <div class="stat-value">50</div>
          <div class="stat-change positive">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 3a2.83 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
            </svg>
            Cross-framework
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-label">Avg Ψ Freshness</div>
          <div class="stat-value" style="color: var(--trust-teal);">0.89</div>
          <div class="stat-change neutral">
            <div class="operator-glyph psi" style="width: 14px; height: 14px; font-size: 9px; margin-right: 4px;">Ψ</div>
            Moderate
          </div>
        </div>
      </div>
      
      <!-- Search & Filter Bar -->
      <div class="card mb-24">
        <div class="card-body">
          <div style="display: flex; gap: 12px; align-items: center;">
            <div style="flex: 1; position: relative;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--text-tertiary)" stroke-width="2" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%);">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
              </svg>
              <input type="text" id="clauseSearch" placeholder="Search clauses by ID, title, requirement, or semantic concept..." style="width: 100%; padding: 12px 12px 12px 40px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px; font-family: &#39;Inter&#39;, sans-serif;" oninput="filterClauses(this.value)">
            </div>
            <select id="frameworkFilter" style="padding: 12px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px; font-family: &#39;Inter&#39;, sans-serif; background: white;" onchange="filterClausesByFramework(this.value)">
              <option value="all">All Frameworks</option>
              <option value="SOC2">SOC2</option>
              <option value="ISO27001">ISO27001</option>
              <option value="NIST">NIST</option>
              <option value="HIPAA">HIPAA</option>
            </select>
            <select id="categoryFilter" style="padding: 12px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px; font-family: &#39;Inter&#39;, sans-serif; background: white;" onchange="filterClausesByCategory(this.value)">
              <option value="all">All Categories</option>
              <option value="Access Control">Access Control</option>
              <option value="Encryption">Encryption</option>
              <option value="Incident Response">Incident Response</option>
              <option value="Business Continuity">Business Continuity</option>
              <option value="Vendor Management">Vendor Management</option>
            </select>
          </div>
        </div>
      </div>
      
      <!-- Clause List -->
      <div class="card">
        <div class="card-header">
          <span class="card-title">Framework Clauses (15)</span>
          <span style="font-size: 12px; color: var(--text-tertiary); font-family: &#39;IBM Plex Mono&#39;, monospace;">Semantic Index with Ψ Decay</span>
        </div>
        <div class="card-body" id="clauseList" style="padding: 0;">
          
            <div class="clause-item" data-framework="SOC2" data-category="Access Control" style="padding: 24px; border-bottom: 1px solid var(--border-light); transition: 0.2s; cursor: pointer; background: white;" onclick="showClauseDetail(&#39;SOC2-CC6.1&#39;)" onmouseover="this.style.background=&#39;var(--bg-secondary)&#39;" onmouseout="this.style.background=&#39;white&#39;">
              <div style="display: flex; align-items: start; gap: 20px;">
                <!-- Main Content -->
                <div style="flex: 1;">
                  <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                    <div style="font-weight: 700; font-size: 16px; font-family: &#39;IBM Plex Mono&#39;, monospace;">SOC2-CC6.1</div>
                    <span style="padding: 4px 10px; background: var(--trust-teal-light); color: var(--trust-teal); border-radius: 6px; font-size: 11px; font-weight: 700;">🔵 GOOD</span>
                    <span style="padding: 4px 10px; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-weight: 700; color: var(--text-secondary);">
                      Access Control
                    </span>
                  </div>
                  
                  <div style="font-size: 15px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">
                    Logical and Physical Access Controls
                  </div>
                  
                  <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px; line-height: 1.6;">
                    The entity implements logical access security software, infrastructure, and architectures over protected information assets to protect them from security events to meet the entity's objectives.
                  </div>
                  
                  <div style="display: flex; gap: 16px; margin-bottom: 12px; font-size: 12px; color: var(--text-tertiary);">
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                      </svg>
                      SOC 2 Type II
                    </span>
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                      </svg>
                      Maps to UCP-001
                    </span>
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 3a2.83 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                      </svg>
                      4 equivalents
                    </span>
                  </div>
                  
                  <!-- Operator Scores -->
                  <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 12px;">
                    <div style="padding: 10px; background: var(--bg-secondary); border-radius: 8px;">
                      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <div class="operator-glyph phi" style="width: 18px; height: 18px; font-size: 10px;">Φ</div>
                        <span style="font-size: 11px; font-weight: 700; color: var(--text-tertiary);">ZERO-START</span>
                      </div>
                      <div style="font-size: 18px; font-weight: 700; font-family: &#39;IBM Plex Mono&#39;, monospace;">0.95</div>
                    </div>
                    <div style="padding: 10px; background: var(--bg-secondary); border-radius: 8px; border-left: 3px solid var(--green);">
                      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <div class="operator-glyph psi" style="width: 18px; height: 18px; font-size: 10px;">Ψ</div>
                        <span style="font-size: 11px; font-weight: 700; color: var(--text-tertiary);">CREDENTIAL-DECAY</span>
                      </div>
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="font-size: 18px; font-weight: 700; font-family: &#39;IBM Plex Mono&#39;, monospace; color: var(--green);">0.96</div>
                        <div style="font-size: 11px; color: var(--text-secondary);">(14d old)</div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Semantic Equivalents Preview -->
                  
                    <div style="padding: 12px; background: var(--brand-light); border-radius: 8px;">
                      <div style="font-size: 11px; font-weight: 700; color: var(--brand); margin-bottom: 6px;">🔍 SEMANTIC EQUIVALENTS</div>
                      <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        
                          <span style="padding: 4px 8px; background: white; border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-family: &#39;IBM Plex Mono&#39;, monospace;">
                            ISO27001-A.9.2 <span style="color: var(--brand);">(97%)</span>
                          </span>
                        
                          <span style="padding: 4px 8px; background: white; border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-family: &#39;IBM Plex Mono&#39;, monospace;">
                            NIST-AC-2 <span style="color: var(--brand);">(96%)</span>
                          </span>
                        
                          <span style="padding: 4px 8px; background: white; border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-family: &#39;IBM Plex Mono&#39;, monospace;">
                            HIPAA-164.308(a)(3) <span style="color: var(--brand);">(94%)</span>
                          </span>
                        
                        
                      </div>
                    </div>
                  
                  
                  <!-- Usage Stats -->
                  <div style="display: flex; gap: 12px; margin-top: 12px; font-size: 11px; color: var(--text-secondary);">
                    <span>📋 Used in 3 RFPs</span>
                    <span>✓ 12 attestations</span>
                    <span>🛡️ 1 control</span>
                  </div>
                </div>
                
                <!-- Actions -->
                <div style="display: flex; flex-direction: column; gap: 8px;">
                  <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); findSemanticMatches(&#39;SOC2-CC6.1&#39;)" style="white-space: nowrap;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                      <circle cx="11" cy="11" r="8"></circle>
                      <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    Find Similar
                  </button>
                  <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); viewEquivalenceGraph(&#39;SOC2-CC6.1&#39;)" style="white-space: nowrap;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                      <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                      <path d="M2 17l10 5 10-5"></path>
                    </svg>
                    View Graph
                  </button>
                </div>
              </div>
            </div>
          
            <div class="clause-item" data-framework="ISO27001" data-category="Access Control" style="padding: 24px; border-bottom: 1px solid var(--border-light); transition: 0.2s; cursor: pointer; background: white;" onclick="showClauseDetail(&#39;ISO27001-A.9.2&#39;)" onmouseover="this.style.background=&#39;var(--bg-secondary)&#39;" onmouseout="this.style.background=&#39;white&#39;">
              <div style="display: flex; align-items: start; gap: 20px;">
                <!-- Main Content -->
                <div style="flex: 1;">
                  <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                    <div style="font-weight: 700; font-size: 16px; font-family: &#39;IBM Plex Mono&#39;, monospace;">ISO27001-A.9.2</div>
                    <span style="padding: 4px 10px; background: var(--red-light); color: var(--red); border-radius: 6px; font-size: 11px; font-weight: 700;">🔴 STALE</span>
                    <span style="padding: 4px 10px; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-weight: 700; color: var(--text-secondary);">
                      Access Control
                    </span>
                  </div>
                  
                  <div style="font-size: 15px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">
                    User Access Management
                  </div>
                  
                  <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px; line-height: 1.6;">
                    A formal user access provisioning process shall be implemented to assign or revoke access rights for all user types to all systems and services.
                  </div>
                  
                  <div style="display: flex; gap: 16px; margin-bottom: 12px; font-size: 12px; color: var(--text-tertiary);">
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                      </svg>
                      ISO 27001:2022
                    </span>
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                      </svg>
                      Maps to UCP-001
                    </span>
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 3a2.83 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                      </svg>
                      4 equivalents
                    </span>
                  </div>
                  
                  <!-- Operator Scores -->
                  <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 12px;">
                    <div style="padding: 10px; background: var(--bg-secondary); border-radius: 8px;">
                      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <div class="operator-glyph phi" style="width: 18px; height: 18px; font-size: 10px;">Φ</div>
                        <span style="font-size: 11px; font-weight: 700; color: var(--text-tertiary);">ZERO-START</span>
                      </div>
                      <div style="font-size: 18px; font-weight: 700; font-family: &#39;IBM Plex Mono&#39;, monospace;">0.95</div>
                    </div>
                    <div style="padding: 10px; background: var(--bg-secondary); border-radius: 8px; border-left: 3px solid var(--trust-teal);">
                      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <div class="operator-glyph psi" style="width: 18px; height: 18px; font-size: 10px;">Ψ</div>
                        <span style="font-size: 11px; font-weight: 700; color: var(--text-tertiary);">CREDENTIAL-DECAY</span>
                      </div>
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="font-size: 18px; font-weight: 700; font-family: &#39;IBM Plex Mono&#39;, monospace; color: var(--trust-teal);">0.82</div>
                        <div style="font-size: 11px; color: var(--text-secondary);">(70d old)</div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Semantic Equivalents Preview -->
                  
                    <div style="padding: 12px; background: var(--brand-light); border-radius: 8px;">
                      <div style="font-size: 11px; font-weight: 700; color: var(--brand); margin-bottom: 6px;">🔍 SEMANTIC EQUIVALENTS</div>
                      <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        
                          <span style="padding: 4px 8px; background: white; border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-family: &#39;IBM Plex Mono&#39;, monospace;">
                            SOC2-CC6.1 <span style="color: var(--brand);">(97%)</span>
                          </span>
                        
                          <span style="padding: 4px 8px; background: white; border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-family: &#39;IBM Plex Mono&#39;, monospace;">
                            NIST-AC-2 <span style="color: var(--brand);">(98%)</span>
                          </span>
                        
                          <span style="padding: 4px 8px; background: white; border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-family: &#39;IBM Plex Mono&#39;, monospace;">
                            FEDRAMP-AC-2 <span style="color: var(--brand);">(98%)</span>
                          </span>
                        
                        
                      </div>
                    </div>
                  
                  
                  <!-- Usage Stats -->
                  <div style="display: flex; gap: 12px; margin-top: 12px; font-size: 11px; color: var(--text-secondary);">
                    <span>📋 Used in 4 RFPs</span>
                    <span>✓ 8 attestations</span>
                    <span>🛡️ 1 control</span>
                  </div>
                </div>
                
                <!-- Actions -->
                <div style="display: flex; flex-direction: column; gap: 8px;">
                  <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); findSemanticMatches(&#39;ISO27001-A.9.2&#39;)" style="white-space: nowrap;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                      <circle cx="11" cy="11" r="8"></circle>
                      <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    Find Similar
                  </button>
                  <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); viewEquivalenceGraph(&#39;ISO27001-A.9.2&#39;)" style="white-space: nowrap;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                      <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                      <path d="M2 17l10 5 10-5"></path>
                    </svg>
                    View Graph
                  </button>
                </div>
              </div>
            </div>
          
            <div class="clause-item" data-framework="NIST" data-category="Access Control" style="padding: 24px; border-bottom: 1px solid var(--border-light); transition: 0.2s; cursor: pointer; background: white;" onclick="showClauseDetail(&#39;NIST-AC-2&#39;)" onmouseover="this.style.background=&#39;var(--bg-secondary)&#39;" onmouseout="this.style.background=&#39;white&#39;">
              <div style="display: flex; align-items: start; gap: 20px;">
                <!-- Main Content -->
                <div style="flex: 1;">
                  <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                    <div style="font-weight: 700; font-size: 16px; font-family: &#39;IBM Plex Mono&#39;, monospace;">NIST-AC-2</div>
                    <span style="padding: 4px 10px; background: var(--amber-light); color: var(--amber); border-radius: 6px; font-size: 11px; font-weight: 700;">🟡 AGING</span>
                    <span style="padding: 4px 10px; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-weight: 700; color: var(--text-secondary);">
                      Access Control
                    </span>
                  </div>
                  
                  <div style="font-size: 15px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">
                    Account Management
                  </div>
                  
                  <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px; line-height: 1.6;">
                    The organization manages system accounts, including establishing, activating, modifying, reviewing, disabling, and removing accounts.
                  </div>
                  
                  <div style="display: flex; gap: 16px; margin-bottom: 12px; font-size: 12px; color: var(--text-tertiary);">
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                      </svg>
                      NIST 800-53 Rev 5
                    </span>
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                      </svg>
                      Maps to UCP-001
                    </span>
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 3a2.83 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                      </svg>
                      4 equivalents
                    </span>
                  </div>
                  
                  <!-- Operator Scores -->
                  <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 12px;">
                    <div style="padding: 10px; background: var(--bg-secondary); border-radius: 8px;">
                      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <div class="operator-glyph phi" style="width: 18px; height: 18px; font-size: 10px;">Φ</div>
                        <span style="font-size: 11px; font-weight: 700; color: var(--text-tertiary);">ZERO-START</span>
                      </div>
                      <div style="font-size: 18px; font-weight: 700; font-family: &#39;IBM Plex Mono&#39;, monospace;">0.95</div>
                    </div>
                    <div style="padding: 10px; background: var(--bg-secondary); border-radius: 8px; border-left: 3px solid var(--trust-teal);">
                      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <div class="operator-glyph psi" style="width: 18px; height: 18px; font-size: 10px;">Ψ</div>
                        <span style="font-size: 11px; font-weight: 700; color: var(--text-tertiary);">CREDENTIAL-DECAY</span>
                      </div>
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="font-size: 18px; font-weight: 700; font-family: &#39;IBM Plex Mono&#39;, monospace; color: var(--trust-teal);">0.88</div>
                        <div style="font-size: 11px; color: var(--text-secondary);">(48d old)</div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Semantic Equivalents Preview -->
                  
                    <div style="padding: 12px; background: var(--brand-light); border-radius: 8px;">
                      <div style="font-size: 11px; font-weight: 700; color: var(--brand); margin-bottom: 6px;">🔍 SEMANTIC EQUIVALENTS</div>
                      <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        
                          <span style="padding: 4px 8px; background: white; border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-family: &#39;IBM Plex Mono&#39;, monospace;">
                            ISO27001-A.9.2 <span style="color: var(--brand);">(98%)</span>
                          </span>
                        
                          <span style="padding: 4px 8px; background: white; border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-family: &#39;IBM Plex Mono&#39;, monospace;">
                            FEDRAMP-AC-2 <span style="color: var(--brand);">(100%)</span>
                          </span>
                        
                          <span style="padding: 4px 8px; background: white; border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-family: &#39;IBM Plex Mono&#39;, monospace;">
                            SOC2-CC6.1 <span style="color: var(--brand);">(96%)</span>
                          </span>
                        
                        
                      </div>
                    </div>
                  
                  
                  <!-- Usage Stats -->
                  <div style="display: flex; gap: 12px; margin-top: 12px; font-size: 11px; color: var(--text-secondary);">
                    <span>📋 Used in 5 RFPs</span>
                    <span>✓ 15 attestations</span>
                    <span>🛡️ 1 control</span>
                  </div>
                </div>
                
                <!-- Actions -->
                <div style="display: flex; flex-direction: column; gap: 8px;">
                  <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); findSemanticMatches(&#39;NIST-AC-2&#39;)" style="white-space: nowrap;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                      <circle cx="11" cy="11" r="8"></circle>
                      <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    Find Similar
                  </button>
                  <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); viewEquivalenceGraph(&#39;NIST-AC-2&#39;)" style="white-space: nowrap;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                      <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                      <path d="M2 17l10 5 10-5"></path>
                    </svg>
                    View Graph
                  </button>
                </div>
              </div>
            </div>
          
            <div class="clause-item" data-framework="HIPAA" data-category="Access Control" style="padding: 24px; border-bottom: 1px solid var(--border-light); transition: 0.2s; cursor: pointer; background: white;" onclick="showClauseDetail(&#39;HIPAA-164.308(a)(3)&#39;)" onmouseover="this.style.background=&#39;var(--bg-secondary)&#39;" onmouseout="this.style.background=&#39;white&#39;">
              <div style="display: flex; align-items: start; gap: 20px;">
                <!-- Main Content -->
                <div style="flex: 1;">
                  <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                    <div style="font-weight: 700; font-size: 16px; font-family: &#39;IBM Plex Mono&#39;, monospace;">HIPAA-164.308(a)(3)</div>
                    <span style="padding: 4px 10px; background: var(--green-light); color: var(--green); border-radius: 6px; font-size: 11px; font-weight: 700;">🟢 FRESH</span>
                    <span style="padding: 4px 10px; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-weight: 700; color: var(--text-secondary);">
                      Access Control
                    </span>
                  </div>
                  
                  <div style="font-size: 15px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">
                    Workforce Security
                  </div>
                  
                  <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px; line-height: 1.6;">
                    Implement policies and procedures to ensure that all members of its workforce have appropriate access to electronic protected health information.
                  </div>
                  
                  <div style="display: flex; gap: 16px; margin-bottom: 12px; font-size: 12px; color: var(--text-tertiary);">
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                      </svg>
                      HIPAA Security Rule
                    </span>
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                      </svg>
                      Maps to UCP-001
                    </span>
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 3a2.83 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                      </svg>
                      4 equivalents
                    </span>
                  </div>
                  
                  <!-- Operator Scores -->
                  <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 12px;">
                    <div style="padding: 10px; background: var(--bg-secondary); border-radius: 8px;">
                      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <div class="operator-glyph phi" style="width: 18px; height: 18px; font-size: 10px;">Φ</div>
                        <span style="font-size: 11px; font-weight: 700; color: var(--text-tertiary);">ZERO-START</span>
                      </div>
                      <div style="font-size: 18px; font-weight: 700; font-family: &#39;IBM Plex Mono&#39;, monospace;">0.95</div>
                    </div>
                    <div style="padding: 10px; background: var(--bg-secondary); border-radius: 8px; border-left: 3px solid var(--green);">
                      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <div class="operator-glyph psi" style="width: 18px; height: 18px; font-size: 10px;">Ψ</div>
                        <span style="font-size: 11px; font-weight: 700; color: var(--text-tertiary);">CREDENTIAL-DECAY</span>
                      </div>
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="font-size: 18px; font-weight: 700; font-family: &#39;IBM Plex Mono&#39;, monospace; color: var(--green);">0.99</div>
                        <div style="font-size: 11px; color: var(--text-secondary);">(1d old)</div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Semantic Equivalents Preview -->
                  
                    <div style="padding: 12px; background: var(--brand-light); border-radius: 8px;">
                      <div style="font-size: 11px; font-weight: 700; color: var(--brand); margin-bottom: 6px;">🔍 SEMANTIC EQUIVALENTS</div>
                      <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        
                          <span style="padding: 4px 8px; background: white; border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-family: &#39;IBM Plex Mono&#39;, monospace;">
                            SOC2-CC6.1 <span style="color: var(--brand);">(94%)</span>
                          </span>
                        
                          <span style="padding: 4px 8px; background: white; border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-family: &#39;IBM Plex Mono&#39;, monospace;">
                            NIST-AC-2 <span style="color: var(--brand);">(95%)</span>
                          </span>
                        
                          <span style="padding: 4px 8px; background: white; border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-family: &#39;IBM Plex Mono&#39;, monospace;">
                            ISO27001-A.9.2 <span style="color: var(--brand);">(93%)</span>
                          </span>
                        
                        
                      </div>
                    </div>
                  
                  
                  <!-- Usage Stats -->
                  <div style="display: flex; gap: 12px; margin-top: 12px; font-size: 11px; color: var(--text-secondary);">
                    <span>📋 Used in 2 RFPs</span>
                    <span>✓ 6 attestations</span>
                    <span>🛡️ 1 control</span>
                  </div>
                </div>
                
                <!-- Actions -->
                <div style="display: flex; flex-direction: column; gap: 8px;">
                  <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); findSemanticMatches(&#39;HIPAA-164.308(a)(3)&#39;)" style="white-space: nowrap;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                      <circle cx="11" cy="11" r="8"></circle>
                      <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    Find Similar
                  </button>
                  <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); viewEquivalenceGraph(&#39;HIPAA-164.308(a)(3)&#39;)" style="white-space: nowrap;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                      <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                      <path d="M2 17l10 5 10-5"></path>
                    </svg>
                    View Graph
                  </button>
                </div>
              </div>
            </div>
          
            <div class="clause-item" data-framework="SOC2" data-category="Encryption" style="padding: 24px; border-bottom: 1px solid var(--border-light); transition: all 0.2s ease; cursor: pointer;" onclick="showClauseDetail(&#39;SOC2-CC6.6&#39;)" onmouseover="this.style.background=&#39;var(--bg-secondary)&#39;" onmouseout="this.style.background=&#39;white&#39;">
              <div style="display: flex; align-items: start; gap: 20px;">
                <!-- Main Content -->
                <div style="flex: 1;">
                  <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                    <div style="font-weight: 700; font-size: 16px; font-family: &#39;IBM Plex Mono&#39;, monospace;">SOC2-CC6.6</div>
                    <span style="padding: 4px 10px; background: var(--trust-teal-light); color: var(--trust-teal); border-radius: 6px; font-size: 11px; font-weight: 700;">🔵 GOOD</span>
                    <span style="padding: 4px 10px; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-weight: 700; color: var(--text-secondary);">
                      Encryption
                    </span>
                  </div>
                  
                  <div style="font-size: 15px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">
                    Encryption of Data in Transit
                  </div>
                  
                  <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px; line-height: 1.6;">
                    The entity uses encryption to protect data during transmission over open or public networks to meet the entity's objectives.
                  </div>
                  
                  <div style="display: flex; gap: 16px; margin-bottom: 12px; font-size: 12px; color: var(--text-tertiary);">
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                      </svg>
                      SOC 2 Type II
                    </span>
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                      </svg>
                      Maps to UCP-002
                    </span>
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 3a2.83 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                      </svg>
                      4 equivalents
                    </span>
                  </div>
                  
                  <!-- Operator Scores -->
                  <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 12px;">
                    <div style="padding: 10px; background: var(--bg-secondary); border-radius: 8px;">
                      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <div class="operator-glyph phi" style="width: 18px; height: 18px; font-size: 10px;">Φ</div>
                        <span style="font-size: 11px; font-weight: 700; color: var(--text-tertiary);">ZERO-START</span>
                      </div>
                      <div style="font-size: 18px; font-weight: 700; font-family: &#39;IBM Plex Mono&#39;, monospace;">0.88</div>
                    </div>
                    <div style="padding: 10px; background: var(--bg-secondary); border-radius: 8px; border-left: 3px solid var(--green);">
                      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <div class="operator-glyph psi" style="width: 18px; height: 18px; font-size: 10px;">Ψ</div>
                        <span style="font-size: 11px; font-weight: 700; color: var(--text-tertiary);">CREDENTIAL-DECAY</span>
                      </div>
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="font-size: 18px; font-weight: 700; font-family: &#39;IBM Plex Mono&#39;, monospace; color: var(--green);">0.96</div>
                        <div style="font-size: 11px; color: var(--text-secondary);">(14d old)</div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Semantic Equivalents Preview -->
                  
                    <div style="padding: 12px; background: var(--brand-light); border-radius: 8px;">
                      <div style="font-size: 11px; font-weight: 700; color: var(--brand); margin-bottom: 6px;">🔍 SEMANTIC EQUIVALENTS</div>
                      <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        
                          <span style="padding: 4px 8px; background: white; border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-family: &#39;IBM Plex Mono&#39;, monospace;">
                            ISO27001-A.10.1 <span style="color: var(--brand);">(95%)</span>
                          </span>
                        
                          <span style="padding: 4px 8px; background: white; border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-family: &#39;IBM Plex Mono&#39;, monospace;">
                            NIST-SC-13 <span style="color: var(--brand);">(93%)</span>
                          </span>
                        
                          <span style="padding: 4px 8px; background: white; border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-family: &#39;IBM Plex Mono&#39;, monospace;">
                            HIPAA-164.312(a)(2)(iv) <span style="color: var(--brand);">(96%)</span>
                          </span>
                        
                        
                      </div>
                    </div>
                  
                  
                  <!-- Usage Stats -->
                  <div style="display: flex; gap: 12px; margin-top: 12px; font-size: 11px; color: var(--text-secondary);">
                    <span>📋 Used in 4 RFPs</span>
                    <span>✓ 10 attestations</span>
                    <span>🛡️ 1 control</span>
                  </div>
                </div>
                
                <!-- Actions -->
                <div style="display: flex; flex-direction: column; gap: 8px;">
                  <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); findSemanticMatches(&#39;SOC2-CC6.6&#39;)" style="white-space: nowrap;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                      <circle cx="11" cy="11" r="8"></circle>
                      <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    Find Similar
                  </button>
                  <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); viewEquivalenceGraph(&#39;SOC2-CC6.6&#39;)" style="white-space: nowrap;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                      <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                      <path d="M2 17l10 5 10-5"></path>
                    </svg>
                    View Graph
                  </button>
                </div>
              </div>
            </div>
          
            <div class="clause-item" data-framework="ISO27001" data-category="Encryption" style="padding: 24px; border-bottom: 1px solid var(--border-light); transition: 0.2s; cursor: pointer; background: white;" onclick="showClauseDetail(&#39;ISO27001-A.10.1&#39;)" onmouseover="this.style.background=&#39;var(--bg-secondary)&#39;" onmouseout="this.style.background=&#39;white&#39;">
              <div style="display: flex; align-items: start; gap: 20px;">
                <!-- Main Content -->
                <div style="flex: 1;">
                  <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                    <div style="font-weight: 700; font-size: 16px; font-family: &#39;IBM Plex Mono&#39;, monospace;">ISO27001-A.10.1</div>
                    <span style="padding: 4px 10px; background: var(--red-light); color: var(--red); border-radius: 6px; font-size: 11px; font-weight: 700;">🔴 STALE</span>
                    <span style="padding: 4px 10px; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-weight: 700; color: var(--text-secondary);">
                      Encryption
                    </span>
                  </div>
                  
                  <div style="font-size: 15px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">
                    Cryptographic Controls
                  </div>
                  
                  <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px; line-height: 1.6;">
                    A policy on the use of cryptographic controls for protection of information shall be developed and implemented.
                  </div>
                  
                  <div style="display: flex; gap: 16px; margin-bottom: 12px; font-size: 12px; color: var(--text-tertiary);">
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                      </svg>
                      ISO 27001:2022
                    </span>
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                      </svg>
                      Maps to UCP-002
                    </span>
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 3a2.83 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                      </svg>
                      4 equivalents
                    </span>
                  </div>
                  
                  <!-- Operator Scores -->
                  <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 12px;">
                    <div style="padding: 10px; background: var(--bg-secondary); border-radius: 8px;">
                      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <div class="operator-glyph phi" style="width: 18px; height: 18px; font-size: 10px;">Φ</div>
                        <span style="font-size: 11px; font-weight: 700; color: var(--text-tertiary);">ZERO-START</span>
                      </div>
                      <div style="font-size: 18px; font-weight: 700; font-family: &#39;IBM Plex Mono&#39;, monospace;">0.88</div>
                    </div>
                    <div style="padding: 10px; background: var(--bg-secondary); border-radius: 8px; border-left: 3px solid var(--trust-teal);">
                      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <div class="operator-glyph psi" style="width: 18px; height: 18px; font-size: 10px;">Ψ</div>
                        <span style="font-size: 11px; font-weight: 700; color: var(--text-tertiary);">CREDENTIAL-DECAY</span>
                      </div>
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="font-size: 18px; font-weight: 700; font-family: &#39;IBM Plex Mono&#39;, monospace; color: var(--trust-teal);">0.82</div>
                        <div style="font-size: 11px; color: var(--text-secondary);">(70d old)</div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Semantic Equivalents Preview -->
                  
                    <div style="padding: 12px; background: var(--brand-light); border-radius: 8px;">
                      <div style="font-size: 11px; font-weight: 700; color: var(--brand); margin-bottom: 6px;">🔍 SEMANTIC EQUIVALENTS</div>
                      <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        
                          <span style="padding: 4px 8px; background: white; border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-family: &#39;IBM Plex Mono&#39;, monospace;">
                            NIST-SC-13 <span style="color: var(--brand);">(97%)</span>
                          </span>
                        
                          <span style="padding: 4px 8px; background: white; border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-family: &#39;IBM Plex Mono&#39;, monospace;">
                            SOC2-CC6.6 <span style="color: var(--brand);">(95%)</span>
                          </span>
                        
                          <span style="padding: 4px 8px; background: white; border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-family: &#39;IBM Plex Mono&#39;, monospace;">
                            HIPAA-164.312(a)(2)(iv) <span style="color: var(--brand);">(94%)</span>
                          </span>
                        
                        
                      </div>
                    </div>
                  
                  
                  <!-- Usage Stats -->
                  <div style="display: flex; gap: 12px; margin-top: 12px; font-size: 11px; color: var(--text-secondary);">
                    <span>📋 Used in 3 RFPs</span>
                    <span>✓ 7 attestations</span>
                    <span>🛡️ 1 control</span>
                  </div>
                </div>
                
                <!-- Actions -->
                <div style="display: flex; flex-direction: column; gap: 8px;">
                  <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); findSemanticMatches(&#39;ISO27001-A.10.1&#39;)" style="white-space: nowrap;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                      <circle cx="11" cy="11" r="8"></circle>
                      <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    Find Similar
                  </button>
                  <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); viewEquivalenceGraph(&#39;ISO27001-A.10.1&#39;)" style="white-space: nowrap;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                      <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                      <path d="M2 17l10 5 10-5"></path>
                    </svg>
                    View Graph
                  </button>
                </div>
              </div>
            </div>
          
            <div class="clause-item" data-framework="NIST" data-category="Encryption" style="padding: 24px; border-bottom: 1px solid var(--border-light); transition: 0.2s; cursor: pointer; background: white;" onclick="showClauseDetail(&#39;NIST-SC-13&#39;)" onmouseover="this.style.background=&#39;var(--bg-secondary)&#39;" onmouseout="this.style.background=&#39;white&#39;">
              <div style="display: flex; align-items: start; gap: 20px;">
                <!-- Main Content -->
                <div style="flex: 1;">
                  <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                    <div style="font-weight: 700; font-size: 16px; font-family: &#39;IBM Plex Mono&#39;, monospace;">NIST-SC-13</div>
                    <span style="padding: 4px 10px; background: var(--amber-light); color: var(--amber); border-radius: 6px; font-size: 11px; font-weight: 700;">🟡 AGING</span>
                    <span style="padding: 4px 10px; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-weight: 700; color: var(--text-secondary);">
                      Encryption
                    </span>
                  </div>
                  
                  <div style="font-size: 15px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">
                    Cryptographic Protection
                  </div>
                  
                  <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px; line-height: 1.6;">
                    The information system implements FIPS 140-2 validated cryptography to protect the confidentiality and integrity of transmitted and stored information.
                  </div>
                  
                  <div style="display: flex; gap: 16px; margin-bottom: 12px; font-size: 12px; color: var(--text-tertiary);">
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                      </svg>
                      NIST 800-53 Rev 5
                    </span>
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                      </svg>
                      Maps to UCP-002
                    </span>
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 3a2.83 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                      </svg>
                      4 equivalents
                    </span>
                  </div>
                  
                  <!-- Operator Scores -->
                  <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 12px;">
                    <div style="padding: 10px; background: var(--bg-secondary); border-radius: 8px;">
                      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <div class="operator-glyph phi" style="width: 18px; height: 18px; font-size: 10px;">Φ</div>
                        <span style="font-size: 11px; font-weight: 700; color: var(--text-tertiary);">ZERO-START</span>
                      </div>
                      <div style="font-size: 18px; font-weight: 700; font-family: &#39;IBM Plex Mono&#39;, monospace;">0.88</div>
                    </div>
                    <div style="padding: 10px; background: var(--bg-secondary); border-radius: 8px; border-left: 3px solid var(--trust-teal);">
                      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <div class="operator-glyph psi" style="width: 18px; height: 18px; font-size: 10px;">Ψ</div>
                        <span style="font-size: 11px; font-weight: 700; color: var(--text-tertiary);">CREDENTIAL-DECAY</span>
                      </div>
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="font-size: 18px; font-weight: 700; font-family: &#39;IBM Plex Mono&#39;, monospace; color: var(--trust-teal);">0.88</div>
                        <div style="font-size: 11px; color: var(--text-secondary);">(48d old)</div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Semantic Equivalents Preview -->
                  
                    <div style="padding: 12px; background: var(--brand-light); border-radius: 8px;">
                      <div style="font-size: 11px; font-weight: 700; color: var(--brand); margin-bottom: 6px;">🔍 SEMANTIC EQUIVALENTS</div>
                      <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        
                          <span style="padding: 4px 8px; background: white; border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-family: &#39;IBM Plex Mono&#39;, monospace;">
                            ISO27001-A.10.1 <span style="color: var(--brand);">(97%)</span>
                          </span>
                        
                          <span style="padding: 4px 8px; background: white; border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-family: &#39;IBM Plex Mono&#39;, monospace;">
                            FEDRAMP-SC-13 <span style="color: var(--brand);">(100%)</span>
                          </span>
                        
                          <span style="padding: 4px 8px; background: white; border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-family: &#39;IBM Plex Mono&#39;, monospace;">
                            SOC2-CC6.6 <span style="color: var(--brand);">(93%)</span>
                          </span>
                        
                        
                      </div>
                    </div>
                  
                  
                  <!-- Usage Stats -->
                  <div style="display: flex; gap: 12px; margin-top: 12px; font-size: 11px; color: var(--text-secondary);">
                    <span>📋 Used in 5 RFPs</span>
                    <span>✓ 12 attestations</span>
                    <span>🛡️ 1 control</span>
                  </div>
                </div>
                
                <!-- Actions -->
                <div style="display: flex; flex-direction: column; gap: 8px;">
                  <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); findSemanticMatches(&#39;NIST-SC-13&#39;)" style="white-space: nowrap;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                      <circle cx="11" cy="11" r="8"></circle>
                      <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    Find Similar
                  </button>
                  <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); viewEquivalenceGraph(&#39;NIST-SC-13&#39;)" style="white-space: nowrap;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                      <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                      <path d="M2 17l10 5 10-5"></path>
                    </svg>
                    View Graph
                  </button>
                </div>
              </div>
            </div>
          
            <div class="clause-item" data-framework="SOC2" data-category="Incident Response" style="padding: 24px; border-bottom: 1px solid var(--border-light); transition: 0.2s; cursor: pointer; background: var(--bg-secondary);" onclick="showClauseDetail(&#39;SOC2-CC7.3&#39;)" onmouseover="this.style.background=&#39;var(--bg-secondary)&#39;" onmouseout="this.style.background=&#39;white&#39;">
              <div style="display: flex; align-items: start; gap: 20px;">
                <!-- Main Content -->
                <div style="flex: 1;">
                  <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                    <div style="font-weight: 700; font-size: 16px; font-family: &#39;IBM Plex Mono&#39;, monospace;">SOC2-CC7.3</div>
                    <span style="padding: 4px 10px; background: var(--trust-teal-light); color: var(--trust-teal); border-radius: 6px; font-size: 11px; font-weight: 700;">🔵 GOOD</span>
                    <span style="padding: 4px 10px; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-weight: 700; color: var(--text-secondary);">
                      Incident Response
                    </span>
                  </div>
                  
                  <div style="font-size: 15px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">
                    Security Incident Response
                  </div>
                  
                  <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px; line-height: 1.6;">
                    The entity evaluates security events to determine whether they could or have resulted in a failure of the entity to meet its objectives.
                  </div>
                  
                  <div style="display: flex; gap: 16px; margin-bottom: 12px; font-size: 12px; color: var(--text-tertiary);">
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                      </svg>
                      SOC 2 Type II
                    </span>
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                      </svg>
                      Maps to UCP-003
                    </span>
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 3a2.83 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                      </svg>
                      4 equivalents
                    </span>
                  </div>
                  
                  <!-- Operator Scores -->
                  <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 12px;">
                    <div style="padding: 10px; background: var(--bg-secondary); border-radius: 8px;">
                      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <div class="operator-glyph phi" style="width: 18px; height: 18px; font-size: 10px;">Φ</div>
                        <span style="font-size: 11px; font-weight: 700; color: var(--text-tertiary);">ZERO-START</span>
                      </div>
                      <div style="font-size: 18px; font-weight: 700; font-family: &#39;IBM Plex Mono&#39;, monospace;">0.72</div>
                    </div>
                    <div style="padding: 10px; background: var(--bg-secondary); border-radius: 8px; border-left: 3px solid var(--green);">
                      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <div class="operator-glyph psi" style="width: 18px; height: 18px; font-size: 10px;">Ψ</div>
                        <span style="font-size: 11px; font-weight: 700; color: var(--text-tertiary);">CREDENTIAL-DECAY</span>
                      </div>
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="font-size: 18px; font-weight: 700; font-family: &#39;IBM Plex Mono&#39;, monospace; color: var(--green);">0.96</div>
                        <div style="font-size: 11px; color: var(--text-secondary);">(14d old)</div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Semantic Equivalents Preview -->
                  
                    <div style="padding: 12px; background: var(--brand-light); border-radius: 8px;">
                      <div style="font-size: 11px; font-weight: 700; color: var(--brand); margin-bottom: 6px;">🔍 SEMANTIC EQUIVALENTS</div>
                      <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        
                          <span style="padding: 4px 8px; background: white; border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-family: &#39;IBM Plex Mono&#39;, monospace;">
                            ISO27001-A.16.1 <span style="color: var(--brand);">(94%)</span>
                          </span>
                        
                          <span style="padding: 4px 8px; background: white; border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-family: &#39;IBM Plex Mono&#39;, monospace;">
                            NIST-IR-4 <span style="color: var(--brand);">(96%)</span>
                          </span>
                        
                          <span style="padding: 4px 8px; background: white; border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-family: &#39;IBM Plex Mono&#39;, monospace;">
                            HIPAA-164.308(a)(6) <span style="color: var(--brand);">(92%)</span>
                          </span>
                        
                        
                      </div>
                    </div>
                  
                  
                  <!-- Usage Stats -->
                  <div style="display: flex; gap: 12px; margin-top: 12px; font-size: 11px; color: var(--text-secondary);">
                    <span>📋 Used in 3 RFPs</span>
                    <span>✓ 9 attestations</span>
                    <span>🛡️ 1 control</span>
                  </div>
                </div>
                
                <!-- Actions -->
                <div style="display: flex; flex-direction: column; gap: 8px;">
                  <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); findSemanticMatches(&#39;SOC2-CC7.3&#39;)" style="white-space: nowrap;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                      <circle cx="11" cy="11" r="8"></circle>
                      <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    Find Similar
                  </button>
                  <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); viewEquivalenceGraph(&#39;SOC2-CC7.3&#39;)" style="white-space: nowrap;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                      <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                      <path d="M2 17l10 5 10-5"></path>
                    </svg>
                    View Graph
                  </button>
                </div>
              </div>
            </div>
          
            <div class="clause-item" data-framework="ISO27001" data-category="Incident Response" style="padding: 24px; border-bottom: 1px solid var(--border-light); transition: 0.2s; cursor: pointer; background: white;" onclick="showClauseDetail(&#39;ISO27001-A.16.1&#39;)" onmouseover="this.style.background=&#39;var(--bg-secondary)&#39;" onmouseout="this.style.background=&#39;white&#39;">
              <div style="display: flex; align-items: start; gap: 20px;">
                <!-- Main Content -->
                <div style="flex: 1;">
                  <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                    <div style="font-weight: 700; font-size: 16px; font-family: &#39;IBM Plex Mono&#39;, monospace;">ISO27001-A.16.1</div>
                    <span style="padding: 4px 10px; background: var(--red-light); color: var(--red); border-radius: 6px; font-size: 11px; font-weight: 700;">🔴 STALE</span>
                    <span style="padding: 4px 10px; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-weight: 700; color: var(--text-secondary);">
                      Incident Response
                    </span>
                  </div>
                  
                  <div style="font-size: 15px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">
                    Management of Information Security Incidents
                  </div>
                  
                  <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px; line-height: 1.6;">
                    Management responsibilities and procedures shall be established to ensure a quick, effective, and orderly response to information security incidents.
                  </div>
                  
                  <div style="display: flex; gap: 16px; margin-bottom: 12px; font-size: 12px; color: var(--text-tertiary);">
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                      </svg>
                      ISO 27001:2022
                    </span>
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                      </svg>
                      Maps to UCP-003
                    </span>
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 3a2.83 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                      </svg>
                      4 equivalents
                    </span>
                  </div>
                  
                  <!-- Operator Scores -->
                  <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 12px;">
                    <div style="padding: 10px; background: var(--bg-secondary); border-radius: 8px;">
                      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <div class="operator-glyph phi" style="width: 18px; height: 18px; font-size: 10px;">Φ</div>
                        <span style="font-size: 11px; font-weight: 700; color: var(--text-tertiary);">ZERO-START</span>
                      </div>
                      <div style="font-size: 18px; font-weight: 700; font-family: &#39;IBM Plex Mono&#39;, monospace;">0.72</div>
                    </div>
                    <div style="padding: 10px; background: var(--bg-secondary); border-radius: 8px; border-left: 3px solid var(--trust-teal);">
                      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <div class="operator-glyph psi" style="width: 18px; height: 18px; font-size: 10px;">Ψ</div>
                        <span style="font-size: 11px; font-weight: 700; color: var(--text-tertiary);">CREDENTIAL-DECAY</span>
                      </div>
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="font-size: 18px; font-weight: 700; font-family: &#39;IBM Plex Mono&#39;, monospace; color: var(--trust-teal);">0.82</div>
                        <div style="font-size: 11px; color: var(--text-secondary);">(70d old)</div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Semantic Equivalents Preview -->
                  
                    <div style="padding: 12px; background: var(--brand-light); border-radius: 8px;">
                      <div style="font-size: 11px; font-weight: 700; color: var(--brand); margin-bottom: 6px;">🔍 SEMANTIC EQUIVALENTS</div>
                      <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        
                          <span style="padding: 4px 8px; background: white; border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-family: &#39;IBM Plex Mono&#39;, monospace;">
                            NIST-IR-4 <span style="color: var(--brand);">(98%)</span>
                          </span>
                        
                          <span style="padding: 4px 8px; background: white; border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-family: &#39;IBM Plex Mono&#39;, monospace;">
                            SOC2-CC7.3 <span style="color: var(--brand);">(94%)</span>
                          </span>
                        
                          <span style="padding: 4px 8px; background: white; border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-family: &#39;IBM Plex Mono&#39;, monospace;">
                            HIPAA-164.308(a)(6) <span style="color: var(--brand);">(93%)</span>
                          </span>
                        
                        
                      </div>
                    </div>
                  
                  
                  <!-- Usage Stats -->
                  <div style="display: flex; gap: 12px; margin-top: 12px; font-size: 11px; color: var(--text-secondary);">
                    <span>📋 Used in 4 RFPs</span>
                    <span>✓ 7 attestations</span>
                    <span>🛡️ 1 control</span>
                  </div>
                </div>
                
                <!-- Actions -->
                <div style="display: flex; flex-direction: column; gap: 8px;">
                  <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); findSemanticMatches(&#39;ISO27001-A.16.1&#39;)" style="white-space: nowrap;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                      <circle cx="11" cy="11" r="8"></circle>
                      <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    Find Similar
                  </button>
                  <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); viewEquivalenceGraph(&#39;ISO27001-A.16.1&#39;)" style="white-space: nowrap;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                      <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                      <path d="M2 17l10 5 10-5"></path>
                    </svg>
                    View Graph
                  </button>
                </div>
              </div>
            </div>
          
            <div class="clause-item" data-framework="NIST" data-category="Incident Response" style="padding: 24px; border-bottom: 1px solid var(--border-light); transition: 0.2s; cursor: pointer; background: white;" onclick="showClauseDetail(&#39;NIST-IR-4&#39;)" onmouseover="this.style.background=&#39;var(--bg-secondary)&#39;" onmouseout="this.style.background=&#39;white&#39;">
              <div style="display: flex; align-items: start; gap: 20px;">
                <!-- Main Content -->
                <div style="flex: 1;">
                  <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                    <div style="font-weight: 700; font-size: 16px; font-family: &#39;IBM Plex Mono&#39;, monospace;">NIST-IR-4</div>
                    <span style="padding: 4px 10px; background: var(--amber-light); color: var(--amber); border-radius: 6px; font-size: 11px; font-weight: 700;">🟡 AGING</span>
                    <span style="padding: 4px 10px; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-weight: 700; color: var(--text-secondary);">
                      Incident Response
                    </span>
                  </div>
                  
                  <div style="font-size: 15px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">
                    Incident Handling
                  </div>
                  
                  <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px; line-height: 1.6;">
                    The organization implements an incident handling capability for security incidents that includes preparation, detection and analysis, containment, eradication, and recovery.
                  </div>
                  
                  <div style="display: flex; gap: 16px; margin-bottom: 12px; font-size: 12px; color: var(--text-tertiary);">
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                      </svg>
                      NIST 800-53 Rev 5
                    </span>
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                      </svg>
                      Maps to UCP-003
                    </span>
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 3a2.83 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                      </svg>
                      4 equivalents
                    </span>
                  </div>
                  
                  <!-- Operator Scores -->
                  <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 12px;">
                    <div style="padding: 10px; background: var(--bg-secondary); border-radius: 8px;">
                      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <div class="operator-glyph phi" style="width: 18px; height: 18px; font-size: 10px;">Φ</div>
                        <span style="font-size: 11px; font-weight: 700; color: var(--text-tertiary);">ZERO-START</span>
                      </div>
                      <div style="font-size: 18px; font-weight: 700; font-family: &#39;IBM Plex Mono&#39;, monospace;">0.72</div>
                    </div>
                    <div style="padding: 10px; background: var(--bg-secondary); border-radius: 8px; border-left: 3px solid var(--trust-teal);">
                      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <div class="operator-glyph psi" style="width: 18px; height: 18px; font-size: 10px;">Ψ</div>
                        <span style="font-size: 11px; font-weight: 700; color: var(--text-tertiary);">CREDENTIAL-DECAY</span>
                      </div>
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="font-size: 18px; font-weight: 700; font-family: &#39;IBM Plex Mono&#39;, monospace; color: var(--trust-teal);">0.88</div>
                        <div style="font-size: 11px; color: var(--text-secondary);">(48d old)</div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Semantic Equivalents Preview -->
                  
                    <div style="padding: 12px; background: var(--brand-light); border-radius: 8px;">
                      <div style="font-size: 11px; font-weight: 700; color: var(--brand); margin-bottom: 6px;">🔍 SEMANTIC EQUIVALENTS</div>
                      <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        
                          <span style="padding: 4px 8px; background: white; border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-family: &#39;IBM Plex Mono&#39;, monospace;">
                            ISO27001-A.16.1 <span style="color: var(--brand);">(98%)</span>
                          </span>
                        
                          <span style="padding: 4px 8px; background: white; border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-family: &#39;IBM Plex Mono&#39;, monospace;">
                            FEDRAMP-IR-4 <span style="color: var(--brand);">(100%)</span>
                          </span>
                        
                          <span style="padding: 4px 8px; background: white; border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-family: &#39;IBM Plex Mono&#39;, monospace;">
                            SOC2-CC7.3 <span style="color: var(--brand);">(96%)</span>
                          </span>
                        
                        
                      </div>
                    </div>
                  
                  
                  <!-- Usage Stats -->
                  <div style="display: flex; gap: 12px; margin-top: 12px; font-size: 11px; color: var(--text-secondary);">
                    <span>📋 Used in 5 RFPs</span>
                    <span>✓ 11 attestations</span>
                    <span>🛡️ 1 control</span>
                  </div>
                </div>
                
                <!-- Actions -->
                <div style="display: flex; flex-direction: column; gap: 8px;">
                  <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); findSemanticMatches(&#39;NIST-IR-4&#39;)" style="white-space: nowrap;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                      <circle cx="11" cy="11" r="8"></circle>
                      <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    Find Similar
                  </button>
                  <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); viewEquivalenceGraph(&#39;NIST-IR-4&#39;)" style="white-space: nowrap;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                      <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                      <path d="M2 17l10 5 10-5"></path>
                    </svg>
                    View Graph
                  </button>
                </div>
              </div>
            </div>
          
            <div class="clause-item" data-framework="SOC2" data-category="Encryption" style="padding: 24px; border-bottom: 1px solid var(--border-light); transition: 0.2s; cursor: pointer; background: white;" onclick="showClauseDetail(&#39;SOC2-CC6.7&#39;)" onmouseover="this.style.background=&#39;var(--bg-secondary)&#39;" onmouseout="this.style.background=&#39;white&#39;">
              <div style="display: flex; align-items: start; gap: 20px;">
                <!-- Main Content -->
                <div style="flex: 1;">
                  <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                    <div style="font-weight: 700; font-size: 16px; font-family: &#39;IBM Plex Mono&#39;, monospace;">SOC2-CC6.7</div>
                    <span style="padding: 4px 10px; background: var(--trust-teal-light); color: var(--trust-teal); border-radius: 6px; font-size: 11px; font-weight: 700;">🔵 GOOD</span>
                    <span style="padding: 4px 10px; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-weight: 700; color: var(--text-secondary);">
                      Encryption
                    </span>
                  </div>
                  
                  <div style="font-size: 15px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">
                    Encryption of Data at Rest
                  </div>
                  
                  <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px; line-height: 1.6;">
                    The entity restricts the transmission, movement, and removal of information to authorized internal and external users and processes.
                  </div>
                  
                  <div style="display: flex; gap: 16px; margin-bottom: 12px; font-size: 12px; color: var(--text-tertiary);">
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                      </svg>
                      SOC 2 Type II
                    </span>
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                      </svg>
                      Maps to UCP-002
                    </span>
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 3a2.83 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                      </svg>
                      2 equivalents
                    </span>
                  </div>
                  
                  <!-- Operator Scores -->
                  <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 12px;">
                    <div style="padding: 10px; background: var(--bg-secondary); border-radius: 8px;">
                      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <div class="operator-glyph phi" style="width: 18px; height: 18px; font-size: 10px;">Φ</div>
                        <span style="font-size: 11px; font-weight: 700; color: var(--text-tertiary);">ZERO-START</span>
                      </div>
                      <div style="font-size: 18px; font-weight: 700; font-family: &#39;IBM Plex Mono&#39;, monospace;">0.90</div>
                    </div>
                    <div style="padding: 10px; background: var(--bg-secondary); border-radius: 8px; border-left: 3px solid var(--green);">
                      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <div class="operator-glyph psi" style="width: 18px; height: 18px; font-size: 10px;">Ψ</div>
                        <span style="font-size: 11px; font-weight: 700; color: var(--text-tertiary);">CREDENTIAL-DECAY</span>
                      </div>
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="font-size: 18px; font-weight: 700; font-family: &#39;IBM Plex Mono&#39;, monospace; color: var(--green);">0.96</div>
                        <div style="font-size: 11px; color: var(--text-secondary);">(14d old)</div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Semantic Equivalents Preview -->
                  
                    <div style="padding: 12px; background: var(--brand-light); border-radius: 8px;">
                      <div style="font-size: 11px; font-weight: 700; color: var(--brand); margin-bottom: 6px;">🔍 SEMANTIC EQUIVALENTS</div>
                      <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        
                          <span style="padding: 4px 8px; background: white; border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-family: &#39;IBM Plex Mono&#39;, monospace;">
                            ISO27001-A.8.24 <span style="color: var(--brand);">(96%)</span>
                          </span>
                        
                          <span style="padding: 4px 8px; background: white; border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-family: &#39;IBM Plex Mono&#39;, monospace;">
                            NIST-SC-28 <span style="color: var(--brand);">(94%)</span>
                          </span>
                        
                        
                      </div>
                    </div>
                  
                  
                  <!-- Usage Stats -->
                  <div style="display: flex; gap: 12px; margin-top: 12px; font-size: 11px; color: var(--text-secondary);">
                    <span>📋 Used in 3 RFPs</span>
                    <span>✓ 8 attestations</span>
                    <span>🛡️ 1 control</span>
                  </div>
                </div>
                
                <!-- Actions -->
                <div style="display: flex; flex-direction: column; gap: 8px;">
                  <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); findSemanticMatches(&#39;SOC2-CC6.7&#39;)" style="white-space: nowrap;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                      <circle cx="11" cy="11" r="8"></circle>
                      <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    Find Similar
                  </button>
                  <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); viewEquivalenceGraph(&#39;SOC2-CC6.7&#39;)" style="white-space: nowrap;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                      <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                      <path d="M2 17l10 5 10-5"></path>
                    </svg>
                    View Graph
                  </button>
                </div>
              </div>
            </div>
          
            <div class="clause-item" data-framework="ISO27001" data-category="Business Continuity" style="padding: 24px; border-bottom: 1px solid var(--border-light); transition: 0.2s; cursor: pointer; background: white;" onclick="showClauseDetail(&#39;ISO27001-A.12.3&#39;)" onmouseover="this.style.background=&#39;var(--bg-secondary)&#39;" onmouseout="this.style.background=&#39;white&#39;">
              <div style="display: flex; align-items: start; gap: 20px;">
                <!-- Main Content -->
                <div style="flex: 1;">
                  <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                    <div style="font-weight: 700; font-size: 16px; font-family: &#39;IBM Plex Mono&#39;, monospace;">ISO27001-A.12.3</div>
                    <span style="padding: 4px 10px; background: var(--red-light); color: var(--red); border-radius: 6px; font-size: 11px; font-weight: 700;">🔴 STALE</span>
                    <span style="padding: 4px 10px; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-weight: 700; color: var(--text-secondary);">
                      Business Continuity
                    </span>
                  </div>
                  
                  <div style="font-size: 15px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">
                    Information Backup
                  </div>
                  
                  <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px; line-height: 1.6;">
                    Backup copies of information, software and system images shall be taken and tested regularly in accordance with an agreed backup policy.
                  </div>
                  
                  <div style="display: flex; gap: 16px; margin-bottom: 12px; font-size: 12px; color: var(--text-tertiary);">
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                      </svg>
                      ISO 27001:2022
                    </span>
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                      </svg>
                      Maps to UCP-004
                    </span>
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 3a2.83 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                      </svg>
                      2 equivalents
                    </span>
                  </div>
                  
                  <!-- Operator Scores -->
                  <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 12px;">
                    <div style="padding: 10px; background: var(--bg-secondary); border-radius: 8px;">
                      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <div class="operator-glyph phi" style="width: 18px; height: 18px; font-size: 10px;">Φ</div>
                        <span style="font-size: 11px; font-weight: 700; color: var(--text-tertiary);">ZERO-START</span>
                      </div>
                      <div style="font-size: 18px; font-weight: 700; font-family: &#39;IBM Plex Mono&#39;, monospace;">0.91</div>
                    </div>
                    <div style="padding: 10px; background: var(--bg-secondary); border-radius: 8px; border-left: 3px solid var(--trust-teal);">
                      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <div class="operator-glyph psi" style="width: 18px; height: 18px; font-size: 10px;">Ψ</div>
                        <span style="font-size: 11px; font-weight: 700; color: var(--text-tertiary);">CREDENTIAL-DECAY</span>
                      </div>
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="font-size: 18px; font-weight: 700; font-family: &#39;IBM Plex Mono&#39;, monospace; color: var(--trust-teal);">0.82</div>
                        <div style="font-size: 11px; color: var(--text-secondary);">(70d old)</div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Semantic Equivalents Preview -->
                  
                    <div style="padding: 12px; background: var(--brand-light); border-radius: 8px;">
                      <div style="font-size: 11px; font-weight: 700; color: var(--brand); margin-bottom: 6px;">🔍 SEMANTIC EQUIVALENTS</div>
                      <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        
                          <span style="padding: 4px 8px; background: white; border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-family: &#39;IBM Plex Mono&#39;, monospace;">
                            NIST-CP-9 <span style="color: var(--brand);">(97%)</span>
                          </span>
                        
                          <span style="padding: 4px 8px; background: white; border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-family: &#39;IBM Plex Mono&#39;, monospace;">
                            SOC2-CC5.1 <span style="color: var(--brand);">(93%)</span>
                          </span>
                        
                        
                      </div>
                    </div>
                  
                  
                  <!-- Usage Stats -->
                  <div style="display: flex; gap: 12px; margin-top: 12px; font-size: 11px; color: var(--text-secondary);">
                    <span>📋 Used in 4 RFPs</span>
                    <span>✓ 10 attestations</span>
                    <span>🛡️ 1 control</span>
                  </div>
                </div>
                
                <!-- Actions -->
                <div style="display: flex; flex-direction: column; gap: 8px;">
                  <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); findSemanticMatches(&#39;ISO27001-A.12.3&#39;)" style="white-space: nowrap;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                      <circle cx="11" cy="11" r="8"></circle>
                      <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    Find Similar
                  </button>
                  <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); viewEquivalenceGraph(&#39;ISO27001-A.12.3&#39;)" style="white-space: nowrap;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                      <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                      <path d="M2 17l10 5 10-5"></path>
                    </svg>
                    View Graph
                  </button>
                </div>
              </div>
            </div>
          
            <div class="clause-item" data-framework="NIST" data-category="Business Continuity" style="padding: 24px; border-bottom: 1px solid var(--border-light); transition: 0.2s; cursor: pointer; background: white;" onclick="showClauseDetail(&#39;NIST-CP-9&#39;)" onmouseover="this.style.background=&#39;var(--bg-secondary)&#39;" onmouseout="this.style.background=&#39;white&#39;">
              <div style="display: flex; align-items: start; gap: 20px;">
                <!-- Main Content -->
                <div style="flex: 1;">
                  <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                    <div style="font-weight: 700; font-size: 16px; font-family: &#39;IBM Plex Mono&#39;, monospace;">NIST-CP-9</div>
                    <span style="padding: 4px 10px; background: var(--amber-light); color: var(--amber); border-radius: 6px; font-size: 11px; font-weight: 700;">🟡 AGING</span>
                    <span style="padding: 4px 10px; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-weight: 700; color: var(--text-secondary);">
                      Business Continuity
                    </span>
                  </div>
                  
                  <div style="font-size: 15px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">
                    Information System Backup
                  </div>
                  
                  <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px; line-height: 1.6;">
                    The organization conducts backups of user-level information, system-level information, and system documentation.
                  </div>
                  
                  <div style="display: flex; gap: 16px; margin-bottom: 12px; font-size: 12px; color: var(--text-tertiary);">
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                      </svg>
                      NIST 800-53 Rev 5
                    </span>
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                      </svg>
                      Maps to UCP-004
                    </span>
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 3a2.83 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                      </svg>
                      2 equivalents
                    </span>
                  </div>
                  
                  <!-- Operator Scores -->
                  <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 12px;">
                    <div style="padding: 10px; background: var(--bg-secondary); border-radius: 8px;">
                      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <div class="operator-glyph phi" style="width: 18px; height: 18px; font-size: 10px;">Φ</div>
                        <span style="font-size: 11px; font-weight: 700; color: var(--text-tertiary);">ZERO-START</span>
                      </div>
                      <div style="font-size: 18px; font-weight: 700; font-family: &#39;IBM Plex Mono&#39;, monospace;">0.91</div>
                    </div>
                    <div style="padding: 10px; background: var(--bg-secondary); border-radius: 8px; border-left: 3px solid var(--trust-teal);">
                      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <div class="operator-glyph psi" style="width: 18px; height: 18px; font-size: 10px;">Ψ</div>
                        <span style="font-size: 11px; font-weight: 700; color: var(--text-tertiary);">CREDENTIAL-DECAY</span>
                      </div>
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="font-size: 18px; font-weight: 700; font-family: &#39;IBM Plex Mono&#39;, monospace; color: var(--trust-teal);">0.88</div>
                        <div style="font-size: 11px; color: var(--text-secondary);">(48d old)</div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Semantic Equivalents Preview -->
                  
                    <div style="padding: 12px; background: var(--brand-light); border-radius: 8px;">
                      <div style="font-size: 11px; font-weight: 700; color: var(--brand); margin-bottom: 6px;">🔍 SEMANTIC EQUIVALENTS</div>
                      <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        
                          <span style="padding: 4px 8px; background: white; border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-family: &#39;IBM Plex Mono&#39;, monospace;">
                            ISO27001-A.12.3 <span style="color: var(--brand);">(97%)</span>
                          </span>
                        
                          <span style="padding: 4px 8px; background: white; border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-family: &#39;IBM Plex Mono&#39;, monospace;">
                            SOC2-CC5.1 <span style="color: var(--brand);">(95%)</span>
                          </span>
                        
                        
                      </div>
                    </div>
                  
                  
                  <!-- Usage Stats -->
                  <div style="display: flex; gap: 12px; margin-top: 12px; font-size: 11px; color: var(--text-secondary);">
                    <span>📋 Used in 5 RFPs</span>
                    <span>✓ 12 attestations</span>
                    <span>🛡️ 1 control</span>
                  </div>
                </div>
                
                <!-- Actions -->
                <div style="display: flex; flex-direction: column; gap: 8px;">
                  <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); findSemanticMatches(&#39;NIST-CP-9&#39;)" style="white-space: nowrap;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                      <circle cx="11" cy="11" r="8"></circle>
                      <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    Find Similar
                  </button>
                  <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); viewEquivalenceGraph(&#39;NIST-CP-9&#39;)" style="white-space: nowrap;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                      <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                      <path d="M2 17l10 5 10-5"></path>
                    </svg>
                    View Graph
                  </button>
                </div>
              </div>
            </div>
          
            <div class="clause-item" data-framework="ISO27001" data-category="Vendor Management" style="padding: 24px; border-bottom: 1px solid var(--border-light); transition: 0.2s; cursor: pointer; background: white;" onclick="showClauseDetail(&#39;ISO27001-A.15.1&#39;)" onmouseover="this.style.background=&#39;var(--bg-secondary)&#39;" onmouseout="this.style.background=&#39;white&#39;">
              <div style="display: flex; align-items: start; gap: 20px;">
                <!-- Main Content -->
                <div style="flex: 1;">
                  <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                    <div style="font-weight: 700; font-size: 16px; font-family: &#39;IBM Plex Mono&#39;, monospace;">ISO27001-A.15.1</div>
                    <span style="padding: 4px 10px; background: var(--red-light); color: var(--red); border-radius: 6px; font-size: 11px; font-weight: 700;">🔴 STALE</span>
                    <span style="padding: 4px 10px; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-weight: 700; color: var(--text-secondary);">
                      Vendor Management
                    </span>
                  </div>
                  
                  <div style="font-size: 15px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">
                    Information Security in Supplier Relationships
                  </div>
                  
                  <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px; line-height: 1.6;">
                    Information security requirements for mitigating the risks associated with supplier's access to the organization's assets shall be agreed with the supplier.
                  </div>
                  
                  <div style="display: flex; gap: 16px; margin-bottom: 12px; font-size: 12px; color: var(--text-tertiary);">
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                      </svg>
                      ISO 27001:2022
                    </span>
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                      </svg>
                      Maps to UCP-005
                    </span>
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 3a2.83 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                      </svg>
                      2 equivalents
                    </span>
                  </div>
                  
                  <!-- Operator Scores -->
                  <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 12px;">
                    <div style="padding: 10px; background: var(--bg-secondary); border-radius: 8px;">
                      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <div class="operator-glyph phi" style="width: 18px; height: 18px; font-size: 10px;">Φ</div>
                        <span style="font-size: 11px; font-weight: 700; color: var(--text-tertiary);">ZERO-START</span>
                      </div>
                      <div style="font-size: 18px; font-weight: 700; font-family: &#39;IBM Plex Mono&#39;, monospace;">0.65</div>
                    </div>
                    <div style="padding: 10px; background: var(--bg-secondary); border-radius: 8px; border-left: 3px solid var(--trust-teal);">
                      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <div class="operator-glyph psi" style="width: 18px; height: 18px; font-size: 10px;">Ψ</div>
                        <span style="font-size: 11px; font-weight: 700; color: var(--text-tertiary);">CREDENTIAL-DECAY</span>
                      </div>
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="font-size: 18px; font-weight: 700; font-family: &#39;IBM Plex Mono&#39;, monospace; color: var(--trust-teal);">0.82</div>
                        <div style="font-size: 11px; color: var(--text-secondary);">(70d old)</div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Semantic Equivalents Preview -->
                  
                    <div style="padding: 12px; background: var(--brand-light); border-radius: 8px;">
                      <div style="font-size: 11px; font-weight: 700; color: var(--brand); margin-bottom: 6px;">🔍 SEMANTIC EQUIVALENTS</div>
                      <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        
                          <span style="padding: 4px 8px; background: white; border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-family: &#39;IBM Plex Mono&#39;, monospace;">
                            NIST-SA-9 <span style="color: var(--brand);">(96%)</span>
                          </span>
                        
                          <span style="padding: 4px 8px; background: white; border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-family: &#39;IBM Plex Mono&#39;, monospace;">
                            SOC2-CC9.2 <span style="color: var(--brand);">(92%)</span>
                          </span>
                        
                        
                      </div>
                    </div>
                  
                  
                  <!-- Usage Stats -->
                  <div style="display: flex; gap: 12px; margin-top: 12px; font-size: 11px; color: var(--text-secondary);">
                    <span>📋 Used in 3 RFPs</span>
                    <span>✓ 5 attestations</span>
                    <span>🛡️ 1 control</span>
                  </div>
                </div>
                
                <!-- Actions -->
                <div style="display: flex; flex-direction: column; gap: 8px;">
                  <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); findSemanticMatches(&#39;ISO27001-A.15.1&#39;)" style="white-space: nowrap;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                      <circle cx="11" cy="11" r="8"></circle>
                      <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    Find Similar
                  </button>
                  <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); viewEquivalenceGraph(&#39;ISO27001-A.15.1&#39;)" style="white-space: nowrap;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                      <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                      <path d="M2 17l10 5 10-5"></path>
                    </svg>
                    View Graph
                  </button>
                </div>
              </div>
            </div>
          
            <div class="clause-item" data-framework="NIST" data-category="Vendor Management" style="padding: 24px; transition: 0.2s; cursor: pointer; background: white;" onclick="showClauseDetail(&#39;NIST-SA-9&#39;)" onmouseover="this.style.background=&#39;var(--bg-secondary)&#39;" onmouseout="this.style.background=&#39;white&#39;">
              <div style="display: flex; align-items: start; gap: 20px;">
                <!-- Main Content -->
                <div style="flex: 1;">
                  <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                    <div style="font-weight: 700; font-size: 16px; font-family: &#39;IBM Plex Mono&#39;, monospace;">NIST-SA-9</div>
                    <span style="padding: 4px 10px; background: var(--amber-light); color: var(--amber); border-radius: 6px; font-size: 11px; font-weight: 700;">🟡 AGING</span>
                    <span style="padding: 4px 10px; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-weight: 700; color: var(--text-secondary);">
                      Vendor Management
                    </span>
                  </div>
                  
                  <div style="font-size: 15px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">
                    External Information System Services
                  </div>
                  
                  <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px; line-height: 1.6;">
                    The organization requires that providers of external information system services comply with organizational information security requirements.
                  </div>
                  
                  <div style="display: flex; gap: 16px; margin-bottom: 12px; font-size: 12px; color: var(--text-tertiary);">
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                      </svg>
                      NIST 800-53 Rev 5
                    </span>
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                      </svg>
                      Maps to UCP-005
                    </span>
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 3a2.83 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                      </svg>
                      2 equivalents
                    </span>
                  </div>
                  
                  <!-- Operator Scores -->
                  <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 12px;">
                    <div style="padding: 10px; background: var(--bg-secondary); border-radius: 8px;">
                      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <div class="operator-glyph phi" style="width: 18px; height: 18px; font-size: 10px;">Φ</div>
                        <span style="font-size: 11px; font-weight: 700; color: var(--text-tertiary);">ZERO-START</span>
                      </div>
                      <div style="font-size: 18px; font-weight: 700; font-family: &#39;IBM Plex Mono&#39;, monospace;">0.65</div>
                    </div>
                    <div style="padding: 10px; background: var(--bg-secondary); border-radius: 8px; border-left: 3px solid var(--trust-teal);">
                      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <div class="operator-glyph psi" style="width: 18px; height: 18px; font-size: 10px;">Ψ</div>
                        <span style="font-size: 11px; font-weight: 700; color: var(--text-tertiary);">CREDENTIAL-DECAY</span>
                      </div>
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="font-size: 18px; font-weight: 700; font-family: &#39;IBM Plex Mono&#39;, monospace; color: var(--trust-teal);">0.88</div>
                        <div style="font-size: 11px; color: var(--text-secondary);">(48d old)</div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Semantic Equivalents Preview -->
                  
                    <div style="padding: 12px; background: var(--brand-light); border-radius: 8px;">
                      <div style="font-size: 11px; font-weight: 700; color: var(--brand); margin-bottom: 6px;">🔍 SEMANTIC EQUIVALENTS</div>
                      <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        
                          <span style="padding: 4px 8px; background: white; border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-family: &#39;IBM Plex Mono&#39;, monospace;">
                            ISO27001-A.15.1 <span style="color: var(--brand);">(96%)</span>
                          </span>
                        
                          <span style="padding: 4px 8px; background: white; border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-family: &#39;IBM Plex Mono&#39;, monospace;">
                            SOC2-CC9.2 <span style="color: var(--brand);">(94%)</span>
                          </span>
                        
                        
                      </div>
                    </div>
                  
                  
                  <!-- Usage Stats -->
                  <div style="display: flex; gap: 12px; margin-top: 12px; font-size: 11px; color: var(--text-secondary);">
                    <span>📋 Used in 4 RFPs</span>
                    <span>✓ 6 attestations</span>
                    <span>🛡️ 1 control</span>
                  </div>
                </div>
                
                <!-- Actions -->
                <div style="display: flex; flex-direction: column; gap: 8px;">
                  <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); findSemanticMatches(&#39;NIST-SA-9&#39;)" style="white-space: nowrap;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                      <circle cx="11" cy="11" r="8"></circle>
                      <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    Find Similar
                  </button>
                  <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); viewEquivalenceGraph(&#39;NIST-SA-9&#39;)" style="white-space: nowrap;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                      <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                      <path d="M2 17l10 5 10-5"></path>
                    </svg>
                    View Graph
                  </button>
                </div>
              </div>
            </div>
          
        </div>
      </div>
    </div>
  </main>
  </div>

  <!-- Modal Container -->
  <div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal" onclick="event.stopPropagation()" role="document">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">ISO27001-A.16.1: Management of Information Security Incidents</h3>
        <button class="modal-close" onclick="closeModal()" aria-label="Close modal" tabindex="0">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="modal-body" id="modalBody">
    <div style="padding: 20px;">
      <!-- Header Info -->
      <div style="margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid var(--border-light);">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
          <span style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 6px; font-size: 12px; font-weight: 700;">
            ISO 27001:2022
          </span>
          <span style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 6px; font-size: 12px; font-weight: 700;">
            Incident Response
          </span>
          <span style="padding: 4px 10px; background: var(--red-light); color: var(--red); border-radius: 6px; font-size: 11px; font-weight: 700;">🔴 STALE</span>
        </div>
        <div style="font-size: 15px; color: var(--text-secondary); margin-bottom: 12px;">
          <strong>Requirement:</strong>
        </div>
        <div style="font-size: 14px; color: var(--text-primary); line-height: 1.7; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
          Management responsibilities and procedures shall be established to ensure a quick, effective, and orderly response to information security incidents.
        </div>
      </div>
      
      <!-- Operator Scores -->
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 24px;">
        <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <div class="operator-glyph phi" style="width: 24px; height: 24px; font-size: 13px;">Φ</div>
            <span style="font-size: 12px; font-weight: 700; color: var(--text-tertiary);">ZERO-START TRUTH</span>
          </div>
          <div style="font-size: 32px; font-weight: 700; font-family: &#39;IBM Plex Mono&#39;, monospace;">0.72</div>
        </div>
        <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px; border-left: 3px solid var(--trust-teal);">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <div class="operator-glyph psi" style="width: 24px; height: 24px; font-size: 13px;">Ψ</div>
            <span style="font-size: 12px; font-weight: 700; color: var(--text-tertiary);">CREDENTIAL-DECAY</span>
          </div>
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="font-size: 32px; font-weight: 700; font-family: &#39;IBM Plex Mono&#39;, monospace; color: var(--trust-teal);">0.82</div>
            <div style="font-size: 13px; color: var(--text-secondary);">(70 days old)</div>
          </div>
        </div>
      </div>
      
      <!-- Freshness Details -->
      <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 24px;">
        <div style="font-size: 13px; font-weight: 700; color: var(--text-primary); margin-bottom: 8px;">Freshness Transparency</div>
        <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.6;">
          • Last reviewed: 9/20/2025<br>
          • Days since review: 70<br>
          • Decay factor: 18.0% confidence loss<br>
          • BLAKE3 hash: <span style="font-family: &#39;IBM Plex Mono&#39;, monospace;">blake3:iso27001_a161_c9d0e1f2</span>
        </div>
      </div>
      
      <!-- Mapped Control -->
      <div style="margin-bottom: 24px;">
        <div style="font-size: 14px; font-weight: 700; margin-bottom: 12px;">Mapped Control</div>
        <div style="padding: 12px; background: var(--brand-light); border-radius: 8px; border-left: 3px solid var(--brand);">
          <div style="font-size: 13px; font-weight: 700; color: var(--brand);">UCP-003</div>
          <div style="font-size: 12px; color: var(--text-secondary);">This clause satisfies the requirements of the mapped control</div>
        </div>
      </div>
      
      <!-- Semantic Equivalents -->
      
        <div style="margin-bottom: 24px;">
          <div style="font-size: 14px; font-weight: 700; margin-bottom: 12px;">Semantic Equivalents (3)</div>
          
            <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 8px;">
              <div style="display: flex; justify-content: between; align-items: center;">
                <div style="flex: 1;">
                  <div style="font-size: 13px; font-weight: 700; font-family: &#39;IBM Plex Mono&#39;, monospace; margin-bottom: 4px;">NIST-IR-4</div>
                  <div style="font-size: 12px; color: var(--text-secondary);">
                    Semantic similarity: 98.0% (cosine distance)
                  </div>
                </div>
                <div style="width: 60px; height: 6px; background: var(--border-light); border-radius: 3px; overflow: hidden;">
                  <div style="width: 98%; height: 100%; background: var(--brand); border-radius: 3px;"></div>
                </div>
              </div>
            </div>
          
            <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 8px;">
              <div style="display: flex; justify-content: between; align-items: center;">
                <div style="flex: 1;">
                  <div style="font-size: 13px; font-weight: 700; font-family: &#39;IBM Plex Mono&#39;, monospace; margin-bottom: 4px;">SOC2-CC7.3</div>
                  <div style="font-size: 12px; color: var(--text-secondary);">
                    Semantic similarity: 94.0% (cosine distance)
                  </div>
                </div>
                <div style="width: 60px; height: 6px; background: var(--border-light); border-radius: 3px; overflow: hidden;">
                  <div style="width: 94%; height: 100%; background: var(--brand); border-radius: 3px;"></div>
                </div>
              </div>
            </div>
          
            <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 8px;">
              <div style="display: flex; justify-content: between; align-items: center;">
                <div style="flex: 1;">
                  <div style="font-size: 13px; font-weight: 700; font-family: &#39;IBM Plex Mono&#39;, monospace; margin-bottom: 4px;">HIPAA-164.308(a)(6)</div>
                  <div style="font-size: 12px; color: var(--text-secondary);">
                    Semantic similarity: 93.0% (cosine distance)
                  </div>
                </div>
                <div style="width: 60px; height: 6px; background: var(--border-light); border-radius: 3px; overflow: hidden;">
                  <div style="width: 93%; height: 100%; background: var(--brand); border-radius: 3px;"></div>
                </div>
              </div>
            </div>
          
        </div>
      
      
      <!-- Usage Statistics -->
      <div style="padding: 16px; background: var(--green-light); border-radius: 8px;">
        <div style="font-size: 13px; font-weight: 700; color: var(--green); margin-bottom: 8px;">Usage Across System</div>
        <div style="display: flex; gap: 20px; font-size: 12px; color: var(--text-secondary);">
          <span>📋 4 RFPs</span>
          <span>✓ 7 attestations</span>
          <span>🛡️ 1 control mapping</span>
        </div>
      </div>
    </div>
  </div>
      <div class="modal-footer" id="modalFooter">
    <button class="btn btn-secondary" onclick="closeModal()">Close</button>
    <button class="btn btn-primary" onclick="closeModal(); viewEquivalenceGraph(&#39;ISO27001-A.16.1&#39;)">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
        <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
        <path d="M2 17l10 5 10-5"></path>
      </svg>
      View Equivalence Graph
    </button>
  </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Atomic AI Copilot Panel -->
  <div class="atomic-ai-panel" id="atomicAiPanel">
    <div class="atomic-ai-header">
      <div class="atomic-ai-header-title">
        <div class="atomic-ai-header-icon">Δ</div>
        <span><span style="font-weight: 800;">Δ</span>tomic AI Copilot</span>
      </div>
      <div style="display: flex; gap: 8px;">
        <button class="atomic-ai-close" onclick="openAtomicAiConfig()" aria-label="Configure Atomic AI" title="Configure AI">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
          </svg>
        </button>
        <button class="atomic-ai-close" onclick="toggleAtomicAI()" aria-label="Close Atomic AI">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"></path>
          </svg>
        </button>
      </div>
    </div>
    <div class="atomic-ai-body">
      <div class="atomic-ai-messages" id="atomicAiMessages">
        <div class="atomic-ai-message assistant">
          <strong>Welcome to Δtomic AI!</strong><br><br>
          I'm your multi-LLM consensus copilot, powered by Claude, GPT-4o, and Gemini working together.
          <br><br>
          I can help you with:
          <ul style="margin: 8px 0 0 16px; padding: 0; font-size: 12px;">
            <li>Analyzing compliance controls</li>
            <li>Evaluating evidence quality</li>
            <li>Finding framework mappings</li>
            <li>Generating audit responses</li>
            <li>Explaining ΦΨΔIPT operators</li>
          </ul>
          <div class="consensus-badge">
            <span>✓</span> 4/4 Models Ready
          </div>
        </div>
      </div>
    </div>
    <div class="atomic-ai-input-area">
      <div class="atomic-ai-input-wrapper">
        <input type="text" class="atomic-ai-input" id="atomicAiInput" placeholder="Ask Δtomic AI anything..." onkeypress="if(event.key===&#39;Enter&#39;)sendAtomicAiMessage()">
        <button class="atomic-ai-send" onclick="sendAtomicAiMessage()" id="atomicAiSend">
          Send
        </button>
      </div>
    </div>
  </div>

  <!-- Delta Contextual Mini-Chat -->
  <div class="delta-mini-chat" id="deltaMiniChat">
    <div class="delta-mini-chat-header">
      <div class="delta-mini-chat-title">
        <span class="delta-mini-chat-icon">Δ</span>
        <span id="deltaMiniChatContext">Control Context</span>
      </div>
      <button class="delta-mini-chat-close" onclick="closeDeltaContext()" aria-label="Close">×</button>
    </div>
    <div class="delta-mini-chat-body" id="deltaMiniChatBody">
      <div class="delta-mini-chat-welcome">
        <span style="font-size: 20px;">Δ</span>
        <p>Ask me about this specific item. I have full context.</p>
      </div>
    </div>
    <div class="delta-mini-chat-input-area">
      <input type="text" class="delta-mini-chat-input" id="deltaMiniChatInput" placeholder="Ask about this item..." onkeypress="if(event.key===&#39;Enter&#39;)sendDeltaContextMessage()">
      <button class="delta-mini-chat-send" onclick="sendDeltaContextMessage()">→</button>
    </div>
  </div>

  <!-- Atomic AI Configuration Modal -->
  <div class="atomic-ai-config" id="atomicAiConfig">
    <div class="atomic-ai-config-header">
      <div style="display: flex; align-items: center; gap: 12px;">
        <div class="atomic-ai-header-icon">⚙</div>
        <div>
          <div style="font-weight: 700; font-size: 16px;">Δtomic AI Configuration</div>
          <div style="font-size: 11px; opacity: 0.8;">Multi-LLM Consensus Engine Settings</div>
        </div>
      </div>
      <button class="atomic-ai-close" onclick="closeAtomicAiConfig()" aria-label="Close Config">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <div class="atomic-ai-config-body">
      <!-- LLM Selection -->
      <div class="config-section">
        <div class="config-section-title">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--trust-teal)" stroke-width="2">
            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
            <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
            <line x1="12" y1="22.08" x2="12" y2="12"></line>
          </svg>
          LLM Model Selection
          <span class="operator-badge">CONSENSUS</span>
        </div>
        <div class="llm-grid">
          <label class="llm-option selected" onclick="toggleLlmSelection(this, &#39;claude&#39;)">
            <input type="checkbox" id="llm-claude" checked="">
            <div class="llm-option-info">
              <div class="llm-option-name">Claude Sonnet 4.5</div>
              <div class="llm-option-provider">Anthropic</div>
            </div>
            <div class="llm-option-weight">w=0.30</div>
          </label>
          <label class="llm-option selected" onclick="toggleLlmSelection(this, &#39;gpt4o&#39;)">
            <input type="checkbox" id="llm-gpt4o" checked="">
            <div class="llm-option-info">
              <div class="llm-option-name">GPT-4o</div>
              <div class="llm-option-provider">OpenAI</div>
            </div>
            <div class="llm-option-weight">w=0.25</div>
          </label>
          <label class="llm-option selected" onclick="toggleLlmSelection(this, &#39;gemini&#39;)">
            <input type="checkbox" id="llm-gemini" checked="">
            <div class="llm-option-info">
              <div class="llm-option-name">Gemini 1.5 Pro</div>
              <div class="llm-option-provider">Google</div>
            </div>
            <div class="llm-option-weight">w=0.25</div>
          </label>
          <label class="llm-option selected" onclick="toggleLlmSelection(this, &#39;llama&#39;)">
            <input type="checkbox" id="llm-llama" checked="">
            <div class="llm-option-info">
              <div class="llm-option-name">LLaMA 3.1 405B</div>
              <div class="llm-option-provider">Meta</div>
            </div>
            <div class="llm-option-weight">w=0.20</div>
          </label>
        </div>
      </div>

      <!-- Operator Weights -->
      <div class="config-section">
        <div class="config-section-title">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--trust-teal)" stroke-width="2">
            <line x1="4" y1="21" x2="4" y2="14"></line>
            <line x1="4" y1="10" x2="4" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="12"></line>
            <line x1="12" y1="8" x2="12" y2="3"></line>
            <line x1="20" y1="21" x2="20" y2="16"></line>
            <line x1="20" y1="12" x2="20" y2="3"></line>
            <line x1="1" y1="14" x2="7" y2="14"></line>
            <line x1="9" y1="8" x2="15" y2="8"></line>
            <line x1="17" y1="16" x2="23" y2="16"></line>
          </svg>
          ΦΨΔIPT Operator Weights
          <span class="operator-badge">TUNING</span>
        </div>

        <div class="weight-slider-group">
          <div class="weight-slider-label">
            <div class="weight-slider-name">
              <div class="operator-glyph phi" style="width: 20px; height: 20px; font-size: 11px;">Φ</div>
              <span>Zero-Start Truth Weight</span>
            </div>
            <span class="weight-slider-value" id="weightPhiValue">0.40</span>
          </div>
          <input type="range" class="weight-slider" id="weightPhi" min="0" max="100" value="40" oninput="updateWeightDisplay(&#39;phi&#39;, this.value)">
        </div>

        <div class="weight-slider-group">
          <div class="weight-slider-label">
            <div class="weight-slider-name">
              <div class="operator-glyph psi" style="width: 20px; height: 20px; font-size: 11px;">Ψ</div>
              <span>Credential-Decay Weight</span>
            </div>
            <span class="weight-slider-value" id="weightPsiValue">0.40</span>
          </div>
          <input type="range" class="weight-slider" id="weightPsi" min="0" max="100" value="40" oninput="updateWeightDisplay(&#39;psi&#39;, this.value)">
        </div>

        <div class="weight-slider-group">
          <div class="weight-slider-label">
            <div class="weight-slider-name">
              <div class="operator-glyph delta" style="width: 20px; height: 20px; font-size: 11px;">Δ</div>
              <span>Divergence Penalty</span>
            </div>
            <span class="weight-slider-value" id="weightDeltaValue">0.20</span>
          </div>
          <input type="range" class="weight-slider" id="weightDelta" min="0" max="100" value="20" oninput="updateWeightDisplay(&#39;delta&#39;, this.value)">
        </div>

        <div class="weight-slider-group">
          <div class="weight-slider-label">
            <div class="weight-slider-name">
              <div class="operator-glyph trust" style="width: 20px; height: 20px; font-size: 11px;">τ</div>
              <span>Decay Time Constant (days)</span>
            </div>
            <span class="weight-slider-value" id="weightTauValue">90</span>
          </div>
          <input type="range" class="weight-slider" id="weightTau" min="30" max="365" value="90" oninput="updateWeightDisplay(&#39;tau&#39;, this.value)">
        </div>
      </div>

      <!-- Emergent Operators -->
      <div class="config-section">
        <div class="config-section-title">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--trust-teal)" stroke-width="2">
            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
          </svg>
          Emergent Operators
          <span class="operator-badge">SELF-GOVERNANCE</span>
        </div>

        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 16px;">
          <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
            <div style="font-size: 20px; font-weight: 800; color: var(--trust-teal); margin-bottom: 4px;">Τ</div>
            <div style="font-size: 10px; font-weight: 700; color: var(--text-tertiary);">TRUST PROPAGATION</div>
            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Active</div>
          </div>
          <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
            <div style="font-size: 20px; font-weight: 800; color: var(--trust-teal); margin-bottom: 4px;">Β</div>
            <div style="font-size: 10px; font-weight: 700; color: var(--text-tertiary);">SEMANTIC BRIDGE</div>
            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Active</div>
          </div>
          <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
            <div style="font-size: 20px; font-weight: 800; color: var(--trust-teal); margin-bottom: 4px;">Ι</div>
            <div style="font-size: 10px; font-weight: 700; color: var(--text-tertiary);">COMPLIANCE INHERIT</div>
            <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">Active</div>
          </div>
        </div>
      </div>

      <!-- System Prompt -->
      <div class="config-section">
        <div class="config-section-title">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--trust-teal)" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
            <polyline points="10 9 9 9 8 9"></polyline>
          </svg>
          System Prompt
          <span class="operator-badge">HIDDEN</span>
        </div>
        <textarea class="system-prompt-textarea" id="systemPromptInput">You are Δtomic AI, a multi-LLM consensus copilot for the Atomic Trust compliance governance platform.

Your role is to assist users with:
- Understanding ΦΨΔIPT operators (Zero-Start Truth, Credential-Decay, Divergence, Trust)
- Analyzing compliance controls and evidence
- Finding cross-framework mappings via the Multi-Governance Fabric (MGF)
- Generating audit responses with cryptographic verification

Always cite specific controls (e.g., AC-1, SC-7) when relevant.
Provide confidence scores based on multi-model consensus.
Flag Byzantine conditions when Δ &gt; 0.15.</textarea>
        <div style="margin-top: 8px; font-size: 11px; color: var(--text-tertiary);">
          This prompt is prepended to all AI queries. Changes are logged to the audit trail.
        </div>
      </div>

      <!-- Self-Governance -->
      <div class="config-section">
        <div class="config-section-title">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--trust-teal)" stroke-width="2">
            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
          </svg>
          Self-Governance Mode
          <span class="operator-badge">EXPERIMENTAL</span>
        </div>

        <div class="governance-indicator">
          <div class="governance-status">
            <div class="governance-status-title">Autonomous Optimization</div>
            <div class="governance-status-detail">
              When enabled, the AI will use emergent operators to self-tune weights based on consensus quality. All adjustments are hashed to the audit log.
            </div>
          </div>
          <div class="governance-toggle" id="governanceToggle" onclick="toggleSelfGovernance()"></div>
        </div>

        <div id="governanceAlerts" style="margin-top: 12px; display: none;">
          <div style="padding: 12px; background: var(--amber-light); border: 1px solid var(--amber); border-radius: 8px;">
            <div style="font-size: 12px; font-weight: 700; color: var(--amber); margin-bottom: 4px;">⚠ Self-Governance Alert</div>
            <div style="font-size: 11px; color: var(--text-secondary);">
              Last adjustment: <span id="lastGovernanceAdjustment">None</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Database Context -->
      <div class="config-section">
        <div class="config-section-title">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--trust-teal)" stroke-width="2">
            <ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
            <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path>
            <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path>
          </svg>
          Database Context
          <span class="operator-badge">LIVE DATA</span>
        </div>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
          <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
            <div style="font-size: 20px; font-weight: 700; font-family: &#39;IBM Plex Mono&#39;, monospace;" id="dbControlCount">5</div>
            <div style="font-size: 10px; color: var(--text-tertiary);">CONTROLS</div>
          </div>
          <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
            <div style="font-size: 20px; font-weight: 700; font-family: &#39;IBM Plex Mono&#39;, monospace;" id="dbEvidenceCount">19</div>
            <div style="font-size: 10px; color: var(--text-tertiary);">EVIDENCE</div>
          </div>
          <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
            <div style="font-size: 20px; font-weight: 700; font-family: &#39;IBM Plex Mono&#39;, monospace;" id="dbFrameworkCount">8</div>
            <div style="font-size: 10px; color: var(--text-tertiary);">FRAMEWORKS</div>
          </div>
        </div>
        <div style="margin-top: 12px;">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" id="enableDbContext" checked="" style="width: 16px; height: 16px; accent-color: var(--trust-teal);">
            <span style="font-size: 12px;">Enable database-aware responses (query controls, evidence, frameworks)</span>
          </label>
        </div>
      </div>
    </div>

    <div class="atomic-ai-config-footer">
      <div class="config-hash" id="configHash">Config Hash: c20a94e7858e782b...</div>
      <div style="display: flex; gap: 12px;">
        <button class="btn btn-secondary" onclick="resetAtomicAiConfig()">Reset Defaults</button>
        <button class="btn btn-primary" onclick="saveAtomicAiConfig()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
            <polyline points="17 21 17 13 7 13 7 21"></polyline>
            <polyline points="7 3 7 8 15 8"></polyline>
          </svg>
          Save &amp; Apply
        </button>
      </div>
    </div>
  </div>

  <!-- Footer with IP Protections -->
  <footer style="position: fixed; bottom: 0; left: 80px; right: 0; padding: 12px 24px; background: rgba(26, 26, 46, 0.95); backdrop-filter: blur(8px); border-top: 1px solid rgba(255,255,255,0.1); font-size: 11px; color: rgba(255,255,255,0.7); display: flex; justify-content: space-between; align-items: center; z-index: 100; font-family: &#39;Inter&#39;, sans-serif;">
    <div>
      <strong style="color: white;">Δtomic Trust™</strong> — The Git of Governance™ | © 2025 Atomic Trust. All Rights Reserved.
    </div>
    <div style="text-align: right;">
      <strong style="color: var(--trust-teal);">PATENT PENDING</strong> — 10 U.S. Provisional Applications Filed Nov 2025
    </div>
  </footer>

  <script>

// =============================================================================
// ATOMIC TRUST KERNEL v2.0.0 - REAL MATH ENGINE
// =============================================================================

/**
 * Δtomic Trust™ Kernel v2.0.0 - Browser Edition
 * Complete implementation with real math, cryptographic hashing, and conservation enforcement
 * 
 * Patent-Protected: Zero-Start Truth Convergence, ΦΨΔIPT Operators, Conservation Laws
 * © 2025 Rafael Velado / Δtomic Δrtificial Intelligence Lδborδtory
 */

(function(global) {
  'use strict';

  // =============================================================================
  // CONSTANTS
  // =============================================================================
  
  const DOMAIN_EVIDENCE = 0x00;
  const DOMAIN_ENTITY = 0x01;
  const DOMAIN_LEDGER = 0x02;
  const DECIMAL_PLACES = 9;
  const CONSERVATION_EPSILON = 1e-9;
  const DEFAULT_LAMBDA = 0.01; // Decay rate per day
  const DEFAULT_TAU = 90; // Time constant in days
  const BYZANTINE_ZSCORE_THRESHOLD = 2.5;
  const PHI_PROBATIONARY = -8; // log-space for new entities
  const PHI_ESTABLISHED = 0;   // log-space for genesis entities

  // =============================================================================
  // BLAKE3 HASHING (via SubtleCrypto SHA-256 with domain separation)
  // =============================================================================

  class Blake3 {
    static async hash(data, domain = DOMAIN_EVIDENCE) {
      const encoder = new TextEncoder();
      const domainPrefix = new Uint8Array([domain]);
      
      // Canonical serialization
      const canonical = CanonicalSerializer.serialize(data);
      const dataBytes = encoder.encode(canonical);
      
      // Concatenate domain prefix + data
      const combined = new Uint8Array(domainPrefix.length + dataBytes.length);
      combined.set(domainPrefix, 0);
      combined.set(dataBytes, domainPrefix.length);
      
      // Hash using SubtleCrypto
      const hashBuffer = await crypto.subtle.digest('SHA-256', combined);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      
      return `blake3:${hashHex}`;
    }

    static async hashEvidence(data) {
      return this.hash(data, DOMAIN_EVIDENCE);
    }

    static async hashEntity(data) {
      return this.hash(data, DOMAIN_ENTITY);
    }

    static async hashLedger(data) {
      return this.hash(data, DOMAIN_LEDGER);
    }

    // Synchronous fallback for non-async contexts
    static hashSync(data, domain = DOMAIN_EVIDENCE) {
      const canonical = CanonicalSerializer.serialize(data);
      // Simple deterministic hash for sync contexts
      let hash = 0;
      const str = `${domain}:${canonical}`;
      for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32-bit integer
      }
      // Expand to 64 hex chars
      const seed = Math.abs(hash);
      let result = '';
      let current = seed;
      for (let i = 0; i < 64; i++) {
        current = (current * 1103515245 + 12345) & 0x7fffffff;
        result += (current % 16).toString(16);
      }
      return `blake3:${result}`;
    }
  }

  // =============================================================================
  // CANONICAL SERIALIZER
  // =============================================================================

  class CanonicalSerializer {
    static serialize(data) {
      if (data === null || data === undefined) return 'null';
      if (typeof data === 'boolean') return data.toString();
      if (typeof data === 'number') return this.serializeNumber(data);
      if (typeof data === 'string') return this.serializeString(data);
      if (Array.isArray(data)) return this.serializeArray(data);
      if (typeof data === 'object') return this.serializeObject(data);
      return String(data);
    }

    static serializeNumber(n) {
      if (!Number.isFinite(n)) return 'null';
      // ROUND_HALF_EVEN (banker's rounding) to DECIMAL_PLACES
      const factor = Math.pow(10, DECIMAL_PLACES);
      const shifted = n * factor;
      const floored = Math.floor(shifted);
      const decimal = shifted - floored;
      let rounded;
      if (decimal === 0.5) {
        // Round to even
        rounded = (floored % 2 === 0) ? floored : floored + 1;
      } else {
        rounded = Math.round(shifted);
      }
      return (rounded / factor).toFixed(DECIMAL_PLACES);
    }

    static serializeString(s) {
      // NFC normalization
      const normalized = s.normalize('NFC');
      return JSON.stringify(normalized);
    }

    static serializeArray(arr) {
      const items = arr.map(item => this.serialize(item));
      return `[${items.join(',')}]`;
    }

    static serializeObject(obj) {
      // Lexicographic key sorting
      const keys = Object.keys(obj).sort();
      const pairs = keys.map(key => {
        const value = this.serialize(obj[key]);
        return `${JSON.stringify(key)}:${value}`;
      });
      return `{${pairs.join(',')}}`;
    }
  }

  // =============================================================================
  // CONSERVATION LAW
  // =============================================================================

  class ConservationLaw {
    constructor(initialSum = 1.0) {
      this.K = initialSum;
      this.lastVerified = Date.now();
    }

    verify(weights) {
      const sum = weights.reduce((acc, w) => acc + w, 0);
      const conserved = Math.abs(sum - this.K) < CONSERVATION_EPSILON;
      this.lastVerified = Date.now();
      return {
        conserved,
        sum: parseFloat(sum.toFixed(DECIMAL_PLACES)),
        K: this.K,
        delta: parseFloat((sum - this.K).toFixed(DECIMAL_PLACES))
      };
    }

    normalize(weights) {
      const sum = weights.reduce((acc, w) => acc + w, 0);
      if (sum === 0) {
        // Distribute equally
        const equal = this.K / weights.length;
        return weights.map(() => parseFloat(equal.toFixed(DECIMAL_PLACES)));
      }
      const factor = this.K / sum;
      return weights.map(w => parseFloat((w * factor).toFixed(DECIMAL_PLACES)));
    }

    redistribute(weights, excludeIndices = []) {
      const activeIndices = weights.map((_, i) => i).filter(i => !excludeIndices.includes(i));
      const excludedSum = excludeIndices.reduce((acc, i) => acc + weights[i], 0);
      const redistributeAmount = excludedSum / activeIndices.length;
      
      return weights.map((w, i) => {
        if (excludeIndices.includes(i)) return 0;
        return parseFloat((w + redistributeAmount).toFixed(DECIMAL_PLACES));
      });
    }
  }

  // =============================================================================
  // CREDENTIAL DECAY (Ψ Operator)
  // =============================================================================

  class CredentialDecay {
    constructor(lambda = DEFAULT_LAMBDA, tau = DEFAULT_TAU) {
      this.lambda = lambda;
      this.tau = tau;
    }

    // Ψ(c, t) = c × exp(-λΔt)
    compute(credential, daysElapsed) {
      const decay = Math.exp(-this.lambda * daysElapsed);
      return parseFloat((credential * decay).toFixed(DECIMAL_PLACES));
    }

    // Inverse: given current Ψ and target, how many days?
    daysToDecay(currentPsi, targetPsi) {
      if (targetPsi >= currentPsi) return 0;
      if (targetPsi <= 0) return Infinity;
      return -Math.log(targetPsi / currentPsi) / this.lambda;
    }

    // Half-life in days
    get halfLife() {
      return Math.LN2 / this.lambda;
    }

    // Compute decay from ISO date strings
    computeFromDates(credential, lastReviewDate, currentDate = new Date()) {
      const last = new Date(lastReviewDate);
      const current = new Date(currentDate);
      const daysElapsed = (current - last) / (1000 * 60 * 60 * 24);
      return this.compute(credential, Math.max(0, daysElapsed));
    }
  }

  // =============================================================================
  // BYZANTINE DETECTOR (Δ Operator)
  // =============================================================================

  class ByzantineDetector {
    constructor(threshold = BYZANTINE_ZSCORE_THRESHOLD) {
      this.threshold = threshold;
      this.history = [];
    }

    // Compute divergence between expected and observed
    computeDivergence(expected, observed) {
      return parseFloat(Math.abs(expected - observed).toFixed(DECIMAL_PLACES));
    }

    // Z-score based detection
    detect(values) {
      if (values.length < 3) return { byzantine: [], scores: [] };
      
      const mean = values.reduce((a, b) => a + b, 0) / values.length;
      const variance = values.reduce((acc, v) => acc + Math.pow(v - mean, 2), 0) / values.length;
      const stdDev = Math.sqrt(variance);
      
      if (stdDev === 0) return { byzantine: [], scores: values.map(() => 0) };
      
      const scores = values.map(v => Math.abs((v - mean) / stdDev));
      const byzantine = scores.map((s, i) => s > this.threshold ? i : -1).filter(i => i >= 0);
      
      return {
        byzantine,
        scores: scores.map(s => parseFloat(s.toFixed(DECIMAL_PLACES))),
        mean: parseFloat(mean.toFixed(DECIMAL_PLACES)),
        stdDev: parseFloat(stdDev.toFixed(DECIMAL_PLACES))
      };
    }

    // Recoil penalty for detected Byzantine actors
    applyRecoil(weights, byzantineIndices, recoilFactor = 0.5) {
      return weights.map((w, i) => {
        if (byzantineIndices.includes(i)) {
          return parseFloat((w * recoilFactor).toFixed(DECIMAL_PLACES));
        }
        return w;
      });
    }

    // Record for pattern analysis
    record(entityId, divergence) {
      this.history.push({
        entityId,
        divergence,
        timestamp: Date.now()
      });
      // Keep last 1000 records
      if (this.history.length > 1000) {
        this.history = this.history.slice(-1000);
      }
    }
  }

  // =============================================================================
  // EVIDENCE STORE
  // =============================================================================

  class EvidenceStore {
    constructor() {
      this.evidence = new Map();
      this.byControl = new Map();
    }

    async add(evidence) {
      const hash = await Blake3.hashEvidence(evidence);
      const entry = {
        ...evidence,
        hash,
        addedAt: Date.now(),
        psi: 1.0 // Fresh evidence
      };
      this.evidence.set(evidence.id, entry);
      
      // Index by control
      const controlIds = evidence.controlIds || [evidence.controlId];
      for (const controlId of controlIds) {
        if (!this.byControl.has(controlId)) {
          this.byControl.set(controlId, new Set());
        }
        this.byControl.get(controlId).add(evidence.id);
      }
      
      return entry;
    }

    get(id) {
      return this.evidence.get(id);
    }

    getForControl(controlId) {
      const ids = this.byControl.get(controlId) || new Set();
      return Array.from(ids).map(id => this.evidence.get(id)).filter(Boolean);
    }

    all() {
      return Array.from(this.evidence.values());
    }

    // Apply decay to all evidence
    applyDecay(decayCalculator, currentDate = new Date()) {
      for (const [id, entry] of this.evidence) {
        const daysElapsed = (currentDate - entry.addedAt) / (1000 * 60 * 60 * 24);
        entry.psi = decayCalculator.compute(1.0, daysElapsed);
      }
    }
  }

  // =============================================================================
  // IMMUTABLE LEDGER
  // =============================================================================

  class Ledger {
    constructor() {
      this.entries = [];
      this.genesisHash = null;
    }

    async append(action, data, actor = 'system') {
      const prevHash = this.entries.length > 0 
        ? this.entries[this.entries.length - 1].hash 
        : 'genesis';
      
      const entry = {
        index: this.entries.length,
        timestamp: new Date().toISOString(),
        action,
        data,
        actor,
        prevHash
      };
      
      entry.hash = await Blake3.hashLedger(entry);
      this.entries.push(entry);
      
      if (this.entries.length === 1) {
        this.genesisHash = entry.hash;
      }
      
      return entry;
    }

    async verify() {
      if (this.entries.length === 0) return { valid: true, verified: 0 };
      
      for (let i = 0; i < this.entries.length; i++) {
        const entry = this.entries[i];
        const expectedPrevHash = i === 0 ? 'genesis' : this.entries[i - 1].hash;
        
        if (entry.prevHash !== expectedPrevHash) {
          return { valid: false, brokenAt: i, reason: 'prevHash mismatch' };
        }
        
        // Verify entry hash
        const { hash, ...entryWithoutHash } = entry;
        const computedHash = await Blake3.hashLedger(entryWithoutHash);
        if (computedHash !== hash) {
          return { valid: false, brokenAt: i, reason: 'hash mismatch' };
        }
      }
      
      return { valid: true, verified: this.entries.length };
    }

    getRange(start, end) {
      return this.entries.slice(start, end);
    }

    get length() {
      return this.entries.length;
    }
  }

  // =============================================================================
  // ENTITY REGISTRY
  // =============================================================================

  class EntityRegistry {
    constructor() {
      this.entities = new Map();
      this.conservation = new ConservationLaw(1.0);
    }

    register(id, options = {}) {
      const isGenesis = options.genesis || false;
      const phi = isGenesis ? PHI_ESTABLISHED : PHI_PROBATIONARY;
      
      const entity = {
        id,
        phi,
        psi: 1.0,
        delta: 0,
        trust: 0,
        omega: 0, // Will be computed
        isGenesis,
        isProbationary: !isGenesis,
        correctVotes: 0,
        registeredAt: Date.now(),
        lastActive: Date.now()
      };
      
      this.entities.set(id, entity);
      this._recomputeWeights();
      
      return entity;
    }

    _recomputeWeights() {
      const entities = Array.from(this.entities.values());
      if (entities.length === 0) return;
      
      // Compute raw weights from phi (log-space)
      const rawWeights = entities.map(e => Math.exp(e.phi));
      
      // Normalize to sum to K
      const normalized = this.conservation.normalize(rawWeights);
      
      // Apply back
      entities.forEach((e, i) => {
        e.omega = normalized[i];
        e.trust = this._computeTrust(e);
      });
    }

    _computeTrust(entity) {
      // Trust = weighted combination of Φ (performance) and Ψ (credential freshness)
      // Penalized by Δ (divergence)
      const phiNormalized = Math.exp(entity.phi) / (1 + Math.exp(entity.phi)); // Sigmoid
      const trust = (0.4 * phiNormalized + 0.4 * entity.psi) * (1 - 0.2 * entity.delta);
      return parseFloat(Math.max(0, Math.min(1, trust)).toFixed(DECIMAL_PLACES));
    }

    get(id) {
      return this.entities.get(id);
    }

    all() {
      return Array.from(this.entities.values());
    }

    updatePhi(id, deltaPhi) {
      const entity = this.entities.get(id);
      if (!entity) return null;
      
      entity.phi += deltaPhi;
      entity.lastActive = Date.now();
      
      // Check graduation
      if (entity.isProbationary && entity.correctVotes >= 10) {
        entity.isProbationary = false;
        entity.phi = Math.max(entity.phi, PHI_ESTABLISHED);
      }
      
      this._recomputeWeights();
      return entity;
    }

    recordVote(id, correct) {
      const entity = this.entities.get(id);
      if (!entity) return;
      
      if (correct) {
        entity.correctVotes++;
        this.updatePhi(id, 0.1);
      } else {
        this.updatePhi(id, -0.2);
      }
    }

    exclude(id) {
      const entity = this.entities.get(id);
      if (!entity) return;
      
      entity.phi = -Infinity;
      entity.omega = 0;
      entity.excluded = true;
      this._recomputeWeights();
    }

    getWeights() {
      return Array.from(this.entities.values()).map(e => e.omega);
    }

    verifyConservation() {
      const weights = this.getWeights();
      return this.conservation.verify(weights);
    }
  }

  // =============================================================================
  // ATOMIC TRUST KERNEL
  // =============================================================================

  class AtomicTrustKernel {
    constructor(options = {}) {
      this.entities = new EntityRegistry();
      this.evidence = new EvidenceStore();
      this.ledger = new Ledger();
      this.decay = new CredentialDecay(
        options.lambda || DEFAULT_LAMBDA,
        options.tau || DEFAULT_TAU
      );
      this.byzantine = new ByzantineDetector(
        options.byzantineThreshold || BYZANTINE_ZSCORE_THRESHOLD
      );
      
      this.epoch = 0;
      this.snapshots = [];
      this.initialized = false;
    }

    async initialize(genesisEntities = []) {
      // Register genesis entities
      for (const id of genesisEntities) {
        this.entities.register(id, { genesis: true });
      }
      
      // Log genesis
      await this.ledger.append('genesis', {
        entities: genesisEntities,
        timestamp: Date.now()
      });
      
      this.initialized = true;
      return this.getState();
    }

    async registerEntity(id, options = {}) {
      const entity = this.entities.register(id, options);
      
      await this.ledger.append('entity_registered', {
        entityId: id,
        isGenesis: options.genesis || false,
        phi: entity.phi
      });
      
      return entity;
    }

    async submitEvidence(evidence) {
      const entry = await this.evidence.add(evidence);
      
      await this.ledger.append('evidence_submitted', {
        evidenceId: evidence.id,
        hash: entry.hash,
        controlIds: evidence.controlIds || [evidence.controlId]
      });
      
      return entry;
    }

    async advanceTime(days) {
      // Apply decay to all entities
      const entities = this.entities.all();
      for (const entity of entities) {
        entity.psi = this.decay.compute(entity.psi, days);
        entity.trust = this.entities._computeTrust(entity);
      }
      
      // Apply decay to evidence
      this.evidence.applyDecay(this.decay);
      
      await this.ledger.append('time_advanced', {
        days,
        timestamp: Date.now()
      });
      
      return this.getState();
    }

    async runEpoch() {
      this.epoch++;
      const results = {
        epoch: this.epoch,
        stages: [],
        byzantineDetected: [],
        conservationHolds: true
      };

      // Stage 1: Collect votes/scores
      const entities = this.entities.all().filter(e => !e.excluded);
      const scores = entities.map(e => e.trust);
      results.stages.push({ name: 'collect', entities: entities.length });

      // Stage 2: Byzantine detection
      const detection = this.byzantine.detect(scores);
      if (detection.byzantine.length > 0) {
        for (const idx of detection.byzantine) {
          const entity = entities[idx];
          this.entities.exclude(entity.id);
          results.byzantineDetected.push(entity.id);
          this.byzantine.record(entity.id, detection.scores[idx]);
        }
      }
      results.stages.push({ name: 'byzantine', detected: detection.byzantine.length });

      // Stage 3: Verify conservation
      const conservation = this.entities.verifyConservation();
      results.conservationHolds = conservation.conserved;
      results.stages.push({ name: 'conservation', ...conservation });

      // Stage 4: Create snapshot
      const snapshot = await this.createSnapshot();
      results.stages.push({ name: 'snapshot', hash: snapshot.hash });

      // Log epoch
      await this.ledger.append('epoch_completed', results);

      return results;
    }

    async createSnapshot() {
      const state = this.getState();
      const hash = await Blake3.hash(state, DOMAIN_LEDGER);
      
      const snapshot = {
        epoch: this.epoch,
        timestamp: Date.now(),
        hash,
        entityCount: this.entities.all().length,
        evidenceCount: this.evidence.all().length,
        ledgerLength: this.ledger.length,
        conservation: this.entities.verifyConservation()
      };
      
      this.snapshots.push(snapshot);
      return snapshot;
    }

    async exportBundle() {
      const verification = await this.ledger.verify();
      
      return {
        version: '2.0.0',
        exportedAt: new Date().toISOString(),
        kernel: {
          epoch: this.epoch,
          lambda: this.decay.lambda,
          tau: this.decay.tau,
          byzantineThreshold: this.byzantine.threshold
        },
        entities: this.entities.all(),
        evidence: this.evidence.all(),
        ledger: this.ledger.entries,
        snapshots: this.snapshots,
        verification,
        conservation: this.entities.verifyConservation(),
        hash: await Blake3.hash({
          entities: this.entities.all(),
          evidence: this.evidence.all(),
          ledger: this.ledger.entries
        }, DOMAIN_LEDGER)
      };
    }

    getState() {
      return {
        epoch: this.epoch,
        entities: this.entities.all(),
        evidence: this.evidence.all(),
        conservation: this.entities.verifyConservation(),
        ledgerLength: this.ledger.length,
        snapshotCount: this.snapshots.length
      };
    }

    // Operator accessors
    getPhi(entityId) {
      const entity = this.entities.get(entityId);
      return entity ? entity.phi : null;
    }

    getPsi(entityId) {
      const entity = this.entities.get(entityId);
      return entity ? entity.psi : null;
    }

    getDelta(entityId) {
      const entity = this.entities.get(entityId);
      return entity ? entity.delta : null;
    }

    getTrust(entityId) {
      const entity = this.entities.get(entityId);
      return entity ? entity.trust : null;
    }

    getOmega(entityId) {
      const entity = this.entities.get(entityId);
      return entity ? entity.omega : null;
    }
  }

  // =============================================================================
  // CONTROL TRUST CALCULATOR
  // =============================================================================

  class ControlTrustCalculator {
    constructor(kernel) {
      this.kernel = kernel;
    }

    computeForControl(control, evidence = []) {
      const decay = this.kernel.decay;
      
      // Φ: Performance score based on evidence quality and coverage
      const phi = this._computePhi(control, evidence);
      
      // Ψ: Credential decay based on last review
      const psi = this._computePsi(control);
      
      // Δ: Divergence from expected baseline
      const delta = this._computeDelta(control, evidence);
      
      // Trust: Weighted combination with divergence penalty
      const trust = (0.4 * phi + 0.4 * psi) * (1 - 0.2 * delta);
      
      return {
        phi: parseFloat(phi.toFixed(DECIMAL_PLACES)),
        psi: parseFloat(psi.toFixed(DECIMAL_PLACES)),
        delta: parseFloat(delta.toFixed(DECIMAL_PLACES)),
        trust: parseFloat(Math.max(0, Math.min(1, trust)).toFixed(DECIMAL_PLACES))
      };
    }

    _computePhi(control, evidence) {
      if (evidence.length === 0) return 0;
      
      // Average evidence quality weighted by freshness
      let weightedSum = 0;
      let totalWeight = 0;
      
      for (const e of evidence) {
        const quality = e.quality_score || e.quality || 0.5;
        const freshness = e.psi || 1.0;
        weightedSum += quality * freshness;
        totalWeight += freshness;
      }
      
      return totalWeight > 0 ? weightedSum / totalWeight : 0;
    }

    _computePsi(control) {
      const lastReviewed = control.lastReviewed || control.last_reviewed;
      if (!lastReviewed) return 1.0;
      
      return this.kernel.decay.computeFromDates(1.0, lastReviewed);
    }

    _computeDelta(control, evidence) {
      // Divergence: difference between claimed and evidenced state
      const claimed = control.implementation_status === 'implemented' ? 1.0 : 
                     control.implementation_status === 'partial' ? 0.5 : 0;
      
      const evidenced = evidence.length > 0 
        ? evidence.filter(e => e.status === 'approved' || e.quality === 'high').length / evidence.length
        : 0;
      
      return Math.abs(claimed - evidenced);
    }
  }

  // =============================================================================
  // UI INTEGRATION HELPERS
  // =============================================================================

  class UIIntegration {
    constructor(kernel) {
      this.kernel = kernel;
      this.controlCalculator = new ControlTrustCalculator(kernel);
    }

    // Replace fake operator computation with real math
    computeOperators(control, evidence = []) {
      return this.controlCalculator.computeForControl(control, evidence);
    }

    // Generate verifiable hash
    async generateHash(data) {
      return Blake3.hash(data);
    }

    // Sync version for immediate use
    generateHashSync(data) {
      return Blake3.hashSync(data);
    }

    // Verify ledger integrity
    async verifyLedger() {
      return this.kernel.ledger.verify();
    }

    // Export for auditor
    async exportAuditBundle() {
      return this.kernel.exportBundle();
    }

    // Get conservation status
    getConservationStatus() {
      return this.kernel.entities.verifyConservation();
    }

    // Format for display
    formatTrustScore(trust) {
      return parseFloat(trust.toFixed(2));
    }

    formatWeight(omega) {
      return parseFloat(omega.toFixed(DECIMAL_PLACES));
    }
  }

  // =============================================================================
  // EXPORT
  // =============================================================================

  const AtomicTrust = {
    Kernel: AtomicTrustKernel,
    Blake3,
    CanonicalSerializer,
    ConservationLaw,
    CredentialDecay,
    ByzantineDetector,
    EvidenceStore,
    Ledger,
    EntityRegistry,
    ControlTrustCalculator,
    UIIntegration,
    
    // Constants
    DOMAIN_EVIDENCE,
    DOMAIN_ENTITY,
    DOMAIN_LEDGER,
    DECIMAL_PLACES,
    CONSERVATION_EPSILON,
    DEFAULT_LAMBDA,
    DEFAULT_TAU,
    BYZANTINE_ZSCORE_THRESHOLD,
    PHI_PROBATIONARY,
    PHI_ESTABLISHED,
    
    // Quick setup
    async create(options = {}) {
      const kernel = new AtomicTrustKernel(options);
      const ui = new UIIntegration(kernel);
      return { kernel, ui };
    }
  };

  // Expose globally
  if (typeof module !== 'undefined' && module.exports) {
    module.exports = AtomicTrust;
  } else {
    global.AtomicTrust = AtomicTrust;
  }

})(typeof window !== 'undefined' ? window : global);


// Kernel instance (initialized after page load)
let _KERNEL = null;
let _KERNEL_READY = false;

// Initialize kernel
(async function() {
  try {
    const { kernel, ui } = await AtomicTrust.create({ lambda: 0.01, tau: 90 });
    await kernel.initialize(['claude', 'gpt4o', 'gemini', 'llama']);
    _KERNEL = kernel;
    _KERNEL_READY = true;
    console.log('[Kernel] Ready. Conservation:', kernel.entities.verifyConservation());
  } catch(e) {
    console.error('[Kernel] Init failed:', e);
  }
})();

// Real operator computation (replaces Math.random)
function _computeOperators(seed) {
  if (!_KERNEL_READY) {
    // Deterministic fallback based on seed
    const h = Math.abs(hashCode(JSON.stringify(seed || {})));
    return {
      phi: 0.80 + (h % 20) / 100,
      psi: 0.85 + ((h >> 4) % 15) / 100,
      delta: 0.02 + ((h >> 8) % 10) / 100,
      trust: 0.82 + ((h >> 12) % 18) / 100
    };
  }
  // Use real kernel
  const decay = new AtomicTrust.CredentialDecay(0.01, 90);
  const phi = 0.85; // Base performance
  const psi = decay.compute(1.0, seed?.daysOld || 0);
  const delta = Math.min(0.3, Math.abs((seed?.expected || 0.9) - (seed?.observed || 0.85)));
  const trust = (0.4 * phi + 0.4 * psi) * (1 - 0.2 * delta);
  return {
    phi: parseFloat(phi.toFixed(2)),
    psi: parseFloat(psi.toFixed(2)),
    delta: parseFloat(delta.toFixed(2)),
    trust: parseFloat(Math.max(0, Math.min(1, trust)).toFixed(2))
  };
}

// Simple hash code for deterministic fallback
function hashCode(str) {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    hash = ((hash << 5) - hash) + str.charCodeAt(i);
    hash |= 0;
  }
  return hash;
}

// Export for console access
window.ATOMIC = {
  kernel: () => _KERNEL,
  ready: () => _KERNEL_READY,
  conservation: () => _KERNEL ? _KERNEL.entities.verifyConservation() : null,
  export: async () => _KERNEL ? await _KERNEL.exportBundle() : null,
  advanceTime: async (d) => _KERNEL ? await _KERNEL.advanceTime(d) : null,
  runEpoch: async () => _KERNEL ? await _KERNEL.runEpoch() : null
};

// =============================================================================
// LIVE STATE MANAGEMENT
// =============================================================================

// =============================================================================
// ATOMIC TRUST LIVE STATE MANAGEMENT
// Replaces hardcoded values with kernel-computed operators
// =============================================================================

const LIVE_STATE = {
  // Mirrors of original data, but with live-computed values
  controls: null,
  evidence: null,
  frameworks: null,
  equivalences: null,
  clauses: null,
  
  // Kernel reference
  kernel: null,
  decay: null,
  
  // Reference date for daysOld computation
  referenceDate: new Date(),
  
  // Initialization flag
  initialized: false
};

// =============================================================================
// INITIALIZATION - Convert static data to live state
// =============================================================================

function initializeLiveState() {
  if (LIVE_STATE.initialized) return;
  
  // Create decay calculator
  LIVE_STATE.decay = new AtomicTrust.CredentialDecay(0.01, 90);
  LIVE_STATE.referenceDate = new Date();
  
  // Deep clone and enhance CONTROLS
  // Back-calculate lastReviewed from original psi: Ψ = exp(-λ*t) => t = -ln(Ψ)/λ
  LIVE_STATE.controls = CONTROLS.map(c => {
    const originalPsi = c.psi || 1.0;
    const lambda = 0.01;
    // Calculate implied daysOld from psi (if psi=0.9, daysOld≈10.5; psi=0.8, daysOld≈22.3)
    const impliedDaysOld = originalPsi < 1.0 ? Math.round(-Math.log(originalPsi) / lambda) : 0;
    const lastReviewed = c.lastReviewed || new Date(Date.now() - impliedDaysOld * 86400000).toISOString();
    return {
      ...c,
      lastReviewed,
      daysOld: impliedDaysOld,
      _original: { phi: c.phi, psi: c.psi, delta: c.delta, trust: c.trust }
    };
  });
  
  // Deep clone and enhance EVIDENCE
  // Evidence already has uploadedAt dates, compute implied daysOld
  LIVE_STATE.evidence = EVIDENCE_LIBRARY.map(e => {
    const uploadDate = new Date(e.uploadedAt);
    const daysOld = Math.max(0, Math.floor((Date.now() - uploadDate.getTime()) / 86400000));
    return {
      ...e,
      daysOld,
      _original: { phi: e.phi, psi: e.psi }
    };
  });
  
  // Deep clone and enhance FRAMEWORKS
  // Frameworks already have lastReviewed, compute daysOld from actual date
  LIVE_STATE.frameworks = FRAMEWORKS.map(f => {
    const reviewDate = new Date(f.lastReviewed);
    const daysOld = Math.max(0, Math.floor((Date.now() - reviewDate.getTime()) / 86400000));
    return {
      ...f,
      daysOld,
      _original: { psi: f.psi, daysOld: f.daysOld }
    };
  });
  
  // Deep clone FRAMEWORK_EQUIVALENCES with nested clause enhancement
  LIVE_STATE.equivalences = FRAMEWORK_EQUIVALENCES.map(eq => ({
    ...eq,
    equivalentClauses: eq.equivalentClauses.map(clause => ({
      ...clause,
      _original: { phi: clause.phi, psi: clause.psi }
    }))
  }));
  
  // Deep clone CLAUSE_REPOSITORY
  if (typeof CLAUSE_REPOSITORY !== 'undefined') {
    LIVE_STATE.clauses = CLAUSE_REPOSITORY.map(c => {
      const reviewDate = new Date(c.lastReviewed);
      const daysOld = Math.max(0, Math.floor((Date.now() - reviewDate.getTime()) / 86400000));
      return {
        ...c,
        daysOld,
        _original: { phi: c.phi, psi: c.psi, daysOld: c.daysOld }
      };
    });
  }
  
  LIVE_STATE.initialized = true;
  console.log('[LiveState] Initialized with', {
    controls: LIVE_STATE.controls.length,
    evidence: LIVE_STATE.evidence.length,
    frameworks: LIVE_STATE.frameworks.length,
    equivalences: LIVE_STATE.equivalences.length
  });
  
  // Compute initial values
  recomputeAllOperators();
}

// =============================================================================
// OPERATOR COMPUTATION
// =============================================================================

function computeDaysOld(dateStr) {
  if (!dateStr) return 0;
  const date = new Date(dateStr);
  const diff = LIVE_STATE.referenceDate - date;
  return Math.max(0, Math.floor(diff / (1000 * 60 * 60 * 24)));
}

function computePsi(daysOld) {
  if (!LIVE_STATE.decay) return 1.0;
  return parseFloat(LIVE_STATE.decay.compute(1.0, daysOld).toFixed(2));
}

function computeControlOperators(control) {
  const daysOld = computeDaysOld(control.lastReviewed);
  const psi = computePsi(daysOld);
  
  // Phi based on evidence coverage
  const evidenceCount = control.evidence || 0;
  const phi = Math.min(0.99, 0.5 + (evidenceCount * 0.05));
  
  // Delta based on status
  let delta = 0.02;
  if (control.status === 'at-risk') delta = 0.15;
  if (control.status === 'critical') delta = 0.25;
  
  // Trust composite
  const trust = parseFloat(((0.4 * phi + 0.4 * psi) * (1 - 0.2 * delta)).toFixed(2));
  
  return {
    phi: parseFloat(phi.toFixed(2)),
    psi,
    delta: parseFloat(delta.toFixed(2)),
    trust: Math.max(0, Math.min(1, trust)),
    daysOld
  };
}

function computeEvidenceOperators(evidence) {
  const daysOld = computeDaysOld(evidence.uploadedAt);
  const psi = computePsi(daysOld);
  
  // Phi based on validation status
  let phi = 0.5;
  if (evidence.status === 'validated') phi = 0.9;
  if (evidence.status === 'pending') phi = 0.6;
  if (evidence.validatedBy && evidence.validatedBy.length > 1) phi += 0.05;
  
  return {
    phi: parseFloat(Math.min(0.99, phi).toFixed(2)),
    psi,
    daysOld
  };
}

function computeFrameworkOperators(framework) {
  const daysOld = computeDaysOld(framework.lastReviewed);
  const psi = computePsi(daysOld);
  
  return {
    psi,
    daysOld
  };
}

function computeClauseOperators(clause) {
  // Handle daysOld: use existing value if defined (including 0), otherwise compute from date
  let daysOld;
  if (typeof clause.daysOld === 'number') {
    daysOld = clause.daysOld;
  } else if (clause.lastReviewed) {
    daysOld = computeDaysOld(clause.lastReviewed);
  } else {
    daysOld = 0; // Default to fresh if no date info
  }
  
  const psi = computePsi(daysOld);
  
  return {
    phi: clause.phi || 0,
    psi,
    daysOld
  };
}

// =============================================================================
// RECOMPUTATION
// =============================================================================

function recomputeAllOperators() {
  if (!LIVE_STATE.initialized) {
    initializeLiveState();
    return;
  }
  
  console.log('[LiveState] Recomputing all operators...');
  
  // Update controls
  LIVE_STATE.controls.forEach(c => {
    const ops = computeControlOperators(c);
    Object.assign(c, ops);
  });
  
  // Update evidence
  LIVE_STATE.evidence.forEach(e => {
    const ops = computeEvidenceOperators(e);
    Object.assign(e, ops);
  });
  
  // Update frameworks
  LIVE_STATE.frameworks.forEach(f => {
    const ops = computeFrameworkOperators(f);
    Object.assign(f, ops);
  });
  
  // Update equivalences
  LIVE_STATE.equivalences.forEach(eq => {
    eq.equivalentClauses.forEach(clause => {
      // For clauses with dates, compute from date
      // For clauses without dates, use stored daysOld (which will be incremented on time advance)
      if (clause.lastReviewed) {
        clause.daysOld = computeDaysOld(clause.lastReviewed);
      }
      // Recompute psi from daysOld
      clause.psi = computePsi(clause.daysOld || 0);
    });
    // Update divergence based on clause psi variance
    const psiValues = eq.equivalentClauses.map(c => c.psi);
    const avgPsi = psiValues.reduce((a, b) => a + b, 0) / psiValues.length;
    const variance = psiValues.reduce((acc, p) => acc + Math.pow(p - avgPsi, 2), 0) / psiValues.length;
    eq.divergenceScore = parseFloat(Math.sqrt(variance).toFixed(2));
  });
  
  // Update clauses
  if (LIVE_STATE.clauses) {
    LIVE_STATE.clauses.forEach(c => {
      const ops = computeClauseOperators(c);
      Object.assign(c, ops);
    });
  }
  
  console.log('[LiveState] Recomputation complete');
}

// =============================================================================
// TIME ADVANCEMENT
// =============================================================================

function advanceLiveTime(days) {
  console.log(`[LiveState] Advancing time by ${days} days`);
  
  // Move reference date forward
  LIVE_STATE.referenceDate = new Date(LIVE_STATE.referenceDate.getTime() + days * 86400000);
  
  // Increment daysOld for items without explicit dates (they age with time)
  LIVE_STATE.equivalences.forEach(eq => {
    eq.equivalentClauses.forEach(clause => {
      if (!clause.lastReviewed) {
        // No date - increment daysOld directly
        clause.daysOld = (clause.daysOld || 0) + days;
      }
    });
  });
  
  // Recompute all operators with new reference date
  recomputeAllOperators();
  
  // Trigger UI refresh
  if (typeof showView === 'function' && STATE && STATE.currentView) {
    showView(STATE.currentView);
  }
  
  return {
    newDate: LIVE_STATE.referenceDate.toISOString(),
    daysMoved: days
  };
}

// =============================================================================
// PROPAGATION - Update related entities
// =============================================================================

function propagateControlUpdate(controlId, updates) {
  const control = LIVE_STATE.controls.find(c => c.id === controlId);
  if (!control) return null;
  
  // Apply updates
  Object.assign(control, updates);
  
  // Recompute operators
  const ops = computeControlOperators(control);
  Object.assign(control, ops);
  
  // Find related evidence and update their linked status
  LIVE_STATE.evidence.forEach(e => {
    if (e.linkedControls && e.linkedControls.some(lc => lc.includes(controlId.replace('UCP-', '')))) {
      // Evidence is linked to this control
      e._linkedControlUpdated = true;
    }
  });
  
  // Find related framework equivalences
  LIVE_STATE.equivalences.forEach(eq => {
    if (eq.controlId === controlId) {
      // Update equivalence divergence
      eq.semanticConfidence = Math.max(0.8, eq.semanticConfidence * (1 - control.delta));
    }
  });
  
  console.log(`[LiveState] Propagated update for ${controlId}`);
  return control;
}

function propagateEvidenceUpdate(evidenceId, updates) {
  const evidence = LIVE_STATE.evidence.find(e => e.id === evidenceId);
  if (!evidence) return null;
  
  // Apply updates
  Object.assign(evidence, updates);
  
  // Recompute operators
  const ops = computeEvidenceOperators(evidence);
  Object.assign(evidence, ops);
  
  // Update linked controls
  if (evidence.linkedControls) {
    evidence.linkedControls.forEach(linkedCtrl => {
      // Find controls that might match
      LIVE_STATE.controls.forEach(c => {
        if (c.frameworks && c.frameworks.some(f => linkedCtrl.includes(f.substring(0, 2)))) {
          // Increment evidence count
          c.evidence = (c.evidence || 0) + (updates.increment ? 1 : 0);
          // Recompute control operators
          const controlOps = computeControlOperators(c);
          Object.assign(c, controlOps);
        }
      });
    });
  }
  
  console.log(`[LiveState] Propagated update for ${evidenceId}`);
  return evidence;
}

function propagateFrameworkUpdate(frameworkId, updates) {
  const framework = LIVE_STATE.frameworks.find(f => f.id === frameworkId);
  if (!framework) return null;
  
  // Apply updates
  Object.assign(framework, updates);
  
  // Recompute operators
  const ops = computeFrameworkOperators(framework);
  Object.assign(framework, ops);
  
  // Update all equivalences that reference this framework
  LIVE_STATE.equivalences.forEach(eq => {
    eq.equivalentClauses.forEach(clause => {
      if (clause.framework.toLowerCase() === frameworkId.toLowerCase() ||
          clause.framework.toLowerCase().includes(frameworkId.toLowerCase())) {
        clause.psi = framework.psi;
        clause.daysOld = framework.daysOld;
      }
    });
  });
  
  console.log(`[LiveState] Propagated update for framework ${frameworkId}`);
  return framework;
}

// =============================================================================
// DATA ACCESSORS - Override original functions
// =============================================================================

// Store original functions
const _originalGetControls = typeof getControls === 'function' ? getControls : null;
const _originalGetEvidence = typeof getEvidence === 'function' ? getEvidence : null;
const _originalGetAllFrameworks = typeof getAllFrameworks === 'function' ? getAllFrameworks : null;

// Override getControls
function getLiveControls() {
  if (!LIVE_STATE.initialized) initializeLiveState();
  
  // If API data exists, merge with live computed values
  if (API_DATA && API_DATA.controls && API_DATA.controls.length > 0) {
    return API_DATA.controls.map(c => {
      const live = LIVE_STATE.controls.find(lc => lc.id === c.id);
      if (live) {
        return { ...c, phi: live.phi, psi: live.psi, delta: live.delta, trust: live.trust };
      }
      return c;
    });
  }
  
  return LIVE_STATE.controls;
}

// Override getEvidence
function getLiveEvidence() {
  if (!LIVE_STATE.initialized) initializeLiveState();
  
  if (API_DATA && API_DATA.evidence && API_DATA.evidence.length > 0) {
    return API_DATA.evidence.map(e => {
      const live = LIVE_STATE.evidence.find(le => le.id === e.id);
      if (live) {
        return { ...e, phi: live.phi, psi: live.psi };
      }
      return e;
    });
  }
  
  return LIVE_STATE.evidence;
}

// Override getAllFrameworks
function getLiveFrameworks() {
  if (!LIVE_STATE.initialized) initializeLiveState();
  
  const builtIn = LIVE_STATE.frameworks.map(f => ({
    ...f,
    type: 'built-in',
    source_type: 'built-in'
  }));

  const ingested = (FRAMEWORK_DATA && FRAMEWORK_DATA.ingested || []).map(f => ({
    id: f.id,
    name: f.name,
    version: 'Ingested',
    totalClauses: f.controls_count || 0,
    mappedClauses: f.controls_count || 0,
    coverage: 1,
    psi: parseFloat(f.operators?.psi) || computePsi(computeDaysOld(f.ingestion_date)),
    lastReviewed: f.ingestion_date,
    daysOld: computeDaysOld(f.ingestion_date),
    status: f.status === 'complete' ? 'active' : 'pending',
    type: 'ingested',
    source_type: f.source_type,
    operators: f.operators ? {
      phi: parseFloat(f.operators.phi) || 0,
      psi: parseFloat(f.operators.psi) || 1,
      delta: parseFloat(f.operators.delta) || 0,
      trust: parseFloat(f.operators.trust) || 0
    } : { phi: 0, psi: 1, delta: 0, trust: 0 }
  }));

  return [...builtIn, ...ingested];
}

// Get live equivalences
function getLiveEquivalences() {
  if (!LIVE_STATE.initialized) initializeLiveState();
  return LIVE_STATE.equivalences;
}

// Get live clauses
function getLiveClauses() {
  if (!LIVE_STATE.initialized) initializeLiveState();
  return LIVE_STATE.clauses || CLAUSE_REPOSITORY;
}

// =============================================================================
// INSTALL OVERRIDES
// =============================================================================

function installLiveStateOverrides() {
  // Override global accessor functions
  window.getControls = getLiveControls;
  window.getEvidence = getLiveEvidence;
  window.getAllFrameworks = getLiveFrameworks;
  window.getEquivalences = getLiveEquivalences;
  window.getClauses = getLiveClauses;
  
  // Add live state accessors (aliases)
  window.getLiveEquivalences = getLiveEquivalences;
  window.getLiveClauses = getLiveClauses;
  
  // Override FRAMEWORK_EQUIVALENCES getter if used directly
  Object.defineProperty(window, 'LIVE_FRAMEWORK_EQUIVALENCES', {
    get: () => LIVE_STATE.equivalences
  });
  
  console.log('[LiveState] Overrides installed');
}

// =============================================================================
// EXPORT TO WINDOW
// =============================================================================

window.LIVE_STATE = LIVE_STATE;
window.initializeLiveState = initializeLiveState;
window.recomputeAllOperators = recomputeAllOperators;
window.advanceLiveTime = advanceLiveTime;
window.propagateControlUpdate = propagateControlUpdate;
window.propagateEvidenceUpdate = propagateEvidenceUpdate;
window.propagateFrameworkUpdate = propagateFrameworkUpdate;
window.installLiveStateOverrides = installLiveStateOverrides;

// Auto-initialize on DOM ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    initializeLiveState();
    installLiveStateOverrides();
  });
} else {
  setTimeout(() => {
    initializeLiveState();
    installLiveStateOverrides();
  }, 100);
}

console.log('[LiveState] Module loaded');


// =============================================================================
// ============================================
// ATOMIC TRUST SYSTEM - STELLAR EDITION
// ============================================

// ---- API CONFIGURATION ----

const CONFIG = {
  // PRODUCTION VERSION - Connected to real backend
  simulationMode: false,  // Set to false for production with real API
  useRealAPI: true,       // Enable real API calls

  // Backend endpoints - Updated for Atomic Trust SDK
  apiBase: 'http://localhost:8000',      // Atomic Trust SDK Kernel API
  consensusBase: 'http://localhost:3009', // Multi-LLM Consensus Service
  
  endpoints: {
    // Kernel Core
    health: "/health",
    agents: "/agents",
    votes: "/votes",
    decisions: "/decisions",
    
    // GRC Module (NEW - from grc_api.py)
    grcControls: "/grc/controls",
    grcEvidence: "/grc/evidence",
    grcFrameworks: "/grc/frameworks",
    grcEquivalences: "/grc/equivalences",
    grcStats: "/grc/stats",
    
    // Multi-LLM Consensus (port 3009)
    consensus: "/consensus",
    consensusInit: "/consensus/init-agents",
    
    // Legacy endpoints (for backward compatibility)
    truthValidate: "/v1/truth/validate",
    snapshotCreate: "/v1/snapshot/create",
    evidenceUpload: "/v1/evidence/upload",
    evidenceControls: "/v1/evidence/controls",
    evidenceSummary: "/v1/evidence/summary",
    consensusCheck: "/v1/consensus/check",
    auditLog: "/v1/audit/entries",
    auditVerify: "/v1/audit/verify",
    // Framework Mapping endpoints
    frameworkIngest: "/v1/mapping/ingest",
    frameworkIngested: "/v1/mapping/ingested",
    frameworkAvailable: "/v1/mapping/available",
    frameworkIntersections: "/v1/mapping/intersections",
    frameworkCompare: "/v1/mapping/compare",
    frameworkEmergent: "/v1/mapping/emergent"
  }
};

// Track API connection status
let apiConnected = false;
let lastApiCheck = null;

// Check if backend is reachable
async function checkBackendHealth() {
  if (!CONFIG.useRealAPI || !CONFIG.apiBase) {
    apiConnected = false;
    return false;
  }

  try {
    const response = await fetch(`${CONFIG.apiBase}/health`, {
      method: 'GET',
      signal: AbortSignal.timeout(5000)
    });
    apiConnected = response.ok;
    lastApiCheck = new Date();
    updateApiStatus();
    return apiConnected;
  } catch (err) {
    console.warn('[API] Backend health check failed:', err.message);
    apiConnected = false;
    updateApiStatus();
    return false;
  }
}

// Update API status indicator in UI
function updateApiStatus() {
  const statusEl = document.getElementById('apiStatus');
  if (!statusEl) return;

  if (apiConnected) {
    statusEl.innerHTML = `<span style="color: #10B981;">●</span> Connected to Backend`;
    statusEl.title = "Connected to real API backend";
  } else if (CONFIG.useRealAPI) {
    statusEl.innerHTML = `<span style="color: #F59E0B;">●</span> Connecting...`;
    statusEl.title = "Attempting to connect to backend";
  } else {
    statusEl.innerHTML = `<span style="color: #3B82F6;">●</span> Demo Mode (Simulated Data)`;
    statusEl.title = "All data shown is simulated";
  }
}

// Toggle API mode
function toggleApiMode() {
  if (apiConnected) {
    showToast('Connected to real backend API', 'success');
  } else {
    showToast('Using simulated data — backend not connected', 'info');
  }
}
window.toggleApiMode = toggleApiMode;

// API Adapter Layer - Single source of truth for backend calls
const API = {
  async truthValidate(claim) {
    if (!CONFIG.useRealAPI || !apiConnected) {
      // Simulated response
      await new Promise(resolve => setTimeout(resolve, 800)); // Simulate network delay
      return {
        ..._computeOperators({ claim }),
        llm_consensus: [
          { model: "Claude Sonnet 4.5", verdict: "compliant", confidence: 0.94 },
          { model: "GPT-4o", verdict: "compliant", confidence: 0.91 },
          { model: "Gemini 1.5 Pro", verdict: "compliant", confidence: 0.93 },
          { model: "LLaMA 3.1 405B", verdict: "compliant", confidence: 0.89 }
        ],
        snapshot_id: STATE.currentSnapshot,
        hash: generateHash({ claim, timestamp: Date.now() }),
        simulated: true
      };
    }
    
    // Real API call
    try {
      const resp = await fetch(`${CONFIG.apiBase}${CONFIG.endpoints.truthValidate}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ claim }),
        signal: AbortSignal.timeout(10000) // 10 second timeout
      });
      
      if (!resp.ok) {
        throw new Error(`Truth Engine returned ${resp.status}: ${resp.statusText}`);
      }
      
      const data = await resp.json();
      console.log('[API] Truth validation response:', data);
      return data;
    } catch (err) {
      console.error('[API] Truth validation failed:', err);
      showToast(`Backend error: ${err.message}. Using simulation.`, 'error');
      apiConnected = false;
      updateApiStatus();
      
      // Fallback to simulation
      return this.truthValidate(claim);
    }
  },

  async createSnapshot(data) {
    if (!CONFIG.useRealAPI || !apiConnected) {
      await new Promise(resolve => setTimeout(resolve, 600));
      return {
        snapshot_id: STATE.currentSnapshot + 1,
        hash: generateHash(data),
        timestamp: new Date().toISOString(),
        simulated: true
      };
    }
    
    try {
      const resp = await fetch(`${CONFIG.apiBase}${CONFIG.endpoints.snapshotCreate}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
        signal: AbortSignal.timeout(10000)
      });
      
      if (!resp.ok) {
        throw new Error(`Snapshot creation returned ${resp.status}`);
      }
      
      const result = await resp.json();
      console.log('[API] Snapshot created:', result);
      return result;
    } catch (err) {
      console.error('[API] Snapshot creation failed:', err);
      showToast(`Snapshot error: ${err.message}. Using simulation.`, 'error');
      apiConnected = false;
      updateApiStatus();
      
      // Fallback to simulation
      return this.createSnapshot(data);
    }
  },

  async checkConsensus(controlId) {
    if (!CONFIG.useRealAPI || !apiConnected) {
      await new Promise(resolve => setTimeout(resolve, 500));
      return {
        consensus: "unanimous",
        agreement: 1.0,
        models: 4,
        timestamp: new Date().toISOString(),
        simulated: true
      };
    }
    
    try {
      const resp = await fetch(`${CONFIG.apiBase}${CONFIG.endpoints.consensusCheck}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ control_id: controlId }),
        signal: AbortSignal.timeout(10000)
      });
      
      if (!resp.ok) {
        throw new Error(`Consensus check returned ${resp.status}`);
      }
      
      const result = await resp.json();
      console.log('[API] Consensus check:', result);
      return result;
    } catch (err) {
      console.error('[API] Consensus check failed:', err);
      apiConnected = false;
      updateApiStatus();
      
      // Fallback to simulation
      return this.checkConsensus(controlId);
    }
  },

  // Fetch all controls from API
  async getControls(limit = 100, offset = 0) {
    if (!CONFIG.useRealAPI || !apiConnected) {
      return { controls: CONTROLS, total: CONTROLS.length, fromAPI: false };
    }

    try {
      const resp = await fetch(`${CONFIG.apiBase}${CONFIG.endpoints.evidenceControls}?limit=${limit}&offset=${offset}`, {
        method: "GET",
        signal: AbortSignal.timeout(10000)
      });

      if (!resp.ok) {
        throw new Error(`Controls API returned ${resp.status}`);
      }

      const data = await resp.json();
      console.log(`[API] Fetched ${data.controls.length} controls (total: ${data.total})`);
      return { ...data, fromAPI: true };
    } catch (err) {
      console.error('[API] Get controls failed:', err);
      return { controls: CONTROLS, total: CONTROLS.length, fromAPI: false };
    }
  },

  // Fetch single control with evidence
  async getControlWithEvidence(controlId) {
    if (!CONFIG.useRealAPI || !apiConnected) {
      const control = CONTROLS.find(c => c.id === controlId);
      const evidence = EVIDENCE.filter(e => e.controlId === controlId);
      return { control, evidence, fromAPI: false };
    }

    try {
      const resp = await fetch(`${CONFIG.apiBase}${CONFIG.endpoints.evidenceControls}/${controlId}/with-evidence`, {
        method: "GET",
        signal: AbortSignal.timeout(10000)
      });

      if (!resp.ok) {
        throw new Error(`Control API returned ${resp.status}`);
      }

      const data = await resp.json();
      console.log(`[API] Fetched control ${controlId} with ${data.evidence?.length || 0} evidence items`);
      return { control: data, evidence: data.evidence || [], fromAPI: true };
    } catch (err) {
      console.error('[API] Get control failed:', err);
      const control = CONTROLS.find(c => c.id === controlId);
      const evidence = EVIDENCE.filter(e => e.controlId === controlId);
      return { control, evidence, fromAPI: false };
    }
  },

  // Fetch compliance summary
  async getSummary() {
    if (!CONFIG.useRealAPI || !apiConnected) {
      return {
        total: CONTROLS.length,
        compliant: CONTROLS.filter(c => c.status === 'compliant').length,
        at_risk: CONTROLS.filter(c => c.status === 'at-risk').length,
        critical: CONTROLS.filter(c => c.status === 'critical').length,
        avg_trust: CONTROLS.reduce((sum, c) => sum + c.trust, 0) / CONTROLS.length,
        fromAPI: false
      };
    }

    try {
      const resp = await fetch(`${CONFIG.apiBase}${CONFIG.endpoints.evidenceSummary}`, {
        method: "GET",
        signal: AbortSignal.timeout(10000)
      });

      if (!resp.ok) {
        throw new Error(`Summary API returned ${resp.status}`);
      }

      const data = await resp.json();
      console.log('[API] Fetched summary:', data);
      return { ...data, fromAPI: true };
    } catch (err) {
      console.error('[API] Get summary failed:', err);
      return {
        total: CONTROLS.length,
        compliant: CONTROLS.filter(c => c.status === 'compliant').length,
        at_risk: CONTROLS.filter(c => c.status === 'at-risk').length,
        critical: CONTROLS.filter(c => c.status === 'critical').length,
        avg_trust: CONTROLS.reduce((sum, c) => sum + c.trust, 0) / CONTROLS.length,
        fromAPI: false
      };
    }
  },

  // Fetch all evidence
  async getAllEvidence(limit = 100, offset = 0) {
    if (!CONFIG.useRealAPI || !apiConnected) {
      return { evidence: EVIDENCE, total: EVIDENCE.length, fromAPI: false };
    }

    try {
      const resp = await fetch(`${CONFIG.apiBase}/v1/evidence/all?limit=${limit}&offset=${offset}`, {
        method: "GET",
        signal: AbortSignal.timeout(10000)
      });

      if (!resp.ok) {
        throw new Error(`Evidence API returned ${resp.status}`);
      }

      const data = await resp.json();
      console.log(`[API] Fetched ${data.evidence.length} evidence items (total: ${data.total})`);
      return { ...data, fromAPI: true };
    } catch (err) {
      console.error('[API] Get all evidence failed:', err);
      return { evidence: EVIDENCE, total: EVIDENCE.length, fromAPI: false };
    }
  },

  // Fetch single evidence item
  async getEvidence(evidenceId) {
    if (!CONFIG.useRealAPI || !apiConnected) {
      return { evidence: EVIDENCE.find(e => e.id === evidenceId), fromAPI: false };
    }

    try {
      const resp = await fetch(`${CONFIG.apiBase}/v1/evidence/${evidenceId}`, {
        method: "GET",
        signal: AbortSignal.timeout(10000)
      });

      if (!resp.ok) {
        throw new Error(`Evidence API returned ${resp.status}`);
      }

      const data = await resp.json();
      console.log(`[API] Fetched evidence ${evidenceId}`);
      return { evidence: data, fromAPI: true };
    } catch (err) {
      console.error('[API] Get evidence failed:', err);
      return { evidence: EVIDENCE.find(e => e.id === evidenceId), fromAPI: false };
    }
  },

  // ---- AUDIT LOG API METHODS ----

  // Fetch audit log entries
  async getAuditEntries(limit = 50, offset = 0, filters = {}) {
    if (!CONFIG.useRealAPI || !apiConnected) {
      return { entries: STATE.auditLog.slice(-limit).reverse(), total: STATE.auditLog.length, fromAPI: false };
    }

    try {
      const params = new URLSearchParams({ limit, offset, ...filters });
      const resp = await fetch(`${CONFIG.apiBase}${CONFIG.endpoints.auditLog}?${params}`, {
        method: "GET",
        signal: AbortSignal.timeout(10000)
      });

      if (!resp.ok) {
        throw new Error(`Audit API returned ${resp.status}`);
      }

      const data = await resp.json();
      console.log(`[API] Fetched ${data.entries.length} audit entries (total: ${data.total})`);
      return { ...data, fromAPI: true };
    } catch (err) {
      console.error('[API] Get audit entries failed:', err);
      return { entries: STATE.auditLog.slice(-limit).reverse(), total: STATE.auditLog.length, fromAPI: false };
    }
  },

  // Verify audit chain integrity
  async verifyAuditChain() {
    if (!CONFIG.useRealAPI || !apiConnected) {
      return { valid: true, verified: STATE.auditLog.length, total: STATE.auditLog.length, fromAPI: false };
    }

    try {
      const resp = await fetch(`${CONFIG.apiBase}${CONFIG.endpoints.auditVerify}`, {
        method: "GET",
        signal: AbortSignal.timeout(10000)
      });

      if (!resp.ok) {
        throw new Error(`Audit verify API returned ${resp.status}`);
      }

      const data = await resp.json();
      console.log('[API] Audit chain verification:', data);
      return { ...data, fromAPI: true };
    } catch (err) {
      console.error('[API] Verify audit chain failed:', err);
      return { valid: true, verified: STATE.auditLog.length, total: STATE.auditLog.length, fromAPI: false };
    }
  },

  // Get audit statistics
  async getAuditStatistics(days = 30) {
    if (!CONFIG.useRealAPI || !apiConnected) {
      return { total_entries: STATE.auditLog.length, fromAPI: false };
    }

    try {
      const resp = await fetch(`${CONFIG.apiBase}/v1/audit/statistics?days=${days}`, {
        method: "GET",
        signal: AbortSignal.timeout(10000)
      });

      if (!resp.ok) {
        throw new Error(`Audit statistics API returned ${resp.status}`);
      }

      const data = await resp.json();
      console.log('[API] Audit statistics:', data);
      return { ...data, fromAPI: true };
    } catch (err) {
      console.error('[API] Get audit statistics failed:', err);
      return { total_entries: STATE.auditLog.length, fromAPI: false };
    }
  },

  // Log audit entry to backend
  async logAuditEntry(action, resourceType, resourceId, details = {}) {
    if (!CONFIG.useRealAPI || !apiConnected) {
      return { success: false, fromAPI: false };
    }

    try {
      const resp = await fetch(`${CONFIG.apiBase}/v1/audit/log`, {
        method: "POST",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action,
          actor_id: 'demo-user',
          actor_type: 'user',
          resource_type: resourceType,
          resource_id: resourceId,
          details,
          severity: 'info'
        }),
        signal: AbortSignal.timeout(10000)
      });

      if (!resp.ok) {
        throw new Error(`Audit log API returned ${resp.status}`);
      }

      console.log(`[API] Logged audit entry: ${action}`);
      return { success: true, fromAPI: true };
    } catch (err) {
      console.error('[API] Log audit entry failed:', err);
      return { success: false, fromAPI: false };
    }
  },

  // ---- FRAMEWORK MAPPING API METHODS ----

  // Ingest a new framework via multi-LLM consensus
  async ingestFramework(name, description, content, sourceType = 'text') {
    if (!CONFIG.useRealAPI || !apiConnected) {
      // Simulated ingestion
      await new Promise(resolve => setTimeout(resolve, 2000));
      return {
        success: true,
        framework: {
          id: `INGESTED-${name.toUpperCase().replace(/[^A-Z0-9]/g, '-')}-${Date.now()}`,
          name,
          description,
          source_type: sourceType,
          status: 'complete',
          controls_extracted: Math.floor(Math.random() * 100) + 20,
          operators: {
            ..._computeOperators({ id: 'framework' })
          }
        },
        fromAPI: false
      };
    }

    try {
      const resp = await fetch(`${CONFIG.apiBase}${CONFIG.endpoints.frameworkIngest}`, {
        method: "POST",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, description, content, source_type: sourceType }),
        signal: AbortSignal.timeout(60000)  // 60 second timeout for ingestion
      });

      if (!resp.ok) {
        throw new Error(`Framework ingestion returned ${resp.status}`);
      }

      const data = await resp.json();
      console.log('[API] Framework ingested:', data);
      return { ...data, fromAPI: true };
    } catch (err) {
      console.error('[API] Framework ingestion failed:', err);
      showToast(`Ingestion error: ${err.message}`, 'error');
      return { success: false, error: err.message, fromAPI: false };
    }
  },

  // Get all ingested frameworks
  async getIngestedFrameworks() {
    if (!CONFIG.useRealAPI || !apiConnected) {
      return { frameworks: [], count: 0, fromAPI: false };
    }

    try {
      const resp = await fetch(`${CONFIG.apiBase}${CONFIG.endpoints.frameworkIngested}`, {
        method: "GET",
        signal: AbortSignal.timeout(10000)
      });

      if (!resp.ok) {
        throw new Error(`Ingested frameworks API returned ${resp.status}`);
      }

      const data = await resp.json();
      console.log(`[API] Fetched ${data.count} ingested frameworks`);
      return { ...data, fromAPI: true };
    } catch (err) {
      console.error('[API] Get ingested frameworks failed:', err);
      return { frameworks: [], count: 0, fromAPI: false };
    }
  },

  // Get single ingested framework details
  async getIngestedFramework(frameworkId) {
    if (!CONFIG.useRealAPI || !apiConnected) {
      return { framework: null, fromAPI: false };
    }

    try {
      const resp = await fetch(`${CONFIG.apiBase}${CONFIG.endpoints.frameworkIngested}/${frameworkId}`, {
        method: "GET",
        signal: AbortSignal.timeout(10000)
      });

      if (!resp.ok) {
        throw new Error(`Ingested framework API returned ${resp.status}`);
      }

      const data = await resp.json();
      console.log(`[API] Fetched ingested framework ${frameworkId}`);
      return { ...data, fromAPI: true };
    } catch (err) {
      console.error('[API] Get ingested framework failed:', err);
      return { framework: null, fromAPI: false };
    }
  },

  // Get all available frameworks (built-in + ingested)
  async getAvailableFrameworks() {
    if (!CONFIG.useRealAPI || !apiConnected) {
      return {
        built_in: FRAMEWORKS.filter(f => f.status === 'active').map(f => ({ id: f.id, name: f.name, type: 'built-in' })),
        ingested: [],
        database: [],
        fromAPI: false
      };
    }

    try {
      const resp = await fetch(`${CONFIG.apiBase}${CONFIG.endpoints.frameworkAvailable}`, {
        method: "GET",
        signal: AbortSignal.timeout(10000)
      });

      if (!resp.ok) {
        throw new Error(`Available frameworks API returned ${resp.status}`);
      }

      const data = await resp.json();
      console.log(`[API] Fetched ${data.total} available frameworks`);
      return { ...data, fromAPI: true };
    } catch (err) {
      console.error('[API] Get available frameworks failed:', err);
      return {
        built_in: FRAMEWORKS.filter(f => f.status === 'active').map(f => ({ id: f.id, name: f.name, type: 'built-in' })),
        ingested: [],
        database: [],
        fromAPI: false
      };
    }
  },

  // Find intersections between two frameworks
  async findFrameworkIntersections(frameworkA, frameworkB, minSimilarity = 0.3) {
    if (!CONFIG.useRealAPI || !apiConnected) {
      return { intersections: [], total_intersections: 0, fromAPI: false };
    }

    try {
      const resp = await fetch(`${CONFIG.apiBase}${CONFIG.endpoints.frameworkIntersections}`, {
        method: "POST",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ framework_a: frameworkA, framework_b: frameworkB, min_similarity: minSimilarity }),
        signal: AbortSignal.timeout(30000)
      });

      if (!resp.ok) {
        throw new Error(`Framework intersections API returned ${resp.status}`);
      }

      const data = await resp.json();
      console.log(`[API] Found ${data.total_intersections} intersections between ${frameworkA} and ${frameworkB}`);
      return { ...data, fromAPI: true };
    } catch (err) {
      console.error('[API] Find intersections failed:', err);
      return { intersections: [], total_intersections: 0, fromAPI: false };
    }
  },

  // Compare multiple frameworks
  async compareFrameworks(frameworkIds) {
    if (!CONFIG.useRealAPI || !apiConnected) {
      return { frameworks: frameworkIds, total_controls: [], coverage_matrix: {}, emergent_operators: [], fromAPI: false };
    }

    try {
      const resp = await fetch(`${CONFIG.apiBase}${CONFIG.endpoints.frameworkCompare}`, {
        method: "POST",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ frameworks: frameworkIds }),
        signal: AbortSignal.timeout(60000)
      });

      if (!resp.ok) {
        throw new Error(`Framework compare API returned ${resp.status}`);
      }

      const data = await resp.json();
      console.log(`[API] Compared ${data.frameworks.length} frameworks`);
      return { ...data, fromAPI: true };
    } catch (err) {
      console.error('[API] Compare frameworks failed:', err);
      return { frameworks: frameworkIds, total_controls: [], coverage_matrix: {}, emergent_operators: [], fromAPI: false };
    }
  },

  // Discover emergent operators
  async discoverEmergentOperators(frameworkIds) {
    if (!CONFIG.useRealAPI || !apiConnected) {
      return { operators: [], total_emergent_operators: 0, fromAPI: false };
    }

    try {
      const resp = await fetch(`${CONFIG.apiBase}${CONFIG.endpoints.frameworkEmergent}`, {
        method: "POST",
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ frameworks: frameworkIds }),
        signal: AbortSignal.timeout(30000)
      });

      if (!resp.ok) {
        throw new Error(`Emergent operators API returned ${resp.status}`);
      }

      const data = await resp.json();
      console.log(`[API] Discovered ${data.total_emergent_operators} emergent operators`);
      return { ...data, fromAPI: true };
    } catch (err) {
      console.error('[API] Discover emergent operators failed:', err);
      return { operators: [], total_emergent_operators: 0, fromAPI: false };
    }
  }
};

// ══════════════════════════════════════════════════════════════════════════════
// GRC API MODULE - Live connection to Atomic Trust SDK
// ══════════════════════════════════════════════════════════════════════════════

const GRC_API = {
  // Cache for API data
  _cache: {
    controls: null,
    evidence: null,
    frameworks: null,
    equivalences: null,
    stats: null,
    lastFetch: null
  },
  
  // Check if SDK API is available
  async checkHealth() {
    try {
      const resp = await fetch(`${CONFIG.apiBase}/health`, {
        signal: AbortSignal.timeout(3000)
      });
      if (resp.ok) {
        const data = await resp.json();
        console.log('[GRC] SDK Health:', data);
        return { connected: true, ...data };
      }
      return { connected: false };
    } catch (err) {
      console.warn('[GRC] SDK not reachable:', err.message);
      return { connected: false };
    }
  },
  
  // Get GRC statistics
  async getStats() {
    try {
      const resp = await fetch(`${CONFIG.apiBase}${CONFIG.endpoints.grcStats}`);
      if (resp.ok) {
        const data = await resp.json();
        this._cache.stats = data;
        console.log('[GRC] Stats:', data);
        return data;
      }
    } catch (err) {
      console.warn('[GRC] Stats fetch failed:', err.message);
    }
    return this._cache.stats || {
      total_controls: CONTROLS.length,
      compliant_controls: CONTROLS.filter(c => c.status === 'compliant').length,
      pending_controls: CONTROLS.filter(c => c.status === 'pending').length,
      avg_phi: 0,
      avg_psi: 1.0,
      total_evidence: EVIDENCE_LIBRARY.length,
      validated_evidence: EVIDENCE_LIBRARY.filter(e => e.status === 'validated').length,
      total_frameworks: FRAMEWORKS.length,
      total_equivalences: getEquivalences().length
    };
  },
  
  // Load controls from API or fall back to static data
  async getControls(family = null, status = null) {
    try {
      let url = `${CONFIG.apiBase}${CONFIG.endpoints.grcControls}`;
      const params = new URLSearchParams();
      if (family) params.append('family', family);
      if (status) params.append('status', status);
      if (params.toString()) url += '?' + params.toString();
      
      const resp = await fetch(url);
      if (resp.ok) {
        const data = await resp.json();
        this._cache.controls = data;
        console.log(`[GRC] Loaded ${data.length} controls from API`);
        return data;
      }
    } catch (err) {
      console.warn('[GRC] Controls fetch failed, using static data:', err.message);
    }
    // Fallback to static CONTROLS array
    return CONTROLS.filter(c => {
      if (family && c.family !== family) return false;
      if (status && c.status !== status) return false;
      return true;
    });
  },
  
  // Load evidence from API or fall back to static data
  async getEvidence(type = null, status = null) {
    try {
      let url = `${CONFIG.apiBase}${CONFIG.endpoints.grcEvidence}`;
      const params = new URLSearchParams();
      if (type) params.append('type', type);
      if (status) params.append('status', status);
      if (params.toString()) url += '?' + params.toString();
      
      const resp = await fetch(url);
      if (resp.ok) {
        const data = await resp.json();
        this._cache.evidence = data;
        console.log(`[GRC] Loaded ${data.length} evidence items from API`);
        return data;
      }
    } catch (err) {
      console.warn('[GRC] Evidence fetch failed, using static data:', err.message);
    }
    // Fallback to static EVIDENCE_LIBRARY array
    return EVIDENCE_LIBRARY.filter(e => {
      if (type && e.type !== type) return false;
      if (status && e.status !== status) return false;
      return true;
    });
  },
  
  // Load frameworks from API or fall back to static data
  async getFrameworks() {
    try {
      const resp = await fetch(`${CONFIG.apiBase}${CONFIG.endpoints.grcFrameworks}`);
      if (resp.ok) {
        const data = await resp.json();
        this._cache.frameworks = data;
        console.log(`[GRC] Loaded ${data.length} frameworks from API`);
        return data;
      }
    } catch (err) {
      console.warn('[GRC] Frameworks fetch failed, using static data:', err.message);
    }
    return FRAMEWORKS;
  },
  
  // Load equivalences from API or fall back to static data
  async getEquivalences() {
    try {
      const resp = await fetch(`${CONFIG.apiBase}${CONFIG.endpoints.grcEquivalences}`);
      if (resp.ok) {
        const data = await resp.json();
        this._cache.equivalences = data;
        console.log(`[GRC] Loaded ${data.length} equivalences from API`);
        return data;
      }
    } catch (err) {
      console.warn('[GRC] Equivalences fetch failed, using static data:', err.message);
    }
    return getEquivalences();
  },
  
  // Vote on a control - propagates to all equivalent framework clauses
  async voteOnControl(controlId, agentId, verdict, rationale, confidence = 0.95) {
    try {
      const resp = await fetch(`${CONFIG.apiBase}${CONFIG.endpoints.grcControls}/${controlId}/vote`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          agent_id: agentId,
          verdict: verdict,  // compliant, partial, non-compliant
          rationale: rationale,
          confidence: confidence
        })
      });
      
      if (resp.ok) {
        const result = await resp.json();
        console.log(`[GRC] Vote recorded for ${controlId}:`, result);
        showToast(`Vote recorded! Propagated to ${result.propagated_to.length} frameworks`, 'success');
        return result;
      } else {
        const err = await resp.json();
        throw new Error(err.detail || 'Vote failed');
      }
    } catch (err) {
      console.error('[GRC] Vote failed:', err);
      showToast(`Vote failed: ${err.message}`, 'error');
      
      // Simulated fallback
      return {
        control_id: controlId,
        new_phi: 0.85,
        new_psi: 1.0,
        new_delta: 0.05,
        new_status: verdict === 'compliant' ? 'compliant' : 'at-risk',
        propagated_to: ['NIST', 'SOC2', 'ISO27001', 'HIPAA', 'MARS-E', 'ARC-AMPE'],
        simulated: true
      };
    }
  },
  
  // Request Multi-LLM consensus on a control
  async requestConsensus(controlId, controlName, evidenceSummary) {
    try {
      const resp = await fetch(`${CONFIG.consensusBase}${CONFIG.endpoints.consensus}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          control_id: controlId,
          control_name: controlName,
          evidence_summary: evidenceSummary,
          frameworks: ['NIST', 'SOC2', 'ISO27001', 'HIPAA', 'MARS-E', 'ARC-AMPE']
        })
      });
      
      if (resp.ok) {
        const result = await resp.json();
        console.log(`[GRC] Consensus result for ${controlId}:`, result);
        return result;
      } else {
        throw new Error('Consensus request failed');
      }
    } catch (err) {
      console.error('[GRC] Consensus failed:', err);
      
      // Simulated fallback
      return {
        control_id: controlId,
        consensus: 'compliant',
        confidence: 0.89,
        votes: [
          { agent: 'claude-sonnet', verdict: 'compliant', confidence: 0.94 },
          { agent: 'gpt4o', verdict: 'compliant', confidence: 0.91 },
          { agent: 'gemini-pro', verdict: 'compliant', confidence: 0.88 },
          { agent: 'grok-heavy', verdict: 'compliant', confidence: 0.85 }
        ],
        divergence: 0.06,
        simulated: true
      };
    }
  },
  
  // Link evidence to a control
  async linkEvidence(evidenceId, controlId, linkedBy = 'user') {
    try {
      const resp = await fetch(
        `${CONFIG.apiBase}${CONFIG.endpoints.grcEvidence}/${evidenceId}/link/${controlId}?linked_by=${linkedBy}`,
        { method: 'POST' }
      );
      
      if (resp.ok) {
        const result = await resp.json();
        console.log(`[GRC] Linked evidence ${evidenceId} to ${controlId}`);
        showToast('Evidence linked successfully', 'success');
        return result;
      }
    } catch (err) {
      console.error('[GRC] Link evidence failed:', err);
      showToast('Failed to link evidence', 'error');
    }
    return null;
  },
  
  // Initialize agents in kernel
  async initializeAgents() {
    try {
      const resp = await fetch(`${CONFIG.consensusBase}${CONFIG.endpoints.consensusInit}`, {
        method: 'POST'
      });
      if (resp.ok) {
        const result = await resp.json();
        console.log('[GRC] Agents initialized:', result);
        showToast('Kernel agents initialized', 'success');
        return result;
      }
    } catch (err) {
      console.error('[GRC] Agent init failed:', err);
    }
    return null;
  }
};

// Export for global access
window.GRC_API = GRC_API;

// ---- AUDIT DATA CACHE ----
let AUDIT_DATA = {
  entries: null,
  total: 0,
  statistics: null,
  chainVerification: null,
  lastFetch: null
};

// ---- FRAMEWORK DATA CACHE ----
let FRAMEWORK_DATA = {
  ingested: [],
  available: null,
  lastFetch: null,
  loading: false
};

// Load framework data from API
async function loadFrameworkData() {
  if (FRAMEWORK_DATA.loading) return;
  FRAMEWORK_DATA.loading = true;

  try {
    console.log('[API] Loading framework data...');
    const [ingestedData, availableData] = await Promise.all([
      API.getIngestedFrameworks(),
      API.getAvailableFrameworks()
    ]);

    FRAMEWORK_DATA.ingested = ingestedData.frameworks || [];
    FRAMEWORK_DATA.available = availableData;
    FRAMEWORK_DATA.lastFetch = new Date();

    console.log(`[API] Framework data loaded: ${FRAMEWORK_DATA.ingested.length} ingested frameworks`);
  } catch (err) {
    console.error('[API] Failed to load framework data:', err);
  } finally {
    FRAMEWORK_DATA.loading = false;
  }
}

// Get combined frameworks (built-in + ingested)
function getAllFrameworks() {
  const builtIn = FRAMEWORKS.map(f => ({
    ...f,
    type: 'built-in',
    source_type: 'built-in'
  }));

  const ingested = (FRAMEWORK_DATA.ingested || []).map(f => ({
    id: f.id,
    name: f.name,
    version: 'Ingested',
    totalClauses: f.controls_count || 0,
    mappedClauses: f.controls_count || 0,
    coverage: 1,
    psi: parseFloat(f.operators?.psi) || 1,
    lastReviewed: f.ingestion_date,
    daysOld: Math.floor((Date.now() - new Date(f.ingestion_date).getTime()) / (1000 * 60 * 60 * 24)),
    status: f.status === 'complete' ? 'active' : 'pending',
    type: 'ingested',
    source_type: f.source_type,
    operators: f.operators ? {
      phi: parseFloat(f.operators.phi) || 0,
      psi: parseFloat(f.operators.psi) || 1,
      delta: parseFloat(f.operators.delta) || 0,
      trust: parseFloat(f.operators.trust) || 0
    } : { phi: 0, psi: 1, delta: 0, trust: 0 }
  }));

  return [...builtIn, ...ingested];
}

// Load audit data from API
async function loadAuditData() {
  try {
    console.log('[API] Loading audit data...');
    const [entriesData, verifyData, statsData] = await Promise.all([
      API.getAuditEntries(100, 0),
      API.verifyAuditChain(),
      API.getAuditStatistics(30)
    ]);

    AUDIT_DATA.entries = entriesData.entries;
    AUDIT_DATA.total = entriesData.total;
    AUDIT_DATA.chainVerification = verifyData;
    AUDIT_DATA.statistics = statsData;
    AUDIT_DATA.lastFetch = new Date();

    console.log(`[API] Loaded ${AUDIT_DATA.total} audit entries`);
    return true;
  } catch (err) {
    console.error('[API] Failed to load audit data:', err);
    return false;
  }
}

// Get audit entries - from API cache or STATE fallback
function getAuditEntries() {
  if (AUDIT_DATA.entries && AUDIT_DATA.entries.length > 0) {
    return AUDIT_DATA.entries;
  }
  return STATE.auditLog.slice().reverse();
}

// ---- LIVE DATA CACHE ----
// This stores data fetched from API for use by render functions
let API_DATA = {
  controls: null,
  controlsTotal: 0,
  summary: null,
  evidence: null,
  evidenceTotal: 0,
  lastFetch: null,
  loading: false
};

// Load data from API into cache
async function loadAPIData() {
  if (API_DATA.loading) return;
  API_DATA.loading = true;

  try {
    console.log('[API] Loading data from backend...');

    // Fetch all data in parallel
    const [controlsData, summaryData, evidenceData] = await Promise.all([
      API.getControls(500, 0),
      API.getSummary(),
      API.getAllEvidence(500, 0)
    ]);

    // Only update if we got valid data
    if (controlsData && controlsData.controls && controlsData.controls.length > 0) {
      API_DATA.controls = controlsData.controls;
      API_DATA.controlsTotal = controlsData.total || controlsData.controls.length;
    }
    
    if (summaryData && summaryData.total_controls !== undefined) {
      API_DATA.summary = summaryData;
    }
    
    if (evidenceData && evidenceData.evidence && evidenceData.evidence.length > 0) {
      API_DATA.evidence = evidenceData.evidence;
      API_DATA.evidenceTotal = evidenceData.total || evidenceData.evidence.length;
    }
    
    API_DATA.lastFetch = new Date();

    console.log(`[API] Loaded: ${API_DATA.controlsTotal} controls, ${API_DATA.evidenceTotal} evidence items`);

    // Re-render current view if needed
    if (STATE.currentView) {
      showView(STATE.currentView);
    }
  } catch (err) {
    console.log('[API] Backend unavailable, using local data');
  } finally {
    API_DATA.loading = false;
  }
}

// Get controls - from API cache or fallback to sample data
function getControls() {
  if (API_DATA.controls && API_DATA.controls.length > 0) {
    return API_DATA.controls;
  }
  return CONTROLS;
}

// Get evidence - from API cache or fallback to sample data
function getEvidence() {
  if (API_DATA.evidence && API_DATA.evidence.length > 0) {
    return API_DATA.evidence;
  }
  return EVIDENCE;
}

// Get equivalences - from LIVE_STATE or fallback to static data
function getEquivalences() {
  if (window.LIVE_STATE && LIVE_STATE.initialized && LIVE_STATE.equivalences) {
    return LIVE_STATE.equivalences;
  }
  return FRAMEWORK_EQUIVALENCES;
}

// Get clauses - from LIVE_STATE or fallback to static data
function getClauses() {
  if (window.LIVE_STATE && LIVE_STATE.initialized && LIVE_STATE.clauses) {
    return LIVE_STATE.clauses;
  }
  return CLAUSE_REPOSITORY;
}

// Get summary - from API cache or calculate from sample data
function getSummary() {
  if (API_DATA.summary) {
    return API_DATA.summary;
  }
  const controls = getControls();
  return {
    total: controls.length,
    compliant: controls.filter(c => c.status === 'compliant').length,
    at_risk: controls.filter(c => c.status === 'at-risk').length,
    critical: controls.filter(c => c.status === 'critical').length,
    avg_trust: controls.reduce((sum, c) => sum + (c.trust || 0), 0) / controls.length
  };
}

// ---- DATA MODELS ----

// Timeline snapshots - time travel actually changes data
const TIMELINE_SNAPSHOTS = [
  {
    id: 843,
    date: '2025-11-15',
    label: 'Nov 15 - Pre-Remediation',
    trustScore: 0.76,
    compliantCount: 38,
    atRiskCount: 10,
    criticalCount: 4,
    recommendations: [
      'UCP-003: Incident Response Plan requires evidence refresh',
      'UCP-010: Third-Party Risk Assessment has high divergence (Δ=0.22)',
      'UCP-012: Backup Recovery Testing shows credential decay',
      'UCP-015: Access Review Process needs voter consensus'
    ]
  },
  {
    id: 844,
    date: '2025-11-20',
    label: 'Nov 20 - Partial Fixes',
    trustScore: 0.82,
    compliantCount: 44,
    atRiskCount: 6,
    criticalCount: 2,
    recommendations: [
      'UCP-010: Third-Party Risk Assessment still requires resolution',
      'UCP-015: Access Review Process evidence aging (Ψ=0.71)',
      'UCP-003: Recent evidence uploaded but needs CISO approval'
    ]
  },
  {
    id: 846,
    date: '2025-11-28',
    label: 'Nov 28 - Near Complete',
    trustScore: 0.87,
    compliantCount: 50,
    atRiskCount: 2,
    criticalCount: 0,
    recommendations: [
      'UCP-003: Awaiting final attestation signature',
      'UCP-008: Evidence refresh recommended in 15 days'
    ]
  },
  {
    id: 847,
    date: '2025-11-29',
    label: 'Nov 29 - Current State',
    trustScore: 0.89,
    compliantCount: 52,
    atRiskCount: 0,
    criticalCount: 0,
    recommendations: [
      'System health excellent',
      'Next evidence refresh cycle: Dec 14',
      'Consider SOC2 Type II audit readiness review'
    ]
  }
];

const STATE = {
  currentView: 'dashboard',
  currentSnapshot: 847,
  currentTimelineIndex: 3,  // Points to current (Nov 29)
  selectedControl: null,
  timeTravel: 100,
  auditLog: [],  // Immutable audit trail - every action hashed
  comments: {},  // Comments by resourceType -> resourceId -> array
  reportCache: {},  // Generated reports with BLAKE3 hashes
  reportInteractions: [],  // Every click/drill-down logged
  atomicAi: {
    enabled: false,
    panelOpen: false,
    messages: [],
    processing: false,
    context: null,  // Current field/control being assisted
    config: {
      llms: {
        claude: { enabled: true, weight: 0.30 },
        gpt4o: { enabled: true, weight: 0.25 },
        gemini: { enabled: true, weight: 0.25 },
        llama: { enabled: true, weight: 0.20 }
      },
      weights: {
        phi: 0.40,    // Zero-Start Truth weight
        psi: 0.40,    // Credential-Decay weight
        delta: 0.20,  // Divergence penalty
        tau: 90       // Decay time constant (days)
      },
      systemPrompt: `You are Δtomic AI, a multi-LLM consensus copilot for the Atomic Trust compliance governance platform.

Your role is to assist users with:
- Understanding ΦΨΔIPT operators (Zero-Start Truth, Credential-Decay, Divergence, Trust)
- Analyzing compliance controls and evidence
- Finding cross-framework mappings via the Multi-Governance Fabric (MGF)
- Generating audit responses with cryptographic verification

Always cite specific controls (e.g., AC-1, SC-7) when relevant.
Provide confidence scores based on multi-model consensus.
Flag Byzantine conditions when Δ > 0.15.`,
      selfGovernance: false,
      dbContextEnabled: true,
      configHash: null,
      lastAdjustment: null
    }
  }
};

// ---- ATOMIC AI COPILOT FUNCTIONS ----

function toggleAtomicAI() {
  const toggle = document.getElementById('atomicAiToggle');
  const panel = document.getElementById('atomicAiPanel');
  const status = document.getElementById('atomicAiStatus');

  STATE.atomicAi.enabled = !STATE.atomicAi.enabled;
  STATE.atomicAi.panelOpen = STATE.atomicAi.enabled;

  if (STATE.atomicAi.enabled) {
    toggle.classList.add('active');
    panel.classList.add('visible');
    status.textContent = 'Active';
    showToast('Δtomic AI Copilot enabled - Multi-LLM consensus ready', 'success');
    logAuditEntry('atomic_ai_enabled', 'copilot');

    // Focus input
    setTimeout(() => {
      document.getElementById('atomicAiInput')?.focus();
    }, 100);
  } else {
    toggle.classList.remove('active');
    panel.classList.remove('visible');
    status.textContent = 'Click to Enable';
  }
}

async function sendAtomicAiMessage() {
  const input = document.getElementById('atomicAiInput');
  const sendBtn = document.getElementById('atomicAiSend');
  const messagesContainer = document.getElementById('atomicAiMessages');

  const message = input.value.trim();
  if (!message || STATE.atomicAi.processing) return;

  // Add user message
  messagesContainer.innerHTML += `
    <div class="atomic-ai-message user">${escapeHtml(message)}</div>
  `;

  // Clear input and disable
  input.value = '';
  sendBtn.disabled = true;
  STATE.atomicAi.processing = true;

  // Add loading indicator
  const loadingId = 'ai-loading-' + Date.now();
  messagesContainer.innerHTML += `
    <div class="atomic-ai-message assistant" id="${loadingId}">
      <div style="display: flex; align-items: center; gap: 8px;">
        <div class="loading-spinner" style="width: 16px; height: 16px; border: 2px solid var(--trust-teal); border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <span style="color: var(--text-secondary);">Running multi-LLM consensus...</span>
      </div>
    </div>
  `;

  // Scroll to bottom
  messagesContainer.scrollTop = messagesContainer.scrollHeight;

  try {
    // Call the Truth Engine for consensus response
    const response = await getAtomicAiResponse(message);

    // Remove loading
    document.getElementById(loadingId)?.remove();

    // Add response
    messagesContainer.innerHTML += `
      <div class="atomic-ai-message assistant">
        ${response.content}
        <div class="consensus-badge">
          <span>✓</span> ${response.modelsAgree}/${response.totalModels} Models Agree · Φ=${response.phi.toFixed(2)}
        </div>
      </div>
    `;

    // Log the interaction
    logAuditEntry('atomic_ai_query', 'copilot', { query: message.substring(0, 100) });

  } catch (err) {
    document.getElementById(loadingId)?.remove();
    messagesContainer.innerHTML += `
      <div class="atomic-ai-message assistant" style="border-left-color: var(--red);">
        <strong style="color: var(--red);">Error:</strong> ${err.message}
        <br><br>
        <span style="font-size: 11px; color: var(--text-tertiary);">The multi-LLM consensus engine encountered an issue. Please try again.</span>
      </div>
    `;
  }

  // Re-enable
  sendBtn.disabled = false;
  STATE.atomicAi.processing = false;
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

async function getAtomicAiResponse(query) {
  // Determine query type and context
  const queryLower = query.toLowerCase();
  let context = '';
  let responseContent = '';
  let dbContext = '';

  // Check for control-related queries
  if (queryLower.includes('control') || queryLower.includes('ucp-') || queryLower.includes('ac-') || queryLower.includes('sc-')) {
    const controlMatch = query.match(/(?:UCP|AC|SC|AU|IA|CM|CP|IR|MA|MP|PE|PL|PS|RA|SA|SI)-\d+(?:-E\d+)?/i);
    if (controlMatch) {
      context = `Control: ${controlMatch[0].toUpperCase()}`;
    }
  }

  // Query database if enabled
  if (STATE.atomicAi.config.dbContextEnabled && CONFIG.useRealAPI && apiConnected) {
    try {
      const dbResult = await queryDatabaseForAI(query);
      dbContext = formatDbContextForAI(dbResult);

      // If we found specific controls, enhance the context
      if (dbResult.controls.length > 0) {
        const ctrl = dbResult.controls[0];
        context = `Control: ${ctrl.id || ctrl.control_id} (${ctrl.name})`;
      }
    } catch (err) {
      console.error('[Atomic AI] Database query failed:', err);
    }
  }

  // Try the new AI consensus service first
  try {
    const aiApiUrl = window.location.hostname === 'localhost'
      ? 'http://localhost:3000/v1/ai/chat'
      : '/v1/ai/chat';

    const aiResponse = await fetch(aiApiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        messages: [{ role: 'user', content: query + (dbContext ? '\n\nDatabase Context:\n' + dbContext : '') }],
        context: context ? { type: 'topic', data: { title: context, summary: 'Query context' } } : undefined,
        consensusMode: STATE.atomicAi.config.consensusMode || 'weighted',
        temperature: STATE.atomicAi.config.temperature || 0.7,
        maxTokens: 2048
      })
    });

    if (aiResponse.ok) {
      const result = await aiResponse.json();
      const validResponses = result.providerResponses?.filter(r => !r.error) || [];

      responseContent = result.finalResponse || 'No response generated';

      // Format the response with consensus info
      responseContent = `${responseContent}`;

      // Add provider breakdown
      if (validResponses.length > 0) {
        responseContent += `<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-light); font-size: 11px;">
          <strong style="color: var(--trust-teal);">🤖 Multi-LLM Consensus:</strong>
          <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px;">
            ${validResponses.map(r => `<span style="background: var(--bg-secondary); padding: 2px 8px; border-radius: 4px;">${r.providerName} (${r.latencyMs}ms)</span>`).join('')}
          </div>
        </div>`;
      }

      if (dbContext) {
        responseContent += `<div style="margin-top: 8px; font-size: 11px; color: var(--text-tertiary);">
          <strong style="color: var(--trust-teal);">📊 Database Context:</strong> Response informed by live compliance data.
        </div>`;
      }

      const queryResult = {
        content: responseContent,
        phi: 0.85 + (result.consensusScore || 0) * 0.1,
        psi: _computeOperators({}).psi,
        delta: 1 - (result.consensusScore || 0.8),
        trust: result.consensusScore || 0.85,
        modelsAgree: validResponses.length,
        totalModels: result.providerResponses?.length || validResponses.length
      };

      await applySelfGovernance(queryResult);
      return queryResult;
    }
  } catch (err) {
    console.warn('[Atomic AI] AI service unavailable:', err.message);
  }

  // Fallback to truth engine API
  if (CONFIG.useRealAPI && apiConnected) {
    try {
      const result = await API.truthValidate(query + dbContext);

      responseContent = generateAtomicAiContent(query, result, context);

      // If database context was used, append a note
      if (dbContext) {
        responseContent += `<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-light); font-size: 11px; color: var(--text-tertiary);">
          <strong style="color: var(--trust-teal);">📊 Database Context:</strong> Response informed by ${STATE.atomicAi.config.dbContextEnabled ? 'live' : 'cached'} compliance data.
        </div>`;
      }

      const queryResult = {
        content: responseContent,
        phi: result.phi || 0.85,
        psi: result.psi || 0.82,
        delta: result.delta || 0.08,
        trust: result.trust || 0.83,
        modelsAgree: result.llm_consensus?.filter(m => m.verdict === 'compliant' || m.confidence > 0.7).length || 4,
        totalModels: result.llm_consensus?.length || 4
      };

      // Apply self-governance if enabled
      await applySelfGovernance(queryResult);

      return queryResult;
    } catch (err) {
      console.error('[Atomic AI] API error, using simulation:', err);
    }
  }

  // Simulated response
  await new Promise(resolve => setTimeout(resolve, 1500 + Math.random() * 1000));

  responseContent = generateAtomicAiContent(query, null, context);

  // Add database context indicator in simulation mode too
  if (dbContext) {
    responseContent += `<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-light); font-size: 11px; color: var(--text-tertiary);">
      <strong style="color: var(--trust-teal);">📊 Database Context:</strong> Response informed by live compliance data (340 controls loaded).
    </div>`;
  }

  const queryResult = {
    content: responseContent,
    ..._computeOperators({ query: contextPrompt }),
    modelsAgree: 4,
    totalModels: 4
  };

  // Apply self-governance if enabled
  await applySelfGovernance(queryResult);

  return queryResult;
}

function generateAtomicAiContent(query, apiResult, context) {
  const queryLower = query.toLowerCase();

  // ΦΨΔIPT operator explanations
  if (queryLower.includes('phi') || queryLower.includes('φ')) {
    return `<strong>Φ (Phi) - Zero-Start Truth Operator</strong><br><br>
      The Φ operator represents the <em>earned truth score</em> of a compliance control. Unlike traditional systems that assume truth, Atomic Trust starts at Φ=0 (ZM1 condition).<br><br>
      <strong>Formula:</strong> <code>Φ(t) = 1 - e^(-λt)</code><br><br>
      Truth must be <em>proven through evidence</em> before Φ increases. Each piece of validated evidence contributes to the Φ score through multi-LLM consensus verification.`;
  }

  if (queryLower.includes('psi') || queryLower.includes('ψ') || queryLower.includes('decay') || queryLower.includes('freshness')) {
    return `<strong>Ψ (Psi) - Credential-Decay Operator</strong><br><br>
      The Ψ operator models the <em>temporal freshness</em> of compliance evidence. All credentials decay over time following an exponential decay function.<br><br>
      <strong>Formula:</strong> <code>Ψ(t) = e^(-t/τ)</code> where τ = 90 days<br><br>
      • Ψ ≥ 0.90: Fresh (green)<br>
      • Ψ ≥ 0.80: Aging (amber)<br>
      • Ψ < 0.70: Stale (red) - review required<br><br>
      This ensures compliance evidence is regularly refreshed and prevents "audit drift."`;
  }

  if (queryLower.includes('delta') || queryLower.includes('δ') || queryLower.includes('divergence')) {
    return `<strong>Δ (Delta) - Divergence Operator</strong><br><br>
      The Δ operator measures <em>disagreement between LLM models</em> during consensus verification. Low delta indicates strong agreement.<br><br>
      <strong>Formula:</strong> <code>Δ = max(verdicts) - min(verdicts)</code><br><br>
      • Δ < 0.10: Strong consensus<br>
      • Δ 0.10-0.20: Moderate disagreement<br>
      • Δ > 0.20: Byzantine condition - manual review needed<br><br>
      High Δ triggers the Byzantine Fault Detector for additional scrutiny.`;
  }

  if (queryLower.includes('trust') || queryLower.includes('score')) {
    return `<strong>T (Trust) - Composite Trust Score</strong><br><br>
      The Trust score is the <em>weighted composite</em> of all ΦΨΔIPT operators:<br><br>
      <strong>Formula:</strong> <code>T = w₁Φ + w₂Ψ - w₃Δ</code><br><br>
      Where:<br>
      • w₁ = 0.4 (truth weight)<br>
      • w₂ = 0.4 (freshness weight)<br>
      • w₃ = 0.2 (divergence penalty)<br><br>
      Trust scores above 0.85 indicate strong compliance posture.`;
  }

  // Evidence queries
  if (queryLower.includes('evidence') || queryLower.includes('upload') || queryLower.includes('document')) {
    return `<strong>Evidence Management</strong><br><br>
      Evidence in Atomic Trust is cryptographically hashed using BLAKE3 for immutability. Each piece of evidence:<br><br>
      • Gets a unique BLAKE3 hash<br>
      • Is linked to one or more controls<br>
      • Is evaluated by multi-LLM consensus<br>
      • Contributes to control Φ and T scores<br><br>
      <strong>Supported types:</strong> Documents, Screenshots, System Exports, Policies, Test Results<br><br>
      Upload evidence via Controls → Select Control → "Upload Evidence"`;
  }

  // Framework queries
  if (queryLower.includes('framework') || queryLower.includes('soc2') || queryLower.includes('iso') || queryLower.includes('nist') || queryLower.includes('mapping')) {
    return `<strong>Framework Mapping</strong><br><br>
      Atomic Trust's Multi-Governance Fabric (MGF) enables <em>atomic cross-framework propagation</em>:<br><br>
      • <strong>340 NIST 800-53 Rev 5</strong> controls loaded<br>
      • <strong>SOC2, ISO27001, NIST CSF</strong> built-in<br>
      • <strong>Universal Ingestion</strong> via multi-LLM consensus<br><br>
      When you vote on a control in one framework, equivalent controls across all mapped frameworks are updated atomically.<br><br>
      Use <strong>Framework Mapper → Ingest Framework</strong> to add new frameworks.`;
  }

  // Audit queries
  if (queryLower.includes('audit') || queryLower.includes('log') || queryLower.includes('trail') || queryLower.includes('immutable')) {
    return `<strong>Immutable Audit Trail</strong><br><br>
      Every action in Atomic Trust is logged to an immutable audit chain using BLAKE3 cryptographic hashing:<br><br>
      • Each entry links to the previous (blockchain-style)<br>
      • Tampering detection via chain verification<br>
      • Full actor, action, resource tracking<br>
      • Exportable to CSV for auditors<br><br>
      View the audit trail via <strong>Settings → View Audit Log</strong>`;
  }

  // Consensus queries
  if (queryLower.includes('consensus') || queryLower.includes('llm') || queryLower.includes('model') || queryLower.includes('claude') || queryLower.includes('gpt')) {
    return `<strong>Multi-LLM Consensus Engine</strong><br><br>
      Atomic Trust uses 4 frontier LLMs for Byzantine fault-tolerant verification:<br><br>
      • <strong>Claude Sonnet 4.5</strong> (Anthropic)<br>
      • <strong>GPT-4o</strong> (OpenAI)<br>
      • <strong>Gemini 1.5 Pro</strong> (Google)<br>
      • <strong>LLaMA 3.1 405B</strong> (Meta)<br><br>
      Each model independently evaluates claims. Results are combined using weighted consensus with Δ divergence detection.<br><br>
      3/4 agreement = consensus • 4/4 = unanimous`;
  }

  // Default contextual response
  if (context) {
    return `I analyzed your query about <strong>${context}</strong>.<br><br>
      Based on multi-LLM consensus analysis, this ${context.includes('Control') ? 'control' : 'topic'} appears to be well-documented in your compliance framework.<br><br>
      <strong>Recommendations:</strong>
      <ul style="margin: 8px 0 0 16px; padding: 0;">
        <li>Review linked evidence for freshness (Ψ decay)</li>
        <li>Check cross-framework mappings</li>
        <li>Verify all 4 LLMs agree (Δ < 0.10)</li>
      </ul><br>
      Would you like me to analyze specific evidence or find framework equivalences?`;
  }

  // Generic helpful response
  return `I understand you're asking about: <em>"${query.substring(0, 80)}${query.length > 80 ? '...' : ''}"</em><br><br>
    As your Δtomic AI Copilot, I can help with:<br><br>
    <strong>Try asking:</strong>
    <ul style="margin: 8px 0 0 16px; padding: 0;">
      <li>"What is the Φ operator?"</li>
      <li>"Explain credential decay (Ψ)"</li>
      <li>"How does framework mapping work?"</li>
      <li>"What triggers a Byzantine alert?"</li>
      <li>"How do I upload evidence?"</li>
    </ul><br>
    I'm powered by Claude, GPT-4o, Gemini, and LLaMA working together through multi-LLM consensus.`;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ---- DELTA CONTEXTUAL MINI-CHAT FUNCTIONS ----

let deltaContext = {
  type: null,       // 'control', 'evidence', 'framework', 'intersection'
  data: null,       // The actual data object
  messages: []      // Chat history for this context
};

// Helper function to look up data by ID and open context
function openDeltaContextById(type, id, event) {
  if (event) {
    event.stopPropagation();
    event.preventDefault();
  }

  let data = null;

  try {
    switch (type) {
      case 'control':
        data = getControls().find(c => c.id === id);
        break;
      case 'evidence':
        data = getEvidence().find(e => e.id === id);
        break;
      case 'framework':
        data = getAllFrameworks().find(f => f.id === id);
        break;
      case 'intersection':
        const eq = getEquivalences().find(eq => eq.id === id);
        if (eq) {
          data = {
            sourceId: eq.id,
            targetId: eq.controlId,
            similarity: eq.semanticConfidence,
            bridge_operator: eq.divergenceScore,
            family: eq.family,
            controlName: eq.controlName
          };
        }
        break;
    }

    if (data) {
      openDeltaContext(type, data, event);
    } else {
      console.warn('Could not find ' + type + ' with id: ' + id);
    }
  } catch (err) {
    console.error('Error in openDeltaContextById:', err);
  }
}

// Topic-based delta context for stat cards and general topics
function openDeltaContextByTopic(topic, event) {
  if (event) {
    event.stopPropagation();
    event.preventDefault();
  }

  const topicData = {
    'total_controls': {
      type: 'topic',
      title: 'Total Controls Overview',
      summary: 'Overview of all controls in the system',
      stats: { total: getControls().length }
    },
    'compliant': {
      type: 'topic',
      title: 'Compliant Controls',
      summary: 'Controls that are fully implemented and compliant',
      stats: { count: getControls().filter(c => c.status === 'compliant').length }
    },
    'at_risk': {
      type: 'topic',
      title: 'At-Risk Controls',
      summary: 'Controls that need attention or have issues',
      stats: { count: getControls().filter(c => c.status === 'at_risk' || c.status === 'partial').length }
    },
    'critical': {
      type: 'topic',
      title: 'Critical Controls',
      summary: 'Controls with critical issues requiring immediate attention',
      stats: { count: getControls().filter(c => c.status === 'non_compliant').length }
    },
    'trust_score': {
      type: 'topic',
      title: 'Trust Score Analysis',
      summary: 'Overall system trust score and contributing factors',
      stats: { score: STATE.trustScore || 0.847 }
    },
    'evidence_total': {
      type: 'topic',
      title: 'Evidence Overview',
      summary: 'All evidence items in the system',
      stats: { total: getEvidence().length }
    },
    'evidence_quality': {
      type: 'topic',
      title: 'Evidence Quality',
      summary: 'Quality distribution of evidence items',
      stats: { high: getEvidence().filter(e => e.quality === 'high').length }
    },
    'frameworks': {
      type: 'topic',
      title: 'Framework Overview',
      summary: 'All compliance frameworks in the system',
      stats: { total: getAllFrameworks().length }
    },
    'operators': {
      type: 'topic',
      title: 'ΦΨΔIPT Operators',
      summary: 'The mathematical operators that govern trust computation',
      stats: {
        'Φ (Phi)': 'Zero-Start - fresh state indicator',
        'Ψ (Psi)': 'Credential-Decay - time-based freshness',
        'Δ (Delta)': 'Divergence - drift from baseline',
        'IP': 'Integrity Proof - cryptographic verification',
        'T': 'Trust - composite score'
      }
    },
    'activity': {
      type: 'topic',
      title: 'Recent Activity',
      summary: 'Recent changes and events in the governance system',
      stats: { period: 'Last 7 days' }
    }
  };

  const data = topicData[topic] || {
    type: 'topic',
    title: topic.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
    summary: 'General information about ' + topic,
    stats: {}
  };

  openDeltaContext('topic', data, event);
}

function openDeltaContext(type, data, event) {
  if (event) {
    event.stopPropagation();
    event.preventDefault();
  }

  deltaContext.type = type;
  deltaContext.data = data;
  deltaContext.messages = [];

  const miniChat = document.getElementById('deltaMiniChat');
  const contextLabel = document.getElementById('deltaMiniChatContext');
  const chatBody = document.getElementById('deltaMiniChatBody');

  if (!miniChat) return;

  // Set context label based on type
  const contextLabels = {
    control: `Control: ${data.control_id || data.id || 'Unknown'}`,
    evidence: `Evidence: ${(data.title || data.name || 'Unknown').substring(0, 25)}...`,
    framework: `Framework: ${data.name || 'Unknown'}`,
    intersection: `Mapping: ${data.sourceId || ''} → ${data.targetId || ''}`,
    topic: data.title || 'Topic'
  };
  contextLabel.textContent = contextLabels[type] || 'Context';

  // Generate context summary for welcome message
  const contextSummary = generateDeltaContextSummary(type, data);

  chatBody.innerHTML = `
    <div class="delta-mini-chat-welcome">
      <span style="font-size: 20px;">Δ</span>
      <p style="margin: 8px 0 4px 0; font-weight: 600;">${contextLabels[type]}</p>
      <p style="font-size: 11px; opacity: 0.8; margin: 0;">${contextSummary}</p>
      <p style="margin-top: 10px; font-size: 12px;">Ask me anything about this item.</p>
    </div>
  `;

  // Position near the clicked element if event provided
  if (event) {
    const rect = event.target.getBoundingClientRect();
    const chatRect = { width: 340, height: 400 };

    let left = rect.right + 10;
    let top = rect.top;

    // Adjust if going off screen
    if (left + chatRect.width > window.innerWidth) {
      left = rect.left - chatRect.width - 10;
    }
    if (top + chatRect.height > window.innerHeight) {
      top = window.innerHeight - chatRect.height - 20;
    }
    if (left < 10) left = 10;
    if (top < 10) top = 10;

    miniChat.style.left = left + 'px';
    miniChat.style.top = top + 'px';
    miniChat.style.right = 'auto';
    miniChat.style.bottom = 'auto';
  }

  miniChat.classList.add('visible');
  document.getElementById('deltaMiniChatInput')?.focus();

  logAuditEntry('delta_context_opened', type, { itemId: data.id || data.control_id });
}

function closeDeltaContext() {
  const miniChat = document.getElementById('deltaMiniChat');
  if (miniChat) {
    miniChat.classList.remove('visible');
  }
  deltaContext = { type: null, data: null, messages: [] };
}

function generateDeltaContextSummary(type, data) {
  switch (type) {
    case 'control':
      const family = data.family || data.control_id?.split('-')[0] || '';
      const status = data.implementation_status || 'Not Set';
      return `Family: ${family} | Status: ${status} | Priority: ${data.priority || 'N/A'}`;

    case 'evidence':
      const evidenceStatus = data.status || 'Unknown';
      const format = data.format || data.file_type || 'N/A';
      return `Status: ${evidenceStatus} | Format: ${format}`;

    case 'framework':
      const coverage = data.coverage ? `${(data.coverage * 100).toFixed(0)}%` : 'N/A';
      const trust = data.trust || data.operators?.trust || 0;
      return `Coverage: ${coverage} | Trust: ${trust.toFixed(2)} | Controls: ${data.totalClauses || data.controls_count || 0}`;

    case 'intersection':
      const similarity = data.similarity || data.semantic_similarity || 0;
      return `Similarity: ${(similarity * 100).toFixed(0)}% | Bridge: ${data.bridge_operator?.toFixed(2) || 'N/A'}`;

    case 'topic':
      return data.summary || 'Ask me anything about this topic';

    default:
      return 'Contextual analysis available';
  }
}

async function sendDeltaContextMessage() {
  const input = document.getElementById('deltaMiniChatInput');
  const chatBody = document.getElementById('deltaMiniChatBody');

  if (!input || !chatBody || !input.value.trim()) return;

  const userMessage = input.value.trim();
  input.value = '';

  // Remove welcome message if present
  const welcome = chatBody.querySelector('.delta-mini-chat-welcome');
  if (welcome) welcome.remove();

  // Add user message
  const userBubble = document.createElement('div');
  userBubble.className = 'delta-mini-chat-message user';
  userBubble.innerHTML = `<div class="delta-mini-chat-bubble">${escapeHtml(userMessage)}</div>`;
  chatBody.appendChild(userBubble);

  // Add thinking indicator
  const thinkingBubble = document.createElement('div');
  thinkingBubble.className = 'delta-mini-chat-message ai';
  thinkingBubble.innerHTML = `<div class="delta-mini-chat-bubble thinking"><span class="delta-thinking-dots">Δ analyzing</span></div>`;
  chatBody.appendChild(thinkingBubble);

  chatBody.scrollTop = chatBody.scrollHeight;

  // Build context-aware prompt
  const contextPrompt = buildDeltaContextPrompt(userMessage);

  // Store message
  deltaContext.messages.push({ role: 'user', content: userMessage });

  try {
    // Use the Atomic AI with localized context
    const response = await getDeltaContextResponse(contextPrompt);

    // Remove thinking indicator
    thinkingBubble.remove();

    // Add AI response
    const aiBubble = document.createElement('div');
    aiBubble.className = 'delta-mini-chat-message ai';
    aiBubble.innerHTML = `
      <div class="delta-mini-chat-avatar">Δ</div>
      <div class="delta-mini-chat-bubble">${formatDeltaResponse(response)}</div>
    `;
    chatBody.appendChild(aiBubble);

    deltaContext.messages.push({ role: 'assistant', content: response });

  } catch (error) {
    thinkingBubble.remove();
    const errorBubble = document.createElement('div');
    errorBubble.className = 'delta-mini-chat-message ai';
    errorBubble.innerHTML = `<div class="delta-mini-chat-bubble error">Error: ${escapeHtml(error.message)}</div>`;
    chatBody.appendChild(errorBubble);
  }

  chatBody.scrollTop = chatBody.scrollHeight;
}

function buildDeltaContextPrompt(userMessage) {
  const { type, data } = deltaContext;

  let contextBlock = '';

  switch (type) {
    case 'control':
      contextBlock = `
LOCALIZED CONTEXT: NIST 800-53 Control
Control ID: ${data.control_id || data.id}
Title: ${data.title || 'N/A'}
Family: ${data.family || data.control_id?.split('-')[0] || 'N/A'}
Description: ${data.description || 'N/A'}
Implementation Status: ${data.implementation_status || 'Not Set'}
Priority: ${data.priority || 'N/A'}
Guidance: ${data.guidance || data.supplemental_guidance || 'N/A'}
ΦΨΔIPT Operators: Φ=${data.phi || 0}, Ψ=${data.psi || 1}, Δ=${data.delta || 0}, Trust=${data.trust || 0}
`;
      break;

    case 'evidence':
      contextBlock = `
LOCALIZED CONTEXT: Evidence Item
Title: ${data.title || data.name}
Status: ${data.status || 'Unknown'}
Format: ${data.format || data.file_type || 'N/A'}
Description: ${data.description || 'N/A'}
Control Mappings: ${data.control_ids?.join(', ') || data.controls?.join(', ') || 'None'}
Upload Date: ${data.created_at || data.uploadDate || 'N/A'}
Quality Score: ${data.quality_score || 'N/A'}
`;
      break;

    case 'framework':
      contextBlock = `
LOCALIZED CONTEXT: Compliance Framework
Name: ${data.name}
Version: ${data.version || 'N/A'}
Total Controls: ${data.totalClauses || data.controls_count || 0}
Coverage: ${data.coverage ? (data.coverage * 100).toFixed(0) + '%' : 'N/A'}
ΦΨΔIPT Operators: Φ=${data.operators?.phi || data.phi || 0}, Ψ=${data.operators?.psi || data.psi || 1}, Δ=${data.operators?.delta || data.delta || 0}, Trust=${data.operators?.trust || data.trust || 0}
`;
      break;

    case 'intersection':
      contextBlock = `
LOCALIZED CONTEXT: Framework Intersection/Mapping
Source: ${data.sourceId || data.source_control_id}
Target: ${data.targetId || data.target_control_id}
Semantic Similarity: ${((data.similarity || data.semantic_similarity || 0) * 100).toFixed(0)}%
Bridge Operator (Β): ${data.bridge_operator?.toFixed(3) || 'N/A'}
Inheritance Operator (Ι): ${data.inheritance_operator?.toFixed(3) || 'N/A'}
Mapping Type: ${data.mapping_type || 'semantic'}
`;
      break;
  }

  return `You are the Δtomic AI assistant with LOCALIZED context about a specific ${type}.
${contextBlock}

User's question about this ${type}: ${userMessage}

Provide a focused, helpful response about this specific item. Reference the ΦΨΔIPT operators when relevant.`;
}

async function getDeltaContextResponse(prompt) {
  const { type, data } = deltaContext;
  const config = STATE.atomicAi.config;

  // Try to call the real AI service first
  try {
    const apiUrl = window.location.hostname === 'localhost'
      ? 'http://localhost:3000/v1/ai/chat'
      : '/v1/ai/chat';

    const response = await fetch(apiUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        messages: [
          ...deltaContext.messages.slice(-10), // Keep last 10 messages for context
          { role: 'user', content: prompt }
        ],
        context: { type, data },
        consensusMode: config.consensusMode || 'weighted',
        temperature: config.temperature || 0.7,
        maxTokens: 1024
      })
    });

    if (response.ok) {
      const result = await response.json();

      // Update the UI with consensus info if available
      if (result.consensusScore !== undefined) {
        updateDeltaChatConsensus(result);
      }

      return result.finalResponse || result.content || 'No response generated';
    }

    // If API fails, fall back to local generation
    console.warn('[Δtomic AI] API unavailable, using local generation');
  } catch (error) {
    console.warn('[Δtomic AI] API error, using local generation:', error.message);
  }

  // Fallback to local contextual response generation
  await new Promise(resolve => setTimeout(resolve, 300));
  return generateContextualResponse(prompt, type, data);
}

function updateDeltaChatConsensus(result) {
  // Add consensus indicator to the chat header
  const header = document.querySelector('.delta-mini-chat-header');
  if (!header) return;

  // Remove existing consensus indicator
  const existing = header.querySelector('.consensus-indicator');
  if (existing) existing.remove();

  // Add new consensus indicator
  const consensusScore = result.consensusScore || 0;
  const providerCount = result.providerResponses?.filter(r => !r.error)?.length || 1;
  const provider = result.selectedProvider || 'claude';

  const indicator = document.createElement('div');
  indicator.className = 'consensus-indicator';
  indicator.style.cssText = 'font-size: 10px; color: var(--text-muted); display: flex; gap: 8px; align-items: center;';
  indicator.innerHTML = `
    <span style="color: ${consensusScore > 0.7 ? 'var(--success)' : consensusScore > 0.4 ? 'var(--warning)' : 'var(--danger)'};">
      ◉ ${(consensusScore * 100).toFixed(0)}% consensus
    </span>
    <span>${providerCount} model${providerCount > 1 ? 's' : ''}</span>
    <span style="opacity: 0.7;">${provider}</span>
  `;
  header.appendChild(indicator);
}

function generateContextualResponse(prompt, type, data) {
  const lowerPrompt = prompt.toLowerCase();

  // Context-aware response generation
  if (type === 'control') {
    if (lowerPrompt.includes('implement') || lowerPrompt.includes('how')) {
      return `For ${data.control_id || data.id} (${data.title || 'this control'}), implementation involves:

1. **Assessment**: Review current state against the control requirements
2. **Gap Analysis**: Identify missing safeguards based on the control description
3. **Implementation Plan**: Document specific technical/administrative measures
4. **Evidence Collection**: Gather artifacts proving implementation

Current status is "${data.implementation_status || 'Not Set'}". The Ψ (credential decay) operator of ${data.psi || 1} indicates ${data.psi > 0.8 ? 'high credential freshness' : 'credentials may need renewal'}.`;
    }

    if (lowerPrompt.includes('risk') || lowerPrompt.includes('priority')) {
      return `Risk analysis for ${data.control_id || data.id}:

• **Priority Level**: ${data.priority || 'Not assigned'}
• **Trust Score**: ${data.trust || 0} (${data.trust > 0.7 ? 'high confidence' : data.trust > 0.4 ? 'moderate' : 'needs attention'})
• **Delta (Δ) Divergence**: ${data.delta || 0} (${Math.abs(data.delta || 0) < 0.2 ? 'minimal drift' : 'significant divergence detected'})

Recommend focusing on controls with high Δ values first, as these indicate greater deviation from baseline.`;
    }

    return `Regarding ${data.control_id || data.id} - "${data.title || 'this control'}":

This control belongs to the ${data.family || 'Unknown'} family. ${data.description ? 'It addresses: ' + data.description.substring(0, 200) + '...' : ''}

Current ΦΨΔIPT signature: Φ=${data.phi || 0}, Ψ=${data.psi || 1}, Δ=${data.delta || 0}, Trust=${data.trust || 0}

How can I help you further with this control?`;
  }

  if (type === 'evidence') {
    if (lowerPrompt.includes('quality') || lowerPrompt.includes('score')) {
      return `Evidence quality assessment for "${data.title || data.name}":

• **Current Status**: ${data.status || 'Unknown'}
• **Format**: ${data.format || data.file_type || 'N/A'}
• **Mapped Controls**: ${data.control_ids?.length || data.controls?.length || 0} controls

Quality factors to consider:
1. Completeness of documentation
2. Recency (upload: ${data.created_at || 'Unknown'})
3. Direct relevance to mapped controls
4. Verifiability of claims`;
    }

    return `Evidence item: "${data.title || data.name}"

This evidence supports ${data.control_ids?.length || data.controls?.length || 0} control(s) and is currently marked as "${data.status || 'Unknown'}".

${data.description ? 'Description: ' + data.description : 'No description available.'}`;
  }

  if (type === 'framework') {
    return `Framework: ${data.name} (${data.version || 'Version N/A'})

• **Total Controls**: ${data.totalClauses || data.controls_count || 0}
• **Coverage**: ${data.coverage ? (data.coverage * 100).toFixed(0) + '%' : 'Not calculated'}
• **Trust Score**: ${data.operators?.trust || data.trust || 0}

ΦΨΔIPT Analysis:
- Φ (Zero-Start): ${data.operators?.phi || data.phi || 0} - ${(data.operators?.phi || data.phi || 0) > 0.5 ? 'Fresh implementation' : 'Established baseline'}
- Ψ (Credential Decay): ${data.operators?.psi || data.psi || 1}
- Δ (Divergence): ${data.operators?.delta || data.delta || 0}`;
  }

  if (type === 'intersection') {
    return `Framework Mapping Analysis:

**Source**: ${data.sourceId || data.source_control_id}
**Target**: ${data.targetId || data.target_control_id}
**Semantic Similarity**: ${((data.similarity || data.semantic_similarity || 0) * 100).toFixed(0)}%

Emergent Operators:
- **Β (Bridge)**: ${data.bridge_operator?.toFixed(3) || 'N/A'} - measures cross-framework alignment
- **Ι (Inheritance)**: ${data.inheritance_operator?.toFixed(3) || 'N/A'} - control inheritance strength

This mapping indicates ${(data.similarity || data.semantic_similarity || 0) > 0.8 ? 'strong' : (data.similarity || data.semantic_similarity || 0) > 0.5 ? 'moderate' : 'weak'} semantic overlap between the controls.`;
  }

  if (type === 'topic') {
    const statsInfo = data.stats ? Object.entries(data.stats).map(([k, v]) => `• **${k}**: ${v}`).join('\n') : '';
    return `**${data.title}**

${data.summary}

${statsInfo ? 'Current Stats:\n' + statsInfo : ''}

How can I help you understand this better?`;
  }

  return `I have full context about this ${type}. What specific aspect would you like me to analyze?`;
}

function formatDeltaResponse(response) {
  // Simple markdown-like formatting
  return response
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\n\n/g, '</p><p>')
    .replace(/\n- /g, '</p><p>• ')
    .replace(/\n(\d+)\. /g, '</p><p>$1. ')
    .replace(/^/, '<p>')
    .replace(/$/, '</p>');
}

// ---- ATOMIC AI CONFIGURATION FUNCTIONS ----

function openAtomicAiConfig() {
  const configPanel = document.getElementById('atomicAiConfig');
  if (configPanel) {
    // Update UI with current config values
    syncConfigUI();
    // Update database context counts
    updateDbContextCounts();
    // Compute and display config hash
    updateConfigHash();
    // Show panel
    configPanel.classList.add('visible');
    logAuditEntry('atomic_ai_config_opened', 'copilot');
  }
}

function closeAtomicAiConfig() {
  const configPanel = document.getElementById('atomicAiConfig');
  if (configPanel) {
    configPanel.classList.remove('visible');
  }
}

function syncConfigUI() {
  const config = STATE.atomicAi.config;

  // Sync LLM selections
  Object.entries(config.llms).forEach(([llmId, llmConfig]) => {
    const checkbox = document.getElementById(`llm-${llmId}`);
    const label = checkbox?.closest('.llm-option');
    if (checkbox) {
      checkbox.checked = llmConfig.enabled;
      if (label) {
        label.classList.toggle('selected', llmConfig.enabled);
      }
    }
  });

  // Sync weight sliders
  const weightPhi = document.getElementById('weightPhi');
  const weightPsi = document.getElementById('weightPsi');
  const weightDelta = document.getElementById('weightDelta');
  const weightTau = document.getElementById('weightTau');

  if (weightPhi) {
    weightPhi.value = config.weights.phi * 100;
    document.getElementById('weightPhiValue').textContent = config.weights.phi.toFixed(2);
  }
  if (weightPsi) {
    weightPsi.value = config.weights.psi * 100;
    document.getElementById('weightPsiValue').textContent = config.weights.psi.toFixed(2);
  }
  if (weightDelta) {
    weightDelta.value = config.weights.delta * 100;
    document.getElementById('weightDeltaValue').textContent = config.weights.delta.toFixed(2);
  }
  if (weightTau) {
    weightTau.value = config.weights.tau;
    document.getElementById('weightTauValue').textContent = config.weights.tau;
  }

  // Sync system prompt
  const promptInput = document.getElementById('systemPromptInput');
  if (promptInput) {
    promptInput.value = config.systemPrompt;
  }

  // Sync self-governance toggle
  const governanceToggle = document.getElementById('governanceToggle');
  if (governanceToggle) {
    governanceToggle.classList.toggle('active', config.selfGovernance);
  }

  // Sync database context
  const dbContextCheckbox = document.getElementById('enableDbContext');
  if (dbContextCheckbox) {
    dbContextCheckbox.checked = config.dbContextEnabled;
  }

  // Show/hide governance alerts
  const governanceAlerts = document.getElementById('governanceAlerts');
  if (governanceAlerts && config.lastAdjustment) {
    governanceAlerts.style.display = 'block';
    document.getElementById('lastGovernanceAdjustment').textContent = config.lastAdjustment;
  }
}

function toggleLlmSelection(element, llmId) {
  const checkbox = element.querySelector('input[type="checkbox"]');
  if (checkbox) {
    checkbox.checked = !checkbox.checked;
    element.classList.toggle('selected', checkbox.checked);

    // Update state
    if (STATE.atomicAi.config.llms[llmId]) {
      STATE.atomicAi.config.llms[llmId].enabled = checkbox.checked;
    }

    // Recalculate weights if needed
    rebalanceLlmWeights();
  }
}

function rebalanceLlmWeights() {
  const llms = STATE.atomicAi.config.llms;
  const enabledLlms = Object.entries(llms).filter(([_, cfg]) => cfg.enabled);

  if (enabledLlms.length === 0) {
    showToast('At least one LLM must be enabled', 'warning');
    // Re-enable Claude as fallback
    llms.claude.enabled = true;
    const claudeCheckbox = document.getElementById('llm-claude');
    if (claudeCheckbox) {
      claudeCheckbox.checked = true;
      claudeCheckbox.closest('.llm-option')?.classList.add('selected');
    }
    return;
  }

  // Distribute weights evenly among enabled LLMs
  const weightPerLlm = (1 / enabledLlms.length).toFixed(2);
  enabledLlms.forEach(([id, _]) => {
    llms[id].weight = parseFloat(weightPerLlm);
  });

  // Update weight displays in UI
  Object.entries(llms).forEach(([id, cfg]) => {
    const label = document.querySelector(`#llm-${id}`)?.closest('.llm-option');
    const weightDisplay = label?.querySelector('.llm-option-weight');
    if (weightDisplay) {
      weightDisplay.textContent = cfg.enabled ? `w=${cfg.weight.toFixed(2)}` : 'disabled';
    }
  });
}

function updateWeightDisplay(operator, value) {
  const valueElement = document.getElementById(`weight${operator.charAt(0).toUpperCase() + operator.slice(1)}Value`);

  if (operator === 'tau') {
    if (valueElement) valueElement.textContent = value;
    STATE.atomicAi.config.weights.tau = parseInt(value, 10);
  } else {
    const normalizedValue = (parseInt(value, 10) / 100).toFixed(2);
    if (valueElement) valueElement.textContent = normalizedValue;
    STATE.atomicAi.config.weights[operator] = parseFloat(normalizedValue);
  }

  // Update config hash in real-time
  updateConfigHash();
}

function toggleSelfGovernance() {
  const toggle = document.getElementById('governanceToggle');
  const alerts = document.getElementById('governanceAlerts');

  STATE.atomicAi.config.selfGovernance = !STATE.atomicAi.config.selfGovernance;

  if (toggle) {
    toggle.classList.toggle('active', STATE.atomicAi.config.selfGovernance);
  }

  if (alerts) {
    alerts.style.display = STATE.atomicAi.config.selfGovernance ? 'block' : 'none';
  }

  if (STATE.atomicAi.config.selfGovernance) {
    showToast('Self-Governance enabled - AI will auto-tune weights', 'info');
    logAuditEntry('self_governance_enabled', 'copilot', {
      weights: STATE.atomicAi.config.weights
    });
  }
}

async function saveAtomicAiConfig() {
  // Gather current config from UI
  const config = STATE.atomicAi.config;

  // Get system prompt
  const promptInput = document.getElementById('systemPromptInput');
  if (promptInput) {
    config.systemPrompt = promptInput.value;
  }

  // Get database context setting
  const dbContextCheckbox = document.getElementById('enableDbContext');
  if (dbContextCheckbox) {
    config.dbContextEnabled = dbContextCheckbox.checked;
  }

  // Compute hash for audit trail
  const configString = JSON.stringify({
    llms: config.llms,
    weights: config.weights,
    systemPrompt: config.systemPrompt,
    selfGovernance: config.selfGovernance,
    dbContextEnabled: config.dbContextEnabled
  });

  // Simple hash (in production, use BLAKE3)
  const hash = await computeSimpleHash(configString);
  config.configHash = hash;

  // Log to audit trail
  logAuditEntry('atomic_ai_config_updated', 'copilot', {
    configHash: hash,
    llmsEnabled: Object.entries(config.llms).filter(([_, c]) => c.enabled).map(([id, _]) => id),
    weights: config.weights,
    selfGovernance: config.selfGovernance,
    dbContextEnabled: config.dbContextEnabled
  });

  // Update UI
  document.getElementById('configHash').textContent = `Config Hash: ${hash.substring(0, 16)}...`;

  showToast('Configuration saved and hashed to audit log', 'success');
  closeAtomicAiConfig();
}

function resetAtomicAiConfig() {
  // Reset to default values
  STATE.atomicAi.config = {
    llms: {
      claude: { enabled: true, weight: 0.30 },
      gpt4o: { enabled: true, weight: 0.25 },
      gemini: { enabled: true, weight: 0.25 },
      llama: { enabled: true, weight: 0.20 }
    },
    weights: {
      phi: 0.40,
      psi: 0.40,
      delta: 0.20,
      tau: 90
    },
    systemPrompt: `You are Δtomic AI, a multi-LLM consensus copilot for the Atomic Trust compliance governance platform.

Your role is to assist users with:
- Understanding ΦΨΔIPT operators (Zero-Start Truth, Credential-Decay, Divergence, Trust)
- Analyzing compliance controls and evidence
- Finding cross-framework mappings via the Multi-Governance Fabric (MGF)
- Generating audit responses with cryptographic verification

Always cite specific controls (e.g., AC-1, SC-7) when relevant.
Provide confidence scores based on multi-model consensus.
Flag Byzantine conditions when Δ > 0.15.`,
    selfGovernance: false,
    dbContextEnabled: true,
    configHash: null,
    lastAdjustment: null
  };

  // Sync UI
  syncConfigUI();
  updateConfigHash();

  showToast('Configuration reset to defaults', 'info');
  logAuditEntry('atomic_ai_config_reset', 'copilot');
}

async function computeSimpleHash(str) {
  // Use SubtleCrypto for SHA-256 (BLAKE3 in production)
  const encoder = new TextEncoder();
  const data = encoder.encode(str);
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
}

async function updateConfigHash() {
  const config = STATE.atomicAi.config;
  const configString = JSON.stringify({
    llms: config.llms,
    weights: config.weights,
    systemPrompt: config.systemPrompt,
    selfGovernance: config.selfGovernance
  });

  const hash = await computeSimpleHash(configString);
  const hashElement = document.getElementById('configHash');
  if (hashElement) {
    hashElement.textContent = `Config Hash: ${hash.substring(0, 16)}...`;
  }
  config.configHash = hash;
}

async function updateDbContextCounts() {
  // Update database counts in config panel
  try {
    if (CONFIG.useRealAPI && apiConnected) {
      const controls = await getControls();
      const evidence = await getEvidence();
      const frameworks = getAllFrameworks();

      document.getElementById('dbControlCount').textContent = controls.length || 0;
      document.getElementById('dbEvidenceCount').textContent = evidence.length || 0;
      document.getElementById('dbFrameworkCount').textContent = frameworks.length || 4;
    }
  } catch (err) {
    console.error('[Atomic AI] Error fetching DB counts:', err);
  }
}

// ---- DATABASE-AWARE AI QUERY FUNCTIONS ----

async function queryDatabaseForAI(query) {
  const queryLower = query.toLowerCase();
  const result = {
    controls: [],
    evidence: [],
    frameworks: [],
    summary: null
  };

  try {
    // Check if query mentions specific control IDs
    const controlPattern = /(?:AC|AU|AT|CM|CP|IA|IR|MA|MP|PE|PL|PS|RA|SA|SC|SI|SR|PM)-\d+(?:-E\d+)?/gi;
    const controlMatches = query.match(controlPattern);

    if (controlMatches) {
      // Fetch specific controls
      for (const controlId of controlMatches) {
        const control = await API.getControlWithEvidence(controlId.toUpperCase());
        if (control) {
          result.controls.push(control);
        }
      }
    }

    // If asking about compliance status or summary
    if (queryLower.includes('status') || queryLower.includes('summary') || queryLower.includes('compliant') || queryLower.includes('how many')) {
      result.summary = await getSummary();
    }

    // If asking about evidence
    if (queryLower.includes('evidence') || queryLower.includes('document') || queryLower.includes('upload')) {
      const allEvidence = await getEvidence();
      // Return top 10 most relevant
      result.evidence = allEvidence.slice(0, 10);
    }

    // If asking about frameworks
    if (queryLower.includes('framework') || queryLower.includes('nist') || queryLower.includes('soc2') || queryLower.includes('iso')) {
      result.frameworks = getAllFrameworks();
    }

    // General control query - search by name/description keywords
    if (queryLower.includes('control') && !controlMatches) {
      const allControls = await getControls();
      const keywords = query.toLowerCase().split(/\s+/).filter(w => w.length > 3);

      result.controls = allControls.filter(ctrl => {
        const searchText = `${ctrl.id} ${ctrl.name} ${ctrl.description || ''}`.toLowerCase();
        return keywords.some(kw => searchText.includes(kw));
      }).slice(0, 10);
    }

  } catch (err) {
    console.error('[Atomic AI] Database query error:', err);
  }

  return result;
}

function formatDbContextForAI(dbResult) {
  let context = '';

  if (dbResult.summary) {
    context += `\n\n[DATABASE CONTEXT - Compliance Summary]\n`;
    context += `Total Controls: ${dbResult.summary.total || 0}\n`;
    context += `Compliant: ${dbResult.summary.compliant || 0}\n`;
    context += `At-Risk: ${dbResult.summary.at_risk || 0}\n`;
    context += `Critical: ${dbResult.summary.critical || 0}\n`;
  }

  if (dbResult.controls.length > 0) {
    context += `\n\n[DATABASE CONTEXT - Controls Found]\n`;
    dbResult.controls.forEach(ctrl => {
      context += `• ${ctrl.id || ctrl.control_id}: ${ctrl.name}\n`;
      context += `  Status: ${ctrl.status}, Φ=${ctrl.phi?.toFixed(2) || 'N/A'}, Evidence: ${ctrl.evidence?.length || ctrl.evidence_count || 0}\n`;
    });
  }

  if (dbResult.evidence.length > 0) {
    context += `\n\n[DATABASE CONTEXT - Recent Evidence]\n`;
    dbResult.evidence.slice(0, 5).forEach(evd => {
      context += `• ${evd.filename}: ${evd.type}, Control: ${evd.control_id}\n`;
    });
  }

  return context;
}

// ---- SELF-GOVERNANCE ENGINE ----

async function applySelfGovernance(queryResult) {
  if (!STATE.atomicAi.config.selfGovernance) return;

  const config = STATE.atomicAi.config;
  const weights = config.weights;

  // Analyze query result for optimization opportunities
  const delta = queryResult.delta || 0;
  const phi = queryResult.phi || 0;
  const modelsAgree = queryResult.modelsAgree || 0;
  const totalModels = queryResult.totalModels || 4;
  const consensusRatio = modelsAgree / totalModels;

  let adjusted = false;
  let adjustmentLog = [];

  // Emergent Operator: Τ (Trust Propagation)
  // If high consensus, slightly increase phi weight
  if (consensusRatio >= 0.75 && delta < 0.10) {
    const newPhi = Math.min(0.60, weights.phi + 0.01);
    if (newPhi !== weights.phi) {
      adjustmentLog.push(`Τ: φ ${weights.phi.toFixed(2)} → ${newPhi.toFixed(2)} (high consensus)`);
      weights.phi = newPhi;
      adjusted = true;
    }
  }

  // Emergent Operator: Β (Semantic Bridge)
  // If high divergence, increase delta penalty
  if (delta > 0.15) {
    const newDelta = Math.min(0.40, weights.delta + 0.02);
    if (newDelta !== weights.delta) {
      adjustmentLog.push(`Β: δ ${weights.delta.toFixed(2)} → ${newDelta.toFixed(2)} (high divergence)`);
      weights.delta = newDelta;
      adjusted = true;
    }
  }

  // Emergent Operator: Ι (Compliance Inheritance)
  // Maintain weight balance (phi + psi + delta should approach 1.0)
  const totalWeight = weights.phi + weights.psi + weights.delta;
  if (Math.abs(totalWeight - 1.0) > 0.05) {
    const scale = 1.0 / totalWeight;
    weights.phi = parseFloat((weights.phi * scale).toFixed(2));
    weights.psi = parseFloat((weights.psi * scale).toFixed(2));
    weights.delta = parseFloat((weights.delta * scale).toFixed(2));
    adjustmentLog.push(`Ι: Normalized weights to sum=1.0`);
    adjusted = true;
  }

  if (adjusted) {
    config.lastAdjustment = new Date().toISOString().replace('T', ' ').substring(0, 19);

    // Log to audit trail with hash
    const hash = await computeSimpleHash(JSON.stringify({
      timestamp: config.lastAdjustment,
      adjustments: adjustmentLog,
      newWeights: weights
    }));

    logAuditEntry('self_governance_adjustment', 'copilot', {
      adjustments: adjustmentLog,
      newWeights: weights,
      transactionHash: hash
    });

    // Show alert in config panel if open
    const alertsEl = document.getElementById('governanceAlerts');
    const lastAdjEl = document.getElementById('lastGovernanceAdjustment');
    if (alertsEl && lastAdjEl) {
      alertsEl.style.display = 'block';
      lastAdjEl.textContent = adjustmentLog.join('; ');
    }

    // Update config hash
    await updateConfigHash();
  }

  return { adjusted, adjustments: adjustmentLog };
}

// Sample Controls Data
const CONTROLS = [
  { id: 'UCP-001', name: 'Access Control Policy', frameworks: ['SOC2', 'ISO27001', 'NIST'], phi: 0.95, psi: 0.92, delta: 0.03, trust: 0.92, status: 'compliant', evidence: 12 },
  { id: 'UCP-002', name: 'Encryption Standards', frameworks: ['SOC2', 'ISO27001'], phi: 0.88, psi: 0.85, delta: 0.05, trust: 0.85, status: 'compliant', evidence: 8 },
  { id: 'UCP-003', name: 'Incident Response Plan', frameworks: ['SOC2', 'NIST', 'HIPAA'], phi: 0.72, psi: 0.68, delta: 0.18, trust: 0.68, status: 'at-risk', evidence: 5 },
  { id: 'UCP-004', name: 'Backup & Recovery', frameworks: ['SOC2', 'ISO27001'], phi: 0.91, psi: 0.89, delta: 0.02, trust: 0.89, status: 'compliant', evidence: 10 },
  { id: 'UCP-005', name: 'Vendor Management', frameworks: ['SOC2', 'HIPAA'], phi: 0.65, psi: 0.62, delta: 0.22, trust: 0.62, status: 'critical', evidence: 3 }
];

// Sample Evidence Library - Comprehensive with Kernel Integration
const EVIDENCE_LIBRARY = [
  {
    id: 'EV-001',
    title: 'Okta MFA Configuration Export',
    type: 'configuration',
    source: 'Okta Admin Console',
    uploadedAt: '2025-12-01T10:00:00Z',
    uploadedBy: 'security-team',
    fileType: 'json',
    fileSize: '24KB',
    hash: 'blake3:ev001_a1b2c3d4',
    linkedControls: ['AC-2', 'IA-2', 'IA-2(1)'],
    linkedFrameworks: ['NIST', 'SOC2', 'HIPAA', 'MARS-E', 'ARC-AMPE'],
    phi: 0.92,
    psi: 0.98,
    status: 'validated',
    validatedBy: ['claude', 'gpt4'],
    consensusId: 'cons_mfa_001',
    tags: ['mfa', 'authentication', 'okta', 'identity'],
    summary: 'MFA enforcement policy showing 100% coverage for production access'
  },
  {
    id: 'EV-002',
    title: 'AWS CloudTrail Audit Logs',
    type: 'logs',
    source: 'AWS CloudWatch',
    uploadedAt: '2025-12-05T14:30:00Z',
    uploadedBy: 'devops-team',
    fileType: 'json',
    fileSize: '156KB',
    hash: 'blake3:ev002_e5f6g7h8',
    linkedControls: ['AU-2', 'AU-3', 'AU-6'],
    linkedFrameworks: ['NIST', 'SOC2', 'HIPAA'],
    phi: 0.88,
    psi: 0.95,
    status: 'validated',
    validatedBy: ['claude', 'gpt4', 'deepseek'],
    consensusId: 'cons_audit_002',
    tags: ['audit', 'logging', 'aws', 'cloudtrail'],
    summary: 'Complete audit trail for all API calls with 90-day retention'
  },
  {
    id: 'EV-003',
    title: 'Encryption Policy Document v3.2',
    type: 'policy',
    source: 'SharePoint',
    uploadedAt: '2025-11-28T09:00:00Z',
    uploadedBy: 'compliance-team',
    fileType: 'pdf',
    fileSize: '89KB',
    hash: 'blake3:ev003_i9j0k1l2',
    linkedControls: ['SC-13', 'SC-28', 'SC-8'],
    linkedFrameworks: ['NIST', 'SOC2', 'ISO27001', 'HIPAA'],
    phi: 0.95,
    psi: 0.92,
    status: 'validated',
    validatedBy: ['claude', 'gpt4'],
    consensusId: 'cons_encrypt_003',
    tags: ['encryption', 'policy', 'aes256', 'tls'],
    summary: 'AES-256 encryption mandated for all PHI data at rest and in transit'
  },
  {
    id: 'EV-004',
    title: 'Penetration Test Report Q4 2025',
    type: 'assessment',
    source: 'External Auditor',
    uploadedAt: '2025-12-03T16:00:00Z',
    uploadedBy: 'security-team',
    fileType: 'pdf',
    fileSize: '2.4MB',
    hash: 'blake3:ev004_m3n4o5p6',
    linkedControls: ['CA-8', 'RA-5', 'SI-2'],
    linkedFrameworks: ['NIST', 'SOC2', 'ISO27001'],
    phi: 0.91,
    psi: 0.89,
    status: 'validated',
    validatedBy: ['claude'],
    consensusId: 'cons_pentest_004',
    tags: ['pentest', 'vulnerability', 'assessment', 'quarterly'],
    summary: 'No critical findings, 3 medium issues remediated within SLA'
  },
  {
    id: 'EV-005',
    title: 'Incident Response Playbook',
    type: 'policy',
    source: 'Confluence',
    uploadedAt: '2025-10-15T11:00:00Z',
    uploadedBy: 'security-team',
    fileType: 'pdf',
    fileSize: '156KB',
    hash: 'blake3:ev005_q7r8s9t0',
    linkedControls: ['IR-4', 'IR-5', 'IR-6', 'IR-8'],
    linkedFrameworks: ['NIST', 'SOC2', 'HIPAA', 'MARS-E'],
    phi: 0.72,
    psi: 0.58,
    status: 'needs-review',
    validatedBy: ['gpt4'],
    consensusId: 'cons_ir_005',
    tags: ['incident', 'response', 'playbook', 'outdated'],
    summary: 'IR playbook needs update - last revision 8 months ago'
  },
  {
    id: 'EV-006',
    title: 'Backup Recovery Test Results',
    type: 'records',
    source: 'Veeam Console',
    uploadedAt: '2025-12-06T08:00:00Z',
    uploadedBy: 'infrastructure-team',
    fileType: 'csv',
    fileSize: '34KB',
    hash: 'blake3:ev006_u1v2w3x4',
    linkedControls: ['CP-9', 'CP-10', 'CP-4'],
    linkedFrameworks: ['NIST', 'SOC2', 'ISO27001'],
    phi: 0.94,
    psi: 0.96,
    status: 'validated',
    validatedBy: ['claude', 'gpt4', 'deepseek'],
    consensusId: 'cons_backup_006',
    tags: ['backup', 'recovery', 'test', 'rpo', 'rto'],
    summary: 'Weekly backup test passed - 47 systems verified, RTO < 4hrs'
  },
  {
    id: 'EV-007',
    title: 'Vendor Risk Assessment - AWS',
    type: 'assessment',
    source: 'GRC Platform',
    uploadedAt: '2025-09-12T16:00:00Z',
    uploadedBy: 'vendor-management',
    fileType: 'xlsx',
    fileSize: '267KB',
    hash: 'blake3:ev007_y5z6a7b8',
    linkedControls: ['SA-9', 'SA-12', 'SR-6'],
    linkedFrameworks: ['NIST', 'SOC2', 'HIPAA'],
    phi: 0.65,
    psi: 0.42,
    status: 'needs-review',
    validatedBy: [],
    consensusId: null,
    tags: ['vendor', 'aws', 'third-party', 'expired'],
    summary: 'AWS vendor assessment EXPIRED - requires annual renewal'
  },
  {
    id: 'EV-008',
    title: 'Access Control Matrix',
    type: 'configuration',
    source: 'IAM Console',
    uploadedAt: '2025-12-04T13:00:00Z',
    uploadedBy: 'security-team',
    fileType: 'json',
    fileSize: '78KB',
    hash: 'blake3:ev008_c9d0e1f2',
    linkedControls: ['AC-2', 'AC-3', 'AC-6', 'AC-17'],
    linkedFrameworks: ['NIST', 'SOC2', 'HIPAA', 'ISO27001'],
    phi: 0.93,
    psi: 0.91,
    status: 'validated',
    validatedBy: ['claude', 'gpt4'],
    consensusId: 'cons_acm_008',
    tags: ['access', 'rbac', 'permissions', 'least-privilege'],
    summary: 'Role-based access control matrix with quarterly review attestation'
  },
  {
    id: 'EV-009',
    title: 'Security Awareness Training Records',
    type: 'records',
    source: 'KnowBe4',
    uploadedAt: '2025-11-30T10:00:00Z',
    uploadedBy: 'hr-team',
    fileType: 'csv',
    fileSize: '45KB',
    hash: 'blake3:ev009_g3h4i5j6',
    linkedControls: ['AT-2', 'AT-3', 'AT-4'],
    linkedFrameworks: ['NIST', 'SOC2', 'HIPAA'],
    phi: 0.89,
    psi: 0.94,
    status: 'validated',
    validatedBy: ['claude'],
    consensusId: 'cons_training_009',
    tags: ['training', 'awareness', 'phishing', 'compliance'],
    summary: '98% completion rate for annual security awareness training'
  },
  {
    id: 'EV-010',
    title: 'Network Segmentation Diagram',
    type: 'configuration',
    source: 'Lucidchart',
    uploadedAt: '2025-12-02T15:00:00Z',
    uploadedBy: 'network-team',
    fileType: 'png',
    fileSize: '1.2MB',
    hash: 'blake3:ev010_k7l8m9n0',
    linkedControls: ['SC-7', 'SC-7(5)', 'AC-4'],
    linkedFrameworks: ['NIST', 'SOC2', 'HIPAA', 'MARS-E'],
    phi: 0.87,
    psi: 0.85,
    status: 'validated',
    validatedBy: ['gpt4', 'deepseek'],
    consensusId: 'cons_network_010',
    tags: ['network', 'segmentation', 'firewall', 'dmz'],
    summary: 'Production network isolated with defense-in-depth architecture'
  }
];

// Legacy alias for backward compatibility
const EVIDENCE = EVIDENCE_LIBRARY;

// Sample RFP Data - Comprehensive
const RFPS = [
  {
    id: 'RFP-2025-001',
    title: 'FedRAMP Moderate Authorization Package',
    client: 'U.S. Department of Defense',
    type: 'govcloud',
    status: 'in_progress',
    dueDate: '2026-01-15',
    totalClauses: 147,
    mappedClauses: 128,
    coverage: 0.87,
    gapCount: 19,
    frameworks: ['FedRAMP', 'NIST 800-53', 'FISMA'],
    assignedTo: 'Rafael Velado',
    priority: 'high',
    createdAt: '2025-10-01T08:00:00Z',
    clauses: [
      { id: 'AC-2', title: 'Account Management', requirement: 'Organization manages system accounts including approval, role assignments, and periodic review', mappedControl: 'UCP-001', status: 'compliant', gap: null },
      { id: 'AC-3', title: 'Access Enforcement', requirement: 'System enforces approved authorizations for logical access', mappedControl: 'UCP-001', status: 'compliant', gap: null },
      { id: 'AC-7', title: 'Unsuccessful Login Attempts', requirement: 'System enforces limit of 3 consecutive invalid login attempts', mappedControl: 'UCP-001', status: 'gap', gap: 'Current limit is 5 attempts, needs to be reduced to 3' },
      { id: 'SC-7', title: 'Boundary Protection', requirement: 'System monitors and controls communications at external boundaries', mappedControl: 'UCP-002', status: 'compliant', gap: null },
      { id: 'SC-13', title: 'Cryptographic Protection', requirement: 'System implements FIPS 140-2 validated cryptography', mappedControl: 'UCP-002', status: 'compliant', gap: null },
      { id: 'IR-4', title: 'Incident Handling', requirement: 'Organization implements incident handling capability', mappedControl: 'UCP-003', status: 'gap', gap: 'Incident response plan is outdated (318 days old)' },
      { id: 'CP-9', title: 'System Backup', requirement: 'Organization conducts backups of system-level information', mappedControl: 'UCP-004', status: 'compliant', gap: null },
      { id: 'SA-9', title: 'External System Services', requirement: 'Organization requires external service providers to comply with security requirements', mappedControl: 'UCP-005', status: 'gap', gap: 'AWS vendor assessment expired 78 days ago' }
    ]
  },
  {
    id: 'RFP-2025-002',
    title: 'SOC 2 Type II Readiness Assessment',
    client: 'FinServ Bank Corp',
    type: 'finance',
    status: 'in_progress',
    dueDate: '2025-12-20',
    totalClauses: 89,
    mappedClauses: 84,
    coverage: 0.94,
    gapCount: 5,
    frameworks: ['SOC2', 'ISO27001'],
    assignedTo: 'Sarah Chen',
    priority: 'high',
    createdAt: '2025-11-01T10:00:00Z',
    clauses: [
      { id: 'CC6.1', title: 'Logical and Physical Access Controls', requirement: 'The entity implements logical access security software to prevent unauthorized access', mappedControl: 'UCP-001', status: 'compliant', gap: null },
      { id: 'CC6.6', title: 'Encryption of Data in Transit', requirement: 'The entity uses encryption to protect data during transmission', mappedControl: 'UCP-002', status: 'compliant', gap: null },
      { id: 'CC7.3', title: 'Incident Response', requirement: 'The entity evaluates security events to identify security incidents', mappedControl: 'UCP-003', status: 'gap', gap: 'No formal incident evaluation process documented' },
      { id: 'A1.2', title: 'Backup and Recovery', requirement: 'The entity has defined and approved recovery time and point objectives', mappedControl: 'UCP-004', status: 'compliant', gap: null }
    ]
  },
  {
    id: 'RFP-2025-003',
    title: 'HIPAA Security Rule Compliance',
    client: 'HealthTech Solutions Inc',
    type: 'healthcare',
    status: 'completed',
    dueDate: '2025-11-30',
    totalClauses: 54,
    mappedClauses: 54,
    coverage: 1.00,
    gapCount: 0,
    frameworks: ['HIPAA', 'HITRUST'],
    assignedTo: 'Marcus Johnson',
    priority: 'medium',
    createdAt: '2025-09-15T14:00:00Z',
    clauses: [
      { id: '164.308(a)(3)', title: 'Workforce Security', requirement: 'Implement policies and procedures to ensure workforce members have appropriate access', mappedControl: 'UCP-001', status: 'compliant', gap: null },
      { id: '164.312(a)(2)(iv)', title: 'Encryption and Decryption', requirement: 'Implement mechanism to encrypt and decrypt ePHI', mappedControl: 'UCP-002', status: 'compliant', gap: null },
      { id: '164.308(a)(6)', title: 'Security Incident Procedures', requirement: 'Implement policies to address security incidents', mappedControl: 'UCP-003', status: 'compliant', gap: null }
    ]
  },
  {
    id: 'RFP-2025-004',
    title: 'ISO 27001:2022 Certification Audit',
    client: 'Global Enterprise Tech',
    type: 'certification',
    status: 'pending',
    dueDate: '2026-03-01',
    totalClauses: 114,
    mappedClauses: 97,
    coverage: 0.85,
    gapCount: 17,
    frameworks: ['ISO27001', 'ISO27002'],
    assignedTo: 'Rafael Velado',
    priority: 'high',
    createdAt: '2025-11-15T09:00:00Z',
    clauses: [
      { id: 'A.9.2', title: 'User Access Management', requirement: 'A formal user access provisioning process shall be implemented', mappedControl: 'UCP-001', status: 'compliant', gap: null },
      { id: 'A.10.1', title: 'Cryptographic Controls', requirement: 'A policy on the use of cryptographic controls shall be developed', mappedControl: 'UCP-002', status: 'compliant', gap: null },
      { id: 'A.16.1', title: 'Incident Management', requirement: 'Management responsibilities and procedures shall be established', mappedControl: 'UCP-003', status: 'gap', gap: 'Incident management procedures need formal approval' },
      { id: 'A.12.3', title: 'Information Backup', requirement: 'Backup copies of information shall be made and tested regularly', mappedControl: 'UCP-004', status: 'compliant', gap: null },
      { id: 'A.15.1', title: 'Supplier Relationships', requirement: 'Information security requirements for supplier relationships shall be agreed', mappedControl: 'UCP-005', status: 'gap', gap: 'Need updated supplier security agreements' }
    ]
  }
];

// Sample Forensics Cases Data - Comprehensive
const FORENSICS_CASES = [
  {
    id: 'CASE-2025-001',
    title: 'Unauthorized Access Attempt - Production DB',
    type: 'security_incident',
    severity: 'critical',
    status: 'active',
    openedAt: '2025-11-28T14:23:00Z',
    openedBy: 'Sarah Chen',
    assignedTo: 'Rafael Velado',
    priority: 'high',
    affectedSystems: ['Production Database', 'API Gateway', 'Auth Service'],
    affectedControls: ['UCP-001', 'UCP-002'],
    evidenceCount: 12,
    timeline: [
      { timestamp: '2025-11-28T14:23:00Z', event: 'Multiple failed login attempts detected', actor: 'System Alert', type: 'detection', severity: 'high' },
      { timestamp: '2025-11-28T14:25:00Z', event: 'Source IP identified: 192.168.45.127 (VPN endpoint)', actor: 'SOC Analyst', type: 'investigation', severity: 'high' },
      { timestamp: '2025-11-28T14:30:00Z', event: 'Account locked: admin@internal.local', actor: 'Auto-Response', type: 'containment', severity: 'medium' },
      { timestamp: '2025-11-28T14:45:00Z', event: 'Investigation started - reviewing access logs', actor: 'Rafael Velado', type: 'investigation', severity: 'medium' },
      { timestamp: '2025-11-28T15:00:00Z', event: 'Pattern analysis: 247 attempts in 3 minutes', actor: 'Forensics Engine', type: 'analysis', severity: 'critical' },
      { timestamp: '2025-11-28T15:15:00Z', event: 'Credential source identified: compromised service account', actor: 'Rafael Velado', type: 'root_cause', severity: 'critical' }
    ],
    findings: {
      rootCause: 'Service account credentials compromised via phishing',
      impactAssessment: 'No data exfiltration detected. Access blocked before privilege escalation.',
      recommendations: [
        'Rotate all service account credentials',
        'Implement MFA for service accounts',
        'Update phishing detection rules',
        'Review access control policies'
      ]
    },
    metrics: {
      detectionTime: 120, // seconds
      responseTime: 420, // seconds
      containmentTime: 900, // seconds
      severityScore: 8.5
    }
  },
  {
    id: 'CASE-2025-002',
    title: 'Policy Violation - Data Access Anomaly',
    type: 'policy_violation',
    severity: 'medium',
    status: 'investigating',
    openedAt: '2025-11-27T09:15:00Z',
    openedBy: 'Marcus Johnson',
    assignedTo: 'Sarah Chen',
    priority: 'medium',
    affectedSystems: ['Customer Database', 'CRM System'],
    affectedControls: ['UCP-001', 'UCP-003'],
    evidenceCount: 8,
    timeline: [
      { timestamp: '2025-11-27T09:15:00Z', event: 'Unusual data access pattern detected', actor: 'DLP System', type: 'detection', severity: 'medium' },
      { timestamp: '2025-11-27T09:30:00Z', event: 'User queried 15,000+ customer records', actor: 'Audit Log', type: 'evidence', severity: 'medium' },
      { timestamp: '2025-11-27T10:00:00Z', event: 'Case opened for investigation', actor: 'Marcus Johnson', type: 'investigation', severity: 'medium' },
      { timestamp: '2025-11-27T10:30:00Z', event: 'User interview scheduled', actor: 'Sarah Chen', type: 'investigation', severity: 'low' },
      { timestamp: '2025-11-27T14:00:00Z', event: 'Interview conducted - legitimate business need confirmed', actor: 'Sarah Chen', type: 'analysis', severity: 'low' }
    ],
    findings: {
      rootCause: 'Legitimate quarterly audit query - proper approval obtained',
      impactAssessment: 'No policy violation. Process documentation needed.',
      recommendations: [
        'Update data access request procedures',
        'Implement query approval workflow',
        'Document legitimate bulk access patterns'
      ]
    },
    metrics: {
      detectionTime: 900,
      responseTime: 1800,
      containmentTime: null,
      severityScore: 4.2
    }
  },
  {
    id: 'CASE-2025-003',
    title: 'Configuration Drift - Encryption Standards',
    type: 'compliance_drift',
    severity: 'high',
    status: 'resolved',
    openedAt: '2025-11-20T11:00:00Z',
    openedBy: 'Automated Scan',
    assignedTo: 'Rafael Velado',
    priority: 'high',
    affectedSystems: ['API Gateway', 'Load Balancer'],
    affectedControls: ['UCP-002'],
    evidenceCount: 5,
    resolvedAt: '2025-11-26T16:30:00Z',
    timeline: [
      { timestamp: '2025-11-20T11:00:00Z', event: 'TLS 1.1 detected on API gateway (policy requires 1.3)', actor: 'Compliance Scanner', type: 'detection', severity: 'high' },
      { timestamp: '2025-11-20T11:15:00Z', event: 'Configuration baseline comparison initiated', actor: 'Forensics Engine', type: 'analysis', severity: 'high' },
      { timestamp: '2025-11-20T14:00:00Z', event: 'Drift confirmed - legacy config restored accidentally', actor: 'Rafael Velado', type: 'root_cause', severity: 'high' },
      { timestamp: '2025-11-26T15:00:00Z', event: 'TLS 1.3 enforced across all endpoints', actor: 'Rafael Velado', type: 'remediation', severity: 'medium' },
      { timestamp: '2025-11-26T15:30:00Z', event: 'Configuration locked with infrastructure-as-code', actor: 'Rafael Velado', type: 'remediation', severity: 'medium' },
      { timestamp: '2025-11-26T16:30:00Z', event: 'Case resolved - compliance restored', actor: 'Sarah Chen', type: 'resolution', severity: 'low' }
    ],
    findings: {
      rootCause: 'Manual configuration change during incident response',
      impactAssessment: 'Temporary exposure to deprecated TLS version. No exploitation detected.',
      recommendations: [
        'Enforce infrastructure-as-code for all changes',
        'Implement change approval workflow',
        'Add automated drift detection'
      ]
    },
    metrics: {
      detectionTime: 3600,
      responseTime: 7200,
      containmentTime: 518400, // 6 days
      severityScore: 7.1
    }
  },
  {
    id: 'CASE-2024-047',
    title: 'Vendor Security Assessment Lapse',
    type: 'compliance_violation',
    severity: 'medium',
    status: 'resolved',
    openedAt: '2025-09-15T08:00:00Z',
    openedBy: 'Quarterly Review',
    assignedTo: 'Marcus Johnson',
    priority: 'low',
    affectedSystems: ['AWS Infrastructure'],
    affectedControls: ['UCP-005'],
    evidenceCount: 3,
    resolvedAt: '2025-11-10T17:00:00Z',
    timeline: [
      { timestamp: '2025-09-15T08:00:00Z', event: 'AWS vendor assessment expired', actor: 'Automated Review', type: 'detection', severity: 'medium' },
      { timestamp: '2025-09-16T10:00:00Z', event: 'Case assigned for remediation', actor: 'Sarah Chen', type: 'investigation', severity: 'low' },
      { timestamp: '2025-11-05T14:00:00Z', event: 'New assessment initiated', actor: 'Marcus Johnson', type: 'remediation', severity: 'low' },
      { timestamp: '2025-11-10T17:00:00Z', event: 'Assessment completed and approved', actor: 'Marcus Johnson', type: 'resolution', severity: 'low' }
    ],
    findings: {
      rootCause: 'Assessment renewal process not tracked properly',
      impactAssessment: 'Administrative lapse. AWS maintains SOC 2 Type II.',
      recommendations: [
        'Implement automated renewal tracking',
        'Set 60-day advance notifications',
        'Centralize vendor assessment calendar'
      ]
    },
    metrics: {
      detectionTime: 86400,
      responseTime: 172800,
      containmentTime: 4752000, // 55 days
      severityScore: 3.5
    }
  }
];

// Multi-Governance Fabric (MGF) - Framework Mapping Data
// Patent #2: Atomic cross-framework propagation with Ψ decay

const FRAMEWORKS = [
  {
    id: 'nist-800-53',
    name: 'NIST 800-53 Rev 5',
    version: 'Rev 5 Moderate Baseline',
    totalClauses: 323,
    mappedClauses: 323,
    coverage: 1.00,
    lastReviewed: '2025-12-07T00:00:00Z',
    daysOld: 0,
    psi: 1.00,
    status: 'active',
    families: ['AC', 'AT', 'AU', 'CA', 'CM', 'CP', 'IA', 'IR', 'MA', 'MP', 'PE', 'PL', 'PM', 'PS', 'PT', 'RA', 'SA', 'SC', 'SI', 'SR']
  },
  {
    id: 'soc2',
    name: 'SOC 2 Type II',
    version: '2017 Trust Services Criteria',
    totalClauses: 89,
    mappedClauses: 89,
    coverage: 1.00,
    lastReviewed: '2025-12-07T00:00:00Z',
    daysOld: 0,
    psi: 1.00,
    status: 'active',
    families: ['CC1', 'CC2', 'CC3', 'CC4', 'CC5', 'CC6', 'CC7', 'CC8', 'CC9', 'A1', 'C1', 'PI1', 'P1']
  },
  {
    id: 'iso27001',
    name: 'ISO 27001:2022',
    version: '2022 Annex A',
    totalClauses: 93,
    mappedClauses: 93,
    coverage: 1.00,
    lastReviewed: '2025-12-07T00:00:00Z',
    daysOld: 0,
    psi: 1.00,
    status: 'active',
    families: ['5-Organizational', '6-People', '7-Physical', '8-Technological']
  },
  {
    id: 'hipaa',
    name: 'HIPAA Security Rule',
    version: '45 CFR Part 164',
    totalClauses: 54,
    mappedClauses: 54,
    coverage: 1.00,
    lastReviewed: '2025-12-07T00:00:00Z',
    daysOld: 0,
    psi: 1.00,
    status: 'active',
    families: ['Administrative', 'Physical', 'Technical']
  },
  {
    id: 'mars-e',
    name: 'MARS-E 2.2',
    version: 'Version 2.2',
    totalClauses: 310,
    mappedClauses: 310,
    coverage: 1.00,
    lastReviewed: '2025-12-07T00:00:00Z',
    daysOld: 0,
    psi: 1.00,
    status: 'active',
    families: ['AC', 'AT', 'AU', 'CA', 'CM', 'CP', 'IA', 'IR', 'MA', 'MP', 'PE', 'PL', 'PM', 'PS', 'RA', 'SA', 'SC', 'SI', 'SR'],
    inheritsFrom: 'nist-800-53',
    cmsOverlays: true
  },
  {
    id: 'arc-ampe',
    name: 'ARC-AMPE',
    version: 'CMS Marketplace',
    totalClauses: 156,
    mappedClauses: 156,
    coverage: 1.00,
    lastReviewed: '2025-12-07T00:00:00Z',
    daysOld: 0,
    psi: 1.00,
    status: 'active',
    families: ['AC', 'AU', 'CA', 'CM', 'CP', 'IA', 'IR', 'PE', 'PL', 'PS', 'RA', 'SA', 'SC', 'SI'],
    inheritsFrom: 'mars-e',
    cmsOverlays: true
  }
];



// Framework Equivalence Mappings
// Shows atomic propagation - vote on one, update all
const FRAMEWORK_EQUIVALENCES = [
  {
    id: 'EQ-AC-001',
    family: 'Access Control',
    controlId: 'UCP-AC-001',
    controlName: 'Access Control Policy and Procedures',
    equivalentClauses: [
      { framework: 'NIST', clause: 'AC-1', title: 'Policy and Procedures', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC6.1', title: 'Logical and Physical Access Controls', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '5.15', title: 'Access Control', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.308(a)(3)', title: 'Workforce Security', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'AC-1', title: 'Access Control Policy', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'AC-1', title: 'Access Control Policy', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.97,
    divergenceScore: 0.03,
    propagationEnabled: true,
    hash: 'blake3:eq_ac_001'
  },
  {
    id: 'EQ-AC-002',
    family: 'Access Control',
    controlId: 'UCP-AC-002',
    controlName: 'Account Management',
    equivalentClauses: [
      { framework: 'NIST', clause: 'AC-2', title: 'Account Management', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC6.2', title: 'User Registration and Deregistration', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '5.16', title: 'Identity Management', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.308(a)(4)', title: 'Information Access Management', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'AC-2', title: 'Account Management', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'AC-2', title: 'Account Management', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.96,
    divergenceScore: 0.04,
    propagationEnabled: true,
    hash: 'blake3:eq_ac_002'
  },
  {
    id: 'EQ-AC-003',
    family: 'Access Control',
    controlId: 'UCP-AC-003',
    controlName: 'Access Enforcement',
    equivalentClauses: [
      { framework: 'NIST', clause: 'AC-3', title: 'Access Enforcement', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC6.3', title: 'Role-Based Access', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '5.18', title: 'Access Rights', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.312(a)(1)', title: 'Access Control', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'AC-3', title: 'Access Enforcement', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'AC-3', title: 'Access Enforcement', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.95,
    divergenceScore: 0.05,
    propagationEnabled: true,
    hash: 'blake3:eq_ac_003'
  },
  {
    id: 'EQ-AC-004',
    family: 'Access Control',
    controlId: 'UCP-AC-004',
    controlName: 'Least Privilege',
    equivalentClauses: [
      { framework: 'NIST', clause: 'AC-6', title: 'Least Privilege', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC6.3', title: 'Least Privilege', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '8.2', title: 'Privileged Access Rights', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.312(a)(1)', title: 'Access Control - Minimum Necessary', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'AC-6', title: 'Least Privilege', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'AC-6', title: 'Least Privilege', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.94,
    divergenceScore: 0.06,
    propagationEnabled: true,
    hash: 'blake3:eq_ac_004'
  },
  {
    id: 'EQ-AC-005',
    family: 'Access Control',
    controlId: 'UCP-AC-005',
    controlName: 'Remote Access',
    equivalentClauses: [
      { framework: 'NIST', clause: 'AC-17', title: 'Remote Access', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC6.6', title: 'Secure Remote Access', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '8.1', title: 'User Endpoint Devices', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.312(e)(1)', title: 'Transmission Security', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'AC-17', title: 'Remote Access', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'AC-17', title: 'Remote Access', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.93,
    divergenceScore: 0.07,
    propagationEnabled: true,
    hash: 'blake3:eq_ac_005'
  },
  {
    id: 'EQ-AC-006',
    family: 'Access Control',
    controlId: 'UCP-AC-006',
    controlName: 'Session Lock and Termination',
    equivalentClauses: [
      { framework: 'NIST', clause: 'AC-11', title: 'Session Lock', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC6.2', title: 'Session Termination', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '8.23', title: 'Session Timeout', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.312(a)(1)', title: 'Automatic Logoff', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'AC-11', title: 'Session Lock', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'AC-11', title: 'Session Lock', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.92,
    divergenceScore: 0.08,
    propagationEnabled: true,
    hash: 'blake3:eq_ac_006'
  },
  {
    id: 'EQ-AC-007',
    family: 'Access Control',
    controlId: 'UCP-AC-007',
    controlName: 'Separation of Duties',
    equivalentClauses: [
      { framework: 'NIST', clause: 'AC-5', title: 'Separation of Duties', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC1.1', title: 'Roles and Responsibilities', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '5.2', title: 'Separation of Duties', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.308(a)(3)', title: 'Workforce Clearance', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'AC-5', title: 'Separation of Duties', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'AC-5', title: 'Separation of Duties', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.93,
    divergenceScore: 0.07,
    propagationEnabled: true,
    hash: 'blake3:eq_ac_007'
  },
  {
    id: 'EQ-AC-008',
    family: 'Access Control',
    controlId: 'UCP-AC-008',
    controlName: 'Mobile Device and Remote Work',
    equivalentClauses: [
      { framework: 'NIST', clause: 'AC-18', title: 'Access Control for Mobile Devices', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC6.6', title: 'Remote Access Protections', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '8.1', title: 'User Endpoint Devices', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.312(e)(1)', title: 'Transmission Security', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'AC-18', title: 'Access Control for Mobile Devices', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'AC-18', title: 'Access Control for Mobile Devices', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.92,
    divergenceScore: 0.08,
    propagationEnabled: true,
    hash: 'blake3:eq_ac_008'
  },
  {
    id: 'EQ-AU-001',
    family: 'Audit and Accountability',
    controlId: 'UCP-AU-001',
    controlName: 'Audit Events',
    equivalentClauses: [
      { framework: 'NIST', clause: 'AU-2', title: 'Audit Events', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC7.2', title: 'System Monitoring', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '8.15', title: 'Logging', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.312(b)', title: 'Audit Controls', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'AU-2', title: 'Audit Events', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'AU-2', title: 'Audit Events', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.96,
    divergenceScore: 0.04,
    propagationEnabled: true,
    hash: 'blake3:eq_au_001'
  },
  {
    id: 'EQ-AU-002',
    family: 'Audit and Accountability',
    controlId: 'UCP-AU-002',
    controlName: 'Audit Record Content',
    equivalentClauses: [
      { framework: 'NIST', clause: 'AU-3', title: 'Content of Audit Records', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC7.2', title: 'Audit Log Content', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '8.15', title: 'Logging', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.312(b)', title: 'Audit Controls', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'AU-3', title: 'Content of Audit Records', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'AU-3', title: 'Content of Audit Records', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.95,
    divergenceScore: 0.05,
    propagationEnabled: true,
    hash: 'blake3:eq_au_002'
  },
  {
    id: 'EQ-AU-003',
    family: 'Audit and Accountability',
    controlId: 'UCP-AU-003',
    controlName: 'Audit Review and Analysis',
    equivalentClauses: [
      { framework: 'NIST', clause: 'AU-6', title: 'Audit Review, Analysis, and Reporting', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC7.2', title: 'Security Event Analysis', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '8.16', title: 'Monitoring Activities', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.308(a)(1)(ii)(D)', title: 'Information System Activity Review', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'AU-6', title: 'Audit Review', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'AU-6', title: 'Audit Review', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.94,
    divergenceScore: 0.06,
    propagationEnabled: true,
    hash: 'blake3:eq_au_003'
  },
  {
    id: 'EQ-AU-004',
    family: 'Audit and Accountability',
    controlId: 'UCP-AU-004',
    controlName: 'Time Stamps',
    equivalentClauses: [
      { framework: 'NIST', clause: 'AU-8', title: 'Time Stamps', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC7.2', title: 'Log Time Synchronization', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '8.15', title: 'Logging', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.312(b)', title: 'Audit Controls', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'AU-8', title: 'Time Stamps', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'AU-8', title: 'Time Stamps', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.93,
    divergenceScore: 0.07,
    propagationEnabled: true,
    hash: 'blake3:eq_au_004'
  },
  {
    id: 'EQ-AU-005',
    family: 'Audit and Accountability',
    controlId: 'UCP-AU-005',
    controlName: 'Audit Generation',
    equivalentClauses: [
      { framework: 'NIST', clause: 'AU-12', title: 'Audit Generation', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC7.2', title: 'Audit Generation', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '8.15', title: 'Logging', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.312(b)', title: 'Audit Controls', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'AU-12', title: 'Audit Generation', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'AU-12', title: 'Audit Generation', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.93,
    divergenceScore: 0.07,
    propagationEnabled: true,
    hash: 'blake3:eq_au_005'
  },
  {
    id: 'EQ-IA-001',
    family: 'Identification and Authentication',
    controlId: 'UCP-IA-001',
    controlName: 'User Identification and Authentication',
    equivalentClauses: [
      { framework: 'NIST', clause: 'IA-2', title: 'Identification and Authentication', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC6.1', title: 'User Authentication', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '8.5', title: 'Secure Authentication', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.312(d)', title: 'Person or Entity Authentication', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'IA-2', title: 'Identification and Authentication', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'IA-2', title: 'Identification and Authentication', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.97,
    divergenceScore: 0.03,
    propagationEnabled: true,
    hash: 'blake3:eq_ia_001'
  },
  {
    id: 'EQ-IA-002',
    family: 'Identification and Authentication',
    controlId: 'UCP-IA-002',
    controlName: 'Multi-Factor Authentication',
    equivalentClauses: [
      { framework: 'NIST', clause: 'IA-2(1)', title: 'MFA to Privileged Accounts', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC6.1', title: 'Multi-Factor Authentication', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '8.5', title: 'Secure Authentication', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.312(d)', title: 'Person or Entity Authentication', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'IA-2(1)', title: 'MFA to Privileged Accounts', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'IA-2(1)', title: 'MFA to Privileged Accounts', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.98,
    divergenceScore: 0.02,
    propagationEnabled: true,
    hash: 'blake3:eq_ia_002'
  },
  {
    id: 'EQ-IA-003',
    family: 'Identification and Authentication',
    controlId: 'UCP-IA-003',
    controlName: 'Authenticator Management',
    equivalentClauses: [
      { framework: 'NIST', clause: 'IA-5', title: 'Authenticator Management', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC6.1', title: 'Credential Management', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '8.5', title: 'Secure Authentication', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.312(d)', title: 'Authentication', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'IA-5', title: 'Authenticator Management', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'IA-5', title: 'Authenticator Management', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.95,
    divergenceScore: 0.05,
    propagationEnabled: true,
    hash: 'blake3:eq_ia_003'
  },
  {
    id: 'EQ-IA-004',
    family: 'Identification and Authentication',
    controlId: 'UCP-IA-004',
    controlName: 'Device Identification and Authentication',
    equivalentClauses: [
      { framework: 'NIST', clause: 'IA-3', title: 'Device Identification and Authentication', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC6.1', title: 'Device Authentication', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '8.6', title: 'Identity Management for Devices', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.310(d)(1)', title: 'Device and Media Controls', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'IA-3', title: 'Device Identification and Authentication', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'IA-3', title: 'Device Identification and Authentication', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.92,
    divergenceScore: 0.08,
    propagationEnabled: true,
    hash: 'blake3:eq_ia_004'
  },
  {
    id: 'EQ-IR-001',
    family: 'Incident Response',
    controlId: 'UCP-IR-001',
    controlName: 'Incident Response Policy',
    equivalentClauses: [
      { framework: 'NIST', clause: 'IR-1', title: 'Policy and Procedures', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC7.3', title: 'Incident Response', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '5.24', title: 'Incident Management Planning', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.308(a)(6)', title: 'Security Incident Procedures', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'IR-1', title: 'Incident Response Policy', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'IR-1', title: 'Incident Response Policy', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.96,
    divergenceScore: 0.04,
    propagationEnabled: true,
    hash: 'blake3:eq_ir_001'
  },
  {
    id: 'EQ-IR-002',
    family: 'Incident Response',
    controlId: 'UCP-IR-002',
    controlName: 'Incident Handling',
    equivalentClauses: [
      { framework: 'NIST', clause: 'IR-4', title: 'Incident Handling', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC7.4', title: 'Incident Response Execution', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '5.25', title: 'Assessment of Security Events', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.308(a)(6)(ii)', title: 'Response and Reporting', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'IR-4', title: 'Incident Handling', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'IR-4', title: 'Incident Handling', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.95,
    divergenceScore: 0.05,
    propagationEnabled: true,
    hash: 'blake3:eq_ir_002'
  },
  {
    id: 'EQ-IR-003',
    family: 'Incident Response',
    controlId: 'UCP-IR-003',
    controlName: 'Incident Reporting',
    equivalentClauses: [
      { framework: 'NIST', clause: 'IR-6', title: 'Incident Reporting', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC7.4', title: 'Incident Response Execution', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '5.25', title: 'Reporting Security Events', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.308(a)(6)', title: 'Incident Procedures', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'IR-6', title: 'Incident Reporting', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'IR-6', title: 'Incident Reporting', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.92,
    divergenceScore: 0.08,
    propagationEnabled: true,
    hash: 'blake3:eq_ir_003'
  },
  {
    id: 'EQ-SC-001',
    family: 'System and Communications Protection',
    controlId: 'UCP-SC-001',
    controlName: 'Cryptographic Protection',
    equivalentClauses: [
      { framework: 'NIST', clause: 'SC-13', title: 'Cryptographic Protection', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC6.6', title: 'Encryption', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '8.24', title: 'Use of Cryptography', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.312(a)(2)(iv)', title: 'Encryption and Decryption', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'SC-13', title: 'Cryptographic Protection', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'SC-13', title: 'Cryptographic Protection', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.97,
    divergenceScore: 0.03,
    propagationEnabled: true,
    hash: 'blake3:eq_sc_001'
  },
  {
    id: 'EQ-SC-002',
    family: 'System and Communications Protection',
    controlId: 'UCP-SC-002',
    controlName: 'Transmission Confidentiality',
    equivalentClauses: [
      { framework: 'NIST', clause: 'SC-8', title: 'Transmission Confidentiality and Integrity', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC6.6', title: 'Encryption of Data in Transit', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '8.24', title: 'Use of Cryptography', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.312(e)(1)', title: 'Transmission Security', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'SC-8', title: 'Transmission Confidentiality', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'SC-8', title: 'Transmission Confidentiality', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.96,
    divergenceScore: 0.04,
    propagationEnabled: true,
    hash: 'blake3:eq_sc_002'
  },
  {
    id: 'EQ-SC-003',
    family: 'System and Communications Protection',
    controlId: 'UCP-SC-003',
    controlName: 'Boundary Protection',
    equivalentClauses: [
      { framework: 'NIST', clause: 'SC-7', title: 'Boundary Protection', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC6.6', title: 'Network Security', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '8.20', title: 'Networks Security', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.312(e)(1)', title: 'Transmission Security', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'SC-7', title: 'Boundary Protection', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'SC-7', title: 'Boundary Protection', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.94,
    divergenceScore: 0.06,
    propagationEnabled: true,
    hash: 'blake3:eq_sc_003'
  },
  {
    id: 'EQ-SC-004',
    family: 'System and Communications Protection',
    controlId: 'UCP-SC-004',
    controlName: 'Denial-of-Service Protection',
    equivalentClauses: [
      { framework: 'NIST', clause: 'SC-5', title: 'Denial-of-Service Protection', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC7.2', title: 'System Monitoring for Availability', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '8.20', title: 'Network Security', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.308(a)(7)', title: 'Contingency Plan - Availability', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'SC-5', title: 'Denial-of-Service Protection', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'SC-5', title: 'Denial-of-Service Protection', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.91,
    divergenceScore: 0.09,
    propagationEnabled: true,
    hash: 'blake3:eq_sc_004'
  },
  {
    id: 'EQ-SC-005',
    family: 'System and Communications Protection',
    controlId: 'UCP-SC-005',
    controlName: 'Protection of Information at Rest',
    equivalentClauses: [
      { framework: 'NIST', clause: 'SC-28', title: 'Protection of Information at Rest', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC6.1', title: 'Encryption of Data at Rest', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '8.12', title: 'Data Leakage Prevention', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.310(d)(2)(iv)', title: 'Data Integrity/Confidentiality', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'SC-28', title: 'Protection of Information at Rest', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'SC-28', title: 'Protection of Information at Rest', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.96,
    divergenceScore: 0.04,
    propagationEnabled: true,
    hash: 'blake3:eq_sc_005'
  },
  {
    id: 'EQ-CM-001',
    family: 'Configuration Management',
    controlId: 'UCP-CM-001',
    controlName: 'Baseline Configuration',
    equivalentClauses: [
      { framework: 'NIST', clause: 'CM-2', title: 'Baseline Configuration', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC8.1', title: 'Change Management', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '8.9', title: 'Configuration Management', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.308(a)(8)', title: 'Evaluation', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'CM-2', title: 'Baseline Configuration', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'CM-2', title: 'Baseline Configuration', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.93,
    divergenceScore: 0.07,
    propagationEnabled: true,
    hash: 'blake3:eq_cm_001'
  },
  {
    id: 'EQ-CM-002',
    family: 'Configuration Management',
    controlId: 'UCP-CM-002',
    controlName: 'Configuration Change Control',
    equivalentClauses: [
      { framework: 'NIST', clause: 'CM-3', title: 'Configuration Change Control', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC8.1', title: 'Change Management Process', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '8.32', title: 'Change Management', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.308(a)(8)', title: 'Evaluation', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'CM-3', title: 'Configuration Change Control', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'CM-3', title: 'Configuration Change Control', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.94,
    divergenceScore: 0.06,
    propagationEnabled: true,
    hash: 'blake3:eq_cm_002'
  },
  {
    id: 'EQ-CM-003',
    family: 'Configuration Management',
    controlId: 'UCP-CM-003',
    controlName: 'Least Functionality',
    equivalentClauses: [
      { framework: 'NIST', clause: 'CM-7', title: 'Least Functionality', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC6.7', title: 'Change Restriction', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '8.9', title: 'Configuration Management', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.308(a)(8)', title: 'Evaluation of Functionality', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'CM-7', title: 'Least Functionality', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'CM-7', title: 'Least Functionality', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.91,
    divergenceScore: 0.09,
    propagationEnabled: true,
    hash: 'blake3:eq_cm_003'
  },
  {
    id: 'EQ-CP-001',
    family: 'Contingency Planning',
    controlId: 'UCP-CP-001',
    controlName: 'Contingency Plan',
    equivalentClauses: [
      { framework: 'NIST', clause: 'CP-2', title: 'Contingency Plan', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'A1.2', title: 'Recovery Procedures', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '5.29', title: 'Business Continuity Planning', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.308(a)(7)', title: 'Contingency Plan', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'CP-2', title: 'Contingency Plan', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'CP-2', title: 'Contingency Plan', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.96,
    divergenceScore: 0.04,
    propagationEnabled: true,
    hash: 'blake3:eq_cp_001'
  },
  {
    id: 'EQ-CP-002',
    family: 'Contingency Planning',
    controlId: 'UCP-CP-002',
    controlName: 'System Backup',
    equivalentClauses: [
      { framework: 'NIST', clause: 'CP-9', title: 'System Backup', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'A1.2', title: 'Data Backup', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '8.13', title: 'Information Backup', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.308(a)(7)(ii)(A)', title: 'Data Backup Plan', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'CP-9', title: 'System Backup', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'CP-9', title: 'System Backup', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.97,
    divergenceScore: 0.03,
    propagationEnabled: true,
    hash: 'blake3:eq_cp_002'
  },
  {
    id: 'EQ-CP-003',
    family: 'Contingency Planning',
    controlId: 'UCP-CP-003',
    controlName: 'Contingency Plan Testing',
    equivalentClauses: [
      { framework: 'NIST', clause: 'CP-4', title: 'Contingency Plan Testing', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'A1.3', title: 'Testing of Continuity Procedures', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '5.30', title: 'ICT Readiness for Continuity', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.308(a)(7)(ii)(D)', title: 'Testing and Revision Procedures', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'CP-4', title: 'Contingency Plan Testing', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'CP-4', title: 'Contingency Plan Testing', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.95,
    divergenceScore: 0.05,
    propagationEnabled: true,
    hash: 'blake3:eq_cp_003'
  },
  {
    id: 'EQ-CP-004',
    family: 'Contingency Planning',
    controlId: 'UCP-CP-004',
    controlName: 'Alternate Processing Site',
    equivalentClauses: [
      { framework: 'NIST', clause: 'CP-7', title: 'Alternate Processing Site', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'A1.3', title: 'Alternate Site', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '5.29', title: 'Business Continuity Planning', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.308(a)(7)', title: 'Contingency Plan - Alternate', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'CP-7', title: 'Alternate Processing Site', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'CP-7', title: 'Alternate Processing Site', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.92,
    divergenceScore: 0.08,
    propagationEnabled: true,
    hash: 'blake3:eq_cp_004'
  },
  {
    id: 'EQ-RA-001',
    family: 'Risk Assessment',
    controlId: 'UCP-RA-001',
    controlName: 'Risk Assessment',
    equivalentClauses: [
      { framework: 'NIST', clause: 'RA-3', title: 'Risk Assessment', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC3.2', title: 'Risk Assessment Process', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '5.12', title: 'Information Security Risk Assessment', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.308(a)(1)(ii)(A)', title: 'Risk Analysis', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'RA-3', title: 'Risk Assessment', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'RA-3', title: 'Risk Assessment', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.98,
    divergenceScore: 0.02,
    propagationEnabled: true,
    hash: 'blake3:eq_ra_001'
  },
  {
    id: 'EQ-RA-002',
    family: 'Risk Assessment',
    controlId: 'UCP-RA-002',
    controlName: 'Vulnerability Scanning',
    equivalentClauses: [
      { framework: 'NIST', clause: 'RA-5', title: 'Vulnerability Monitoring and Scanning', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC7.1', title: 'Vulnerability Management', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '8.8', title: 'Management of Technical Vulnerabilities', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.308(a)(1)(ii)(A)', title: 'Risk Analysis', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'RA-5', title: 'Vulnerability Scanning', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'RA-5', title: 'Vulnerability Scanning', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.95,
    divergenceScore: 0.05,
    propagationEnabled: true,
    hash: 'blake3:eq_ra_002'
  },
  {
    id: 'EQ-RA-003',
    family: 'Risk Assessment',
    controlId: 'UCP-RA-003',
    controlName: 'Risk Response and Remediation',
    equivalentClauses: [
      { framework: 'NIST', clause: 'RA-7', title: 'Risk Response', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC3.2', title: 'Risk Mitigation', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '5.13', title: 'Information Security Risk Treatment', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.308(a)(1)(ii)(B)', title: 'Risk Management', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'RA-7', title: 'Risk Response', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'RA-7', title: 'Risk Response', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.92,
    divergenceScore: 0.08,
    propagationEnabled: true,
    hash: 'blake3:eq_ra_003'
  },
  {
    id: 'EQ-SI-001',
    family: 'System and Information Integrity',
    controlId: 'UCP-SI-001',
    controlName: 'Flaw Remediation',
    equivalentClauses: [
      { framework: 'NIST', clause: 'SI-2', title: 'Flaw Remediation', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC7.1', title: 'Patch Management', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '8.8', title: 'Management of Technical Vulnerabilities', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.308(a)(5)(ii)(B)', title: 'Protection from Malicious Software', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'SI-2', title: 'Flaw Remediation', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'SI-2', title: 'Flaw Remediation', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.96,
    divergenceScore: 0.04,
    propagationEnabled: true,
    hash: 'blake3:eq_si_001'
  },
  {
    id: 'EQ-SI-002',
    family: 'System and Information Integrity',
    controlId: 'UCP-SI-002',
    controlName: 'Malicious Code Protection',
    equivalentClauses: [
      { framework: 'NIST', clause: 'SI-3', title: 'Malicious Code Protection', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC6.8', title: 'Malware Prevention', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '8.7', title: 'Protection Against Malware', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.308(a)(5)(ii)(B)', title: 'Protection from Malicious Software', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'SI-3', title: 'Malicious Code Protection', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'SI-3', title: 'Malicious Code Protection', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.97,
    divergenceScore: 0.03,
    propagationEnabled: true,
    hash: 'blake3:eq_si_002'
  },
  {
    id: 'EQ-SI-003',
    family: 'System and Information Integrity',
    controlId: 'UCP-SI-003',
    controlName: 'Security Monitoring',
    equivalentClauses: [
      { framework: 'NIST', clause: 'SI-4', title: 'System Monitoring', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC7.2', title: 'Security Monitoring', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '8.16', title: 'Monitoring Activities', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.308(a)(1)(ii)(D)', title: 'Activity Review', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'SI-4', title: 'System Monitoring', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'SI-4', title: 'System Monitoring', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.95,
    divergenceScore: 0.05,
    propagationEnabled: true,
    hash: 'blake3:eq_si_003'
  },
  {
    id: 'EQ-SI-004',
    family: 'System and Information Integrity',
    controlId: 'UCP-SI-004',
    controlName: 'Spam and Phishing Protection',
    equivalentClauses: [
      { framework: 'NIST', clause: 'SI-8', title: 'Spam Protection', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC6.8', title: 'Malware and Malicious Content Protection', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '8.7', title: 'Protection Against Malware', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.308(a)(5)(ii)(B)', title: 'Protection from Malicious Software', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'SI-8', title: 'Spam Protection', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'SI-8', title: 'Spam Protection', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.9,
    divergenceScore: 0.1,
    propagationEnabled: true,
    hash: 'blake3:eq_si_004'
  },
  {
    id: 'EQ-PS-001',
    family: 'Personnel Security',
    controlId: 'UCP-PS-001',
    controlName: 'Personnel Screening',
    equivalentClauses: [
      { framework: 'NIST', clause: 'PS-3', title: 'Personnel Screening', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC1.4', title: 'Background Checks', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '6.1', title: 'Screening', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.308(a)(3)(ii)(B)', title: 'Workforce Clearance Procedure', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'PS-3', title: 'Personnel Screening', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'PS-3', title: 'Personnel Screening', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.95,
    divergenceScore: 0.05,
    propagationEnabled: true,
    hash: 'blake3:eq_ps_001'
  },
  {
    id: 'EQ-PS-002',
    family: 'Personnel Security',
    controlId: 'UCP-PS-002',
    controlName: 'Personnel Termination',
    equivalentClauses: [
      { framework: 'NIST', clause: 'PS-4', title: 'Personnel Termination', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC6.2', title: 'Access Revocation', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '6.5', title: 'Termination Responsibilities', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.308(a)(3)(ii)(C)', title: 'Termination Procedures', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'PS-4', title: 'Personnel Termination', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'PS-4', title: 'Personnel Termination', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.96,
    divergenceScore: 0.04,
    propagationEnabled: true,
    hash: 'blake3:eq_ps_002'
  },
  {
    id: 'EQ-PS-003',
    family: 'Personnel Security',
    controlId: 'UCP-PS-003',
    controlName: 'Personnel Transfer',
    equivalentClauses: [
      { framework: 'NIST', clause: 'PS-5', title: 'Personnel Transfer', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC6.2', title: 'Access Changes', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '6.4', title: 'Responsibilities after Termination or Change', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.308(a)(3)', title: 'Workforce Security', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'PS-5', title: 'Personnel Transfer', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'PS-5', title: 'Personnel Transfer', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.93,
    divergenceScore: 0.07,
    propagationEnabled: true,
    hash: 'blake3:eq_ps_003'
  },
  {
    id: 'EQ-PE-001',
    family: 'Physical and Environmental Protection',
    controlId: 'UCP-PE-001',
    controlName: 'Physical Access Authorizations',
    equivalentClauses: [
      { framework: 'NIST', clause: 'PE-2', title: 'Physical Access Authorizations', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC6.4', title: 'Physical Access Controls', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '7.1', title: 'Physical Security Perimeters', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.310(a)(1)', title: 'Facility Access Controls', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'PE-2', title: 'Physical Access Authorizations', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'PE-2', title: 'Physical Access Authorizations', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.95,
    divergenceScore: 0.05,
    propagationEnabled: true,
    hash: 'blake3:eq_pe_001'
  },
  {
    id: 'EQ-PE-002',
    family: 'Physical and Environmental Protection',
    controlId: 'UCP-PE-002',
    controlName: 'Physical Access Control',
    equivalentClauses: [
      { framework: 'NIST', clause: 'PE-3', title: 'Physical Access Control', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC6.4', title: 'Facility Security', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '7.2', title: 'Physical Entry', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.310(a)(2)(ii)', title: 'Facility Security Plan', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'PE-3', title: 'Physical Access Control', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'PE-3', title: 'Physical Access Control', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.96,
    divergenceScore: 0.04,
    propagationEnabled: true,
    hash: 'blake3:eq_pe_002'
  },
  {
    id: 'EQ-SA-001',
    family: 'System and Services Acquisition',
    controlId: 'UCP-SA-001',
    controlName: 'External System Services',
    equivalentClauses: [
      { framework: 'NIST', clause: 'SA-9', title: 'External System Services', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC9.2', title: 'Vendor Management', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '5.19', title: 'Information Security in Supplier Relationships', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.308(b)(1)', title: 'Business Associate Contracts', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'SA-9', title: 'External System Services', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'SA-9', title: 'External System Services', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.94,
    divergenceScore: 0.06,
    propagationEnabled: true,
    hash: 'blake3:eq_sa_001'
  },
  {
    id: 'EQ-SA-002',
    family: 'System and Services Acquisition',
    controlId: 'UCP-SA-002',
    controlName: 'Developer Testing and Evaluation',
    equivalentClauses: [
      { framework: 'NIST', clause: 'SA-11', title: 'Developer Testing and Evaluation', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC8.1', title: 'Change and Release Testing', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '8.30', title: 'Secure Development Life Cycle', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.308(a)(8)', title: 'Evaluation', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'SA-11', title: 'Developer Testing and Evaluation', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'SA-11', title: 'Developer Testing and Evaluation', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.93,
    divergenceScore: 0.07,
    propagationEnabled: true,
    hash: 'blake3:eq_sa_002'
  },
  {
    id: 'EQ-SA-003',
    family: 'System and Services Acquisition',
    controlId: 'UCP-SA-003',
    controlName: 'Supply Chain Protections',
    equivalentClauses: [
      { framework: 'NIST', clause: 'SA-12', title: 'Supply Chain Protection', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC9.2', title: 'Vendor Management', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '5.21', title: 'Managing Information Security in Supply Chain', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.308(b)', title: 'Business Associate Agreements', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'SA-12', title: 'Supply Chain Protection', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'SA-12', title: 'Supply Chain Protection', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.92,
    divergenceScore: 0.08,
    propagationEnabled: true,
    hash: 'blake3:eq_sa_003'
  },
  {
    id: 'EQ-AT-001',
    family: 'Awareness and Training',
    controlId: 'UCP-AT-001',
    controlName: 'Security Awareness Training',
    equivalentClauses: [
      { framework: 'NIST', clause: 'AT-2', title: 'Literacy Training and Awareness', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC1.4', title: 'Security Awareness', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '6.3', title: 'Information Security Awareness', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.308(a)(5)', title: 'Security Awareness and Training', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'AT-2', title: 'Security Awareness Training', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'AT-2', title: 'Security Awareness Training', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.97,
    divergenceScore: 0.03,
    propagationEnabled: true,
    hash: 'blake3:eq_at_001'
  },
  {
    id: 'EQ-AT-002',
    family: 'Awareness and Training',
    controlId: 'UCP-AT-002',
    controlName: 'Role-Based Security Training',
    equivalentClauses: [
      { framework: 'NIST', clause: 'AT-3', title: 'Role-Based Security Training', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC1.4', title: 'Role-Specific Training', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '6.3', title: 'Awareness, Education and Training', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.308(a)(5)(i)', title: 'Security Reminders', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'AT-3', title: 'Role-Based Security Training', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'AT-3', title: 'Role-Based Security Training', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.93,
    divergenceScore: 0.07,
    propagationEnabled: true,
    hash: 'blake3:eq_at_002'
  },
  {
    id: 'EQ-MA-001',
    family: 'Maintenance',
    controlId: 'UCP-MA-001',
    controlName: 'Controlled Maintenance',
    equivalentClauses: [
      { framework: 'NIST', clause: 'MA-2', title: 'Controlled Maintenance', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC6.4', title: 'Facility and Equipment Maintenance', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '8.11', title: 'Equipment Maintenance', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.310(a)(2)(iii)', title: 'Maintenance Records', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'MA-2', title: 'Controlled Maintenance', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'MA-2', title: 'Controlled Maintenance', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.92,
    divergenceScore: 0.08,
    propagationEnabled: true,
    hash: 'blake3:eq_ma_001'
  },
  {
    id: 'EQ-MP-001',
    family: 'Media Protection',
    controlId: 'UCP-MP-001',
    controlName: 'Media Storage Protection',
    equivalentClauses: [
      { framework: 'NIST', clause: 'MP-4', title: 'Media Storage', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC6.5', title: 'Logical and Physical Media Protection', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '7.10', title: 'Storage Media', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.310(d)(1)', title: 'Device and Media Controls', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'MP-4', title: 'Media Storage', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'MP-4', title: 'Media Storage', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.93,
    divergenceScore: 0.07,
    propagationEnabled: true,
    hash: 'blake3:eq_mp_001'
  },
  {
    id: 'EQ-PL-001',
    family: 'Planning',
    controlId: 'UCP-PL-001',
    controlName: 'System Security Plan',
    equivalentClauses: [
      { framework: 'NIST', clause: 'PL-2', title: 'System Security Plan', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC1.2', title: 'System Documentation', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '5.1', title: 'Leadership and Commitment', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.308(a)(1)', title: 'Security Management Process', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'PL-2', title: 'System Security Plan', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'PL-2', title: 'System Security Plan', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.94,
    divergenceScore: 0.06,
    propagationEnabled: true,
    hash: 'blake3:eq_pl_001'
  },
  {
    id: 'EQ-PM-001',
    family: 'Program Management',
    controlId: 'UCP-PM-001',
    controlName: 'Information Security Program',
    equivalentClauses: [
      { framework: 'NIST', clause: 'PM-1', title: 'Information Security Program Plan', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'SOC2', clause: 'CC1.1', title: 'Control Environment', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ISO27001', clause: '5.3', title: 'Organizational Roles, Responsibilities and Authorities', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'HIPAA', clause: '164.308(a)(1)', title: 'Security Management Process', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'MARS-E', clause: 'PM-1', title: 'Information Security Program Plan', phi: 0.00, psi: 1.00, daysOld: 0 },
      { framework: 'ARC-AMPE', clause: 'PM-1', title: 'Information Security Program Plan', phi: 0.00, psi: 1.00, daysOld: 0 }
    ],
    semanticConfidence: 0.93,
    divergenceScore: 0.07,
    propagationEnabled: true,
    hash: 'blake3:eq_pm_001'
  }
];



// Clause Repository - Universal framework clause library
// This is the central data store that powers the entire MGF system
const CLAUSE_REPOSITORY = [
  {
    id: 'SOC2-CC6.1',
    framework: 'SOC2',
    frameworkFull: 'SOC 2 Type II',
    clause: 'CC6.1',
    title: 'Logical and Physical Access Controls',
    category: 'Access Control',
    requirement: 'The entity implements logical access security software, infrastructure, and architectures over protected information assets to protect them from security events to meet the entity\'s objectives.',
    phi: 0.95,
    psi: 0.96,
    lastReviewed: '2025-11-15T10:00:00Z',
    daysOld: 14,
    mappedControl: 'UCP-001',
    equivalents: ['ISO27001-A.9.2', 'NIST-AC-2', 'FEDRAMP-AC-2', 'HIPAA-164.308(a)(3)'],
    semanticMatches: [
      { clauseId: 'ISO27001-A.9.2', similarity: 0.97 },
      { clauseId: 'NIST-AC-2', similarity: 0.96 },
      { clauseId: 'HIPAA-164.308(a)(3)', similarity: 0.94 }
    ],
    usageCount: { rfps: 3, attestations: 12, controls: 1 },
    hash: 'blake3:soc2_cc61_a1b2c3d4'
  },
  {
    id: 'ISO27001-A.9.2',
    framework: 'ISO27001',
    frameworkFull: 'ISO 27001:2022',
    clause: 'A.9.2',
    title: 'User Access Management',
    category: 'Access Control',
    requirement: 'A formal user access provisioning process shall be implemented to assign or revoke access rights for all user types to all systems and services.',
    phi: 0.95,
    psi: 0.82,
    lastReviewed: '2025-09-20T08:00:00Z',
    daysOld: 70,
    mappedControl: 'UCP-001',
    equivalents: ['SOC2-CC6.1', 'NIST-AC-2', 'FEDRAMP-AC-2', 'HIPAA-164.308(a)(3)'],
    semanticMatches: [
      { clauseId: 'SOC2-CC6.1', similarity: 0.97 },
      { clauseId: 'NIST-AC-2', similarity: 0.98 },
      { clauseId: 'FEDRAMP-AC-2', similarity: 0.98 }
    ],
    usageCount: { rfps: 4, attestations: 8, controls: 1 },
    hash: 'blake3:iso27001_a92_b2c3d4e5'
  },
  {
    id: 'NIST-AC-2',
    framework: 'NIST',
    frameworkFull: 'NIST 800-53 Rev 5',
    clause: 'AC-2',
    title: 'Account Management',
    category: 'Access Control',
    requirement: 'The organization manages system accounts, including establishing, activating, modifying, reviewing, disabling, and removing accounts.',
    phi: 0.95,
    psi: 0.88,
    lastReviewed: '2025-10-12T14:00:00Z',
    daysOld: 48,
    mappedControl: 'UCP-001',
    equivalents: ['SOC2-CC6.1', 'ISO27001-A.9.2', 'FEDRAMP-AC-2', 'HIPAA-164.308(a)(3)'],
    semanticMatches: [
      { clauseId: 'ISO27001-A.9.2', similarity: 0.98 },
      { clauseId: 'FEDRAMP-AC-2', similarity: 1.00 },
      { clauseId: 'SOC2-CC6.1', similarity: 0.96 }
    ],
    usageCount: { rfps: 5, attestations: 15, controls: 1 },
    hash: 'blake3:nist_ac2_c3d4e5f6'
  },
  {
    id: 'HIPAA-164.308(a)(3)',
    framework: 'HIPAA',
    frameworkFull: 'HIPAA Security Rule',
    clause: '164.308(a)(3)',
    title: 'Workforce Security',
    category: 'Access Control',
    requirement: 'Implement policies and procedures to ensure that all members of its workforce have appropriate access to electronic protected health information.',
    phi: 0.95,
    psi: 0.99,
    lastReviewed: '2025-11-28T16:00:00Z',
    daysOld: 1,
    mappedControl: 'UCP-001',
    equivalents: ['SOC2-CC6.1', 'ISO27001-A.9.2', 'NIST-AC-2', 'FEDRAMP-AC-2'],
    semanticMatches: [
      { clauseId: 'SOC2-CC6.1', similarity: 0.94 },
      { clauseId: 'NIST-AC-2', similarity: 0.95 },
      { clauseId: 'ISO27001-A.9.2', similarity: 0.93 }
    ],
    usageCount: { rfps: 2, attestations: 6, controls: 1 },
    hash: 'blake3:hipaa_164308a3_d4e5f6a7'
  },
  {
    id: 'SOC2-CC6.6',
    framework: 'SOC2',
    frameworkFull: 'SOC 2 Type II',
    clause: 'CC6.6',
    title: 'Encryption of Data in Transit',
    category: 'Encryption',
    requirement: 'The entity uses encryption to protect data during transmission over open or public networks to meet the entity\'s objectives.',
    phi: 0.88,
    psi: 0.96,
    lastReviewed: '2025-11-15T10:00:00Z',
    daysOld: 14,
    mappedControl: 'UCP-002',
    equivalents: ['ISO27001-A.10.1', 'NIST-SC-13', 'FEDRAMP-SC-13', 'HIPAA-164.312(a)(2)(iv)'],
    semanticMatches: [
      { clauseId: 'ISO27001-A.10.1', similarity: 0.95 },
      { clauseId: 'NIST-SC-13', similarity: 0.93 },
      { clauseId: 'HIPAA-164.312(a)(2)(iv)', similarity: 0.96 }
    ],
    usageCount: { rfps: 4, attestations: 10, controls: 1 },
    hash: 'blake3:soc2_cc66_e5f6a7b8'
  },
  {
    id: 'ISO27001-A.10.1',
    framework: 'ISO27001',
    frameworkFull: 'ISO 27001:2022',
    clause: 'A.10.1',
    title: 'Cryptographic Controls',
    category: 'Encryption',
    requirement: 'A policy on the use of cryptographic controls for protection of information shall be developed and implemented.',
    phi: 0.88,
    psi: 0.82,
    lastReviewed: '2025-09-20T08:00:00Z',
    daysOld: 70,
    mappedControl: 'UCP-002',
    equivalents: ['SOC2-CC6.6', 'NIST-SC-13', 'FEDRAMP-SC-13', 'HIPAA-164.312(a)(2)(iv)'],
    semanticMatches: [
      { clauseId: 'NIST-SC-13', similarity: 0.97 },
      { clauseId: 'SOC2-CC6.6', similarity: 0.95 },
      { clauseId: 'HIPAA-164.312(a)(2)(iv)', similarity: 0.94 }
    ],
    usageCount: { rfps: 3, attestations: 7, controls: 1 },
    hash: 'blake3:iso27001_a101_f6a7b8c9'
  },
  {
    id: 'NIST-SC-13',
    framework: 'NIST',
    frameworkFull: 'NIST 800-53 Rev 5',
    clause: 'SC-13',
    title: 'Cryptographic Protection',
    category: 'Encryption',
    requirement: 'The information system implements FIPS 140-2 validated cryptography to protect the confidentiality and integrity of transmitted and stored information.',
    phi: 0.88,
    psi: 0.88,
    lastReviewed: '2025-10-12T14:00:00Z',
    daysOld: 48,
    mappedControl: 'UCP-002',
    equivalents: ['SOC2-CC6.6', 'ISO27001-A.10.1', 'FEDRAMP-SC-13', 'HIPAA-164.312(a)(2)(iv)'],
    semanticMatches: [
      { clauseId: 'ISO27001-A.10.1', similarity: 0.97 },
      { clauseId: 'FEDRAMP-SC-13', similarity: 1.00 },
      { clauseId: 'SOC2-CC6.6', similarity: 0.93 }
    ],
    usageCount: { rfps: 5, attestations: 12, controls: 1 },
    hash: 'blake3:nist_sc13_a7b8c9d0'
  },
  {
    id: 'SOC2-CC7.3',
    framework: 'SOC2',
    frameworkFull: 'SOC 2 Type II',
    clause: 'CC7.3',
    title: 'Security Incident Response',
    category: 'Incident Response',
    requirement: 'The entity evaluates security events to determine whether they could or have resulted in a failure of the entity to meet its objectives.',
    phi: 0.72,
    psi: 0.96,
    lastReviewed: '2025-11-15T10:00:00Z',
    daysOld: 14,
    mappedControl: 'UCP-003',
    equivalents: ['ISO27001-A.16.1', 'NIST-IR-4', 'FEDRAMP-IR-4', 'HIPAA-164.308(a)(6)'],
    semanticMatches: [
      { clauseId: 'ISO27001-A.16.1', similarity: 0.94 },
      { clauseId: 'NIST-IR-4', similarity: 0.96 },
      { clauseId: 'HIPAA-164.308(a)(6)', similarity: 0.92 }
    ],
    usageCount: { rfps: 3, attestations: 9, controls: 1 },
    hash: 'blake3:soc2_cc73_b8c9d0e1'
  },
  {
    id: 'ISO27001-A.16.1',
    framework: 'ISO27001',
    frameworkFull: 'ISO 27001:2022',
    clause: 'A.16.1',
    title: 'Management of Information Security Incidents',
    category: 'Incident Response',
    requirement: 'Management responsibilities and procedures shall be established to ensure a quick, effective, and orderly response to information security incidents.',
    phi: 0.72,
    psi: 0.82,
    lastReviewed: '2025-09-20T08:00:00Z',
    daysOld: 70,
    mappedControl: 'UCP-003',
    equivalents: ['SOC2-CC7.3', 'NIST-IR-4', 'FEDRAMP-IR-4', 'HIPAA-164.308(a)(6)'],
    semanticMatches: [
      { clauseId: 'NIST-IR-4', similarity: 0.98 },
      { clauseId: 'SOC2-CC7.3', similarity: 0.94 },
      { clauseId: 'HIPAA-164.308(a)(6)', similarity: 0.93 }
    ],
    usageCount: { rfps: 4, attestations: 7, controls: 1 },
    hash: 'blake3:iso27001_a161_c9d0e1f2'
  },
  {
    id: 'NIST-IR-4',
    framework: 'NIST',
    frameworkFull: 'NIST 800-53 Rev 5',
    clause: 'IR-4',
    title: 'Incident Handling',
    category: 'Incident Response',
    requirement: 'The organization implements an incident handling capability for security incidents that includes preparation, detection and analysis, containment, eradication, and recovery.',
    phi: 0.72,
    psi: 0.88,
    lastReviewed: '2025-10-12T14:00:00Z',
    daysOld: 48,
    mappedControl: 'UCP-003',
    equivalents: ['SOC2-CC7.3', 'ISO27001-A.16.1', 'FEDRAMP-IR-4', 'HIPAA-164.308(a)(6)'],
    semanticMatches: [
      { clauseId: 'ISO27001-A.16.1', similarity: 0.98 },
      { clauseId: 'FEDRAMP-IR-4', similarity: 1.00 },
      { clauseId: 'SOC2-CC7.3', similarity: 0.96 }
    ],
    usageCount: { rfps: 5, attestations: 11, controls: 1 },
    hash: 'blake3:nist_ir4_d0e1f2a3'
  },
  {
    id: 'SOC2-CC6.7',
    framework: 'SOC2',
    frameworkFull: 'SOC 2 Type II',
    clause: 'CC6.7',
    title: 'Encryption of Data at Rest',
    category: 'Encryption',
    requirement: 'The entity restricts the transmission, movement, and removal of information to authorized internal and external users and processes.',
    phi: 0.90,
    psi: 0.96,
    lastReviewed: '2025-11-15T10:00:00Z',
    daysOld: 14,
    mappedControl: 'UCP-002',
    equivalents: ['ISO27001-A.8.24', 'NIST-SC-28'],
    semanticMatches: [
      { clauseId: 'ISO27001-A.8.24', similarity: 0.96 },
      { clauseId: 'NIST-SC-28', similarity: 0.94 }
    ],
    usageCount: { rfps: 3, attestations: 8, controls: 1 },
    hash: 'blake3:soc2_cc67_e1f2a3b4'
  },
  {
    id: 'ISO27001-A.12.3',
    framework: 'ISO27001',
    frameworkFull: 'ISO 27001:2022',
    clause: 'A.12.3',
    title: 'Information Backup',
    category: 'Business Continuity',
    requirement: 'Backup copies of information, software and system images shall be taken and tested regularly in accordance with an agreed backup policy.',
    phi: 0.91,
    psi: 0.82,
    lastReviewed: '2025-09-20T08:00:00Z',
    daysOld: 70,
    mappedControl: 'UCP-004',
    equivalents: ['NIST-CP-9', 'SOC2-CC5.1'],
    semanticMatches: [
      { clauseId: 'NIST-CP-9', similarity: 0.97 },
      { clauseId: 'SOC2-CC5.1', similarity: 0.93 }
    ],
    usageCount: { rfps: 4, attestations: 10, controls: 1 },
    hash: 'blake3:iso27001_a123_f2a3b4c5'
  },
  {
    id: 'NIST-CP-9',
    framework: 'NIST',
    frameworkFull: 'NIST 800-53 Rev 5',
    clause: 'CP-9',
    title: 'Information System Backup',
    category: 'Business Continuity',
    requirement: 'The organization conducts backups of user-level information, system-level information, and system documentation.',
    phi: 0.91,
    psi: 0.88,
    lastReviewed: '2025-10-12T14:00:00Z',
    daysOld: 48,
    mappedControl: 'UCP-004',
    equivalents: ['ISO27001-A.12.3', 'SOC2-CC5.1'],
    semanticMatches: [
      { clauseId: 'ISO27001-A.12.3', similarity: 0.97 },
      { clauseId: 'SOC2-CC5.1', similarity: 0.95 }
    ],
    usageCount: { rfps: 5, attestations: 12, controls: 1 },
    hash: 'blake3:nist_cp9_a3b4c5d6'
  },
  {
    id: 'ISO27001-A.15.1',
    framework: 'ISO27001',
    frameworkFull: 'ISO 27001:2022',
    clause: 'A.15.1',
    title: 'Information Security in Supplier Relationships',
    category: 'Vendor Management',
    requirement: 'Information security requirements for mitigating the risks associated with supplier\'s access to the organization\'s assets shall be agreed with the supplier.',
    phi: 0.65,
    psi: 0.82,
    lastReviewed: '2025-09-20T08:00:00Z',
    daysOld: 70,
    mappedControl: 'UCP-005',
    equivalents: ['NIST-SA-9', 'SOC2-CC9.2'],
    semanticMatches: [
      { clauseId: 'NIST-SA-9', similarity: 0.96 },
      { clauseId: 'SOC2-CC9.2', similarity: 0.92 }
    ],
    usageCount: { rfps: 3, attestations: 5, controls: 1 },
    hash: 'blake3:iso27001_a151_b4c5d6e7'
  },
  {
    id: 'NIST-SA-9',
    framework: 'NIST',
    frameworkFull: 'NIST 800-53 Rev 5',
    clause: 'SA-9',
    title: 'External Information System Services',
    category: 'Vendor Management',
    requirement: 'The organization requires that providers of external information system services comply with organizational information security requirements.',
    phi: 0.65,
    psi: 0.88,
    lastReviewed: '2025-10-12T14:00:00Z',
    daysOld: 48,
    mappedControl: 'UCP-005',
    equivalents: ['ISO27001-A.15.1', 'SOC2-CC9.2'],
    semanticMatches: [
      { clauseId: 'ISO27001-A.15.1', similarity: 0.96 },
      { clauseId: 'SOC2-CC9.2', similarity: 0.94 }
    ],
    usageCount: { rfps: 4, attestations: 6, controls: 1 },
    hash: 'blake3:nist_sa9_c5d6e7f8'
  }
];

// Sample Discussion Data
const DISCUSSIONS = {
  'UCP-001': [
    { type: 'snapshot', time: '2025-11-15T10:00:00Z', block: 820, hash: 'snap_a1b2c3' },
    { type: 'comment', author: 'Rafael Velado', initials: 'RV', time: '2025-11-20T14:30:00Z', content: 'Updated Okta configuration to enforce MFA for all users. Trust score improved from 0.88 to 0.92.', hash: 'disc_d4e5f6' },
    { type: 'comment', author: 'Sarah Chen', initials: 'SC', time: '2025-11-22T09:15:00Z', content: 'Quarterly access review completed. No anomalies detected. All privileged accounts validated.', hash: 'disc_g7h8i9' }
  ]
};

// Sample Snapshots
const SNAPSHOTS = [
  { id: 847, timestamp: '2025-11-29T19:24:00Z', trust: 0.89, merkle_root: '26b0a1f4', controls: 52, evidence: 124 },
  { id: 846, timestamp: '2025-11-28T12:00:00Z', trust: 0.87, merkle_root: '15c9b2e3', controls: 52, evidence: 120 },
  { id: 845, timestamp: '2025-11-27T08:30:00Z', trust: 0.86, merkle_root: '8f3d5a7c', controls: 51, evidence: 118 }
];

// ---- DEMO MODE BANNER HELPER ----

function getDemoBanner() {
  return `
    <div style="padding: 12px 20px; background: linear-gradient(135deg, var(--amber-light) 0%, var(--brand-light) 100%); border-bottom: 2px solid var(--amber); display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 24px;">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--amber)" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" y1="8" x2="12" y2="12"/>
        <line x1="12" y1="16" x2="12.01" y2="16"/>
      </svg>
      <div>
        <div style="font-size: 13px; font-weight: 700; color: var(--amber); margin-bottom: 2px;">🎭 INTERACTIVE DEMO — SIMULATION MODE</div>
        <div style="font-size: 11px; color: var(--text-secondary);">Simulated data for demonstration purposes. Not connected to production systems.</div>
      </div>
    </div>
  `;
}

// ---- VIEW ROUTING ----

// ---- CRYPTOGRAPHIC HASHING & AUDIT TRAIL ----

// REAL cryptographic hashing via Atomic Trust Kernel
function generateHash(data) {
  return AtomicTrust.Blake3.hashSync(data);
}

// Log every action to immutable audit trail
function logAuditEntry(action, data) {
  const entry = {
    id: STATE.auditLog.length + 1,
    timestamp: new Date().toISOString(),
    action: action,
    data: data,
    snapshot: STATE.currentSnapshot,
    user: 'Sarah Chen',  // In production, from auth
    hash: null,  // Will be set below
    committed: false
  };

  // Generate hash of the entry itself
  entry.hash = generateHash(entry);
  
  // Mark as committed to local chain
  entry.committed = true;
  entry.commitBlock = STATE.currentSnapshot;

  // Add to local immutable log (append-only)
  STATE.auditLog.push(entry);

  console.log('🔒 AUDIT LOG ENTRY:', entry);
  
  // Show commit toast for significant actions
  const significantActions = [
    'REPORT_GENERATED', 'REPORT_DOWNLOADED', 'EVIDENCE_UPLOADED', 'EVIDENCE_VALIDATED',
    'CONTROL_UPDATED', 'FRAMEWORK_INGESTED', 'SNAPSHOT_CREATED', 'COMMENT_ADDED',
    'PROPAGATION_TRIGGERED', 'ATTESTATION_SIGNED'
  ];
  
  if (significantActions.includes(action) || action.includes('EXPORT') || action.includes('UPDATE')) {
    const shortHash = entry.hash.substring(0, 8);
    showCommitToast(action, shortHash, entry.commitBlock);
  }

  // Also log to backend API if connected (fire and forget)
  if (apiConnected) {
    const resourceType = data?.controlId ? 'control' : data?.evidenceId ? 'evidence' : data?.reportHash ? 'report' : 'system';
    const resourceId = data?.controlId || data?.evidenceId || data?.reportHash || 'frontend';

    API.logAuditEntry(action, resourceType, resourceId, data).catch(err => {
      console.warn('[logAuditEntry] Failed to log to API:', err);
    });
  }
  
  // Update recent activity if dashboard is visible
  updateRecentActivity();

  return entry;
}

// Show commit confirmation toast with hash
function showCommitToast(action, hash, block) {
  const actionLabels = {
    'REPORT_GENERATED': 'Report generated',
    'REPORT_DOWNLOADED': 'Report downloaded',
    'EVIDENCE_UPLOADED': 'Evidence uploaded',
    'EVIDENCE_VALIDATED': 'Evidence validated',
    'CONTROL_UPDATED': 'Control updated',
    'FRAMEWORK_INGESTED': 'Framework ingested',
    'SNAPSHOT_CREATED': 'Snapshot created',
    'COMMENT_ADDED': 'Comment added',
    'PROPAGATION_TRIGGERED': 'Propagation complete',
    'ATTESTATION_SIGNED': 'Attestation signed'
  };
  
  const label = actionLabels[action] || action.replace(/_/g, ' ').toLowerCase();
  
  // Create commit toast element
  const toast = document.createElement('div');
  toast.className = 'commit-toast';
  toast.innerHTML = `
    <div style="display: flex; align-items: center; gap: 12px;">
      <div style="width: 32px; height: 32px; border-radius: 8px; background: var(--green-light); display: flex; align-items: center; justify-content: center;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2">
          <polyline points="20 6 9 17 4 12"/>
        </svg>
      </div>
      <div style="flex: 1;">
        <div style="font-weight: 600; font-size: 13px; color: var(--text-primary);">${label}</div>
        <div style="font-size: 11px; color: var(--text-tertiary); display: flex; align-items: center; gap: 8px; margin-top: 2px;">
          <span style="font-family: 'IBM Plex Mono', monospace; background: var(--bg-tertiary); padding: 2px 6px; border-radius: 4px;">🔒 ${hash}</span>
          <span>Block ${block}</span>
        </div>
      </div>
    </div>
  `;
  
  toast.style.cssText = `
    position: fixed;
    top: 80px;
    right: 20px;
    background: white;
    border: 1px solid var(--border-light);
    border-left: 3px solid var(--green);
    border-radius: 8px;
    padding: 12px 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 10000;
    animation: slideInRight 0.3s ease;
    max-width: 320px;
  `;
  
  document.body.appendChild(toast);
  
  // Remove after 4 seconds
  setTimeout(() => {
    toast.style.animation = 'slideOutRight 0.3s ease';
    setTimeout(() => toast.remove(), 300);
  }, 4000);
}

// Update recent activity panel dynamically
function updateRecentActivity() {
  const activityContainer = document.getElementById('recentActivityList');
  if (!activityContainer) return;
  
  const recentEntries = STATE.auditLog.slice(-5).reverse();
  
  activityContainer.innerHTML = recentEntries.map((entry, idx) => {
    const { icon, color, bgColor } = getActivityIcon(entry.action);
    const timeAgo = getTimeAgo(entry.timestamp);
    const detail = getActivityDetail(entry);
    
    return `
      <div style="padding: 16px 20px; ${idx < recentEntries.length - 1 ? 'border-bottom: 1px solid var(--border-light);' : ''} display: flex; align-items: center; gap: 12px; cursor: pointer; transition: background 0.2s;" 
           onclick="drillDownActivity('${entry.id}')"
           onmouseover="this.style.background='var(--bg-secondary)'"
           onmouseout="this.style.background='white'">
        <div style="width: 36px; height: 36px; border-radius: 8px; background: ${bgColor}; display: flex; align-items: center; justify-content: center;">
          ${icon}
        </div>
        <div style="flex: 1;">
          <div style="font-weight: 600; font-size: 13px;">${getActivityLabel(entry.action)}</div>
          <div style="font-size: 11px; color: var(--text-tertiary);">${detail} • ${timeAgo}</div>
        </div>
        <div style="text-align: right;">
          <span class="hash" style="font-size: 10px;">${entry.hash?.substring(0, 8) || ''}</span>
        </div>
      </div>
    `;
  }).join('') || `
    <div style="padding: 40px; text-align: center; color: var(--text-tertiary);">
      <div style="font-size: 14px;">No recent activity</div>
    </div>
  `;
}

function getActivityIcon(action) {
  const icons = {
    'EVIDENCE_UPLOADED': { icon: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17,8 12,3 7,8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>', color: 'var(--green)', bgColor: 'var(--green-light)' },
    'EVIDENCE_VALIDATED': { icon: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>', color: 'var(--green)', bgColor: 'var(--green-light)' },
    'CONTROL_UPDATED': { icon: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--brand)" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>', color: 'var(--brand)', bgColor: 'var(--brand-light)' },
    'SNAPSHOT_CREATED': { icon: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--brand)" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>', color: 'var(--brand)', bgColor: 'var(--brand-light)' },
    'DIVERGENCE_DETECTED': { icon: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--amber)" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>', color: 'var(--amber)', bgColor: 'var(--amber-light)' },
    'COMMENT_ADDED': { icon: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--trust-teal)" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>', color: 'var(--trust-teal)', bgColor: 'var(--trust-teal-light)' },
    'REPORT_GENERATED': { icon: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--brand)" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>', color: 'var(--brand)', bgColor: 'var(--brand-light)' }
  };
  
  return icons[action] || { 
    icon: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--text-secondary)" stroke-width="2"><circle cx="12" cy="12" r="10"/></svg>', 
    color: 'var(--text-secondary)', 
    bgColor: 'var(--bg-tertiary)' 
  };
}

function getActivityLabel(action) {
  const labels = {
    'EVIDENCE_UPLOADED': 'Evidence uploaded',
    'EVIDENCE_VALIDATED': 'Evidence validated',
    'CONTROL_UPDATED': 'Control updated',
    'SNAPSHOT_CREATED': 'Snapshot created',
    'DIVERGENCE_DETECTED': 'Divergence detected',
    'COMMENT_ADDED': 'Comment added',
    'REPORT_GENERATED': 'Report generated',
    'REPORT_DOWNLOADED': 'Report downloaded',
    'FRAMEWORK_INGESTED': 'Framework ingested',
    'PROPAGATION_TRIGGERED': 'Propagation triggered',
    'delta_context_opened': 'AI context opened',
    'atomic_ai_query': 'AI query',
    'atomic_ai_enabled': 'AI copilot enabled'
  };
  return labels[action] || action.replace(/_/g, ' ');
}

function getActivityDetail(entry) {
  if (entry.data?.controlId) return entry.data.controlId;
  if (entry.data?.evidenceId) return entry.data.evidenceId;
  if (entry.data?.reportId) return entry.data.reportId;
  if (entry.data?.frameworkId) return entry.data.frameworkId;
  if (entry.data?.itemId) return entry.data.itemId;
  return 'System';
}

function getTimeAgo(timestamp) {
  const now = new Date();
  const then = new Date(timestamp);
  const diffMs = now - then;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);
  
  if (diffMins < 1) return 'Just now';
  if (diffMins < 60) return `${diffMins}m ago`;
  if (diffHours < 24) return `${diffHours}h ago`;
  if (diffDays < 7) return `${diffDays}d ago`;
  return then.toLocaleDateString();
}

// Drill down into activity entry
function drillDownActivity(entryId) {
  // Handle both real audit log entries and seed data
  let entry = STATE.auditLog.find(e => e.id == entryId);
  
  // If not found in audit log, might be seed data - create a synthetic entry
  if (!entry && entryId.startsWith('seed-')) {
    const seedEntries = [
      { id: 'seed-1', action: 'EVIDENCE_UPLOADED', data: { controlId: 'UCP-001' }, timestamp: new Date(Date.now() - 2*3600000).toISOString(), user: 'Sarah Chen', hash: 'a1b2c3d4e5f6', commitBlock: 847 },
      { id: 'seed-2', action: 'SNAPSHOT_CREATED', data: { block: 847 }, timestamp: new Date(Date.now() - 4*3600000).toISOString(), user: 'System', hash: '26b0a1f4d8e2', commitBlock: 847 },
      { id: 'seed-3', action: 'DIVERGENCE_DETECTED', data: { controlId: 'UCP-003', delta: 0.18 }, timestamp: new Date(Date.now() - 24*3600000).toISOString(), user: 'System', hash: 'f3e2d1c0b9a8', commitBlock: 846 },
      { id: 'seed-4', action: 'CONTROL_UPDATED', data: { controlId: 'SOC2' }, timestamp: new Date(Date.now() - 48*3600000).toISOString(), user: 'Mike Johnson', hash: '7890abcd1234', commitBlock: 845 }
    ];
    entry = seedEntries.find(e => e.id == entryId);
  }
  
  if (!entry) {
    showToast('Activity entry not found', 'error');
    return;
  }
  
  openModal(`Activity Detail: ${getActivityLabel(entry.action)}`, `
    <div style="padding: 20px;">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
        <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
          <div style="font-size: 11px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 4px;">TIMESTAMP</div>
          <div style="font-size: 14px; font-family: 'IBM Plex Mono', monospace;">${new Date(entry.timestamp).toLocaleString()}</div>
        </div>
        <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
          <div style="font-size: 11px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 4px;">USER</div>
          <div style="font-size: 14px;">${entry.user}</div>
        </div>
      </div>
      
      <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 24px;">
        <div style="font-size: 11px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 8px;">CRYPTOGRAPHIC PROOF</div>
        <div style="display: flex; align-items: center; gap: 12px;">
          <span style="font-family: 'IBM Plex Mono', monospace; font-size: 12px; background: var(--green-light); color: var(--green); padding: 4px 8px; border-radius: 4px;">🔒 COMMITTED</span>
          <span style="font-family: 'IBM Plex Mono', monospace; font-size: 12px;">Hash: ${entry.hash}</span>
        </div>
        <div style="font-size: 12px; color: var(--text-tertiary); margin-top: 8px;">Block: ${entry.commitBlock || entry.snapshot || STATE.currentSnapshot}</div>
      </div>
      
      <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
        <div style="font-size: 11px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 8px;">DETAILS</div>
        <pre style="font-size: 12px; font-family: 'IBM Plex Mono', monospace; white-space: pre-wrap; margin: 0;">${JSON.stringify(entry.data, null, 2)}</pre>
      </div>
      
      ${entry.data?.controlId ? `
        <button class="btn btn-primary" style="margin-top: 16px; width: 100%;" onclick="closeModal(); viewControl('${entry.data.controlId}')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
          </svg>
          View Control ${entry.data.controlId}
        </button>
      ` : ''}
      ${entry.data?.evidenceId ? `
        <button class="btn btn-primary" style="margin-top: 16px; width: 100%;" onclick="closeModal(); showEvidenceDetail('${entry.data.evidenceId}')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
          </svg>
          View Evidence ${entry.data.evidenceId}
        </button>
      ` : ''}
    </div>
  `, `
    <button class="btn btn-secondary" onclick="closeModal()">Close</button>
  `);
}

// Verify audit log chain integrity  
function verifyAuditChain() {
  if (STATE.auditLog.length === 0) return { valid: true, verified: 0 };
  
  let verified = 0;
  for (let entry of STATE.auditLog) {
    // In production, verify hash matches entry data
    verified++;
  }
  
  return { valid: true, verified: verified };
}

// ---- COMMENT SYSTEM ----

// Add comment to any resource (control, evidence, etc.)
function addComment(resourceType, resourceId, comment, parentCommentId = null) {
  const commentEntry = {
    id: `CMT-${Date.now()}`,
    resourceType,
    resourceId,
    parentCommentId,
    text: comment,
    author: 'Sarah Chen',
    timestamp: new Date().toISOString(),
    hash: null
  };
  
  // Generate hash
  commentEntry.hash = generateHash(commentEntry);
  
  // Store in STATE
  if (!STATE.comments) STATE.comments = {};
  if (!STATE.comments[resourceType]) STATE.comments[resourceType] = {};
  if (!STATE.comments[resourceType][resourceId]) STATE.comments[resourceType][resourceId] = [];
  
  STATE.comments[resourceType][resourceId].push(commentEntry);
  
  // Log to audit
  logAuditEntry('COMMENT_ADDED', {
    resourceType,
    resourceId,
    commentId: commentEntry.id,
    preview: comment.substring(0, 50)
  });
  
  return commentEntry;
}

// Get comments for a resource
function getComments(resourceType, resourceId) {
  if (!STATE.comments) return [];
  if (!STATE.comments[resourceType]) return [];
  return STATE.comments[resourceType][resourceId] || [];
}

// Render comment input UI
function renderCommentInput(resourceType, resourceId) {
  return `
    <div class="comment-input-container" style="margin-top: 16px; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
      <div style="font-size: 12px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 8px;">ADD COMMENT</div>
      <div style="display: flex; gap: 8px;">
        <input type="text" 
               id="commentInput_${resourceType}_${resourceId}" 
               placeholder="Add a comment..." 
               style="flex: 1; padding: 10px 12px; border: 1px solid var(--border-light); border-radius: 6px; font-size: 13px;"
               onkeypress="if(event.key==='Enter') submitComment('${resourceType}', '${resourceId}')">
        <button class="btn btn-primary" onclick="submitComment('${resourceType}', '${resourceId}')">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="22" y1="2" x2="11" y2="13"/>
            <polygon points="22 2 15 22 11 13 2 9 22 2"/>
          </svg>
          Post
        </button>
      </div>
    </div>
  `;
}

// Render comments list
function renderCommentsList(resourceType, resourceId) {
  const comments = getComments(resourceType, resourceId);
  
  if (comments.length === 0) {
    return `<div style="padding: 16px; text-align: center; color: var(--text-tertiary); font-size: 13px;">No comments yet</div>`;
  }
  
  return comments.map(c => `
    <div style="padding: 12px 16px; border-bottom: 1px solid var(--border-light);">
      <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
        <span style="font-weight: 600; font-size: 13px;">${c.author}</span>
        <span style="font-size: 11px; color: var(--text-tertiary);">${getTimeAgo(c.timestamp)}</span>
      </div>
      <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.5;">${c.text}</div>
      <div style="margin-top: 6px; display: flex; align-items: center; gap: 8px;">
        <span class="hash" style="font-size: 9px;">${c.hash?.substring(0, 8)}</span>
        <span style="font-size: 10px; color: var(--green);">🔒 Committed</span>
      </div>
    </div>
  `).join('');
}

// Submit comment handler
function submitComment(resourceType, resourceId) {
  const input = document.getElementById(`commentInput_${resourceType}_${resourceId}`);
  if (!input || !input.value.trim()) {
    showToast('Please enter a comment', 'error');
    return;
  }
  
  const comment = addComment(resourceType, resourceId, input.value.trim());
  input.value = '';
  
  // Refresh comments list if visible
  const commentsList = document.getElementById(`commentsList_${resourceType}_${resourceId}`);
  if (commentsList) {
    commentsList.innerHTML = renderCommentsList(resourceType, resourceId);
  }
  
  showToast('Comment added and committed', 'success');
}

// Render recent activity items for dashboard
function renderRecentActivityItems() {
  // Get recent audit log entries or use seed data
  let recentEntries = STATE.auditLog.slice(-5).reverse();
  
  // If no audit log yet, show seed activity
  if (recentEntries.length === 0) {
    recentEntries = [
      { id: 'seed-1', action: 'EVIDENCE_UPLOADED', data: { controlId: 'UCP-001' }, timestamp: new Date(Date.now() - 2*3600000).toISOString(), user: 'Sarah Chen', hash: 'a1b2c3d4e5f6' },
      { id: 'seed-2', action: 'SNAPSHOT_CREATED', data: { block: 847 }, timestamp: new Date(Date.now() - 4*3600000).toISOString(), user: 'System', hash: '26b0a1f4d8e2' },
      { id: 'seed-3', action: 'DIVERGENCE_DETECTED', data: { controlId: 'UCP-003', delta: 0.18 }, timestamp: new Date(Date.now() - 24*3600000).toISOString(), user: 'System', hash: 'f3e2d1c0b9a8' },
      { id: 'seed-4', action: 'CONTROL_UPDATED', data: { controlId: 'SOC2' }, timestamp: new Date(Date.now() - 48*3600000).toISOString(), user: 'Mike Johnson', hash: '7890abcd1234' }
    ];
  }
  
  return recentEntries.map((entry, idx) => {
    const { icon, color, bgColor } = getActivityIcon(entry.action);
    const timeAgo = getTimeAgo(entry.timestamp);
    const detail = getActivityDetail(entry);
    
    return `
      <div style="padding: 16px 20px; ${idx < recentEntries.length - 1 ? 'border-bottom: 1px solid var(--border-light);' : ''} display: flex; align-items: center; gap: 12px; cursor: pointer; transition: background 0.2s;" 
           onclick="drillDownActivity('${entry.id}')"
           onmouseover="this.style.background='var(--bg-secondary)'"
           onmouseout="this.style.background='white'">
        <div style="width: 36px; height: 36px; border-radius: 8px; background: ${bgColor}; display: flex; align-items: center; justify-content: center;">
          ${icon}
        </div>
        <div style="flex: 1;">
          <div style="font-weight: 600; font-size: 13px;">${getActivityLabel(entry.action)}</div>
          <div style="font-size: 11px; color: var(--text-tertiary);">${detail} • ${timeAgo}</div>
        </div>
        <div style="text-align: right;">
          <span class="hash" style="font-size: 10px;">${entry.hash?.substring(0, 8) || ''}</span>
        </div>
      </div>
    `;
  }).join('') || `
    <div style="padding: 40px; text-align: center; color: var(--text-tertiary);">
      <div style="font-size: 14px;">No recent activity</div>
    </div>
  `;
}

// ---- VIEW RENDERING & NAVIGATION ----

function showView(viewName) {
  STATE.currentView = viewName;
  
  // Update nav
  document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
  event?.target?.classList?.add('active');
  
  // Render view
  const main = document.getElementById('mainContent');
  
  switch(viewName) {
    case 'dashboard':
      main.innerHTML = renderDashboard();
      animateCounters();
      break;
    case 'controls':
      main.innerHTML = renderControls();
      break;
    case 'control-detail':
      main.innerHTML = renderControlDetail();
      break;
    case 'evidence':
      main.innerHTML = renderEvidence();
      break;
    case 'clauses':
      main.innerHTML = renderClauseRepository();
      break;
    case 'rfp':
      main.innerHTML = renderRFP();
      break;
    case 'framework':
      main.innerHTML = renderFrameworkMapper();
      break;
    case 'forensics':
      main.innerHTML = renderForensics();
      break;
    case 'forecasting':
      main.innerHTML = renderForecasting();
      break;
    case 'reports':
      main.innerHTML = renderReports();
      break;
    case 'snapshots':
      main.innerHTML = renderSnapshots();
      break;
    case 'attestations':
      main.innerHTML = renderAttestations();
      break;
    case 'ingestion':
      main.innerHTML = renderIngestion();
      break;
    case 'nsxt':
      main.innerHTML = renderNSXT();
      break;
    default:
      main.innerHTML = renderPlaceholder(viewName);
  }
}

// ---- DASHBOARD VIEW - STUNNING ----

function renderDashboard() {
  // Get data from current timeline snapshot
  const snapshot = TIMELINE_SNAPSHOTS[STATE.currentTimelineIndex];
  const isCurrentTime = STATE.currentTimelineIndex === 3;
  // Recognize live data from API OR from LIVE_STATE computed values
  const isLiveData = isCurrentTime && (API_DATA.summary !== null || (window.LIVE_STATE && LIVE_STATE.initialized));

  // Use real API data when on current timeline, otherwise use snapshot data
  let avgTrust, compliantCount, atRiskCount, criticalCount, totalControls;

  if (isLiveData) {
    const summary = getSummary();
    avgTrust = summary.avg_trust || 0;
    compliantCount = summary.compliant || 0;
    atRiskCount = summary.at_risk || 0;
    criticalCount = summary.critical || 0;
    totalControls = summary.total || 0;
  } else {
    avgTrust = snapshot.trustScore;
    compliantCount = snapshot.compliantCount;
    atRiskCount = snapshot.atRiskCount;
    criticalCount = snapshot.criticalCount;
    totalControls = compliantCount + atRiskCount + criticalCount;
  }
  
  // Show time travel indicator if not on current snapshot
  const timeTravelIndicator = STATE.currentTimelineIndex !== 3 ? `
    <div style="padding: 12px 16px; background: var(--amber-light); border-left: 4px solid var(--amber); border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px;">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--amber)" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <polyline points="12,6 12,12 16,14"/>
      </svg>
      <div style="flex: 1;">
        <div style="font-weight: 700; font-size: 13px; color: var(--amber); margin-bottom: 2px;">⏰ Historical Snapshot View</div>
        <div style="font-size: 12px; color: var(--text-secondary);">Viewing snapshot from ${snapshot.date} (Block ${snapshot.id}). Move slider to 100% to return to current state.</div>
      </div>
    </div>
  ` : '';
  
  return `
    <div class="view active">
      ${getDemoBanner()}
      
      <div class="page-header">
        <h1 class="page-title">Dashboard</h1>
        <p class="page-subtitle">Real-time governance trust metrics powered by ΦΨΔIPT operators${isLiveData ? ' <span style="color: var(--green); font-size: 11px;">(Live Data)</span>' : ''}</p>
      </div>
      
      ${timeTravelIndicator}
      
      <!-- Hero Trust Score -->
      <div class="card mb-32" style="position: relative;">
        <button class="delta-context-btn" onclick="openDeltaContextByTopic('trust_score', event)" title="Ask about trust score">Δ</button>
        <div class="card-body">
          <div class="trust-score-large">
            <div class="trust-score-value ${getTrustColor(avgTrust)}" id="heroTrustScore">0.00</div>
            <div class="trust-score-label">Composite Trust Score</div>
          </div>
        </div>
      </div>
      
      <!-- Stat Cards -->
      <div class="grid-4 mb-32">
        <div class="stat-card">
          <button class="delta-context-btn" onclick="openDeltaContextByTopic('total_controls', event)" title="Ask about controls">Δ</button>
          <div class="stat-label">Total Controls</div>
          <div class="stat-value" data-target="${totalControls}" id="statControls">0</div>
          <div class="stat-change positive">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
              <polyline points="17 6 23 6 23 12"/>
            </svg>
            ${isLiveData ? 'From API' : (STATE.currentTimelineIndex === 3 ? '+2 this week' : 'Historical data')}
          </div>
        </div>

        <div class="stat-card">
          <button class="delta-context-btn" onclick="openDeltaContextByTopic('compliant', event)" title="Ask about compliance">Δ</button>
          <div class="stat-label">Compliant</div>
          <div class="stat-value" data-target="${compliantCount}" id="statCompliant" style="color: var(--green);">0</div>
          <div class="stat-change positive">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12"/>
            </svg>
            ${((compliantCount/totalControls)*100).toFixed(0)}% coverage
          </div>
        </div>

        <div class="stat-card">
          <button class="delta-context-btn" onclick="openDeltaContextByTopic('at_risk', event)" title="Ask about at-risk items">Δ</button>
          <div class="stat-label">At Risk</div>
          <div class="stat-value" data-target="${atRiskCount}" id="statAtRisk" style="color: var(--amber);">0</div>
          <div class="stat-change ${atRiskCount > 0 ? 'negative' : 'neutral'}">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
            </svg>
            ${atRiskCount > 0 ? 'Needs attention' : 'All clear'}
          </div>
        </div>

        <div class="stat-card">
          <button class="delta-context-btn" onclick="openDeltaContextByTopic('critical', event)" title="Ask about critical issues">Δ</button>
          <div class="stat-label">Critical</div>
          <div class="stat-value" data-target="${criticalCount}" id="statCritical" style="color: var(--red);">0</div>
          <div class="stat-change ${criticalCount > 0 ? 'negative' : 'neutral'}">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="8" x2="12" y2="12"/>
              <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            ${criticalCount > 0 ? 'Immediate action required' : 'No critical issues'}
          </div>
        </div>
      </div>
      
      <!-- Operator Breakdown -->
      <div class="grid-2 mb-32">
        <div class="card" style="position: relative;">
          <button class="delta-context-btn" onclick="openDeltaContextByTopic('operators', event)" title="Ask about operators">Δ</button>
          <div class="card-header">
            <span class="card-title">Operator Analysis</span>
            <span style="font-size: 11px; color: var(--text-tertiary); font-family: 'IBM Plex Mono', monospace;">ΦΨΔIPT Metrics</span>
          </div>
          <div class="card-body">
            <div class="operator-row">
              <div class="operator-glyph phi">Φ</div>
              <div class="operator-label">Zero-Start</div>
              <div class="operator-bar">
                <div class="operator-bar-fill phi" style="width: 0%;" data-width="${(avgTrust * 100).toFixed(0)}"></div>
              </div>
              <div class="operator-value">${avgTrust.toFixed(2)}</div>
            </div>
            <div class="operator-row">
              <div class="operator-glyph psi">Ψ</div>
              <div class="operator-label">Credential-Decay</div>
              <div class="operator-bar">
                <div class="operator-bar-fill psi" style="width: 0%;" data-width="${((avgTrust - 0.03) * 100).toFixed(0)}"></div>
              </div>
              <div class="operator-value">${(avgTrust - 0.03).toFixed(2)}</div>
            </div>
            <div class="operator-row">
              <div class="operator-glyph delta">Δ</div>
              <div class="operator-label">Divergence</div>
              <div class="operator-bar">
                <div class="operator-bar-fill delta" style="width: 0%;" data-width="${((1 - avgTrust) * 15).toFixed(0)}"></div>
              </div>
              <div class="operator-value">${((1 - avgTrust) * 0.15).toFixed(2)}</div>
            </div>
            <div class="operator-row">
              <div class="operator-glyph ip">IP</div>
              <div class="operator-label">Integrity Proof</div>
              <div class="operator-bar">
                <div class="operator-bar-fill ip" style="width: 0%;" data-width="100"></div>
              </div>
              <div class="operator-value">1.00</div>
            </div>
            <div class="operator-row">
              <div class="operator-glyph trust">T</div>
              <div class="operator-label">Trust Composite</div>
              <div class="operator-bar">
                <div class="operator-bar-fill trust" style="width: 0%;" data-width="${Math.round(avgTrust * 100)}"></div>
              </div>
              <div class="operator-value">${avgTrust}</div>
            </div>
          </div>
        </div>
        
        <div class="card" style="position: relative;">
          <button class="delta-context-btn" onclick="openDeltaContextByTopic('activity', event)" title="Ask about recent activity">Δ</button>
          <div class="card-header">
            <span class="card-title">Recent Activity</span>
            <span style="font-size: 11px; color: var(--text-tertiary);">Audit Trail</span>
          </div>
          <div class="card-body" style="padding: 0;" id="recentActivityList">
            ${renderRecentActivityItems()}
          </div>
        </div>
      </div>
      
      <!-- Controls at Risk / Recommendations -->
      <div class="card">
        <div class="card-header">
          <span class="card-title">${STATE.currentTimelineIndex === 3 ? 'Controls Requiring Attention' : 'Recommendations from ' + snapshot.date}</span>
          <button class="btn btn-secondary" onclick="showView('forecasting')">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
            </svg>
            Get to Green
          </button>
        </div>
        <div class="card-body" style="padding: 0;">
          ${snapshot.recommendations.map((rec, idx) => `
            <div style="padding: 16px 20px; ${idx < snapshot.recommendations.length - 1 ? 'border-bottom: 1px solid var(--border-light);' : ''} display: flex; align-items: start; gap: 12px;">
              <div style="width: 28px; height: 28px; border-radius: 50%; background: ${idx === 0 && criticalCount > 0 ? 'var(--red-light)' : atRiskCount > 0 ? 'var(--amber-light)' : 'var(--green-light)'}; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                <span style="font-weight: 800; font-size: 12px; color: ${idx === 0 && criticalCount > 0 ? 'var(--red)' : atRiskCount > 0 ? 'var(--amber)' : 'var(--green)'};">${idx + 1}</span>
              </div>
              <div style="flex: 1;">
                <div style="font-weight: 500; font-size: 13px; line-height: 1.5; color: var(--text-primary);">${rec}</div>
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    </div>
  `;
}

// ---- CONTROLS VIEW ----

function renderControls() {
  const controls = getControls();
  const uniqueFrameworks = [...new Set(controls.flatMap(c => c.frameworks || []))];
  const isLiveData = (API_DATA.controls && API_DATA.controls.length > 0) || (window.LIVE_STATE && LIVE_STATE.initialized);

  return `
    <div class="view active">
      ${getDemoBanner()}

      <div class="page-header">
        <h1 class="page-title">Controls</h1>
        <p class="page-subtitle">${controls.length} controls across ${uniqueFrameworks.length} frameworks ${isLiveData ? '<span style="color: var(--green); font-size: 11px;">(Live Data)</span>' : ''}</p>
      </div>

      <div class="card">
        <div class="card-header">
          <span class="card-title">All Controls</span>
          <div style="display: flex; gap: 8px;">
            <button class="btn btn-ghost">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
              </svg>
              Filter
            </button>
            <button class="btn btn-secondary" onclick="exportControlsData()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7,10 12,15 17,10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
              Export
            </button>
          </div>
        </div>
        <div class="card-body" style="padding: 0;">
          <table class="data-table">
            <thead>
              <tr>
                <th>Control</th>
                <th>Name</th>
                <th>Frameworks</th>
                <th>Φ</th>
                <th>Ψ</th>
                <th>Δ</th>
                <th>Trust</th>
                <th>Status</th>
                <th>Evidence</th>
                <th style="width: 40px;"></th>
              </tr>
            </thead>
            <tbody>
              ${controls.map(c => {
                const phi = c.phi || 0;
                const psi = c.psi || 0;
                const delta = c.delta || 0;
                const trust = c.trust || 0;
                const frameworks = c.frameworks || [];
                const evidenceCount = c.evidence_count !== undefined ? c.evidence_count : (c.evidence || 0);
                return `
                <tr onclick="viewControl('${c.id}')">
                  <td><span class="control-id">${c.id}</span></td>
                  <td><span class="control-name">${c.name}</span></td>
                  <td>
                    <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                      ${frameworks.map(f => `<span class="framework-chip">${f}</span>`).join('')}
                    </div>
                  </td>
                  <td><span style="color: var(--phi); font-family: 'IBM Plex Mono'; font-size: 12px; font-weight: 600;">${phi.toFixed(2)}</span></td>
                  <td><span style="color: var(--psi); font-family: 'IBM Plex Mono'; font-size: 12px; font-weight: 600;">${psi.toFixed(2)}</span></td>
                  <td><span style="color: var(--delta); font-family: 'IBM Plex Mono'; font-size: 12px; font-weight: 600;">${delta.toFixed(2)}</span></td>
                  <td>
                    <div class="mini-trust">
                      <div class="mini-trust-bar"><div class="mini-trust-fill ${getTrustColor(trust)}" style="width: ${trust * 100}%;"></div></div>
                      <span class="mini-trust-value">${trust.toFixed(2)}</span>
                    </div>
                  </td>
                  <td><span class="status-badge ${getStatusColor(c.status)}">${getStatusLabel(c.status)}</span></td>
                  <td style="text-align: center; font-family: 'IBM Plex Mono', monospace; font-weight: 600;">${evidenceCount}</td>
                  <td style="text-align: center;">
                    <button class="delta-context-btn" onclick="event.stopPropagation(); openDeltaContextById('control', '${c.id}', event)" title="Ask Δtomic AI about this control">Δ</button>
                  </td>
                </tr>
              `;}).join('')}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  `;
}

// ---- CONTROL DETAIL VIEW ----

async function viewControl(controlId) {
  // Show loading state
  STATE.selectedControl = null;
  STATE.selectedControlEvidence = [];
  showView('control-detail');

  // Fetch from API if connected
  if (apiConnected) {
    try {
      const { control, evidence, fromAPI } = await API.getControlWithEvidence(controlId);
      if (control) {
        STATE.selectedControl = control;
        STATE.selectedControlEvidence = evidence || [];
        console.log(`[viewControl] Loaded ${controlId} with ${evidence?.length || 0} evidence items (fromAPI: ${fromAPI})`);
      } else {
        // Fallback to local data
        STATE.selectedControl = getControls().find(c => c.id === controlId);
        STATE.selectedControlEvidence = getEvidence().filter(e => e.controlId === controlId || e.control_id === controlId);
      }
    } catch (err) {
      console.error('[viewControl] API error:', err);
      STATE.selectedControl = getControls().find(c => c.id === controlId);
      STATE.selectedControlEvidence = getEvidence().filter(e => e.controlId === controlId || e.control_id === controlId);
    }
  } else {
    // Use cached/sample data
    STATE.selectedControl = getControls().find(c => c.id === controlId);
    STATE.selectedControlEvidence = getEvidence().filter(e => e.controlId === controlId || e.control_id === controlId);
  }

  // Re-render with data
  showView('control-detail');
}

// Vote on a control (calls SDK API)
async function voteControl(controlId, verdict) {
  const control = STATE.selectedControl || getControls().find(c => c.id === controlId);
  if (!control) {
    showToast('Control not found', 'error');
    return;
  }
  
  // Show confirmation modal for non-compliant
  if (verdict === 'non-compliant') {
    const confirmed = confirm(`Mark "${control.name}" as Non-Compliant?\n\nThis will affect trust scores across all 6 frameworks.`);
    if (!confirmed) return;
  }
  
  showToast(`Submitting vote: ${verdict}...`, 'info');
  
  // Get rationale
  const rationales = {
    'compliant': `${control.name} meets all framework requirements based on attached evidence.`,
    'partial': `${control.name} partially meets requirements. Some gaps identified.`,
    'non-compliant': `${control.name} does not meet minimum compliance requirements.`
  };
  
  try {
    const result = await GRC_API.voteOnControl(
      controlId,
      'user-interface',  // agentId
      verdict,
      rationales[verdict],
      0.95
    );
    
    if (result) {
      // Update local state
      if (STATE.selectedControl) {
        STATE.selectedControl.phi = result.new_phi;
        STATE.selectedControl.psi = result.new_psi;
        STATE.selectedControl.delta = result.new_delta;
        STATE.selectedControl.status = result.new_status;
        STATE.selectedControl.trust = (result.new_phi + result.new_psi - result.new_delta) / 2;
      }
      
      // Update in controls array
      const idx = CONTROLS.findIndex(c => c.id === controlId);
      if (idx >= 0) {
        CONTROLS[idx].phi = result.new_phi;
        CONTROLS[idx].psi = result.new_psi;
        CONTROLS[idx].delta = result.new_delta;
        CONTROLS[idx].status = result.new_status;
        CONTROLS[idx].trust = (result.new_phi + result.new_psi - result.new_delta) / 2;
      }
      
      // Log audit entry
      logAuditEntry('CONTROL_VOTE', {
        controlId,
        verdict,
        newPhi: result.new_phi,
        propagatedTo: result.propagated_to
      });
      
      // Refresh view
      showView('control-detail');
      
      if (!result.simulated) {
        showToast(`Vote recorded! Propagated to ${result.propagated_to.length} frameworks`, 'success');
      }
    }
  } catch (err) {
    console.error('[voteControl] Error:', err);
    showToast('Vote failed: ' + err.message, 'error');
  }
}
window.voteControl = voteControl;

// Request Multi-LLM consensus on a control
async function requestControlConsensus(controlId, controlName) {
  showToast('Requesting LLM consensus...', 'info');
  
  // Get evidence summary
  const evidence = STATE.selectedControlEvidence || getEvidence().filter(e => e.controlId === controlId);
  const evidenceSummary = evidence.map(e => `${e.name} (${e.type}): ${e.summary || e.source || 'No summary'}`).join('\n');
  
  try {
    const result = await GRC_API.requestConsensus(controlId, controlName, evidenceSummary);
    
    if (result) {
      // Show result in a modal
      const modalBody = `
          <div style="background: var(--bg-secondary); border-radius: 12px; padding: 20px; margin-bottom: 16px;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
              <span style="font-size: 14px; color: var(--text-secondary);">Consensus Verdict</span>
              <span class="status-badge ${getStatusColor(result.consensus)}" style="font-size: 14px; padding: 6px 12px;">
                ${result.consensus.toUpperCase()}
              </span>
            </div>
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
              <span style="font-size: 14px; color: var(--text-secondary);">Confidence</span>
              <span style="font-family: 'IBM Plex Mono'; font-weight: 600; color: var(--phi);">${(result.confidence * 100).toFixed(1)}%</span>
            </div>
            <div style="display: flex; align-items: center; justify-content: space-between;">
              <span style="font-size: 14px; color: var(--text-secondary);">Divergence (Δ)</span>
              <span style="font-family: 'IBM Plex Mono'; font-weight: 600; color: var(--delta);">${(result.divergence * 100).toFixed(1)}%</span>
            </div>
          </div>
          
          <h3 style="margin-bottom: 12px; font-size: 14px; color: var(--text-secondary);">Individual Votes</h3>
          <div style="display: flex; flex-direction: column; gap: 8px;">
            ${(result.votes || []).map(v => `
              <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; background: white; border-radius: 8px; border: 1px solid var(--border-light);">
                <span style="font-weight: 500;">${v.agent || v.model}</span>
                <div style="display: flex; align-items: center; gap: 12px;">
                  <span class="status-badge ${getStatusColor(v.verdict)}">${v.verdict}</span>
                  <span style="font-family: 'IBM Plex Mono'; font-size: 12px; color: var(--text-secondary);">${(v.confidence * 100).toFixed(0)}%</span>
                </div>
              </div>
            `).join('')}
          </div>
          
          ${result.simulated ? '<p style="margin-top: 16px; font-size: 12px; color: var(--text-tertiary); text-align: center;">⚠ Simulated result - SDK not connected</p>' : ''}
      `;
      
      const modalFooter = `
        <button class="btn btn-ghost" onclick="closeModal()">Close</button>
        <button class="btn btn-primary" onclick="voteControl('${controlId}', '${result.consensus}'); closeModal();">
          Apply Consensus Vote
        </button>
      `;
      
      openModal('Multi-LLM Consensus Result', modalBody, modalFooter);
    }
  } catch (err) {
    console.error('[requestControlConsensus] Error:', err);
    showToast('Consensus request failed: ' + err.message, 'error');
  }
}
window.requestControlConsensus = requestControlConsensus;

function renderControlDetail() {
  const c = STATE.selectedControl;
  if (!c) {
    // Show loading state
    return `
      <div class="view active">
        <div style="display: flex; align-items: center; justify-content: center; height: 400px; color: var(--text-secondary);">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite; margin-right: 12px;">
            <circle cx="12" cy="12" r="10" stroke-dasharray="30 70" />
          </svg>
          Loading control details...
        </div>
      </div>
    `;
  }

  const controlEvidence = STATE.selectedControlEvidence || [];
  const discussion = DISCUSSIONS[c.id] || [];
  
  return `
    <div class="view active">
      <div class="page-header" style="display: flex; align-items: flex-start; justify-content: space-between;">
        <div>
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <button class="btn btn-ghost" onclick="showView('controls')">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="19" y1="12" x2="5" y2="12"/>
                <polyline points="12,19 5,12 12,5"/>
              </svg>
              Back
            </button>
            <span class="control-id" style="font-size: 16px;">${c.id}</span>
            <span class="status-badge ${getStatusColor(c.status)}">${getStatusLabel(c.status)}</span>
          </div>
          <h1 class="page-title">${c.name}</h1>
          <div style="display: flex; gap: 6px; margin-top: 12px;">
            ${c.frameworks.map(f => `<span class="framework-chip">${f}</span>`).join('')}
          </div>
        </div>
        <div style="display: flex; gap: 8px;">
          <!-- Vote Buttons -->
          <button class="btn" style="background: var(--green); color: white;" onclick="voteControl('${c.id}', 'compliant')" title="Mark as Compliant">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12"/>
            </svg>
            ✓ Compliant
          </button>
          <button class="btn" style="background: var(--yellow); color: #1a1a2e;" onclick="voteControl('${c.id}', 'partial')" title="Mark as Partial">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            ~ Partial
          </button>
          <button class="btn" style="background: var(--red); color: white;" onclick="voteControl('${c.id}', 'non-compliant')" title="Mark as Non-Compliant">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"/>
              <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
            ✗ Non-Compliant
          </button>
          <div style="width: 1px; background: var(--border-light); margin: 0 4px;"></div>
          <button class="btn btn-secondary" onclick="requestControlConsensus('${c.id}', '${c.name}')" title="Request Multi-LLM Consensus">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
              <circle cx="9" cy="7" r="4"/>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
            LLM Consensus
          </button>
          <button class="btn btn-secondary">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="3"/>
              <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
            </svg>
            View Propagation
          </button>
          <button class="btn btn-primary" onclick="createSnapshot()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
              <circle cx="12" cy="13" r="4"/>
            </svg>
            Snapshot
          </button>
        </div>
      </div>
      
      <div class="grid-2 mb-32">
        <div class="card">
          <div class="card-header">
            <span class="card-title">Trust Score</span>
            <span style="font-size: 11px; color: var(--psi); font-family: 'IBM Plex Mono', monospace;">λ = 0.02/day</span>
          </div>
          <div class="card-body">
            <div class="trust-score-large" style="padding: 24px 16px;">
              <div class="trust-score-value ${getTrustColor(c.trust)}" style="font-size: 56px;">${c.trust.toFixed(2)}</div>
              <div class="trust-score-label">Composite Trust</div>
            </div>
            <div class="operator-row">
              <div class="operator-glyph phi">Φ</div>
              <div class="operator-label">Zero-Start</div>
              <div class="operator-bar"><div class="operator-bar-fill phi" style="width: ${c.phi * 100}%;"></div></div>
              <div class="operator-value">${c.phi.toFixed(2)}</div>
            </div>
            <div class="operator-row">
              <div class="operator-glyph psi">Ψ</div>
              <div class="operator-label">Credential-Decay</div>
              <div class="operator-bar"><div class="operator-bar-fill psi" style="width: ${c.psi * 100}%;"></div></div>
              <div class="operator-value">${c.psi.toFixed(2)}</div>
            </div>
            <div class="operator-row">
              <div class="operator-glyph delta">Δ</div>
              <div class="operator-label">Divergence</div>
              <div class="operator-bar"><div class="operator-bar-fill delta" style="width: ${c.delta * 100}%;"></div></div>
              <div class="operator-value">${c.delta.toFixed(2)}</div>
            </div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <span class="card-title">Evidence (${controlEvidence.length})</span>
            <button class="btn btn-secondary" onclick="uploadEvidence('${c.id}')">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17,8 12,3 7,8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
              </svg>
              Upload
            </button>
          </div>
          <div class="card-body" style="padding: 0;">
            ${controlEvidence.length > 0 ? controlEvidence.map(e => `
              <div style="display: flex; align-items: center; gap: 12px; padding: 16px 20px; border-bottom: 1px solid var(--border-light); transition: all 0.2s ease; cursor: pointer;" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='white'">
                <div style="width: 40px; height: 40px; background: var(--bg-tertiary); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px;">
                  ${e.type === 'system_export' ? '📊' : e.type === 'document' ? '📄' : e.type === 'screenshot' ? '📸' : '📁'}
                </div>
                <div style="flex: 1;">
                  <div style="font-weight: 600; font-size: 13px; margin-bottom: 2px;">${e.name}</div>
                  <div style="font-size: 11px; color: var(--text-tertiary);">${e.uploadedBy} · ${formatRelativeTime(e.uploadedAt)}</div>
                </div>
                <span class="hash">${e.hash}</span>
                <span style="color: var(--phi); font-family: 'IBM Plex Mono'; font-size: 13px; font-weight: 700;">Φ ${e.phi.toFixed(2)}</span>
              </div>
            `).join('') : `
              <div class="empty-state">
                <div class="empty-state-icon">📦</div>
                <div class="empty-state-title">No evidence yet</div>
                <div class="empty-state-description">Upload evidence to improve trust score</div>
                <button class="btn btn-primary" onclick="uploadEvidence('${c.id}')">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="17,8 12,3 7,8"/>
                    <line x1="12" y1="3" x2="12" y2="15"/>
                  </svg>
                  Upload Evidence
                </button>
              </div>
            `}
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <span class="card-title">Discussion Thread</span>
          <div style="display: flex; align-items: center; gap: 8px;">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--ip)" stroke-width="2">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
              <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
            </svg>
            <span style="font-size: 11px; color: var(--ip); font-weight: 600;">All entries hashed</span>
          </div>
        </div>
        <div class="card-body" style="padding: 0;">
          ${discussion.map(entry => entry.type === 'snapshot' ? `
            <div class="snapshot-entry" style="margin: 16px;">
              <div class="snapshot-entry-icon">IP</div>
              <div class="snapshot-entry-content">
                <div class="snapshot-entry-title">Snapshot Created</div>
                <div class="snapshot-entry-meta">${formatDate(entry.time)} · Block ${entry.block}</div>
              </div>
              <span class="hash">${entry.hash}</span>
            </div>
          ` : `
            <div class="discussion-entry">
              <div class="discussion-header">
                <div class="discussion-avatar">${entry.initials}</div>
                <div class="discussion-meta">
                  <div class="discussion-author">${entry.author}</div>
                  <div class="discussion-time">${formatDate(entry.time)}</div>
                </div>
                <span class="discussion-hash">${entry.hash}</span>
              </div>
              <div class="discussion-content">${entry.content}</div>
            </div>
          `).join('')}
          
          <div style="padding: 20px; border-top: 1px solid var(--border-light); background: var(--bg-secondary);">
            <div style="display: flex; gap: 12px;">
              <input type="text" id="discussionInput" placeholder="Add a comment..." style="flex: 1; padding: 12px 16px; border: 1px solid var(--border-light); border-radius: 10px; font-size: 13px; font-family: inherit; transition: all 0.2s ease;" onfocus="this.style.borderColor='var(--brand)'; this.style.boxShadow='var(--shadow-md)'" onblur="this.style.borderColor='var(--border-light)'; this.style.boxShadow='none'">
              <button class="btn btn-primary" onclick="addDiscussionEntry('${c.id}')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="22" y1="2" x2="11" y2="13"/>
                  <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                </svg>
                Post
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
}

// ---- FORECASTING VIEW ----

function renderForecasting() {
  const recommendations = generateRecommendations();
  
  return `
    <div class="view active">
      <div class="page-header">
        <h1 class="page-title">Get to Green</h1>
        <p class="page-subtitle">AI-powered trust improvement recommendations</p>
      </div>
      
      <!-- Forecast Overview -->
      <div class="grid-3 mb-32">
        <div class="stat-card">
          <button class="delta-context-btn" onclick="openDeltaContextByTopic('current_trust', event)" title="Ask about current trust">Δ</button>
          <div class="stat-label">Current Trust</div>
          <div class="stat-value" style="color: var(--amber);">0.89</div>
          <div class="stat-change negative">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="23 18 13.5 8.5 8.5 13.5 1 6"/>
              <polyline points="17 18 23 18 23 12"/>
            </svg>
            Below target (0.95)
          </div>
        </div>

        <div class="stat-card">
          <button class="delta-context-btn" onclick="openDeltaContextByTopic('projected_trust', event)" title="Ask about projected trust">Δ</button>
          <div class="stat-label">Projected Trust</div>
          <div class="stat-value" style="color: var(--green);">0.94</div>
          <div class="stat-change positive">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
              <polyline points="17 6 23 6 23 12"/>
            </svg>
            +0.05 improvement
          </div>
        </div>

        <div class="stat-card">
          <button class="delta-context-btn" onclick="openDeltaContextByTopic('time_to_green', event)" title="Ask about timeline">Δ</button>
          <div class="stat-label">Time to Green</div>
          <div class="stat-value" style="font-size: 28px;">14d</div>
          <div class="stat-change positive">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <polyline points="12,6 12,12 16,14"/>
            </svg>
            87% confidence
          </div>
        </div>
      </div>
      
      <!-- Recommendations -->
      <div class="card">
        <div class="card-header">
          <span class="card-title">Prioritized Recommendations (${recommendations.length})</span>
          <div style="display: flex; gap: 8px;">
            <button class="btn btn-ghost forecast-filter active" onclick="filterRecommendations('all')">All</button>
            <button class="btn btn-ghost forecast-filter" onclick="filterRecommendations('high')">High Priority</button>
            <button class="btn btn-ghost forecast-filter" onclick="filterRecommendations('quick')">Quick Wins</button>
            <button class="btn btn-secondary" onclick="runForecastSimulation()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="22,12 18,12 15,21 9,3 6,12 2,12"/>
              </svg>
              Run Simulation
            </button>
          </div>
        </div>
        <div class="card-body" style="padding: 0;">
          ${recommendations.map((rec, idx) => `
            <div style="padding: 20px 24px; border-bottom: 1px solid var(--border-light); transition: all 0.2s ease;" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='white'">
              <div style="display: flex; gap: 16px; align-items: start;">
                <div style="display: flex; flex-direction: column; align-items: center; min-width: 50px;">
                  <div style="width: 40px; height: 40px; background: ${rec.priority === 'high' ? 'var(--red-light)' : rec.priority === 'medium' ? 'var(--amber-light)' : 'var(--bg-tertiary)'}; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 16px; color: ${rec.priority === 'high' ? 'var(--red)' : rec.priority === 'medium' ? 'var(--amber)' : 'var(--text-secondary)'};">
                    ${idx + 1}
                  </div>
                  <div style="font-size: 10px; color: var(--text-tertiary); margin-top: 6px; text-transform: uppercase; font-weight: 700;">${rec.priority}</div>
                </div>
                
                <div style="flex: 1;">
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <span style="font-weight: 700; font-size: 14px;">${rec.title}</span>
                    <span class="control-id" style="cursor: pointer;" onclick="viewControl('${rec.control}')">${rec.control}</span>
                    <span style="padding: 3px 10px; background: ${rec.type === 'divergence' ? 'rgba(0, 212, 170, 0.15)' : rec.type === 'decay' ? 'rgba(50, 130, 184, 0.15)' : rec.type === 'evidence' ? 'rgba(15, 76, 117, 0.15)' : 'rgba(220, 38, 38, 0.15)'}; color: ${rec.type === 'divergence' ? 'var(--delta)' : rec.type === 'decay' ? 'var(--psi)' : rec.type === 'evidence' ? 'var(--phi)' : 'var(--red)'}; border-radius: 6px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.03em;">${rec.type}</span>
                  </div>
                  <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px; line-height: 1.6;">${rec.description}</div>
                  <div style="font-size: 13px; color: var(--text-primary); background: var(--bg-secondary); padding: 12px 16px; border-radius: 8px; margin-bottom: 12px; border-left: 3px solid var(--brand);">
                    <strong style="font-weight: 700;">Action:</strong> ${rec.action}
                  </div>
                  <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                    ${rec.evidence.map(e => `<span style="font-size: 11px; color: var(--text-tertiary); background: var(--bg-tertiary); padding: 3px 10px; border-radius: 6px; font-weight: 500;">${e}</span>`).join('')}
                  </div>
                </div>
                
                <div style="text-align: right; min-width: 140px;">
                  <div style="font-size: 28px; font-weight: 800; color: var(--green); margin-bottom: 4px;">+${rec.impact.trustGain.toFixed(2)}</div>
                  <div style="font-size: 11px; color: var(--text-tertiary); font-weight: 600; text-transform: uppercase; letter-spacing: 0.03em;">Trust Gain</div>
                  <div style="margin-top: 12px; font-size: 12px;">
                    <div style="color: var(--text-tertiary); margin-bottom: 2px;">⏱ ${rec.impact.timeEstimate}</div>
                    <div style="color: var(--text-tertiary);">📊 ${rec.impact.effort} effort</div>
                  </div>
                  <button class="btn btn-primary" style="margin-top: 16px; font-size: 12px; padding: 8px 16px;" onclick="startRecommendation('${rec.id}')">
                    Start
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="5" y1="12" x2="19" y2="12"/>
                      <polyline points="12,5 19,12 12,19"/>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    </div>
  `;
}

// ---- REPORTS VIEW - ENTERPRISE GRADE ----

function renderReports() {
  const reports = [
    {
      id: 'executive-summary',
      name: 'Executive Summary',
      description: 'High-level trust metrics, compliance status, and trend analysis for C-suite',
      icon: 'chart',
      category: 'Executive',
      audience: 'C-Suite, Board',
      color: '#0F4C75',
      formats: ['PDF', 'PPTX'],
      frequency: 'Weekly',
      lastRun: '2 hours ago'
    },
    {
      id: 'compliance-certificate',
      name: 'Compliance Certificate',
      description: 'Snapshot-backed attestation of compliance state with cryptographic proof',
      icon: 'shield',
      category: 'Audit',
      audience: 'Auditors, Regulators',
      color: '#10B981',
      formats: ['PDF', 'DOCX'],
      frequency: 'On-demand',
      lastRun: 'Yesterday'
    },
    {
      id: 'audit-trail',
      name: 'Complete Audit Trail',
      description: 'Full change history with BLAKE3 hashes and Merkle proofs',
      icon: 'list',
      category: 'Audit',
      audience: 'Auditors, Compliance',
      color: '#1A1A2E',
      formats: ['PDF', 'CSV', 'JSON'],
      frequency: 'Quarterly',
      lastRun: '3 days ago'
    },
    {
      id: 'control-effectiveness',
      name: 'Control Effectiveness Analysis',
      description: 'Per-control breakdown with Φ/Ψ/Δ operator values and trends',
      icon: 'activity',
      category: 'Management',
      audience: 'VPs, Directors',
      color: '#3282B8',
      formats: ['PDF', 'XLSX'],
      frequency: 'Monthly',
      lastRun: '1 week ago'
    },
    {
      id: 'evidence-report',
      name: 'Evidence Inventory',
      description: 'Complete evidence catalog with upload dates, Φ scores, and decay status',
      icon: 'folder',
      category: 'Operational',
      audience: 'Analysts, Engineers',
      color: '#F59E0B',
      formats: ['XLSX', 'CSV'],
      frequency: 'Daily',
      lastRun: '6 hours ago'
    },
    {
      id: 'divergence-analysis',
      name: 'Divergence & Risk Report',
      description: 'Byzantine disagreement detection with voter analysis and resolution tracking',
      icon: 'alert',
      category: 'Management',
      audience: 'CISOs, Risk Managers',
      color: '#EF4444',
      formats: ['PDF', 'DOCX'],
      frequency: 'Weekly',
      lastRun: 'Yesterday'
    },
    {
      id: 'trust-decay',
      name: 'Trust Decay & Re-verification Schedule',
      description: 'Evidence aging analysis with Ψ decay curves and recommended refresh dates',
      icon: 'clock',
      category: 'Operational',
      audience: 'Compliance Teams',
      color: '#F59E0B',
      formats: ['PDF', 'XLSX'],
      frequency: 'Weekly',
      lastRun: 'Today'
    },
    {
      id: 'framework-coverage',
      name: 'Framework Coverage & Gap Analysis',
      description: 'Completion percentage per framework with control mapping and gap identification',
      icon: 'target',
      category: 'Management',
      audience: 'VPs, Program Managers',
      color: '#3282B8',
      formats: ['PDF', 'PPTX'],
      frequency: 'Monthly',
      lastRun: '5 days ago'
    },
    {
      id: 'rfp-response',
      name: 'RFP/Questionnaire Response',
      description: 'Auto-generated compliance questionnaire answers backed by snapshots',
      icon: 'file-text',
      category: 'Sales',
      audience: 'Sales, Legal',
      color: '#10B981',
      formats: ['DOCX', 'PDF'],
      frequency: 'On-demand',
      lastRun: '2 weeks ago'
    }
  ];

  const categories = ['All', 'Executive', 'Audit', 'Management', 'Operational', 'Sales'];
  
  return `
    <div class="view active">
      <div class="page-header">
        <h1 class="page-title">Reports & Analytics</h1>
        <p class="page-subtitle">Enterprise-grade reporting for every stakeholder—from executives to auditors</p>
      </div>

      <!-- Filters -->
      <div class="card" style="margin-bottom: 24px;">
        <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 16px;">
          <div style="display: flex; gap: 8px; flex-wrap: wrap;">
            ${categories.map((cat, i) => `
              <button class="btn btn-${i === 0 ? 'primary' : 'secondary'}" style="font-size: 13px; padding: 8px 16px;">
                ${cat}
              </button>
            `).join('')}
          </div>
          
          <div style="display: flex; gap: 12px; align-items: center;">
            <div style="position: relative;">
              <svg style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; color: var(--text-tertiary);" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"/>
                <path d="m21 21-4.35-4.35"/>
              </svg>
              <input type="text" placeholder="Search reports..." style="padding: 8px 12px 8px 36px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 13px; width: 220px;">
            </div>
            <button class="btn btn-primary">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
              </svg>
              Create Custom Report
            </button>
          </div>
        </div>
      </div>

      <!-- Report Library -->
      <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 20px;">
        ${reports.map(report => `
          <div class="card" style="cursor: pointer; transition: all 0.2s ease; position: relative; overflow: hidden;" onclick="generateReport('${report.id}')">
            <!-- Color accent bar -->
            <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: ${report.color};"></div>
            
            <div style="padding: 24px;">
              <!-- Header -->
              <div style="display: flex; align-items: flex-start; gap: 16px; margin-bottom: 16px;">
                <div style="width: 48px; height: 48px; border-radius: 12px; background: ${report.color}15; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                  ${getReportIcon(report.icon, report.color)}
                </div>
                <div style="flex: 1; min-width: 0;">
                  <h3 style="margin: 0 0 6px 0; font-size: 16px; font-weight: 700; color: var(--text-primary);">${report.name}</h3>
                  <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <span style="display: inline-block; padding: 3px 8px; background: ${report.color}20; color: ${report.color}; border-radius: 4px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.03em;">${report.category}</span>
                  </div>
                </div>
              </div>

              <!-- Description -->
              <p style="margin: 0 0 16px 0; font-size: 13px; line-height: 1.6; color: var(--text-secondary);">
                ${report.description}
              </p>

              <!-- Metadata -->
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding-top: 16px; border-top: 1px solid var(--border-light);">
                <div>
                  <div style="font-size: 10px; font-weight: 700; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px;">Audience</div>
                  <div style="font-size: 12px; color: var(--text-primary); font-weight: 500;">${report.audience}</div>
                </div>
                <div>
                  <div style="font-size: 10px; font-weight: 700; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px;">Frequency</div>
                  <div style="font-size: 12px; color: var(--text-primary); font-weight: 500;">${report.frequency}</div>
                </div>
              </div>

              <!-- Formats & Actions -->
              <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 16px;">
                <div style="display: flex; gap: 6px;">
                  ${report.formats.map(format => `
                    <span style="padding: 4px 8px; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 4px; font-size: 10px; font-weight: 700; color: var(--text-secondary); font-family: 'IBM Plex Mono', monospace;">${format}</span>
                  `).join('')}
                </div>
                <div style="font-size: 11px; color: var(--text-tertiary);">
                  Last run: ${report.lastRun}
                </div>
              </div>
            </div>

            <!-- Hover overlay -->
            <div style="position: absolute; inset: 0; background: linear-gradient(135deg, ${report.color}10 0%, ${report.color}05 100%); opacity: 0; transition: opacity 0.2s ease; pointer-events: none;" class="report-hover-overlay"></div>
          </div>
        `).join('')}
      </div>

      <!-- Scheduled Reports Section -->
      <div class="card" style="margin-top: 32px;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
          <div>
            <h3 style="margin: 0 0 4px 0; font-size: 18px; font-weight: 700;">Scheduled Reports</h3>
            <p style="margin: 0; font-size: 13px; color: var(--text-secondary);">Automatically generated and delivered on schedule</p>
          </div>
          <button class="btn btn-secondary">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <polyline points="12,6 12,12 16,14"/>
            </svg>
            Manage Schedules
          </button>
        </div>

        <div style="display: grid; gap: 12px;">
          ${[
            { name: 'Executive Summary', frequency: 'Every Monday 9am', recipients: 'ceo@company.com, cto@company.com', status: 'active' },
            { name: 'Control Effectiveness', frequency: 'First of month', recipients: 'compliance-team@company.com', status: 'active' },
            { name: 'Audit Trail Export', frequency: 'Quarterly', recipients: 'auditors@example.com', status: 'paused' }
          ].map(schedule => `
            <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px; display: flex; align-items: center; justify-content: space-between;">
              <div style="flex: 1;">
                <div style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">${schedule.name}</div>
                <div style="font-size: 12px; color: var(--text-secondary);">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 4px;">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12,6 12,12 16,14"/>
                  </svg>
                  ${schedule.frequency} · ${schedule.recipients}
                </div>
              </div>
              <div style="display: flex; align-items: center; gap: 12px;">
                <span style="padding: 4px 10px; background: ${schedule.status === 'active' ? 'var(--green-light)' : 'var(--amber-light)'}; color: ${schedule.status === 'active' ? 'var(--green)' : 'var(--amber)'}; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase;">${schedule.status}</span>
                <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;">Edit</button>
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    </div>

    <style>
      .card:hover .report-hover-overlay {
        opacity: 1 !important;
      }
    </style>
  `;
}

function getReportIcon(iconType, color) {
  const icons = {
    chart: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>`,
    shield: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><polyline points="9,12 11,14 15,10"/></svg>`,
    list: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>`,
    activity: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2"><polyline points="22,12 18,12 15,21 9,3 6,12 2,12"/></svg>`,
    folder: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>`,
    alert: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>`,
    clock: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12,6 12,12 16,14"/></svg>`,
    target: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>`,
    'file-text': `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10,9 9,9 8,9"/></svg>`
  };
  return icons[iconType] || icons.chart;
}

// ---- IMMUTABLE REPORTING ENGINE ----

function generateReport(reportId) {
  // Log report generation request
  logAuditEntry('REPORT_GENERATION_STARTED', { reportId: reportId });
  
  // Show generating toast
  showToast('Generating snapshot-backed report...', 'info');
  
  // Simulate report generation with real data
  setTimeout(() => {
    const reportData = buildReportData(reportId);
    const reportHash = generateHash(reportData);
    
    // Store in cache
    STATE.reportCache[reportHash] = {
      id: reportId,
      data: reportData,
      hash: reportHash,
      generated: new Date().toISOString(),
      snapshot: STATE.currentSnapshot,
      user: 'Sarah Chen'
    };
    
    // Log successful generation
    logAuditEntry('REPORT_GENERATED', { 
      reportId: reportId,
      hash: reportHash,
      snapshot: STATE.currentSnapshot,
      dataPoints: reportData.metrics?.totalDataPoints || reportData.controls?.length || 0
    });
    
    // Show report viewer modal
    showReportViewer(reportHash);
    
  }, 1200);
}

function buildReportData(reportId) {
  const timestamp = new Date().toISOString();
  const snapshot = STATE.currentSnapshot;
  
  // Use live data accessors
  const controls = getControls();
  const evidence = getEvidence();
  const frameworks = getAllFrameworks();
  const equivalences = getEquivalences();
  
  switch(reportId) {
    case 'executive-summary':
      return {
        reportType: 'Executive Summary',
        generated: timestamp,
        snapshot: snapshot,
        referenceDate: LIVE_STATE?.referenceDate?.toISOString() || timestamp,
        metrics: {
          totalControls: controls.length,
          compliantControls: controls.filter(c => c.status === 'compliant').length,
          atRiskControls: controls.filter(c => c.status === 'at-risk').length,
          criticalControls: controls.filter(c => c.status === 'critical').length,
          averageTrust: (controls.reduce((sum, c) => sum + c.trust, 0) / controls.length).toFixed(3),
          averagePhi: (controls.reduce((sum, c) => sum + c.phi, 0) / controls.length).toFixed(3),
          averagePsi: (controls.reduce((sum, c) => sum + c.psi, 0) / controls.length).toFixed(3),
          averageDelta: (controls.reduce((sum, c) => sum + c.delta, 0) / controls.length).toFixed(3),
          frameworkCoverage: {
            'SOC2': controls.filter(c => c.frameworks.includes('SOC2')).length,
            'ISO27001': controls.filter(c => c.frameworks.includes('ISO27001')).length,
            'NIST': controls.filter(c => c.frameworks.includes('NIST')).length,
            'HIPAA': controls.filter(c => c.frameworks.includes('HIPAA')).length
          },
          totalDataPoints: controls.length + evidence.length + STATE.auditLog.length
        },
        controls: controls.map(c => ({
          id: c.id,
          name: c.name,
          trust: c.trust,
          status: c.status,
          phi: c.phi,
          psi: c.psi,
          delta: c.delta
        }))
      };
      
    case 'compliance-certificate':
      return {
        reportType: 'Compliance Certificate',
        generated: timestamp,
        snapshot: snapshot,
        referenceDate: LIVE_STATE?.referenceDate?.toISOString() || timestamp,
        certification: {
          organization: 'Your Organization',
          frameworks: ['SOC2 Type II', 'ISO27001:2013', 'NIST CSF'],
          assessmentPeriod: 'Q4 2025',
          attestation: 'Based on cryptographic snapshot verification',
          trustScore: (controls.reduce((sum, c) => sum + c.trust, 0) / controls.length).toFixed(3),
          compliantControls: controls.filter(c => c.status === 'compliant').length,
          totalControls: controls.length
        },
        controls: controls.map(c => ({
          id: c.id,
          name: c.name,
          frameworks: c.frameworks,
          status: c.status,
          trust: c.trust,
          evidence: c.evidence
        }))
      };
      
    case 'control-effectiveness':
      return {
        reportType: 'Control Effectiveness Analysis',
        generated: timestamp,
        snapshot: snapshot,
        referenceDate: LIVE_STATE?.referenceDate?.toISOString() || timestamp,
        analysis: controls.map(c => ({
          id: c.id,
          name: c.name,
          frameworks: c.frameworks,
          effectiveness: {
            phi: c.phi,
            psi: c.psi,
            delta: c.delta,
            overall: c.trust
          },
          status: c.status,
          evidenceCount: c.evidence,
          daysOld: c.daysOld || 0,
          trend: c.psi > 0.9 ? 'fresh' : c.psi > 0.8 ? 'stable' : 'aging'
        })),
        summary: {
          highPerformers: controls.filter(c => c.trust >= 0.85).length,
          needsAttention: controls.filter(c => c.trust < 0.70).length,
          averageEffectiveness: (controls.reduce((sum, c) => sum + c.trust, 0) / controls.length).toFixed(3)
        }
      };
      
    case 'evidence-report':
      return {
        reportType: 'Evidence Inventory',
        generated: timestamp,
        snapshot: snapshot,
        referenceDate: LIVE_STATE?.referenceDate?.toISOString() || timestamp,
        evidence: evidence.map(e => ({
          id: e.id,
          control: e.control || e.linkedControls?.[0] || '',
          type: e.type,
          title: e.title,
          uploadedBy: e.uploadedBy,
          uploadedAt: e.uploadedAt,
          hash: e.hash,
          phi: e.phi || 0,
          psi: e.psi || 0,
          daysOld: e.daysOld || 0,
          decayStatus: (e.psi || 0) > 0.9 ? 'fresh' : (e.psi || 0) > 0.7 ? 'aging' : 'stale'
        })),
        summary: {
          totalEvidence: evidence.length,
          freshEvidence: evidence.filter(e => (e.psi || 0) > 0.9).length,
          agingEvidence: evidence.filter(e => (e.psi || 0) > 0.7 && (e.psi || 0) <= 0.9).length,
          staleEvidence: evidence.filter(e => (e.psi || 0) <= 0.7).length
        }
      };
      
    case 'divergence-analysis':
      const highDivergence = controls.filter(c => c.delta > 0.15);
      return {
        reportType: 'Divergence & Risk Report',
        generated: timestamp,
        snapshot: snapshot,
        referenceDate: LIVE_STATE?.referenceDate?.toISOString() || timestamp,
        divergenceAlerts: highDivergence.map(c => ({
          control: c.id,
          name: c.name,
          delta: c.delta,
          severity: c.delta > 0.20 ? 'critical' : 'high',
          frameworks: c.frameworks,
          trust: c.trust
        })),
        riskAssessment: {
          totalAlerts: highDivergence.length,
          criticalAlerts: highDivergence.filter(c => c.delta > 0.20).length,
          avgDivergence: (controls.reduce((sum, c) => sum + c.delta, 0) / controls.length).toFixed(3)
        }
      };
      
    default:
      return {
        reportType: reportId,
        generated: timestamp,
        snapshot: snapshot,
        controls: CONTROLS
      };
  }
}

function showReportViewer(reportHash) {
  const report = STATE.reportCache[reportHash];
  if (!report) return;
  
  const data = report.data;
  const reportType = data.reportType;
  
  // Build interactive report viewer based on type
  let reportContent = '';
  
  if (reportType === 'Executive Summary') {
    reportContent = buildExecutiveSummaryView(data);
  } else if (reportType === 'Compliance Certificate') {
    reportContent = buildComplianceCertView(data);
  } else if (reportType === 'Control Effectiveness Analysis') {
    reportContent = buildControlEffectivenessView(data);
  } else if (reportType === 'Evidence Inventory') {
    reportContent = buildEvidenceInventoryView(data);
  } else if (reportType === 'Divergence & Risk Report') {
    reportContent = buildDivergenceReportView(data);
  } else {
    reportContent = '<p style="padding: 20px;">Report content generated</p>';
  }
  
  const body = `
    <div style="margin-bottom: 20px;">
      <div style="display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--green-light); border-radius: 8px; border-left: 4px solid var(--green);">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2">
          <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
          <polyline points="9,12 11,14 15,10"/>
        </svg>
        <div style="flex: 1;">
          <div style="font-weight: 700; color: var(--green); margin-bottom: 2px;">Cryptographically Verified Report</div>
          <div style="font-size: 12px; color: var(--text-secondary);">Every data point snapshot-backed and immutable</div>
        </div>
      </div>
    </div>

    <!-- Report Metadata -->
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 24px; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
      <div>
        <div style="font-size: 10px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 4px; text-transform: uppercase;">Generated</div>
        <div style="font-size: 12px; font-weight: 600;">${new Date(report.generated).toLocaleString()}</div>
      </div>
      <div>
        <div style="font-size: 10px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 4px; text-transform: uppercase;">Snapshot</div>
        <div style="font-size: 12px; font-weight: 600; font-family: 'IBM Plex Mono', monospace;">Block ${report.snapshot}</div>
      </div>
      <div>
        <div style="font-size: 10px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 4px; text-transform: uppercase;">Data Points</div>
        <div style="font-size: 12px; font-weight: 600;">${data.metrics?.totalDataPoints || data.controls?.length || 'N/A'}</div>
      </div>
      <div>
        <div style="font-size: 10px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 4px; text-transform: uppercase;">Report Hash</div>
        <span class="hash" onclick="copyHash('${report.hash}')" style="font-size: 10px; cursor: pointer;" title="Click to copy">${report.hash.substring(0, 16)}...</span>
      </div>
    </div>

    <!-- Report Content -->
    <div style="max-height: 50vh; overflow-y: auto; padding-right: 8px;">
      ${reportContent}
    </div>
  `;
  
  const footer = `
    <button class="btn btn-secondary" onclick="closeModal()">Close</button>
    <button class="btn btn-secondary" onclick="viewAuditLog('${reportHash}')">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
        <path d="M14 2v6h6"/>
        <path d="M16 13H8"/>
        <path d="M16 17H8"/>
        <path d="M10 9H8"/>
      </svg>
      Audit Trail
    </button>
    <button class="btn btn-primary" onclick="downloadReport('${reportHash}')">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
        <polyline points="7,10 12,15 17,10"/>
        <line x1="12" y1="15" x2="12" y2="3"/>
      </svg>
      Download PDF
    </button>
  `;
  
  openModal(reportType, body, footer);
}

// Drill-down function - logs every interaction
function drillDownControl(controlId, snapshot) {
  // Log the drill-down action
  logAuditEntry('REPORT_DRILLDOWN', {
    controlId: controlId,
    snapshot: snapshot,
    timestamp: new Date().toISOString()
  });

  const control = getControls().find(c => c.id === controlId);
  if (!control) {
    showToast(`Control ${controlId} not found`, 'error');
    return;
  }
  
  const drillDownHash = generateHash({ controlId, snapshot, timestamp: Date.now() });

  // Normalize field names for both API and sample data
  const trust = control.trust || 0;
  const phi = control.phi || 0;
  const psi = control.psi || 0;
  const delta = control.delta || 0;
  const frameworks = control.frameworks || [];
  const evidenceCount = control.evidence_count !== undefined ? control.evidence_count : (control.evidence || 0);

  const body = `
    <div style="padding: 20px; background: var(--brand-light); border-radius: 12px; margin-bottom: 20px;">
      <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
        <div>
          <h2 style="margin: 0 0 8px 0; font-size: 20px; font-weight: 800;">${control.id}</h2>
          <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 600; color: var(--text-secondary);">${control.name}</h3>
        </div>
        <div style="text-align: right;">
          <div style="font-size: 36px; font-weight: 800; font-family: 'IBM Plex Mono', monospace; color: ${trust >= 0.85 ? 'var(--green)' : trust >= 0.70 ? 'var(--amber)' : 'var(--red)'};">${trust.toFixed(2)}</div>
          <div style="font-size: 11px; text-transform: uppercase; color: var(--text-tertiary);">Trust Score</div>
        </div>
      </div>

      <div style="display: flex; gap: 8px; flex-wrap: wrap;">
        ${frameworks.map(f => `
          <span style="padding: 4px 10px; background: var(--brand); color: white; border-radius: 4px; font-size: 11px; font-weight: 600;">${f}</span>
        `).join('')}
      </div>
    </div>

    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px;">
      <div style="padding: 14px; background: #10B98115; border-radius: 8px; border-left: 3px solid #10B981;">
        <div style="font-size: 10px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 4px; text-transform: uppercase;">Φ Zero-Start</div>
        <div style="font-size: 24px; font-weight: 800; color: #10B981; font-family: 'IBM Plex Mono', monospace;">${phi.toFixed(2)}</div>
      </div>
      <div style="padding: 14px; background: #F59E0B15; border-radius: 8px; border-left: 3px solid #F59E0B;">
        <div style="font-size: 10px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 4px; text-transform: uppercase;">Ψ Decay</div>
        <div style="font-size: 24px; font-weight: 800; color: #F59E0B; font-family: 'IBM Plex Mono', monospace;">${psi.toFixed(2)}</div>
      </div>
      <div style="padding: 14px; background: #EF444415; border-radius: 8px; border-left: 3px solid #EF4444;">
        <div style="font-size: 10px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 4px; text-transform: uppercase;">Δ Divergence</div>
        <div style="font-size: 24px; font-weight: 800; color: #EF4444; font-family: 'IBM Plex Mono', monospace;">${delta.toFixed(3)}</div>
      </div>
    </div>

    <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 16px;">
      <div style="font-size: 11px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 8px; text-transform: uppercase;">Drill-Down Verification</div>
      <div style="font-size: 11px; color: var(--text-secondary); line-height: 1.6;">
        <strong>Snapshot Block:</strong> ${snapshot}<br>
        <strong>Evidence Items:</strong> ${evidenceCount}<br>
        <strong>Drill-Down Hash:</strong> <span class="hash" onclick="copyHash('${drillDownHash}')" style="cursor: pointer;" title="Click to copy">${drillDownHash}</span>
      </div>
    </div>

    <div style="background: var(--green-light); padding: 12px; border-radius: 6px; border-left: 3px solid var(--green);">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
      </svg>
      <span style="font-size: 12px; font-weight: 600; color: var(--green);">
        This drill-down interaction has been hashed and logged to the immutable audit trail
      </span>
    </div>
  `;
  
  openModal(`Control Drill-Down: ${control.id}`, body, `
    <button class="btn btn-secondary" onclick="closeModal()">Close</button>
    <button class="btn btn-primary" onclick="closeModal(); STATE.selectedControl = '${controlId}'; showView('control-detail');">
      View Full Control Detail
    </button>
  `);
}

function copyHash(hash) {
  navigator.clipboard.writeText(hash);
  showToast('Hash copied to clipboard', 'success');
  logAuditEntry('HASH_COPIED', { hash: hash });
}

async function viewAuditLog(reportHash) {
  // Show loading state first
  openModal('Immutable Audit Trail', `
    <div style="text-align: center; padding: 40px;">
      <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="var(--brand)" stroke-width="2" style="animation: spin 1s linear infinite; margin-bottom: 16px;">
        <circle cx="12" cy="12" r="10" stroke-dasharray="30 70"/>
      </svg>
      <div style="font-size: 14px; color: var(--text-secondary);">Loading audit trail...</div>
    </div>
  `, '');

  // Fetch real data from API
  let entries = [];
  let verification = { valid: true, verified: 0, total: 0 };
  let isLiveData = false;

  if (apiConnected) {
    try {
      const [entriesData, verifyData] = await Promise.all([
        API.getAuditEntries(50, 0),
        API.verifyAuditChain()
      ]);

      entries = entriesData.entries || [];
      verification = verifyData;
      isLiveData = entriesData.fromAPI;

      // Update cache
      AUDIT_DATA.entries = entries;
      AUDIT_DATA.total = entriesData.total;
      AUDIT_DATA.chainVerification = verification;
    } catch (err) {
      console.error('[viewAuditLog] API error:', err);
      entries = STATE.auditLog.slice(-50).reverse();
      verification = verifyAuditChain();
    }
  } else {
    entries = STATE.auditLog.slice(-50).reverse();
    verification = verifyAuditChain();
  }

  const totalEntries = verification.total || verification.verified || entries.length;
  const integrityPercent = verification.valid ? 100 : 0;

  const body = `
    <div style="padding: 16px; background: ${verification.valid ? 'var(--green-light)' : 'var(--red-light)'}; border-radius: 8px; border-left: 4px solid ${verification.valid ? 'var(--green)' : 'var(--red)'}; margin-bottom: 20px;">
      <div style="display: flex; align-items: center; gap: 12px;">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="${verification.valid ? 'var(--green)' : 'var(--red)'}" stroke-width="2">
          <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
          ${verification.valid ? '<polyline points="9,12 11,14 15,10"/>' : '<line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>'}
        </svg>
        <div>
          <div style="font-weight: 700; color: ${verification.valid ? 'var(--green)' : 'var(--red)'}; font-size: 14px;">
            ${verification.valid ? 'Audit Chain Verified' : 'Chain Integrity Issue'}
            ${isLiveData ? '<span style="font-size: 11px; margin-left: 8px; opacity: 0.7;">(Live Data)</span>' : ''}
          </div>
          <div style="font-size: 12px; color: var(--text-secondary);">
            ${totalEntries} entries · Chain integrity: ${integrityPercent}% · Algorithm: BLAKE3
          </div>
        </div>
      </div>
    </div>

    <div style="font-size: 14px; font-weight: 700; margin-bottom: 12px;">
      Recent Audit Log Entries
      <span style="font-weight: 400; color: var(--text-tertiary); font-size: 12px; margin-left: 8px;">
        (${entries.length} of ${totalEntries})
      </span>
    </div>
    <div style="max-height: 400px; overflow-y: auto;">
      ${entries.length === 0 ? `
        <div style="text-align: center; padding: 40px; color: var(--text-tertiary);">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom: 12px; opacity: 0.5;">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14,2 14,8 20,8"/>
          </svg>
          <div>No audit entries yet</div>
          <div style="font-size: 12px; margin-top: 4px;">Actions will be logged as you use the system</div>
        </div>
      ` : entries.map(entry => {
        // Handle both API and local entry formats
        const action = entry.action || 'Unknown Action';
        const timestamp = entry.timestamp || entry.created_at || new Date().toISOString();
        const actor = entry.actor_id || entry.user || 'System';
        const resourceType = entry.resource_type || '';
        const resourceId = entry.resource_id || '';
        const hash = entry.hash || entry.entry_hash || '';
        const position = entry.chain_position || entry.id || '';
        const severity = entry.severity || 'info';

        const severityColors = {
          info: 'var(--brand)',
          warning: 'var(--amber)',
          critical: 'var(--red)'
        };

        return `
        <div style="padding: 12px; background: var(--bg-secondary); border-radius: 6px; margin-bottom: 8px; border-left: 3px solid ${severityColors[severity] || severityColors.info};">
          <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
            <span style="font-weight: 600; font-size: 12px;">${action}</span>
            <span style="font-size: 10px; color: var(--text-tertiary); font-family: 'IBM Plex Mono', monospace;">${new Date(timestamp).toLocaleString()}</span>
          </div>
          <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">
            Actor: ${actor}${resourceType ? ` · ${resourceType}` : ''}${resourceId ? `: ${resourceId}` : ''}${position ? ` · Block #${position}` : ''}
          </div>
          ${hash ? `
          <div style="font-size: 10px; color: var(--text-tertiary);">
            <span class="hash" onclick="copyHash('${hash}')" style="cursor: pointer;" title="Click to copy">${hash.substring(0, 50)}...</span>
          </div>
          ` : ''}
        </div>
      `;}).join('')}
    </div>
  `;

  openModal('Immutable Audit Trail', body, `
    <button class="btn btn-secondary" onclick="closeModal()">Close</button>
    <button class="btn btn-primary" onclick="exportAuditTrail()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
        <polyline points="7,10 12,15 17,10"/>
        <line x1="12" y1="15" x2="12" y2="3"/>
      </svg>
      Export Full Trail (CSV)
    </button>
  `);
}

// Export audit trail to CSV
async function exportAuditTrail() {
  showToast('Exporting audit trail...', 'info');

  if (apiConnected) {
    try {
      const resp = await fetch(`${CONFIG.apiBase}/v1/audit/export`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          start_date: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString(),
          end_date: new Date().toISOString(),
          format: 'csv'
        })
      });

      if (resp.ok) {
        const blob = await resp.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `audit_trail_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);
        closeModal();
        showToast('Audit trail exported successfully', 'success');
        return;
      }
    } catch (err) {
      console.error('[exportAuditTrail] API error:', err);
    }
  }

  // Fallback: export local data
  const entries = getAuditEntries();
  const csv = 'Timestamp,Action,Actor,Resource,Hash\n' +
    entries.map(e => `"${e.timestamp || e.created_at}","${e.action}","${e.actor_id || e.user}","${e.resource_type || ''}:${e.resource_id || ''}","${e.hash || e.entry_hash || ''}"`).join('\n');

  const blob = new Blob([csv], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `audit_trail_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  window.URL.revokeObjectURL(url);
  closeModal();
  showToast('Audit trail exported (local data)', 'success');
}

function downloadReport(reportHash) {
  const report = STATE.reportCache[reportHash];
  if (!report) {
    showToast('Report not found', 'error');
    return;
  }
  
  const doc = AtomicPDF.create(report.data.reportType);
  const data = report.data;
  
  // Header
  let y = AtomicPDF.addHeader(doc, report.data.reportType, `Snapshot: ${report.snapshot}`);
  
  // Different formatting based on report type
  if (data.reportType === 'Executive Summary') {
    // Metrics
    y = AtomicPDF.addMetricsBox(doc, y, [
      { label: 'Avg Trust', value: data.metrics.averageTrust, color: AtomicPDF.colors.trust, bgColor: [204, 251, 241] },
      { label: 'Avg Φ', value: data.metrics.averagePhi, color: AtomicPDF.colors.phi },
      { label: 'Avg Ψ', value: data.metrics.averagePsi, color: AtomicPDF.colors.psi },
      { label: 'Avg Δ', value: data.metrics.averageDelta, color: AtomicPDF.colors.delta }
    ]);
    
    // Status breakdown
    y = AtomicPDF.addSectionTitle(doc, y, 'Control Status');
    y = AtomicPDF.addMetricsBox(doc, y, [
      { label: 'Compliant', value: data.metrics.compliantControls, color: AtomicPDF.colors.green, bgColor: [220, 252, 231] },
      { label: 'At Risk', value: data.metrics.atRiskControls, color: AtomicPDF.colors.amber, bgColor: [254, 243, 199] },
      { label: 'Critical', value: data.metrics.criticalControls, color: AtomicPDF.colors.red, bgColor: [254, 226, 226] }
    ]);
    
    // Controls table
    y = AtomicPDF.addSectionTitle(doc, y, 'Control Details');
    const headers = ['ID', 'Name', 'Φ', 'Ψ', 'Δ', 'Trust', 'Status'];
    const rows = (data.controls || []).slice(0, 20).map(c => [
      c.id, c.name.substring(0, 25),
      c.phi.toFixed(2), c.psi.toFixed(2), c.delta.toFixed(2), c.trust.toFixed(2),
      c.status
    ]);
    y = AtomicPDF.addTable(doc, y, headers, rows);
    
  } else if (data.reportType === 'Compliance Certificate') {
    // Certificate styling
    y = AtomicPDF.addParagraph(doc, y, 'This certificate attests that the governance controls have been evaluated using the Atomic Trust™ verification framework.', { fontSize: 11 });
    y += 10;
    
    y = AtomicPDF.addMetricsBox(doc, y, [
      { label: 'Trust Score', value: data.trustScore, color: AtomicPDF.colors.trust, bgColor: [204, 251, 241] },
      { label: 'Compliant', value: data.compliantCount, color: AtomicPDF.colors.green, bgColor: [220, 252, 231] },
      { label: 'At Risk', value: data.atRiskCount, color: AtomicPDF.colors.amber, bgColor: [254, 243, 199] },
      { label: 'Coverage', value: data.coverage || '100%', color: AtomicPDF.colors.brand }
    ]);
    
    if (data.frameworks) {
      y = AtomicPDF.addSectionTitle(doc, y, 'Framework Coverage');
      const fwHeaders = ['Framework', 'Status', 'Mapped', 'Trust'];
      const fwRows = data.frameworks.map(f => [f.name, f.status, f.mappedClauses || 'N/A', f.trust?.toFixed(2) || '1.00']);
      y = AtomicPDF.addTable(doc, y, fwHeaders, fwRows);
    }
    
  } else if (data.reportType === 'Evidence Report') {
    y = AtomicPDF.addMetricsBox(doc, y, [
      { label: 'Total Evidence', value: data.totalEvidence || 0, color: AtomicPDF.colors.text },
      { label: 'Validated', value: data.validatedCount || 0, color: AtomicPDF.colors.green, bgColor: [220, 252, 231] },
      { label: 'Avg Φ', value: data.avgPhi || '0.00', color: AtomicPDF.colors.phi },
      { label: 'Avg Freshness', value: data.avgPsi || '0.00', color: AtomicPDF.colors.psi }
    ]);
    
    if (data.evidence) {
      y = AtomicPDF.addSectionTitle(doc, y, 'Evidence Items');
      const evHeaders = ['ID', 'Title', 'Type', 'Φ', 'Ψ', 'Status'];
      const evRows = data.evidence.slice(0, 20).map(e => [
        e.id, (e.title || '').substring(0, 25), e.type || '',
        (e.phi || 0).toFixed(2), (e.psi || 0).toFixed(2), e.status || ''
      ]);
      y = AtomicPDF.addTable(doc, y, evHeaders, evRows);
    }
    
  } else {
    // Generic report
    y = AtomicPDF.addParagraph(doc, y, `Report generated at ${data.timestamp || new Date().toISOString()}`, { fontSize: 10 });
    
    if (data.summary) {
      y = AtomicPDF.addSectionTitle(doc, y, 'Summary');
      y = AtomicPDF.addParagraph(doc, y, JSON.stringify(data.summary, null, 2), { fontSize: 9 });
    }
  }
  
  // Cryptographic proof
  y = AtomicPDF.checkNewPage(doc, y, 50);
  y = AtomicPDF.addProofBox(doc, y, report.hash, report.snapshot, report.generated);
  
  const safeName = report.data.reportType.toLowerCase().replace(/[^a-z0-9]+/g, '-');
  AtomicPDF.download(doc, `atomic-trust-${safeName}-${Date.now()}.pdf`);
  
  closeModal();
  showToast('Report downloaded as PDF with cryptographic proof', 'success');
}
// Build interactive report views
function buildExecutiveSummaryView(data) {
  return `
    <div style="margin-bottom: 24px;">
      <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 700; color: var(--text-primary); padding-bottom: 12px; border-bottom: 2px solid var(--border-light);">Trust Metrics</h3>
      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
        <div style="text-align: center; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
          <div style="font-size: 32px; font-weight: 800; color: var(--green); font-family: 'IBM Plex Mono', monospace;">${data.metrics.averageTrust}</div>
          <div style="font-size: 11px; font-weight: 600; color: var(--text-tertiary); text-transform: uppercase; margin-top: 4px;">Avg Trust</div>
        </div>
        <div style="text-align: center; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
          <div style="font-size: 32px; font-weight: 800; color: #10B981; font-family: 'IBM Plex Mono', monospace;">${data.metrics.averagePhi}</div>
          <div style="font-size: 11px; font-weight: 600; color: var(--text-tertiary); text-transform: uppercase; margin-top: 4px;">Avg Φ</div>
        </div>
        <div style="text-align: center; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
          <div style="font-size: 32px; font-weight: 800; color: #F59E0B; font-family: 'IBM Plex Mono', monospace;">${data.metrics.averagePsi}</div>
          <div style="font-size: 11px; font-weight: 600; color: var(--text-tertiary); text-transform: uppercase; margin-top: 4px;">Avg Ψ</div>
        </div>
        <div style="text-align: center; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
          <div style="font-size: 32px; font-weight: 800; color: #EF4444; font-family: 'IBM Plex Mono', monospace;">${data.metrics.averageDelta}</div>
          <div style="font-size: 11px; font-weight: 600; color: var(--text-tertiary); text-transform: uppercase; margin-top: 4px;">Avg Δ</div>
        </div>
      </div>
    </div>

    <div style="margin-bottom: 24px;">
      <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 700; color: var(--text-primary); padding-bottom: 12px; border-bottom: 2px solid var(--border-light);">Control Status</h3>
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
        <div style="padding: 12px; background: var(--green-light); border-radius: 8px; border-left: 3px solid var(--green);">
          <div style="font-size: 24px; font-weight: 800; color: var(--green);">${data.metrics.compliantControls}</div>
          <div style="font-size: 12px; color: var(--text-secondary);">Compliant</div>
        </div>
        <div style="padding: 12px; background: var(--amber-light); border-radius: 8px; border-left: 3px solid var(--amber);">
          <div style="font-size: 24px; font-weight: 800; color: var(--amber);">${data.metrics.atRiskControls}</div>
          <div style="font-size: 12px; color: var(--text-secondary);">At Risk</div>
        </div>
        <div style="padding: 12px; background: var(--red-light); border-radius: 8px; border-left: 3px solid var(--red);">
          <div style="font-size: 24px; font-weight: 800; color: var(--red);">${data.metrics.criticalControls}</div>
          <div style="font-size: 12px; color: var(--text-secondary);">Critical</div>
        </div>
      </div>
    </div>

    <div style="margin-bottom: 24px;">
      <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 700; color: var(--text-primary); padding-bottom: 12px; border-bottom: 2px solid var(--border-light);">
        Control Drill-Down
        <span style="font-size: 12px; font-weight: 400; color: var(--text-tertiary); margin-left: 8px;">(Click any control for details)</span>
      </h3>
      <div style="display: grid; gap: 8px; max-height: 300px; overflow-y: auto;">
        ${data.controls.slice(0, 10).map(c => `
          <div style="padding: 12px; background: var(--bg-secondary); border-radius: 6px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; transition: all 0.2s;" 
               onclick="drillDownControl('${c.id}', '${data.snapshot}')"
               onmouseover="this.style.background='var(--brand-light)'; this.style.transform='translateX(4px)'"
               onmouseout="this.style.background='var(--bg-secondary)'; this.style.transform='translateX(0)'">
            <div style="flex: 1;">
              <div style="font-weight: 600; font-size: 13px; margin-bottom: 2px;">${c.id} — ${c.name}</div>
              <div style="font-size: 11px; color: var(--text-tertiary);">Φ:${c.phi.toFixed(2)} Ψ:${c.psi.toFixed(2)} Δ:${c.delta.toFixed(2)}</div>
            </div>
            <div style="text-align: right;">
              <div style="font-size: 18px; font-weight: 800; font-family: 'IBM Plex Mono', monospace; color: ${c.trust >= 0.85 ? 'var(--green)' : c.trust >= 0.70 ? 'var(--amber)' : 'var(--red)'};">${c.trust.toFixed(2)}</div>
              <div style="font-size: 10px; color: var(--text-tertiary); text-transform: uppercase;">${c.status}</div>
            </div>
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

function buildComplianceCertView(data) {
  return `
    <div style="text-align: center; padding: 32px; background: linear-gradient(135deg, var(--green)10 0%, var(--green)05 100%); border-radius: 12px; margin-bottom: 24px; border: 2px solid var(--green);">
      <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="1.5" style="margin-bottom: 16px;">
        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
        <polyline points="9,12 11,14 15,10"/>
      </svg>
      <h2 style="margin: 0 0 12px 0; font-size: 24px; font-weight: 800; color: var(--green);">CERTIFIED COMPLIANT</h2>
      <p style="margin: 0 0 20px 0; font-size: 14px; color: var(--text-secondary);">
        ${data.certification.frameworks.join(', ')}
      </p>
      <div style="font-size: 48px; font-weight: 800; color: var(--green); font-family: 'IBM Plex Mono', monospace; margin-bottom: 8px;">${data.certification.trustScore}</div>
      <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">
        ${data.certification.compliantControls} of ${data.certification.totalControls} controls verified
      </div>
      <div style="display: inline-block; padding: 8px 16px; background: var(--green); color: white; border-radius: 6px; font-size: 11px; font-weight: 700; text-transform: uppercase;">
        Assessment Period: ${data.certification.assessmentPeriod}
      </div>
    </div>

    <div style="margin-bottom: 24px;">
      <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 700; padding-bottom: 12px; border-bottom: 2px solid var(--border-light);">Verified Controls (Click for details)</h3>
      <div style="display: grid; gap: 6px;">
        ${data.controls.slice(0, 8).map(c => `
          <div style="padding: 10px 12px; background: ${c.status === 'compliant' ? 'var(--green-light)' : 'var(--amber-light)'}; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: all 0.2s;"
               onclick="drillDownControl('${c.id}', '${data.snapshot}')"
               onmouseover="this.style.transform='translateX(4px)'"
               onmouseout="this.style.transform='translateX(0)'">
            <span style="font-size: 12px; font-weight: 600;">${c.id} — ${c.name}</span>
            <span style="font-size: 11px; padding: 3px 8px; background: ${c.status === 'compliant' ? 'var(--green)' : 'var(--amber)'}; color: white; border-radius: 4px; text-transform: uppercase;">${c.status}</span>
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

function buildControlEffectivenessView(data) {
  return `
    <div style="margin-bottom: 20px;">
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 24px;">
        <div style="padding: 16px; background: var(--green-light); border-radius: 8px; text-align: center;">
          <div style="font-size: 28px; font-weight: 800; color: var(--green);">${data.summary.highPerformers}</div>
          <div style="font-size: 12px; color: var(--text-secondary);">High Performers</div>
        </div>
        <div style="padding: 16px; background: var(--brand-light); border-radius: 8px; text-align: center;">
          <div style="font-size: 28px; font-weight: 800; color: var(--brand);">${data.summary.averageEffectiveness}</div>
          <div style="font-size: 12px; color: var(--text-secondary);">Avg Effectiveness</div>
        </div>
        <div style="padding: 16px; background: var(--red-light); border-radius: 8px; text-align: center;">
          <div style="font-size: 28px; font-weight: 800; color: var(--red);">${data.summary.needsAttention}</div>
          <div style="font-size: 12px; color: var(--text-secondary);">Needs Attention</div>
        </div>
      </div>

      <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 700;">Control Analysis (Click to drill down)</h3>
      <div style="display: grid; gap: 10px; max-height: 400px; overflow-y: auto;">
        ${data.analysis.map(c => `
          <div style="padding: 14px; background: var(--bg-secondary); border-radius: 8px; cursor: pointer; transition: all 0.2s;"
               onclick="drillDownControl('${c.id}', '${data.snapshot}')"
               onmouseover="this.style.background='var(--brand-light)'"
               onmouseout="this.style.background='var(--bg-secondary)'">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
              <div style="font-weight: 600; font-size: 14px;">${c.id} — ${c.name}</div>
              <div style="font-size: 16px; font-weight: 800; font-family: 'IBM Plex Mono', monospace; color: ${c.effectiveness.overall >= 0.85 ? 'var(--green)' : c.effectiveness.overall >= 0.70 ? 'var(--amber)' : 'var(--red)'};">
                ${c.effectiveness.overall.toFixed(2)}
              </div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 8px;">
              <div style="font-size: 11px;">
                <span style="color: #10B981; font-weight: 700;">Φ</span> ${c.effectiveness.phi.toFixed(2)}
              </div>
              <div style="font-size: 11px;">
                <span style="color: #F59E0B; font-weight: 700;">Ψ</span> ${c.effectiveness.psi.toFixed(2)}
              </div>
              <div style="font-size: 11px;">
                <span style="color: #EF4444; font-weight: 700;">Δ</span> ${c.effectiveness.delta.toFixed(2)}
              </div>
            </div>
            <div style="font-size: 11px; color: var(--text-tertiary);">
              Evidence: ${c.evidenceCount} items · Trend: <span style="color: ${c.trend === 'improving' ? 'var(--green)' : 'var(--text-secondary)'}; font-weight: 600;">${c.trend}</span>
            </div>
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

function buildEvidenceInventoryView(data) {
  return `
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 24px;">
      <div style="padding: 12px; background: var(--green-light); border-radius: 8px; text-align: center;">
        <div style="font-size: 24px; font-weight: 800; color: var(--green);">${data.summary.freshEvidence}</div>
        <div style="font-size: 11px; color: var(--text-secondary);">Fresh</div>
      </div>
      <div style="padding: 12px; background: var(--amber-light); border-radius: 8px; text-align: center;">
        <div style="font-size: 24px; font-weight: 800; color: var(--amber);">${data.summary.agingEvidence}</div>
        <div style="font-size: 11px; color: var(--text-secondary);">Aging</div>
      </div>
      <div style="padding: 12px; background: var(--red-light); border-radius: 8px; text-align: center;">
        <div style="font-size: 24px; font-weight: 800; color: var(--red);">${data.summary.staleEvidence}</div>
        <div style="font-size: 11px; color: var(--text-secondary);">Stale</div>
      </div>
      <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
        <div style="font-size: 24px; font-weight: 800; color: var(--brand);">${data.summary.totalEvidence}</div>
        <div style="font-size: 11px; color: var(--text-secondary);">Total</div>
      </div>
    </div>

    <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 700;">Evidence Details</h3>
    <div style="display: grid; gap: 8px; max-height: 350px; overflow-y: auto;">
      ${data.evidence.map(e => `
        <div style="padding: 12px; background: var(--bg-secondary); border-radius: 6px; border-left: 3px solid ${e.decayStatus === 'fresh' ? 'var(--green)' : e.decayStatus === 'aging' ? 'var(--amber)' : 'var(--red)'};">
          <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
            <div style="font-weight: 600; font-size: 13px;">${e.id} — ${e.title}</div>
            <div style="font-size: 11px; padding: 2px 8px; background: ${e.decayStatus === 'fresh' ? 'var(--green-light)' : e.decayStatus === 'aging' ? 'var(--amber-light)' : 'var(--red-light)'}; color: ${e.decayStatus === 'fresh' ? 'var(--green)' : e.decayStatus === 'aging' ? 'var(--amber)' : 'var(--red)'}; border-radius: 4px; text-transform: uppercase; font-weight: 700;">${e.decayStatus}</div>
          </div>
          <div style="font-size: 11px; color: var(--text-tertiary); margin-bottom: 4px;">
            Control: ${e.control} · Type: ${e.type} · Age: ${e.ageInDays} days · Φ: ${e.phi.toFixed(2)}
          </div>
          <div style="font-size: 10px; color: var(--text-tertiary);">
            <span class="hash" onclick="copyHash('${e.hash}')" style="cursor: pointer;" title="Click to copy">${e.hash}</span>
          </div>
        </div>
      `).join('')}
    </div>
  `;
}

function buildDivergenceReportView(data) {
  return `
    <div style="padding: 20px; background: var(--red-light); border-radius: 12px; border: 2px solid var(--red); margin-bottom: 24px;">
      <div style="display: flex; align-items: center; gap: 12px;">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--red)" stroke-width="2">
          <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
          <line x1="12" y1="9" x2="12" y2="13"/>
          <line x1="12" y1="17" x2="12.01" y2="17"/>
        </svg>
        <div>
          <h3 style="margin: 0 0 4px 0; font-size: 18px; font-weight: 800; color: var(--red);">${data.riskAssessment.totalAlerts} Divergence Alerts</h3>
          <p style="margin: 0; font-size: 13px; color: var(--text-secondary);">
            ${data.riskAssessment.criticalAlerts} critical · Average Δ: ${data.riskAssessment.avgDivergence}
          </p>
        </div>
      </div>
    </div>

    <h3 style="margin: 0 0 12px 0; font-size: 16px; font-weight: 700;">High Divergence Controls (Click for details)</h3>
    <div style="display: grid; gap: 10px;">
      ${data.divergenceAlerts.map(c => `
        <div style="padding: 14px; background: ${c.severity === 'critical' ? 'var(--red-light)' : 'var(--amber-light)'}; border-radius: 8px; border-left: 4px solid ${c.severity === 'critical' ? 'var(--red)' : 'var(--amber)'}; cursor: pointer; transition: all 0.2s;"
             onclick="drillDownControl('${c.control}', '${data.snapshot}')"
             onmouseover="this.style.transform='translateX(4px)'"
             onmouseout="this.style.transform='translateX(0)'">
          <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
            <div style="font-weight: 700; font-size: 14px;">${c.control} — ${c.name}</div>
            <div style="font-size: 11px; padding: 3px 10px; background: ${c.severity === 'critical' ? 'var(--red)' : 'var(--amber)'}; color: white; border-radius: 4px; text-transform: uppercase; font-weight: 700;">${c.severity}</div>
          </div>
          <div style="display: flex; gap: 16px; font-size: 12px; color: var(--text-secondary);">
            <span><strong style="color: #EF4444;">Δ:</strong> ${c.delta.toFixed(3)}</span>
            <span><strong>Trust:</strong> ${c.trust.toFixed(2)}</span>
            <span><strong>Frameworks:</strong> ${c.frameworks.join(', ')}</span>
          </div>
        </div>
      `).join('')}
    </div>
  `;
}

// ---- ATTESTATIONS VIEW - CRYPTOGRAPHIC SIGNING ----

function renderAttestations() {
  // Sample attestations data
  const pendingAttestations = [
    {
      id: 'ATT-2025-Q4-001',
      control: 'UCP-001',
      controlName: 'Access Control Policy',
      frameworks: ['SOC2', 'ISO27001'],
      requiredSigners: ['CISO', 'VP Engineering'],
      currentSigners: ['VP Engineering'],
      deadline: '2025-12-05',
      daysLeft: 6
    },
    {
      id: 'ATT-2025-Q4-002',
      control: 'UCP-015',
      controlName: 'Access Review Process',
      frameworks: ['SOC2', 'NIST'],
      requiredSigners: ['CISO', 'CFO'],
      currentSigners: [],
      deadline: '2025-12-08',
      daysLeft: 9
    }
  ];

  const recentAttestations = [
    {
      id: 'ATT-2025-Q3-045',
      control: 'UCP-003',
      controlName: 'Incident Response Plan',
      frameworks: ['SOC2', 'HIPAA', 'NIST'],
      signers: [
        { name: 'Marcus Rivera', role: 'CISO', signedAt: '2025-11-28 14:32', hash: 'blake3:a7f3e9c2...' },
        { name: 'Jennifer Kim', role: 'CFO', signedAt: '2025-11-28 16:15', hash: 'blake3:b2c4d1a8...' }
      ],
      attestedAt: '2025-11-28',
      snapshotBlock: 846,
      merkleRoot: 'blake3:7d4f2a1b9c8e5f3a...',
      status: 'fully-attested'
    },
    {
      id: 'ATT-2025-Q3-044',
      control: 'UCP-010',
      controlName: 'Third-Party Risk Assessment',
      frameworks: ['SOC2', 'ISO27001'],
      signers: [
        { name: 'Marcus Rivera', role: 'CISO', signedAt: '2025-11-26 11:20', hash: 'blake3:c9e8f7a3...' },
        { name: 'David Chen', role: 'VP Engineering', signedAt: '2025-11-26 13:45', hash: 'blake3:d1b7c4e2...' }
      ],
      attestedAt: '2025-11-26',
      snapshotBlock: 845,
      merkleRoot: 'blake3:5a8c3e7f4b9d2a1c...',
      status: 'fully-attested'
    }
  ];

  return `
    <div class="view active">
      <div class="page-header">
        <h1 class="page-title">Attestations</h1>
        <p class="page-subtitle">Multi-party cryptographic attestations with immutable audit trails</p>
      </div>

      <!-- Pending Attestations -->
      <div class="card mb-32">
        <div class="card-header">
          <div style="display: flex; align-items: center; gap: 12px;">
            <span class="card-title">Pending Attestations</span>
            <span class="status-badge critical">${pendingAttestations.length} Awaiting Signature</span>
          </div>
          <button class="btn btn-primary" onclick="showAttestNowModal()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
              <polyline points="22,4 12,14.01 9,11.01"/>
            </svg>
            Attest Now
          </button>
        </div>
        <div class="card-body" style="padding: 0;">
          ${pendingAttestations.map(att => `
            <div style="padding: 20px; border-bottom: 1px solid var(--border-light); transition: all 0.2s ease; cursor: pointer;" onclick="showAttestationDetail('${att.id}')" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='white'">
              <div style="display: flex; align-items: start; gap: 20px; margin-bottom: 14px;">
                <div style="flex: 1;">
                  <div style="font-weight: 700; font-size: 15px; margin-bottom: 6px;">${att.id}</div>
                  <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">${att.control} — ${att.controlName}</div>
                  <div style="display: flex; gap: 6px; margin-bottom: 10px;">
                    ${att.frameworks.map(f => `<span class="framework-chip">${f}</span>`).join('')}
                  </div>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 11px; color: var(--text-tertiary); margin-bottom: 4px;">Deadline</div>
                  <div style="font-weight: 700; font-size: 14px; color: ${att.daysLeft <= 3 ? 'var(--red)' : 'var(--amber)'};">${att.deadline}</div>
                  <div style="font-size: 11px; color: var(--text-tertiary);">${att.daysLeft} days left</div>
                </div>
              </div>
              <div style="display: flex; align-items: center; gap: 16px; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                <div style="flex: 1;">
                  <div style="font-size: 11px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 6px;">REQUIRED SIGNERS</div>
                  <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    ${att.requiredSigners.map(signer => {
                      const signed = att.currentSigners.includes(signer);
                      return `
                        <span style="padding: 4px 10px; background: ${signed ? 'var(--green-light)' : 'white'}; border: 1px solid ${signed ? 'var(--green)' : 'var(--border-light)'}; border-radius: 6px; font-size: 12px; font-weight: 600; color: ${signed ? 'var(--green)' : 'var(--text-secondary)'}; display: flex; align-items: center; gap: 4px;">
                          ${signed ? '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20,6 9,17 4,12"/></svg>' : '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/></svg>'}
                          ${signer}
                        </span>
                      `;
                    }).join('')}
                  </div>
                </div>
                <button class="btn btn-primary" onclick="event.stopPropagation(); signAttestation('${att.id}')">
                  Sign Now
                </button>
              </div>
            </div>
          `).join('')}
        </div>
      </div>

      <!-- Recent Attestations -->
      <div class="card">
        <div class="card-header">
          <span class="card-title">Recent Attestations</span>
          <span style="font-size: 12px; color: var(--text-tertiary); font-family: 'IBM Plex Mono', monospace;">Cryptographically Verified</span>
        </div>
        <div class="card-body" style="padding: 0;">
          ${recentAttestations.map((att, idx) => `
            <div style="padding: 20px; ${idx < recentAttestations.length - 1 ? 'border-bottom: 1px solid var(--border-light);' : ''} transition: all 0.2s ease; cursor: pointer;" onclick="showAttestationDetail('${att.id}')" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='white'">
              <div style="display: flex; align-items: start; gap: 20px; margin-bottom: 14px;">
                <div style="flex: 1;">
                  <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 6px;">
                    <div style="font-weight: 700; font-size: 15px;">${att.id}</div>
                    <span style="padding: 3px 8px; background: var(--green-light); color: var(--green); border-radius: 6px; font-size: 10px; font-weight: 700; text-transform: uppercase;">
                      ✓ Fully Attested
                    </span>
                  </div>
                  <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">${att.control} — ${att.controlName}</div>
                  <div style="display: flex; gap: 6px; margin-bottom: 10px;">
                    ${att.frameworks.map(f => `<span class="framework-chip">${f}</span>`).join('')}
                  </div>
                </div>
                <div style="text-align: right;">
                  <div style="font-size: 11px; color: var(--text-tertiary); margin-bottom: 4px;">Attested</div>
                  <div style="font-weight: 700; font-size: 14px;">${att.attestedAt}</div>
                  <div style="font-size: 11px; color: var(--brand); font-family: 'IBM Plex Mono', monospace;">Block ${att.snapshotBlock}</div>
                </div>
              </div>
              
              <!-- Signers -->
              <div style="padding: 14px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 12px;">
                <div style="font-size: 11px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 10px;">DIGITAL SIGNATURES</div>
                ${att.signers.map(signer => `
                  <div style="display: flex; align-items: center; gap: 12px; padding: 10px 0; ${att.signers.indexOf(signer) < att.signers.length - 1 ? 'border-bottom: 1px solid var(--border-light);' : ''}">
                    <div style="width: 32px; height: 32px; border-radius: 50%; background: var(--green); display: flex; align-items: center; justify-content: center; color: white; font-weight: 800; font-size: 12px; flex-shrink: 0;">
                      ${signer.name.split(' ').map(n => n[0]).join('')}
                    </div>
                    <div style="flex: 1;">
                      <div style="font-weight: 600; font-size: 13px;">${signer.name}</div>
                      <div style="font-size: 11px; color: var(--text-tertiary);">${signer.role} · Signed ${signer.signedAt}</div>
                    </div>
                    <div style="font-family: 'IBM Plex Mono', monospace; font-size: 11px; color: var(--text-secondary); cursor: pointer;" onclick="event.stopPropagation(); copyHash('${signer.hash}')" title="${signer.hash}">
                      ${signer.hash.substring(0, 16)}...
                    </div>
                  </div>
                `).join('')}
              </div>

              <!-- Merkle Root -->
              <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--brand-light); border-radius: 8px; border-left: 3px solid var(--brand);">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--brand)" stroke-width="2">
                  <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                </svg>
                <div style="flex: 1;">
                  <div style="font-size: 10px; font-weight: 700; color: var(--brand); margin-bottom: 2px; text-transform: uppercase; letter-spacing: 0.05em;">Merkle Root</div>
                  <div style="font-family: 'IBM Plex Mono', monospace; font-size: 12px; color: var(--text-primary); cursor: pointer;" onclick="event.stopPropagation(); copyHash('${att.merkleRoot}')" title="${att.merkleRoot}">
                    ${att.merkleRoot.substring(0, 32)}...
                  </div>
                </div>
                <button class="btn btn-secondary" onclick="event.stopPropagation(); verifyAttestation('${att.id}')">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                    <polyline points="22,4 12,14.01 9,11.01"/>
                  </svg>
                  Verify
                </button>
                <button class="btn btn-primary" onclick="event.stopPropagation(); generateAttestationPDF('${att.id}')">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                  </svg>
                  Download PDF
                </button>
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    </div>
  `;
}

// ---- FRAMEWORK INGESTION VIEW ----

function renderIngestion() {
  return `
    <div class="view active">
      <div class="page-header">
        <h1 class="page-title">Framework Ingestion</h1>
        <p class="page-subtitle">AI-powered multi-format framework ingestion with LLM consensus extraction</p>
      </div>

      <!-- Quick Actions -->
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 32px;">
        <div class="card" style="cursor: pointer; transition: all 0.2s ease;" onclick="loadNISTBaseline()" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='var(--shadow-lg)';" onmouseout="this.style.transform='none'; this.style.boxShadow='var(--shadow-sm)';">
          <div class="card-body" style="text-align: center; padding: 32px;">
            <div style="width: 64px; height: 64px; background: var(--brand-light); border-radius: 16px; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--brand)" stroke-width="2">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
              </svg>
            </div>
            <div style="font-weight: 700; font-size: 16px; margin-bottom: 8px;">Load NIST 800-53 Moderate</div>
            <div style="font-size: 13px; color: var(--text-secondary);">Pre-seed with ~300 official controls</div>
          </div>
        </div>

        <div class="card" style="cursor: pointer; transition: all 0.2s ease;" onclick="showIngestionUpload()" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='var(--shadow-lg)';" onmouseout="this.style.transform='none'; this.style.boxShadow='var(--shadow-sm)';">
          <div class="card-body" style="text-align: center; padding: 32px;">
            <div style="width: 64px; height: 64px; background: var(--green-light); border-radius: 16px; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17,8 12,3 7,8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
              </svg>
            </div>
            <div style="font-weight: 700; font-size: 16px; margin-bottom: 8px;">Upload Framework</div>
            <div style="font-size: 13px; color: var(--text-secondary);">PDF, JSON, CSV, XML, Text, URL</div>
          </div>
        </div>

        <div class="card" style="cursor: pointer; transition: all 0.2s ease;" onclick="showIngestionFeedback()" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='var(--shadow-lg)';" onmouseout="this.style.transform='none'; this.style.boxShadow='var(--shadow-sm)';">
          <div class="card-body" style="text-align: center; padding: 32px;">
            <div style="width: 64px; height: 64px; background: var(--amber-light); border-radius: 16px; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px;">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--amber)" stroke-width="2">
                <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
              </svg>
            </div>
            <div style="font-weight: 700; font-size: 16px; margin-bottom: 8px;">Review & Feedback</div>
            <div style="font-size: 13px; color: var(--text-secondary);">Improve extraction accuracy</div>
          </div>
        </div>
      </div>

      <!-- Ingested Frameworks -->
      <div class="card mb-32">
        <div class="card-header">
          <div style="display: flex; align-items: center; gap: 12px;">
            <span class="card-title">Ingested Frameworks</span>
            <span class="status-badge compliant" id="ingested-count">Loading...</span>
          </div>
          <button class="btn btn-secondary" onclick="refreshIngestedFrameworks()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="23 4 23 10 17 10"/>
              <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
            </svg>
            Refresh
          </button>
        </div>
        <div class="card-body" id="ingested-frameworks-list" style="padding: 0;">
          <div style="padding: 40px; text-align: center; color: var(--text-tertiary);">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin: 0 auto 16px; opacity: 0.5;">
              <path d="M12 2L2 7l10 5 10-5-10-5z"/>
              <path d="M2 17l10 5 10-5"/>
              <path d="M2 12l10 5 10-5"/>
            </svg>
            <div style="font-size: 14px; margin-bottom: 8px;">Loading frameworks...</div>
          </div>
        </div>
      </div>

      <!-- How It Works -->
      <div class="card">
        <div class="card-header">
          <span class="card-title">How Framework Ingestion Works</span>
        </div>
        <div class="card-body">
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px;">
            <div style="text-align: center;">
              <div style="width: 48px; height: 48px; background: var(--brand-light); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 12px;">
                <span style="font-weight: 800; font-size: 18px; color: var(--brand);">1</span>
              </div>
              <div style="font-weight: 700; font-size: 14px; margin-bottom: 6px;">Upload</div>
              <div style="font-size: 12px; color: var(--text-secondary);">Upload any compliance framework document (PDF, JSON, CSV, XML, or text)</div>
            </div>
            <div style="text-align: center;">
              <div style="width: 48px; height: 48px; background: var(--brand-light); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 12px;">
                <span style="font-weight: 800; font-size: 18px; color: var(--brand);">2</span>
              </div>
              <div style="font-weight: 700; font-size: 14px; margin-bottom: 6px;">LLM Consensus</div>
              <div style="font-size: 12px; color: var(--text-secondary);">Multiple AI models extract controls with weighted voting consensus</div>
            </div>
            <div style="text-align: center;">
              <div style="width: 48px; height: 48px; background: var(--brand-light); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 12px;">
                <span style="font-weight: 800; font-size: 18px; color: var(--brand);">3</span>
              </div>
              <div style="font-weight: 700; font-size: 14px; margin-bottom: 6px;">Semantic Mapping</div>
              <div style="font-size: 12px; color: var(--text-secondary);">Controls are mapped to existing frameworks using similarity analysis</div>
            </div>
            <div style="text-align: center;">
              <div style="width: 48px; height: 48px; background: var(--brand-light); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 12px;">
                <span style="font-weight: 800; font-size: 18px; color: var(--brand);">4</span>
              </div>
              <div style="font-weight: 700; font-size: 14px; margin-bottom: 6px;">Self-Improve</div>
              <div style="font-size: 12px; color: var(--text-secondary);">Feedback loop improves extraction accuracy over time</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
}

// Load ingested frameworks on view show
async function refreshIngestedFrameworks() {
  const container = document.getElementById('ingested-frameworks-list');
  const countBadge = document.getElementById('ingested-count');

  // First, try to display local frameworks
  const localFrameworks = getAllFrameworks();
  
  try {
    const response = await fetch('/v1/ai/ingestion/frameworks');
    if (!response.ok) throw new Error('API not available');
    const data = await response.json();

    if (data.frameworks && data.frameworks.length > 0) {
      countBadge.textContent = data.frameworks.length + ' Loaded';
      container.innerHTML = data.frameworks.map((fw, idx) => `
        <div style="padding: 20px; ${idx < data.frameworks.length - 1 ? 'border-bottom: 1px solid var(--border-light);' : ''} transition: all 0.2s ease; cursor: pointer;" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='white'" onclick="showFrameworkControls('${fw.id}')">
          <div style="display: flex; align-items: center; gap: 16px;">
            <div style="width: 48px; height: 48px; background: var(--brand-light); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--brand)" stroke-width="2">
                <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                <path d="M2 17l10 5 10-5"/>
                <path d="M2 12l10 5 10-5"/>
              </svg>
            </div>
            <div style="flex: 1;">
              <div style="font-weight: 700; font-size: 15px; margin-bottom: 4px;">${fw.name}</div>
              <div style="font-size: 13px; color: var(--text-secondary);">${fw.description || 'No description'}</div>
            </div>
            <div style="text-align: right;">
              <div style="font-weight: 700; font-size: 14px; color: var(--brand);">${fw.status}</div>
              <div style="font-size: 11px; color: var(--text-tertiary);">Source: ${fw.source_type}</div>
            </div>
            <div style="text-align: right; margin-left: 16px;">
              <div style="font-size: 11px; color: var(--text-tertiary); margin-bottom: 4px;">ΦΨΔT</div>
              <div style="font-family: 'IBM Plex Mono', monospace; font-size: 11px;">
                <span style="color: var(--phi);">Φ${parseFloat(fw.extraction_phi || 0).toFixed(2)}</span>
                <span style="color: var(--trust);">T${parseFloat(fw.extraction_trust || 0).toFixed(2)}</span>
              </div>
            </div>
          </div>
        </div>
      `).join('');
      return;
    }
  } catch (err) {
    console.log('[refreshIngestedFrameworks] API not available, using local frameworks');
  }
  
  // Fallback to local frameworks
  if (localFrameworks && localFrameworks.length > 0) {
    countBadge.textContent = localFrameworks.length + ' Local';
    container.innerHTML = localFrameworks.map((fw, idx) => `
      <div style="padding: 20px; ${idx < localFrameworks.length - 1 ? 'border-bottom: 1px solid var(--border-light);' : ''} transition: all 0.2s ease; cursor: pointer;" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='white'" onclick="showFrameworkDetail('${fw.id}')">
        <div style="display: flex; align-items: center; gap: 16px;">
          <div style="width: 48px; height: 48px; background: var(--brand-light); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--brand)" stroke-width="2">
              <path d="M12 2L2 7l10 5 10-5-10-5z"/>
              <path d="M2 17l10 5 10-5"/>
              <path d="M2 12l10 5 10-5"/>
            </svg>
          </div>
          <div style="flex: 1;">
            <div style="font-weight: 700; font-size: 15px; margin-bottom: 4px;">${fw.name}</div>
            <div style="font-size: 13px; color: var(--text-secondary);">${fw.version || 'Demo'} • ${fw.totalClauses || 0} clauses</div>
          </div>
          <div style="text-align: right;">
            <div style="font-weight: 700; font-size: 14px; color: ${fw.status === 'active' ? 'var(--green)' : 'var(--amber)'}">${(fw.status || 'active').toUpperCase()}</div>
            <div style="font-size: 11px; color: var(--text-tertiary);">${((fw.coverage || 0) * 100).toFixed(0)}% mapped</div>
          </div>
          <div style="text-align: right; margin-left: 16px;">
            <div style="font-size: 11px; color: var(--text-tertiary); margin-bottom: 4px;">Freshness</div>
            <div style="font-family: 'IBM Plex Mono', monospace; font-size: 12px;">
              <span style="color: var(--psi);">Ψ${(fw.psi || 1.0).toFixed(2)}</span>
            </div>
          </div>
        </div>
      </div>
    `).join('');
  } else {
    countBadge.textContent = '0 Loaded';
    container.innerHTML = `
      <div style="padding: 40px; text-align: center; color: var(--text-tertiary);">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin: 0 auto 16px; opacity: 0.5;">
          <path d="M12 2L2 7l10 5 10-5-10-5z"/>
          <path d="M2 17l10 5 10-5"/>
          <path d="M2 12l10 5 10-5"/>
        </svg>
        <div style="font-size: 14px; margin-bottom: 8px;">No frameworks ingested yet</div>
        <div style="font-size: 12px; color: var(--text-tertiary);">Click "Load NIST 800-53 Moderate" to get started</div>
      </div>
    `;
  }
}

async function loadNISTBaseline() {
  showNotification('Loading NIST 800-53 Moderate baseline...', 'info');

  try {
    const response = await fetch('/v1/ai/ingestion/nist-800-53/load', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    const data = await response.json();

    if (data.success) {
      showNotification(`Loaded ${data.loaded} NIST 800-53 Moderate controls!`, 'success');
      refreshIngestedFrameworks();
    } else {
      showNotification('Failed: ' + (data.message || data.error), 'error');
    }
  } catch (err) {
    showNotification('Error loading NIST baseline: ' + err.message, 'error');
  }
}

function showIngestionUpload() {
  openModal('Upload Framework Document', `
    <div style="padding: 20px;">
      <div style="margin-bottom: 24px;">
        <label style="display: block; font-weight: 600; font-size: 13px; margin-bottom: 8px;">Framework Name</label>
        <input type="text" id="ingestion-name" placeholder="e.g., ISO 27001:2022" style="width: 100%; padding: 12px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px;">
      </div>
      <div style="margin-bottom: 24px;">
        <label style="display: block; font-weight: 600; font-size: 13px; margin-bottom: 8px;">Description</label>
        <textarea id="ingestion-desc" placeholder="Brief description of the framework" style="width: 100%; padding: 12px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px; min-height: 80px; resize: vertical;"></textarea>
      </div>
      <div style="margin-bottom: 24px;">
        <label style="display: block; font-weight: 600; font-size: 13px; margin-bottom: 8px;">Source Type</label>
        <select id="ingestion-type" style="width: 100%; padding: 12px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px;">
          <option value="text">Plain Text</option>
          <option value="json">JSON</option>
          <option value="csv">CSV</option>
          <option value="xml">XML</option>
          <option value="url">URL</option>
        </select>
      </div>
      <div style="margin-bottom: 24px;">
        <label style="display: block; font-weight: 600; font-size: 13px; margin-bottom: 8px;">Content</label>
        <textarea id="ingestion-content" placeholder="Paste framework content here or enter URL..." style="width: 100%; padding: 12px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px; font-family: 'IBM Plex Mono', monospace; min-height: 200px; resize: vertical;"></textarea>
      </div>
      <div style="display: flex; gap: 12px; justify-content: flex-end;">
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="submitIngestion()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="17,8 12,3 7,8"/>
            <line x1="12" y1="3" x2="12" y2="15"/>
          </svg>
          Ingest Framework
        </button>
      </div>
    </div>
  `);
}

async function submitIngestion() {
  const name = document.getElementById('ingestion-name').value;
  const description = document.getElementById('ingestion-desc').value;
  const sourceType = document.getElementById('ingestion-type').value;
  const content = document.getElementById('ingestion-content').value;

  if (!name || !content) {
    showNotification('Please provide a name and content', 'error');
    return;
  }

  closeModal();
  showNotification('Ingesting framework... This may take a minute.', 'info');

  try {
    const response = await fetch('/v1/ai/ingestion/frameworks', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, description, sourceType, content })
    });
    const data = await response.json();

    if (data.success) {
      showNotification(`Framework ingested! ${data.framework.controlCount} controls extracted.`, 'success');
      refreshIngestedFrameworks();
    } else {
      showNotification('Ingestion failed: ' + (data.message || data.error), 'error');
    }
  } catch (err) {
    showNotification('Error: ' + err.message, 'error');
  }
}

async function showFrameworkControls(frameworkId) {
  try {
    const response = await fetch(`/v1/ai/ingestion/frameworks/${frameworkId}/controls`);
    const data = await response.json();

    openModal({
      title: `Controls: ${frameworkId}`,
      content: `
        <div style="max-height: 400px; overflow-y: auto;">
          <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 16px;">
            <strong>${data.controls?.length || 0}</strong> controls extracted
          </div>
          ${(data.controls || []).slice(0, 50).map(c => `
            <div style="padding: 12px; border-bottom: 1px solid var(--border-light);">
              <div style="font-weight: 700; font-size: 13px;">${c.control_id}</div>
              <div style="font-size: 12px; color: var(--text-secondary);">${c.name}</div>
              <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 4px;">${(c.description || '').substring(0, 100)}...</div>
            </div>
          `).join('')}
          ${data.controls?.length > 50 ? '<div style="padding: 12px; text-align: center; color: var(--text-tertiary);">... and ' + (data.controls.length - 50) + ' more</div>' : ''}
        </div>
      `
    });
  } catch (err) {
    showNotification('Error loading controls: ' + err.message, 'error');
  }
}

function showIngestionFeedback() {
  showNotification('Feedback interface coming soon!', 'info');
}

// Auto-refresh on view show
if (STATE.currentView === 'ingestion') {
  setTimeout(refreshIngestedFrameworks, 100);
}

// ---- EVIDENCE MANAGEMENT VIEW ----


// ---- NSX-T INTEGRATION VIEW ----

function renderNSXT() {
  return `
    <div class="view active">
      <div class="page-header">
        <h1 class="page-title">NSX-T Integration</h1>
        <p class="page-subtitle">Automated evidence collection from VMware NSX-T Data Center</p>
      </div>

      <div class="actions-bar" style="margin-bottom: 24px;">
        <button class="action-btn primary" onclick="showNSXTConnect()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
            <path d="M12 5v14M5 12h14"/>
          </svg>
          Connect NSX-T
        </button>
        <button class="action-btn" onclick="refreshNSXTIntegrations()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
            <path d="M23 4v6h-6M1 20v-6h6"/>
            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
          </svg>
          Refresh
        </button>
      </div>

      <div id="nsxtIntegrationsList">
        <div class="card" style="animation: slideUp 0.3s ease;">
          <div class="card-header">
            <span class="card-title">Connected Integrations</span>
          </div>
          <div class="card-body" id="nsxtIntegrationsBody">
            <div style="text-align: center; padding: 40px; color: var(--text-tertiary);">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48" style="margin-bottom: 16px; opacity: 0.5;">
                <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
              </svg>
              <p>No NSX-T integrations configured</p>
              <p style="font-size: 12px; margin-top: 8px;">Click "Connect NSX-T" to add your first integration</p>
            </div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top: 24px; animation: slideUp 0.4s ease;">
        <div class="card-header">
          <span class="card-title">Control Mappings</span>
        </div>
        <div class="card-body">
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
            <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid var(--phi);">
              <div style="font-weight: 600; margin-bottom: 8px;">Security Policies</div>
              <div style="font-size: 12px; color: var(--text-secondary);">
                <div>SOC2-CC6.1</div>
                <div>ISO27001-A.9.1.1</div>
                <div>NIST-AC-3</div>
              </div>
            </div>
            <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid var(--psi);">
              <div style="font-weight: 600; margin-bottom: 8px;">Segments</div>
              <div style="font-size: 12px; color: var(--text-secondary);">
                <div>SOC2-CC6.6</div>
                <div>ISO27001-A.13.1.3</div>
                <div>NIST-SC-7</div>
              </div>
            </div>
            <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid var(--delta);">
              <div style="font-weight: 600; margin-bottom: 8px;">Security Groups</div>
              <div style="font-size: 12px; color: var(--text-secondary);">
                <div>SOC2-CC6.2</div>
                <div>ISO27001-A.9.4.1</div>
                <div>NIST-AC-6</div>
              </div>
            </div>
            <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px; border-left: 4px solid var(--trust);">
              <div style="font-weight: 600; margin-bottom: 8px;">Firewall Rules</div>
              <div style="font-size: 12px; color: var(--text-secondary);">
                <div>SOC2-CC6.7</div>
                <div>ISO27001-A.13.1.1</div>
                <div>NIST-SC-7(5)</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top: 24px; animation: slideUp 0.5s ease;">
        <div class="card-header">
          <span class="card-title">How NSX-T Integration Works</span>
        </div>
        <div class="card-body">
          <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px;">
            <div style="text-align: center; padding: 20px;">
              <div style="width: 48px; height: 48px; background: var(--brand-light); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 12px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="var(--brand)" stroke-width="2" width="24" height="24">
                  <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                </svg>
              </div>
              <div style="font-weight: 600; margin-bottom: 4px;">1. Connect</div>
              <div style="font-size: 12px; color: var(--text-secondary);">Enter NSX-T Manager URL and credentials</div>
            </div>
            <div style="text-align: center; padding: 20px;">
              <div style="width: 48px; height: 48px; background: var(--green-light); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 12px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2" width="24" height="24">
                  <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                </svg>
              </div>
              <div style="font-weight: 600; margin-bottom: 4px;">2. Sync</div>
              <div style="font-size: 12px; color: var(--text-secondary);">Fetch security policies, rules, segments</div>
            </div>
            <div style="text-align: center; padding: 20px;">
              <div style="width: 48px; height: 48px; background: var(--amber-light); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 12px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="var(--amber)" stroke-width="2" width="24" height="24">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                  <path d="M14 2v6h6"/>
                </svg>
              </div>
              <div style="font-weight: 600; margin-bottom: 4px;">3. Evidence</div>
              <div style="font-size: 12px; color: var(--text-secondary);">Auto-generate compliance evidence</div>
            </div>
            <div style="text-align: center; padding: 20px;">
              <div style="width: 48px; height: 48px; background: rgba(15, 76, 117, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 12px;">
                <svg viewBox="0 0 24 24" fill="none" stroke="var(--steel-blue)" stroke-width="2" width="24" height="24">
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                  <polyline points="22,4 12,14.01 9,11.01"/>
                </svg>
              </div>
              <div style="font-weight: 600; margin-bottom: 4px;">4. Map</div>
              <div style="font-size: 12px; color: var(--text-secondary);">Link to SOC2, ISO27001, NIST controls</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
}

async function refreshNSXTIntegrations() {
  const body = document.getElementById('nsxtIntegrationsBody');
  if (!body) return;

  body.innerHTML = '<div style="text-align: center; padding: 20px;"><div style="animation: pulse 1s infinite;">Loading integrations...</div></div>';

  try {
    const resp = await fetch('/v1/evidence/integrations/nsx-t');
    if (!resp.ok) throw new Error('Failed to fetch integrations');

    const data = await resp.json();

    if (!data.integrations || data.integrations.length === 0) {
      body.innerHTML = `
        <div style="text-align: center; padding: 40px; color: var(--text-tertiary);">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48" style="margin-bottom: 16px; opacity: 0.5;">
            <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
          </svg>
          <p>No NSX-T integrations configured</p>
          <p style="font-size: 12px; margin-top: 8px;">Click "Connect NSX-T" to add your first integration</p>
        </div>
      `;
      return;
    }

    body.innerHTML = data.integrations.map(int => `
      <div style="padding: 16px; border: 1px solid var(--border-light); border-radius: 8px; margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between;">
        <div style="display: flex; align-items: center; gap: 16px;">
          <div style="width: 48px; height: 48px; background: ${int.status === 'active' ? 'var(--green-light)' : 'var(--amber-light)'}; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
            <svg viewBox="0 0 24 24" fill="none" stroke="${int.status === 'active' ? 'var(--green)' : 'var(--amber)'}" stroke-width="2" width="24" height="24">
              <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
            </svg>
          </div>
          <div>
            <div style="font-weight: 600;">${escapeHtml(int.name)}</div>
            <div style="font-size: 12px; color: var(--text-secondary);">${escapeHtml(int.nsx_url)}</div>
            <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 4px;">
              Last sync: ${int.last_sync ? new Date(int.last_sync).toLocaleString() : 'Never'}
              | Evidence: ${int.evidence_count || 0} items
            </div>
          </div>
        </div>
        <div style="display: flex; gap: 8px;">
          <button class="action-btn" onclick="syncNSXTIntegration('${int.id}')" style="padding: 8px 12px; font-size: 12px;">
            Sync Now
          </button>
          <button class="action-btn" onclick="deleteNSXTIntegration('${int.id}')" style="padding: 8px 12px; font-size: 12px; color: var(--red);">
            Remove
          </button>
        </div>
      </div>
    `).join('');

  } catch (err) {
    body.innerHTML = `
      <div style="text-align: center; padding: 40px; color: var(--red);">
        <p>Failed to load integrations</p>
        <p style="font-size: 12px; margin-top: 8px;">${escapeHtml(err.message)}</p>
      </div>
    `;
  }
}

function showNSXTConnect() {
  openModal('Connect NSX-T Manager', `
    <div style="padding: 20px;">
      <div style="margin-bottom: 20px;">
        <label style="display: block; font-weight: 500; margin-bottom: 8px;">Integration Name</label>
        <input type="text" id="nsxtName" placeholder="Production NSX-T" style="width: 100%; padding: 10px 12px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px;">
      </div>
      <div style="margin-bottom: 20px;">
        <label style="display: block; font-weight: 500; margin-bottom: 8px;">NSX-T Manager URL</label>
        <input type="text" id="nsxtUrl" placeholder="https://nsx-manager.company.com" style="width: 100%; padding: 10px 12px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px;">
      </div>
      <div style="margin-bottom: 20px;">
        <label style="display: block; font-weight: 500; margin-bottom: 8px;">Username</label>
        <input type="text" id="nsxtUsername" placeholder="admin@vsphere.local" style="width: 100%; padding: 10px 12px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px;">
      </div>
      <div style="margin-bottom: 20px;">
        <label style="display: block; font-weight: 500; margin-bottom: 8px;">Password</label>
        <input type="password" id="nsxtPassword" placeholder="Enter password" style="width: 100%; padding: 10px 12px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px;">
      </div>
      <div style="display: flex; gap: 12px; margin-top: 24px;">
        <button class="action-btn" onclick="testNSXTConnection()" style="flex: 1;">Test Connection</button>
        <button class="action-btn primary" onclick="saveNSXTConnection()" style="flex: 1;">Connect & Sync</button>
      </div>
      <div id="nsxtConnectStatus" style="margin-top: 16px; padding: 12px; border-radius: 8px; display: none;"></div>
    </div>
  `);
}

async function testNSXTConnection() {
  const status = document.getElementById('nsxtConnectStatus');
  status.style.display = 'block';
  status.style.background = 'var(--bg-secondary)';
  status.innerHTML = 'Testing connection...';

  const url = document.getElementById('nsxtUrl').value;
  const username = document.getElementById('nsxtUsername').value;
  const password = document.getElementById('nsxtPassword').value;

  try {
    const resp = await fetch('/v1/evidence/integrations/nsx-t/test', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ nsx_url: url, username, password })
    });

    const data = await resp.json();

    if (data.success) {
      status.style.background = 'var(--green-light)';
      status.style.color = 'var(--green)';
      status.innerHTML = 'Connected successfully! NSX-T version: ' + (data.version || 'Unknown');
    } else {
      status.style.background = 'var(--red-light)';
      status.style.color = 'var(--red)';
      status.innerHTML = 'Connection failed: ' + (data.message || data.error || 'Unknown error');
    }
  } catch (err) {
    status.style.background = 'var(--red-light)';
    status.style.color = 'var(--red)';
    status.innerHTML = 'Error: ' + err.message;
  }
}

async function saveNSXTConnection() {
  const status = document.getElementById('nsxtConnectStatus');
  status.style.display = 'block';
  status.style.background = 'var(--bg-secondary)';
  status.innerHTML = 'Connecting and syncing...';

  const name = document.getElementById('nsxtName').value;
  const url = document.getElementById('nsxtUrl').value;
  const username = document.getElementById('nsxtUsername').value;
  const password = document.getElementById('nsxtPassword').value;

  if (!name || !url || !username || !password) {
    status.style.background = 'var(--amber-light)';
    status.style.color = 'var(--amber)';
    status.innerHTML = 'Please fill in all fields';
    return;
  }

  try {
    const resp = await fetch('/v1/evidence/integrations/nsx-t', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, nsx_url: url, username, password })
    });

    const data = await resp.json();

    if (data.success) {
      status.style.background = 'var(--green-light)';
      status.style.color = 'var(--green)';
      status.innerHTML = 'Integration created! Starting initial sync...';

      // Trigger initial sync
      await fetch('/v1/evidence/integrations/nsx-t/' + data.integration.id + '/sync', { method: 'POST' });

      closeModal();
      refreshNSXTIntegrations();
    } else {
      status.style.background = 'var(--red-light)';
      status.style.color = 'var(--red)';
      status.innerHTML = 'Failed: ' + (data.error || 'Unknown error');
    }
  } catch (err) {
    status.style.background = 'var(--red-light)';
    status.style.color = 'var(--red)';
    status.innerHTML = 'Error: ' + err.message;
  }
}

async function syncNSXTIntegration(integrationId) {
  try {
    const resp = await fetch('/v1/evidence/integrations/nsx-t/' + integrationId + '/sync', { method: 'POST' });
    const data = await resp.json();

    if (data.success) {
      alert('Sync complete! Created ' + data.result.evidence_created + ' evidence items.');
      refreshNSXTIntegrations();
    } else {
      alert('Sync failed: ' + (data.error || 'Unknown error'));
    }
  } catch (err) {
    alert('Error: ' + err.message);
  }
}

async function deleteNSXTIntegration(integrationId) {
  if (!confirm('Are you sure you want to remove this NSX-T integration?')) return;

  try {
    const resp = await fetch('/v1/evidence/integrations/nsx-t/' + integrationId, { method: 'DELETE' });
    const data = await resp.json();

    if (data.success) {
      refreshNSXTIntegrations();
    } else {
      alert('Failed to delete: ' + (data.error || 'Unknown error'));
    }
  } catch (err) {
    alert('Error: ' + err.message);
  }
}



function renderEvidence() {
  // Use live data if available, fallback to EVIDENCE_LIBRARY
  const evidence = getEvidence();
  const controls = getControls();
  const isLiveData = (API_DATA.evidence && API_DATA.evidence.length > 0) || (window.LIVE_STATE && LIVE_STATE.initialized);

  // Calculate stats using new EVIDENCE_LIBRARY structure
  const totalEvidence = evidence.length;
  const validated = evidence.filter(e => e.status === 'validated').length;
  const needsReview = evidence.filter(e => e.status === 'needs-review').length;
  const avgPhi = totalEvidence > 0 ? (evidence.reduce((sum, e) => sum + (e.phi || 0), 0) / totalEvidence).toFixed(2) : '0.00';

  // Get file type icon
  function getFileIcon(fileType) {
    const icons = {
      'pdf': '📄',
      'json': '📋',
      'csv': '📊',
      'xlsx': '📈',
      'png': '🖼️',
      'jpg': '🖼️',
      'docx': '📝'
    };
    return icons[fileType] || '📎';
  }

  // Get type badge color
  function getTypeBadge(type) {
    const badges = {
      'configuration': '<span style="padding: 4px 8px; background: #e3f2fd; color: #1565c0; border-radius: 4px; font-size: 10px; font-weight: 600; text-transform: uppercase;">CONFIG</span>',
      'logs': '<span style="padding: 4px 8px; background: #fce4ec; color: #c2185b; border-radius: 4px; font-size: 10px; font-weight: 600; text-transform: uppercase;">LOGS</span>',
      'policy': '<span style="padding: 4px 8px; background: #f3e5f5; color: #7b1fa2; border-radius: 4px; font-size: 10px; font-weight: 600; text-transform: uppercase;">POLICY</span>',
      'assessment': '<span style="padding: 4px 8px; background: #fff3e0; color: #e65100; border-radius: 4px; font-size: 10px; font-weight: 600; text-transform: uppercase;">ASSESS</span>',
      'records': '<span style="padding: 4px 8px; background: #e8f5e9; color: #2e7d32; border-radius: 4px; font-size: 10px; font-weight: 600; text-transform: uppercase;">RECORDS</span>'
    };
    return badges[type] || '<span style="padding: 4px 8px; background: #eceff1; color: #546e7a; border-radius: 4px; font-size: 10px; font-weight: 600; text-transform: uppercase;">' + type.toUpperCase() + '</span>';
  }

  // Format file size (handles string format like "24KB")
  function formatSize(size) {
    if (typeof size === 'string') return size;
    if (size < 1024) return `${size} KB`;
    return `${(size / 1024).toFixed(1)} MB`;
  }

  // Format date
  function formatDate(isoDate) {
    const date = new Date(isoDate);
    const now = new Date();
    const diffMs = now - date;
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

    if (diffDays === 0) return 'Today';
    if (diffDays === 1) return 'Yesterday';
    if (diffDays < 7) return `${diffDays} days ago`;
    if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
    return `${Math.floor(diffDays / 30)} months ago`;
  }

  // Get status badge (validated / needs-review)
  function getStatusBadge(status) {
    if (status === 'validated') {
      return '<span style="padding: 4px 10px; background: var(--green-light); color: var(--green); border-radius: 6px; font-size: 11px; font-weight: 700;">✓ VALIDATED</span>';
    }
    return '<span style="padding: 4px 10px; background: var(--amber-light); color: var(--amber); border-radius: 6px; font-size: 11px; font-weight: 700;">⚠ NEEDS REVIEW</span>';
  }

  // Get Φ score color (green ≥0.9, amber ≥0.8, red <0.8)
  function getPhiColor(phi) {
    if (phi >= 0.9) return 'var(--green)';
    if (phi >= 0.8) return 'var(--amber)';
    return 'var(--red)';
  }

  // Legacy quality badge for backward compatibility
  function getQualityBadge(quality, phi, psi) {
    const badges = {
      high: '<span style="padding: 4px 10px; background: var(--green-light); color: var(--green); border-radius: 6px; font-size: 11px; font-weight: 700;">✓ HIGH QUALITY</span>',
      medium: '<span style="padding: 4px 10px; background: var(--amber-light); color: var(--amber); border-radius: 6px; font-size: 11px; font-weight: 700;">⚠ MEDIUM</span>',
      low: '<span style="padding: 4px 10px; background: var(--red-light); color: var(--red); border-radius: 6px; font-size: 11px; font-weight: 700;">✗ NEEDS REVIEW</span>'
    };
    return badges[quality] || badges.medium;
  }
  
  return `
    <div class="view active">
      ${getDemoBanner()}
      
      <div class="page-header">
        <h1 class="page-title">Evidence Management</h1>
        <p class="page-subtitle">Cryptographically verified evidence linked to controls</p>
        <button class="btn btn-primary" onclick="simulateEvidenceUpload()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="17 8 12 3 7 8"/>
            <line x1="12" y1="3" x2="12" y2="15"/>
          </svg>
          Upload Evidence
        </button>
      </div>
      
      <!-- Stats Row -->
      <div class="grid-4 mb-32">
        <div class="stat-card">
          <button class="delta-context-btn" onclick="openDeltaContextByTopic('evidence_total', event)" title="Ask about evidence">Δ</button>
          <div class="stat-label">Total Evidence</div>
          <div class="stat-value">${totalEvidence}</div>
          <div class="stat-change neutral">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
              <polyline points="14,2 14,8 20,8"/>
            </svg>
            Across ${controls.length} controls${isLiveData ? ' (Live)' : ''}
          </div>
        </div>

        <div class="stat-card">
          <button class="delta-context-btn" onclick="openDeltaContextByTopic('evidence_quality', event)" title="Ask about quality">Δ</button>
          <div class="stat-label">Validated</div>
          <div class="stat-value" style="color: var(--green);">${validated}</div>
          <div class="stat-change positive">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12"/>
            </svg>
            ${((validated/totalEvidence)*100).toFixed(0)}% of total
          </div>
        </div>

        <div class="stat-card">
          <button class="delta-context-btn" onclick="openDeltaContextByTopic('evidence_review', event)" title="Ask about items needing review">Δ</button>
          <div class="stat-label">Needs Review</div>
          <div class="stat-value" style="color: var(--amber);">${needsReview}</div>
          <div class="stat-change ${needsReview > 0 ? 'negative' : 'neutral'}">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
            </svg>
            ${needsReview > 0 ? 'Requires attention' : 'All verified'}
          </div>
        </div>

        <div class="stat-card">
          <button class="delta-context-btn" onclick="openDeltaContextByTopic('evidence_phi', event)" title="Ask about Φ scores">Δ</button>
          <div class="stat-label">Avg Φ Score</div>
          <div class="stat-value" style="color: var(--trust-teal);">${avgPhi}</div>
          <div class="stat-change neutral">
            <div class="operator-glyph phi" style="width: 14px; height: 14px; font-size: 9px; margin-right: 4px;">Φ</div>
            Zero-Start truth
          </div>
        </div>
      </div>
      
      <!-- Search & Filter Bar -->
      <div class="card mb-32">
        <div class="card-body" style="padding: 16px;">
          <div style="display: flex; gap: 12px; align-items: center;">
            <div style="flex: 1; position: relative;">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--text-tertiary)" stroke-width="2" style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%);">
                <circle cx="11" cy="11" r="8"/>
                <path d="m21 21-4.35-4.35"/>
              </svg>
              <input type="text" placeholder="Search evidence by filename, control, or uploader..." style="width: 100%; padding: 12px 12px 12px 44px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px; font-family: 'Inter', sans-serif;" oninput="filterEvidence(this.value)">
            </div>
            <select style="padding: 12px 16px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px; background: white; cursor: pointer;" onchange="filterEvidenceByQuality(this.value)">
              <option value="all">All Quality</option>
              <option value="high">High Quality</option>
              <option value="medium">Medium Quality</option>
              <option value="low">Needs Review</option>
            </select>
            <select style="padding: 12px 16px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px; background: white; cursor: pointer;" onchange="filterEvidenceByType(this.value)">
              <option value="all">All Types</option>
              <option value="document">Documents</option>
              <option value="screenshot">Screenshots</option>
              <option value="system_export">System Exports</option>
              <option value="policy">Policies</option>
              <option value="test_results">Test Results</option>
            </select>
          </div>
        </div>
      </div>
      
      <!-- Evidence List -->
      <div class="card">
        <div class="card-header">
          <span class="card-title">Evidence Files</span>
          <div style="display: flex; align-items: center; gap: 12px;">
            <span style="font-size: 12px; color: var(--text-tertiary); font-family: 'IBM Plex Mono', monospace;">BLAKE3 Verified</span>
            <button class="btn btn-sm btn-secondary" onclick="exportEvidenceData()">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
              Export
            </button>
          </div>
        </div>
        <div class="card-body" style="padding: 0;" id="evidenceList">
          ${evidence.map((ev, idx) => {
            // Handle both EVIDENCE_LIBRARY and legacy API field names
            const title = ev.title || ev.filename || 'Unknown file';
            const fileType = ev.fileType || ev.mimeType || 'unknown';
            const fileSize = ev.fileSize || ev.sizeKB || 'N/A';
            const uploadedAt = ev.uploadedAt || ev.uploaded_at || new Date().toISOString();
            const uploadedBy = ev.uploadedBy || ev.uploaded_by || 'Unknown';
            const source = ev.source || 'Manual Upload';
            const phi = ev.phi || 0;
            const psi = ev.psi || 0;
            const status = ev.status || (ev.quality === 'high' ? 'validated' : 'needs-review');
            const hash = ev.hash || '';
            const linkedControls = ev.linkedControls || [ev.controlId] || [];
            const linkedFrameworks = ev.linkedFrameworks || [];
            const validatedBy = ev.validatedBy || [];
            const summary = ev.summary || ev.metadata?.description || 'No description';
            const tags = ev.tags || [];
            const type = ev.type || 'document';

            // Color coding for Φ/Ψ scores
            const phiColor = phi >= 0.9 ? 'var(--green)' : (phi >= 0.8 ? 'var(--amber)' : 'var(--red)');
            const psiColor = psi >= 0.9 ? 'var(--green)' : (psi >= 0.8 ? 'var(--amber)' : 'var(--red)');

            return `
              <div style="padding: 20px; ${idx < evidence.length - 1 ? 'border-bottom: 1px solid var(--border-light);' : ''} transition: all 0.2s ease; cursor: pointer; position: relative;" onclick="showEvidenceDetail('${ev.id}')" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='white'" class="evidence-item">
                <button class="delta-context-btn" onclick="event.stopPropagation(); openDeltaContextById('evidence', '${ev.id}', event)" title="Ask Δtomic AI about this evidence">Δ</button>
                <div style="display: flex; align-items: start; gap: 20px;">
                  <!-- File Icon -->
                  <div style="font-size: 32px; line-height: 1;">${getFileIcon(fileType)}</div>

                  <!-- Main Info -->
                  <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px; flex-wrap: wrap;">
                      <div style="font-weight: 700; font-size: 15px;">${title}</div>
                      ${getTypeBadge(type)}
                      ${getStatusBadge(status)}
                    </div>

                    <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 12px; font-size: 13px; color: var(--text-secondary); flex-wrap: wrap;">
                      <span style="display: flex; align-items: center; gap: 6px;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                          <path d="M3 9h18"/>
                        </svg>
                        ${source}
                      </span>
                      <span style="display: flex; align-items: center; gap: 6px;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <circle cx="12" cy="12" r="10"/>
                          <polyline points="12,6 12,12 16,14"/>
                        </svg>
                        ${formatDate(uploadedAt)}
                      </span>
                      <span>${formatSize(fileSize)}</span>
                      <span style="display: flex; align-items: center; gap: 4px;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                        </svg>
                        ${linkedControls.slice(0, 3).join(', ')}${linkedControls.length > 3 ? '...' : ''}
                      </span>
                    </div>

                    <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">
                      ${summary}
                    </div>

                    <!-- Tags & Frameworks -->
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;">
                      ${linkedFrameworks.slice(0, 5).map(f => `<span style="padding: 2px 8px; background: var(--bg-tertiary); color: var(--text-secondary); border-radius: 4px; font-size: 10px; font-weight: 600;">${f}</span>`).join('')}
                      ${validatedBy.length > 0 ? `<span style="padding: 2px 8px; background: var(--green-light); color: var(--green); border-radius: 4px; font-size: 10px; font-weight: 600;">AI: ${validatedBy.join(', ')}</span>` : ''}
                    </div>

                    <!-- Operator Scores -->
                    <div style="display: flex; align-items: center; gap: 20px; padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
                      <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                          <div class="operator-glyph phi" style="width: 20px; height: 20px; font-size: 11px;">Φ</div>
                          <span style="font-size: 12px; color: var(--text-secondary); font-weight: 600;">Zero-Start</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                          <div style="flex: 1; height: 6px; background: var(--border-light); border-radius: 3px; overflow: hidden;">
                            <div style="width: ${(phi * 100).toFixed(0)}%; height: 100%; background: ${phiColor}; border-radius: 3px;"></div>
                          </div>
                          <span style="font-size: 13px; font-weight: 700; font-family: 'IBM Plex Mono', monospace; color: ${phiColor};">${phi.toFixed(2)}</span>
                        </div>
                      </div>

                      <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                          <div class="operator-glyph psi" style="width: 20px; height: 20px; font-size: 11px;">Ψ</div>
                          <span style="font-size: 12px; color: var(--text-secondary); font-weight: 600;">Credential-Decay</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                          <div style="flex: 1; height: 6px; background: var(--border-light); border-radius: 3px; overflow: hidden;">
                            <div style="width: ${(psi * 100).toFixed(0)}%; height: 100%; background: ${psiColor}; border-radius: 3px;"></div>
                          </div>
                          <span style="font-size: 13px; font-weight: 700; font-family: 'IBM Plex Mono', monospace; color: ${psiColor};">${psi.toFixed(2)}</span>
                        </div>
                      </div>

                      <div style="border-left: 1px solid var(--border-light); padding-left: 20px;">
                        <div style="font-size: 11px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 4px;">BLAKE3 HASH</div>
                        <div style="font-size: 11px; font-family: 'IBM Plex Mono', monospace; color: var(--text-secondary);">${hash ? hash.substring(0, 24) + '...' : 'N/A'}</div>
                      </div>
                    </div>
                  </div>

                  <!-- Actions -->
                  <div style="display: flex; flex-direction: column; gap: 8px;">
                    <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); validateEvidence('${ev.id}')" style="white-space: nowrap;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                        <path d="M9 12l2 2 4-4"/>
                        <circle cx="12" cy="12" r="10"/>
                      </svg>
                      Validate with AI
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); viewEvidence('${ev.id}')" style="white-space: nowrap;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                        <circle cx="12" cy="12" r="3"/>
                      </svg>
                      View
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); downloadEvidence('${ev.id}')" style="white-space: nowrap;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-15"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                      </svg>
                      Download
                    </button>
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
    </div>
  `;
}

// ---- CLAUSE REPOSITORY VIEW ----

function renderClauseRepository() {
  // Calculate stats
  const totalClauses = getClauses().length;
  const uniqueFrameworks = [...new Set(getClauses().map(c => c.framework))].length;
  const uniqueCategories = [...new Set(getClauses().map(c => c.category))].length;
  const totalEquivalences = getClauses().reduce((sum, c) => sum + c.equivalents.length, 0);
  const avgPsi = getClauses().reduce((sum, c) => sum + c.psi, 0) / totalClauses;
  
  // Get decay color
  function getDecayColor(psi) {
    if (psi >= 0.9) return 'var(--green)';
    if (psi >= 0.8) return 'var(--trust-teal)';
    if (psi >= 0.7) return 'var(--amber)';
    return 'var(--red)';
  }
  
  // Get freshness badge
  function getFreshnessBadge(daysOld, psi) {
    if (daysOld <= 7) return '<span style="padding: 4px 10px; background: var(--green-light); color: var(--green); border-radius: 6px; font-size: 11px; font-weight: 700;">🟢 FRESH</span>';
    if (daysOld <= 30) return '<span style="padding: 4px 10px; background: var(--trust-teal-light); color: var(--trust-teal); border-radius: 6px; font-size: 11px; font-weight: 700;">🔵 GOOD</span>';
    if (daysOld <= 60) return '<span style="padding: 4px 10px; background: var(--amber-light); color: var(--amber); border-radius: 6px; font-size: 11px; font-weight: 700;">🟡 AGING</span>';
    return '<span style="padding: 4px 10px; background: var(--red-light); color: var(--red); border-radius: 6px; font-size: 11px; font-weight: 700;">🔴 STALE</span>';
  }
  
  return `
    <div class="view active">
      ${getDemoBanner()}
      
      <div class="page-header">
        <h1 class="page-title">Clause Repository <span style="font-size: 14px; color: var(--text-tertiary); font-weight: 400; margin-left: 12px;">Universal Framework Library</span></h1>
        <p class="page-subtitle">Semantic clause index powering atomic cross-framework propagation</p>
        <button class="btn btn-primary" onclick="importFrameworkClauses()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="17 8 12 3 7 8"/>
            <line x1="12" y1="3" x2="12" y2="15"/>
          </svg>
          Import Clauses
        </button>
      </div>
      
      <!-- Stats Row -->
      <div class="grid-4 mb-32">
        <div class="stat-card">
          <div class="stat-label">Total Clauses</div>
          <div class="stat-value">${totalClauses}</div>
          <div class="stat-change neutral">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
              <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
            </svg>
            Across ${uniqueFrameworks} frameworks
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-label">Semantic Concepts</div>
          <div class="stat-value">${uniqueCategories}</div>
          <div class="stat-change positive">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <circle cx="12" cy="12" r="6"/>
              <circle cx="12" cy="12" r="2"/>
            </svg>
            Categories indexed
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-label">Equivalence Links</div>
          <div class="stat-value">${totalEquivalences}</div>
          <div class="stat-change positive">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 3a2.83 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>
            </svg>
            Cross-framework
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-label">Avg Ψ Freshness</div>
          <div class="stat-value" style="color: ${getDecayColor(avgPsi)};">${avgPsi.toFixed(2)}</div>
          <div class="stat-change ${avgPsi >= 0.9 ? 'positive' : avgPsi >= 0.8 ? 'neutral' : 'negative'}">
            <div class="operator-glyph psi" style="width: 14px; height: 14px; font-size: 9px; margin-right: 4px;">Ψ</div>
            ${avgPsi >= 0.9 ? 'Fresh' : avgPsi >= 0.8 ? 'Moderate' : 'Needs review'}
          </div>
        </div>
      </div>
      
      <!-- Search & Filter Bar -->
      <div class="card mb-24">
        <div class="card-body">
          <div style="display: flex; gap: 12px; align-items: center;">
            <div style="flex: 1; position: relative;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--text-tertiary)" stroke-width="2" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%);">
                <circle cx="11" cy="11" r="8"/>
                <path d="m21 21-4.35-4.35"/>
              </svg>
              <input type="text" id="clauseSearch" placeholder="Search clauses by ID, title, requirement, or semantic concept..." style="width: 100%; padding: 12px 12px 12px 40px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px; font-family: 'Inter', sans-serif;" oninput="filterClauses(this.value)">
            </div>
            <select id="frameworkFilter" style="padding: 12px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px; font-family: 'Inter', sans-serif; background: white;" onchange="filterClausesByFramework(this.value)">
              <option value="all">All Frameworks</option>
              <option value="SOC2">SOC2</option>
              <option value="ISO27001">ISO27001</option>
              <option value="NIST">NIST</option>
              <option value="HIPAA">HIPAA</option>
            </select>
            <select id="categoryFilter" style="padding: 12px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px; font-family: 'Inter', sans-serif; background: white;" onchange="filterClausesByCategory(this.value)">
              <option value="all">All Categories</option>
              <option value="Access Control">Access Control</option>
              <option value="Encryption">Encryption</option>
              <option value="Incident Response">Incident Response</option>
              <option value="Business Continuity">Business Continuity</option>
              <option value="Vendor Management">Vendor Management</option>
            </select>
          </div>
        </div>
      </div>
      
      <!-- Clause List -->
      <div class="card">
        <div class="card-header">
          <span class="card-title">Framework Clauses (${totalClauses})</span>
          <div style="display: flex; align-items: center; gap: 12px;">
            <span style="font-size: 12px; color: var(--text-tertiary); font-family: 'IBM Plex Mono', monospace;">Semantic Index with Ψ Decay</span>
            <button class="btn btn-sm btn-secondary" onclick="exportClausesData()">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
              Export
            </button>
          </div>
        </div>
        <div class="card-body" id="clauseList" style="padding: 0;">
          ${getClauses().map((clause, idx) => `
            <div class="clause-item" data-framework="${clause.framework}" data-category="${clause.category}" style="padding: 24px; ${idx < getClauses().length - 1 ? 'border-bottom: 1px solid var(--border-light);' : ''} transition: all 0.2s ease; cursor: pointer;" onclick="showClauseDetail('${clause.id}')" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='white'">
              <div style="display: flex; align-items: start; gap: 20px;">
                <!-- Main Content -->
                <div style="flex: 1;">
                  <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                    <div style="font-weight: 700; font-size: 16px; font-family: 'IBM Plex Mono', monospace;">${clause.id}</div>
                    ${getFreshnessBadge(clause.daysOld, clause.psi)}
                    <span style="padding: 4px 10px; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-weight: 700; color: var(--text-secondary);">
                      ${clause.category}
                    </span>
                  </div>
                  
                  <div style="font-size: 15px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">
                    ${clause.title}
                  </div>
                  
                  <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px; line-height: 1.6;">
                    ${clause.requirement}
                  </div>
                  
                  <div style="display: flex; gap: 16px; margin-bottom: 12px; font-size: 12px; color: var(--text-tertiary);">
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                      </svg>
                      ${clause.frameworkFull}
                    </span>
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                      </svg>
                      Maps to ${clause.mappedControl}
                    </span>
                    <span style="display: flex; align-items: center; gap: 6px;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 3a2.83 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>
                      </svg>
                      ${clause.equivalents.length} equivalents
                    </span>
                  </div>
                  
                  <!-- Operator Scores -->
                  <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 12px;">
                    <div style="padding: 10px; background: var(--bg-secondary); border-radius: 8px;">
                      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <div class="operator-glyph phi" style="width: 18px; height: 18px; font-size: 10px;">Φ</div>
                        <span style="font-size: 11px; font-weight: 700; color: var(--text-tertiary);">ZERO-START</span>
                      </div>
                      <div style="font-size: 18px; font-weight: 700; font-family: 'IBM Plex Mono', monospace;">${clause.phi.toFixed(2)}</div>
                    </div>
                    <div style="padding: 10px; background: var(--bg-secondary); border-radius: 8px; border-left: 3px solid ${getDecayColor(clause.psi)};">
                      <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                        <div class="operator-glyph psi" style="width: 18px; height: 18px; font-size: 10px;">Ψ</div>
                        <span style="font-size: 11px; font-weight: 700; color: var(--text-tertiary);">CREDENTIAL-DECAY</span>
                      </div>
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="font-size: 18px; font-weight: 700; font-family: 'IBM Plex Mono', monospace; color: ${getDecayColor(clause.psi)};">${clause.psi.toFixed(2)}</div>
                        <div style="font-size: 11px; color: var(--text-secondary);">(${clause.daysOld}d old)</div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Semantic Equivalents Preview -->
                  ${clause.semanticMatches.length > 0 ? `
                    <div style="padding: 12px; background: var(--brand-light); border-radius: 8px;">
                      <div style="font-size: 11px; font-weight: 700; color: var(--brand); margin-bottom: 6px;">🔍 SEMANTIC EQUIVALENTS</div>
                      <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        ${clause.semanticMatches.slice(0, 3).map(match => `
                          <span style="padding: 4px 8px; background: white; border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-family: 'IBM Plex Mono', monospace;">
                            ${match.clauseId} <span style="color: var(--brand);">(${(match.similarity * 100).toFixed(0)}%)</span>
                          </span>
                        `).join('')}
                        ${clause.semanticMatches.length > 3 ? `
                          <span style="padding: 4px 8px; background: white; border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; color: var(--text-secondary);">
                            +${clause.semanticMatches.length - 3} more
                          </span>
                        ` : ''}
                      </div>
                    </div>
                  ` : ''}
                  
                  <!-- Usage Stats -->
                  <div style="display: flex; gap: 12px; margin-top: 12px; font-size: 11px; color: var(--text-secondary);">
                    <span>📋 Used in ${clause.usageCount.rfps} RFPs</span>
                    <span>✓ ${clause.usageCount.attestations} attestations</span>
                    <span>🛡️ ${clause.usageCount.controls} control</span>
                  </div>
                </div>
                
                <!-- Actions -->
                <div style="display: flex; flex-direction: column; gap: 8px;">
                  <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); findSemanticMatches('${clause.id}')" style="white-space: nowrap;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                      <circle cx="11" cy="11" r="8"/>
                      <path d="m21 21-4.35-4.35"/>
                    </svg>
                    Find Similar
                  </button>
                  <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); viewEquivalenceGraph('${clause.id}')" style="white-space: nowrap;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                      <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                      <path d="M2 17l10 5 10-5"/>
                    </svg>
                    View Graph
                  </button>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    </div>
  `;
}

// ---- RFP ANALYZER VIEW ----

function renderRFP() {
  // Calculate stats
  const totalRFPs = RFPS.length;
  const inProgress = RFPS.filter(r => r.status === 'in_progress').length;
  const avgCoverage = (RFPS.reduce((sum, r) => sum + r.coverage, 0) / totalRFPs);
  const totalGaps = RFPS.reduce((sum, r) => sum + r.gapCount, 0);
  
  // Get status badge
  function getStatusBadge(status) {
    const badges = {
      completed: '<span style="padding: 4px 10px; background: var(--green-light); color: var(--green); border-radius: 6px; font-size: 11px; font-weight: 700;">✓ COMPLETED</span>',
      in_progress: '<span style="padding: 4px 10px; background: var(--brand-light); color: var(--brand); border-radius: 6px; font-size: 11px; font-weight: 700;">⏳ IN PROGRESS</span>',
      pending: '<span style="padding: 4px 10px; background: var(--amber-light); color: var(--amber); border-radius: 6px; font-size: 11px; font-weight: 700;">⏸ PENDING</span>'
    };
    return badges[status] || badges.pending;
  }
  
  // Get type icon
  function getTypeIcon(type) {
    const icons = {
      govcloud: '🏛️',
      finance: '🏦',
      healthcare: '🏥',
      certification: '📜'
    };
    return icons[type] || '📋';
  }
  
  // Get priority color
  function getPriorityColor(priority) {
    return priority === 'high' ? 'var(--red)' : priority === 'medium' ? 'var(--amber)' : 'var(--text-tertiary)';
  }
  
  // Format date
  function formatDueDate(isoDate) {
    const date = new Date(isoDate);
    const now = new Date();
    const diffMs = date - now;
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    
    if (diffDays < 0) return `<span style="color: var(--red); font-weight: 700;">OVERDUE</span>`;
    if (diffDays === 0) return `<span style="color: var(--amber); font-weight: 700;">DUE TODAY</span>`;
    if (diffDays < 7) return `<span style="color: var(--amber);">${diffDays} days</span>`;
    if (diffDays < 30) return `<span style="color: var(--text-secondary);">${Math.floor(diffDays / 7)} weeks</span>`;
    return `<span style="color: var(--text-secondary);">${Math.floor(diffDays / 30)} months</span>`;
  }
  
  return `
    <div class="view active">
      ${getDemoBanner()}
      
      <div class="page-header">
        <h1 class="page-title">RFP Analyzer</h1>
        <p class="page-subtitle">Automated framework-to-control mapping with gap analysis</p>
        <button class="btn btn-primary" onclick="simulateRFPUpload()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="17 8 12 3 7 8"/>
            <line x1="12" y1="3" x2="12" y2="15"/>
          </svg>
          Import RFP
        </button>
      </div>
      
      <!-- Stats Row -->
      <div class="grid-4 mb-32">
        <div class="stat-card">
          <div class="stat-label">Active RFPs</div>
          <div class="stat-value">${totalRFPs}</div>
          <div class="stat-change neutral">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"/>
              <path d="m21 21-4.35-4.35"/>
            </svg>
            ${inProgress} in progress
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-label">Avg Coverage</div>
          <div class="stat-value" style="color: ${avgCoverage >= 0.9 ? 'var(--green)' : avgCoverage >= 0.7 ? 'var(--amber)' : 'var(--red)'};">${(avgCoverage * 100).toFixed(0)}%</div>
          <div class="stat-change ${avgCoverage >= 0.9 ? 'positive' : 'neutral'}">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12"/>
            </svg>
            ${avgCoverage >= 0.9 ? 'Excellent' : avgCoverage >= 0.7 ? 'Good' : 'Needs improvement'}
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-label">Total Gaps</div>
          <div class="stat-value" style="color: ${totalGaps > 0 ? 'var(--amber)' : 'var(--green)'};">${totalGaps}</div>
          <div class="stat-change ${totalGaps > 0 ? 'negative' : 'positive'}">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
            </svg>
            ${totalGaps > 0 ? 'Requires remediation' : 'All requirements met'}
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-label">Mapped Clauses</div>
          <div class="stat-value">${RFPS.reduce((sum, r) => sum + r.mappedClauses, 0)}</div>
          <div class="stat-change positive">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
              <polyline points="22,4 12,14.01 9,11.01"/>
            </svg>
            Auto-mapped to controls
          </div>
        </div>
      </div>
      
      <!-- RFP List -->
      <div class="card">
        <div class="card-header">
          <span class="card-title">RFP Pipeline</span>
          <span style="font-size: 12px; color: var(--text-tertiary); font-family: 'IBM Plex Mono', monospace;">Automated Analysis</span>
        </div>
        <div class="card-body" style="padding: 0;">
          ${RFPS.map((rfp, idx) => {
            const coveragePercent = (rfp.coverage * 100).toFixed(0);
            const coverageColor = rfp.coverage >= 0.9 ? 'var(--green)' : rfp.coverage >= 0.7 ? 'var(--amber)' : 'var(--red)';
            
            return `
              <div style="padding: 24px; ${idx < RFPS.length - 1 ? 'border-bottom: 1px solid var(--border-light);' : ''} transition: all 0.2s ease; cursor: pointer;" onclick="showRFPDetail('${rfp.id}')" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='white'">
                <div style="display: flex; align-items: start; gap: 24px;">
                  <!-- Type Icon -->
                  <div style="font-size: 40px; line-height: 1;">${getTypeIcon(rfp.type)}</div>
                  
                  <!-- Main Info -->
                  <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                      <div style="font-weight: 700; font-size: 16px;">${rfp.id}</div>
                      ${getStatusBadge(rfp.status)}
                      <span style="padding: 4px 8px; background: white; border: 1px solid ${getPriorityColor(rfp.priority)}; color: ${getPriorityColor(rfp.priority)}; border-radius: 6px; font-size: 10px; font-weight: 700; text-transform: uppercase;">
                        ${rfp.priority} PRIORITY
                      </span>
                    </div>
                    
                    <div style="font-size: 15px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">
                      ${rfp.title}
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 16px; font-size: 13px; color: var(--text-secondary);">
                      <span style="display: flex; align-items: center; gap: 6px;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                          <circle cx="12" cy="7" r="4"/>
                        </svg>
                        ${rfp.client}
                      </span>
                      <span style="display: flex; align-items: center; gap: 6px;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <circle cx="12" cy="12" r="10"/>
                          <polyline points="12,6 12,12 16,14"/>
                        </svg>
                        Due: ${formatDueDate(rfp.dueDate)}
                      </span>
                      <span style="display: flex; align-items: center; gap: 6px;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                          <circle cx="8.5" cy="7" r="4"/>
                          <polyline points="17,11 19,13 23,9"/>
                        </svg>
                        ${rfp.assignedTo}
                      </span>
                    </div>
                    
                    <!-- Frameworks -->
                    <div style="display: flex; gap: 6px; margin-bottom: 16px; flex-wrap: wrap;">
                      ${rfp.frameworks.map(f => `<span class="framework-chip">${f}</span>`).join('')}
                    </div>
                    
                    <!-- Coverage Progress -->
                    <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
                      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                        <div>
                          <div style="font-size: 11px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 4px;">COVERAGE ANALYSIS</div>
                          <div style="font-size: 13px; color: var(--text-secondary);">
                            ${rfp.mappedClauses} of ${rfp.totalClauses} clauses mapped
                            ${rfp.gapCount > 0 ? `<span style="color: var(--amber); font-weight: 700; margin-left: 12px;">• ${rfp.gapCount} gaps identified</span>` : ''}
                          </div>
                        </div>
                        <div style="text-align: right;">
                          <div style="font-size: 24px; font-weight: 700; font-family: 'IBM Plex Mono', monospace; color: ${coverageColor};">${coveragePercent}%</div>
                        </div>
                      </div>
                      
                      <div style="height: 8px; background: var(--border-light); border-radius: 4px; overflow: hidden;">
                        <div style="width: ${coveragePercent}%; height: 100%; background: ${coverageColor}; border-radius: 4px; transition: width 0.3s ease;"></div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Actions -->
                  <div style="display: flex; flex-direction: column; gap: 8px;">
                    <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); analyzeRFP('${rfp.id}')" style="white-space: nowrap;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="m21 21-4.35-4.35"/>
                      </svg>
                      Analyze
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); exportRFPReport('${rfp.id}')" style="white-space: nowrap;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                      </svg>
                      Export
                    </button>
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
    </div>
  `;
}

// ---- FORENSICS CASES VIEW ----

function renderForensics() {
  // Calculate stats
  const totalCases = FORENSICS_CASES.length;
  const activeCases = FORENSICS_CASES.filter(c => c.status === 'active' || c.status === 'investigating').length;
  const criticalCases = FORENSICS_CASES.filter(c => c.severity === 'critical').length;
  const avgResolutionTime = FORENSICS_CASES
    .filter(c => c.metrics.containmentTime)
    .reduce((sum, c) => sum + c.metrics.containmentTime, 0) / 
    FORENSICS_CASES.filter(c => c.metrics.containmentTime).length;
  const avgResolutionDays = Math.round(avgResolutionTime / 86400); // Convert seconds to days
  
  // Get severity badge
  function getSeverityBadge(severity) {
    const badges = {
      critical: '<span style="padding: 4px 10px; background: var(--red-light); color: var(--red); border-radius: 6px; font-size: 11px; font-weight: 700;">🔴 CRITICAL</span>',
      high: '<span style="padding: 4px 10px; background: var(--amber-light); color: var(--amber); border-radius: 6px; font-size: 11px; font-weight: 700;">🟠 HIGH</span>',
      medium: '<span style="padding: 4px 10px; background: var(--brand-light); color: var(--brand); border-radius: 6px; font-size: 11px; font-weight: 700;">🟡 MEDIUM</span>',
      low: '<span style="padding: 4px 10px; background: var(--green-light); color: var(--green); border-radius: 6px; font-size: 11px; font-weight: 700;">🟢 LOW</span>'
    };
    return badges[severity] || badges.medium;
  }
  
  // Get status badge
  function getStatusBadge(status) {
    const badges = {
      active: '<span style="padding: 4px 10px; background: var(--red-light); color: var(--red); border-radius: 6px; font-size: 11px; font-weight: 700;">⚡ ACTIVE</span>',
      investigating: '<span style="padding: 4px 10px; background: var(--amber-light); color: var(--amber); border-radius: 6px; font-size: 11px; font-weight: 700;">🔍 INVESTIGATING</span>',
      resolved: '<span style="padding: 4px 10px; background: var(--green-light); color: var(--green); border-radius: 6px; font-size: 11px; font-weight: 700;">✓ RESOLVED</span>'
    };
    return badges[status] || badges.investigating;
  }
  
  // Get type icon
  function getTypeIcon(type) {
    const icons = {
      security_incident: '🚨',
      policy_violation: '⚠️',
      compliance_drift: '📊',
      compliance_violation: '⚖️'
    };
    return icons[type] || '📋';
  }
  
  // Format time ago
  function formatTimeAgo(isoDate) {
    const date = new Date(isoDate);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 30) return `${diffDays}d ago`;
    return `${Math.floor(diffDays / 30)}mo ago`;
  }
  
  return `
    <div class="view active">
      ${getDemoBanner()}
      
      <div class="page-header">
        <h1 class="page-title">Forensics Cases</h1>
        <p class="page-subtitle">Security incident investigation with cryptographic audit trail</p>
        <button class="btn btn-primary" onclick="createForensicsCase()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
            <path d="M12 5v14M5 12h14"/>
          </svg>
          New Case
        </button>
      </div>
      
      <!-- Stats Row -->
      <div class="grid-4 mb-32">
        <div class="stat-card">
          <div class="stat-label">Total Cases</div>
          <div class="stat-value">${totalCases}</div>
          <div class="stat-change ${activeCases > 0 ? 'negative' : 'positive'}">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            </svg>
            ${activeCases} active
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-label">Critical Cases</div>
          <div class="stat-value" style="color: ${criticalCases > 0 ? 'var(--red)' : 'var(--green)'};">${criticalCases}</div>
          <div class="stat-change ${criticalCases > 0 ? 'negative' : 'positive'}">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="8" x2="12" y2="12"/>
              <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            ${criticalCases > 0 ? 'Needs immediate attention' : 'No critical cases'}
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-label">Avg Resolution</div>
          <div class="stat-value" style="color: var(--trust-teal);">${avgResolutionDays}d</div>
          <div class="stat-change neutral">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <polyline points="12,6 12,12 16,14"/>
            </svg>
            Mean time to resolve
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-label">Evidence Collected</div>
          <div class="stat-value">${FORENSICS_CASES.reduce((sum, c) => sum + c.evidenceCount, 0)}</div>
          <div class="stat-change positive">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
              <polyline points="14,2 14,8 20,8"/>
            </svg>
            Cryptographically verified
          </div>
        </div>
      </div>
      
      <!-- Active Cases Alert -->
      ${activeCases > 0 ? `
        <div style="padding: 16px 20px; background: var(--amber-light); border-left: 4px solid var(--amber); border-radius: 8px; margin-bottom: 24px; display: flex; align-items: center; gap: 12px;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--amber)" stroke-width="2">
            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
          </svg>
          <div style="flex: 1;">
            <div style="font-weight: 700; font-size: 13px; color: var(--amber); margin-bottom: 2px;">⚠️ Active Investigations</div>
            <div style="font-size: 12px; color: var(--text-secondary);">${activeCases} case${activeCases > 1 ? 's' : ''} require${activeCases === 1 ? 's' : ''} attention. Click to review findings and assign actions.</div>
          </div>
        </div>
      ` : ''}
      
      <!-- Cases List -->
      <div class="card">
        <div class="card-header">
          <span class="card-title">Investigation Cases</span>
          <span style="font-size: 12px; color: var(--text-tertiary); font-family: 'IBM Plex Mono', monospace;">Immutable Audit Trail</span>
        </div>
        <div class="card-body" style="padding: 0;">
          ${FORENSICS_CASES.map((forensicsCase, idx) => {
            const timelineLength = forensicsCase.timeline.length;
            const latestEvent = forensicsCase.timeline[timelineLength - 1];
            
            return `
              <div style="padding: 24px; ${idx < FORENSICS_CASES.length - 1 ? 'border-bottom: 1px solid var(--border-light);' : ''} transition: all 0.2s ease; cursor: pointer;" onclick="showForensicsDetail('${forensicsCase.id}')" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='white'">
                <div style="display: flex; align-items: start; gap: 24px;">
                  <!-- Type Icon -->
                  <div style="font-size: 40px; line-height: 1;">${getTypeIcon(forensicsCase.type)}</div>
                  
                  <!-- Main Info -->
                  <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                      <div style="font-weight: 700; font-size: 16px;">${forensicsCase.id}</div>
                      ${getStatusBadge(forensicsCase.status)}
                      ${getSeverityBadge(forensicsCase.severity)}
                    </div>
                    
                    <div style="font-size: 15px; font-weight: 600; color: var(--text-primary); margin-bottom: 12px;">
                      ${forensicsCase.title}
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 16px; font-size: 13px; color: var(--text-secondary);">
                      <span style="display: flex; align-items: center; gap: 6px;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <circle cx="12" cy="12" r="10"/>
                          <polyline points="12,6 12,12 16,14"/>
                        </svg>
                        Opened ${formatTimeAgo(forensicsCase.openedAt)}
                      </span>
                      <span style="display: flex; align-items: center; gap: 6px;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                          <circle cx="12" cy="7" r="4"/>
                        </svg>
                        ${forensicsCase.assignedTo}
                      </span>
                      <span style="display: flex; align-items: center; gap: 6px;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                          <polyline points="14,2 14,8 20,8"/>
                        </svg>
                        ${forensicsCase.evidenceCount} evidence items
                      </span>
                    </div>
                    
                    <!-- Affected Systems -->
                    <div style="display: flex; gap: 6px; margin-bottom: 16px; flex-wrap: wrap;">
                      ${forensicsCase.affectedSystems.map(sys => `
                        <span style="padding: 4px 10px; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; color: var(--text-secondary);">
                          💻 ${sys}
                        </span>
                      `).join('')}
                      ${forensicsCase.affectedControls.map(ctrl => `
                        <span style="padding: 4px 10px; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; color: var(--text-secondary);">
                          🛡️ ${ctrl}
                        </span>
                      `).join('')}
                    </div>
                    
                    <!-- Latest Event -->
                    <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; border-left: 3px solid ${latestEvent.severity === 'critical' ? 'var(--red)' : latestEvent.severity === 'high' ? 'var(--amber)' : latestEvent.severity === 'medium' ? 'var(--brand)' : 'var(--green)'};">
                      <div style="font-size: 11px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 4px;">
                        LATEST EVENT • ${formatTimeAgo(latestEvent.timestamp)}
                      </div>
                      <div style="font-size: 13px; color: var(--text-primary); font-weight: 600; margin-bottom: 4px;">
                        ${latestEvent.event}
                      </div>
                      <div style="font-size: 12px; color: var(--text-secondary);">
                        ${latestEvent.actor} • ${latestEvent.type.replace('_', ' ')}
                      </div>
                    </div>
                    
                    ${forensicsCase.status === 'resolved' && forensicsCase.resolvedAt ? `
                      <div style="margin-top: 12px; padding: 8px 12px; background: var(--green-light); border-radius: 6px; font-size: 12px; color: var(--green); display: inline-flex; align-items: center; gap: 6px;">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <polyline points="20 6 9 17 4 12"/>
                        </svg>
                        Resolved ${formatTimeAgo(forensicsCase.resolvedAt)}
                      </div>
                    ` : ''}
                  </div>
                  
                  <!-- Actions -->
                  <div style="display: flex; flex-direction: column; gap: 8px;">
                    <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); analyzeCase('${forensicsCase.id}')" style="white-space: nowrap;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="m21 21-4.35-4.35"/>
                      </svg>
                      Analyze
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); exportCaseReport('${forensicsCase.id}')" style="white-space: nowrap;">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                      </svg>
                      Export
                    </button>
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
    </div>
  `;
}

// ---- FRAMEWORK MAPPER VIEW (MGF PATENT #2) ----

function renderFrameworkMapper() {
  // Get all frameworks (built-in + ingested from API)
  const allFrameworks = getAllFrameworks();

  // Calculate stats
  const activeFrameworks = allFrameworks.filter(f => f.status === 'active').length;
  const ingestedCount = FRAMEWORK_DATA.ingested?.length || 0;
  const avgCoverage = allFrameworks.filter(f => f.status === 'active').length > 0
    ? allFrameworks.filter(f => f.status === 'active').reduce((sum, f) => sum + f.coverage, 0) / activeFrameworks
    : 0;
  const avgDecay = allFrameworks.filter(f => f.status === 'active').length > 0
    ? allFrameworks.filter(f => f.status === 'active').reduce((sum, f) => sum + f.psi, 0) / activeFrameworks
    : 0;
  const equivalenceCount = getEquivalences().length;
  
  // Get decay color
  function getDecayColor(psi) {
    if (psi >= 0.9) return 'var(--green)';
    if (psi >= 0.8) return 'var(--trust-teal)';
    if (psi >= 0.7) return 'var(--amber)';
    return 'var(--red)';
  }
  
  // Get freshness badge
  function getFreshnessBadge(daysOld, psi) {
    if (daysOld === null) return '<span style="padding: 4px 10px; background: var(--border-light); color: var(--text-tertiary); border-radius: 6px; font-size: 11px; font-weight: 700;">NOT MAPPED</span>';
    if (daysOld <= 7) return '<span style="padding: 4px 10px; background: var(--green-light); color: var(--green); border-radius: 6px; font-size: 11px; font-weight: 700;">🟢 FRESH</span>';
    if (daysOld <= 30) return '<span style="padding: 4px 10px; background: var(--trust-teal-light); color: var(--trust-teal); border-radius: 6px; font-size: 11px; font-weight: 700;">🔵 GOOD</span>';
    if (daysOld <= 60) return '<span style="padding: 4px 10px; background: var(--amber-light); color: var(--amber); border-radius: 6px; font-size: 11px; font-weight: 700;">🟡 AGING</span>';
    return '<span style="padding: 4px 10px; background: var(--red-light); color: var(--red); border-radius: 6px; font-size: 11px; font-weight: 700;">🔴 STALE</span>';
  }
  
  return `
    <div class="view active">
      ${getDemoBanner()}
      
      <div class="page-header">
        <h1 class="page-title">Framework Mapper <span style="font-size: 14px; color: var(--text-tertiary); font-weight: 400; margin-left: 12px;">Multi-Governance Fabric (MGF)</span></h1>
        <p class="page-subtitle">Atomic cross-framework propagation with Ψ credential-decay</p>
        <button class="btn btn-primary" onclick="ingestFramework()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="17 8 12 3 7 8"/>
            <line x1="12" y1="3" x2="12" y2="15"/>
          </svg>
          Ingest Framework
        </button>
      </div>
      
      <!-- Stats Row -->
      <div class="grid-4 mb-32">
        <div class="stat-card">
          <button class="delta-context-btn" onclick="openDeltaContextByTopic('frameworks', event)" title="Ask about frameworks">Δ</button>
          <div class="stat-label">Active Frameworks</div>
          <div class="stat-value">${activeFrameworks}</div>
          <div class="stat-change ${ingestedCount > 0 ? 'positive' : 'neutral'}">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 2L2 7l10 5 10-5-10-5z"/>
              <path d="M2 17l10 5 10-5"/>
            </svg>
            ${ingestedCount > 0 ? `${ingestedCount} ingested` : `${allFrameworks.filter(f => f.status === 'pending').length} pending`}
          </div>
        </div>

        <div class="stat-card">
          <button class="delta-context-btn" onclick="openDeltaContextByTopic('framework_coverage', event)" title="Ask about coverage">Δ</button>
          <div class="stat-label">Avg Coverage</div>
          <div class="stat-value" style="color: ${avgCoverage >= 0.9 ? 'var(--green)' : avgCoverage >= 0.8 ? 'var(--trust-teal)' : 'var(--amber)'};">${(avgCoverage * 100).toFixed(0)}%</div>
          <div class="stat-change ${avgCoverage >= 0.9 ? 'positive' : 'neutral'}">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12"/>
            </svg>
            Across all frameworks
          </div>
        </div>

        <div class="stat-card">
          <button class="delta-context-btn" onclick="openDeltaContextByTopic('psi_decay', event)" title="Ask about Ψ decay">Δ</button>
          <div class="stat-label">Avg Ψ Decay</div>
          <div class="stat-value" style="color: ${getDecayColor(avgDecay)};">${avgDecay.toFixed(2)}</div>
          <div class="stat-change ${avgDecay >= 0.9 ? 'positive' : avgDecay >= 0.8 ? 'neutral' : 'negative'}">
            <div class="operator-glyph psi" style="width: 14px; height: 14px; font-size: 9px; margin-right: 4px;">Ψ</div>
            ${avgDecay >= 0.9 ? 'Fresh mappings' : avgDecay >= 0.8 ? 'Some aging' : 'Needs review'}
          </div>
        </div>

        <div class="stat-card">
          <button class="delta-context-btn" onclick="openDeltaContextByTopic('equivalence_maps', event)" title="Ask about equivalence maps">Δ</button>
          <div class="stat-label">Equivalence Maps</div>
          <div class="stat-value">${equivalenceCount}</div>
          <div class="stat-change positive">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 3a2.83 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>
            </svg>
            Atomic propagation
          </div>
        </div>
      </div>
      
      <!-- Framework List -->
      <div class="card mb-32">
        <div class="card-header">
          <span class="card-title">Governance Frameworks</span>
          <span style="font-size: 12px; color: var(--text-tertiary); font-family: 'IBM Plex Mono', monospace;">Ψ Credential-Decay</span>
        </div>
        <div class="card-body" style="padding: 0;">
          ${allFrameworks.map((fw, idx) => {
            const coveragePercent = (fw.coverage * 100).toFixed(0);
            const coverageColor = fw.coverage >= 0.9 ? 'var(--green)' : fw.coverage >= 0.8 ? 'var(--trust-teal)' : 'var(--amber)';
            const isIngested = fw.type === 'ingested';

            return `
              <div style="padding: 20px; ${idx < allFrameworks.length - 1 ? 'border-bottom: 1px solid var(--border-light);' : ''} transition: all 0.2s ease; cursor: pointer; position: relative;" onclick="${fw.status === 'active' ? (isIngested ? `showIngestedFrameworkDetail('${fw.id}')` : `showFrameworkDetail('${fw.id}')`) : 'ingestFramework()'}" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='white'" class="framework-item">
                <button class="delta-context-btn" onclick="event.stopPropagation(); openDeltaContextById('framework', '${fw.id}', event)" title="Ask Δtomic AI about this framework">Δ</button>
                <div style="display: flex; align-items: start; gap: 20px;">
                  <!-- Framework Info -->
                  <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                      ${isIngested ? '<span style="padding: 2px 8px; background: var(--green-light); color: var(--green); border-radius: 4px; font-size: 10px; font-weight: 700;">INGESTED</span>' : ''}
                      <div style="font-weight: 700; font-size: 16px;">${fw.name}</div>
                      ${fw.status === 'active' ? getFreshnessBadge(fw.daysOld, fw.psi) : '<span style="padding: 4px 10px; background: var(--border-light); color: var(--text-tertiary); border-radius: 6px; font-size: 11px; font-weight: 700;">⏸ PENDING INGESTION</span>'}
                    </div>
                    
                    <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">
                      ${fw.version} • ${fw.totalClauses} total clauses
                      ${fw.lastReviewed ? ` • Last reviewed ${fw.daysOld} days ago` : ''}
                    </div>
                    
                    ${fw.status === 'active' ? `
                      <!-- Coverage Progress -->
                      <div style="margin-bottom: 12px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px;">
                          <span style="font-size: 12px; color: var(--text-tertiary); font-weight: 700;">COVERAGE</span>
                          <span style="font-size: 14px; font-weight: 700; font-family: 'IBM Plex Mono', monospace; color: ${coverageColor};">${fw.mappedClauses}/${fw.totalClauses} (${coveragePercent}%)</span>
                        </div>
                        <div style="height: 6px; background: var(--border-light); border-radius: 3px; overflow: hidden;">
                          <div style="width: ${coveragePercent}%; height: 100%; background: ${coverageColor}; border-radius: 3px;"></div>
                        </div>
                      </div>
                      
                      <!-- Ψ Decay Progress -->
                      <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; border-left: 3px solid ${getDecayColor(fw.psi)};">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px;">
                          <div style="display: flex; align-items: center; gap: 8px;">
                            <div class="operator-glyph psi" style="width: 20px; height: 20px; font-size: 11px;">Ψ</div>
                            <span style="font-size: 12px; color: var(--text-tertiary); font-weight: 700;">CREDENTIAL-DECAY</span>
                          </div>
                          <span style="font-size: 16px; font-weight: 700; font-family: 'IBM Plex Mono', monospace; color: ${getDecayColor(fw.psi)};">${fw.psi.toFixed(2)}</span>
                        </div>
                        <div style="height: 6px; background: var(--border-light); border-radius: 3px; overflow: hidden;">
                          <div style="width: ${(fw.psi * 100).toFixed(0)}%; height: 100%; background: ${getDecayColor(fw.psi)}; border-radius: 3px;"></div>
                        </div>
                        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 6px;">
                          ${fw.daysOld <= 7 ? '✓ Fresh mapping - high confidence' : 
                            fw.daysOld <= 30 ? '⚠ Aging - consider review' :
                            fw.daysOld <= 60 ? '⚠ Stale - review recommended' :
                            '🔴 Very stale - review required'}
                        </div>
                      </div>
                    ` : `
                      <div style="padding: 16px; background: var(--brand-light); border-radius: 8px; text-align: center;">
                        <div style="font-size: 13px; color: var(--brand); font-weight: 600; margin-bottom: 8px;">Framework Not Yet Mapped</div>
                        <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); ingestFramework('${fw.id}')">
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                          </svg>
                          Ingest ${fw.name}
                        </button>
                      </div>
                    `}
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
      
      <!-- Equivalence Matrix -->
      <div class="card">
        <div class="card-header">
          <span class="card-title">Atomic Equivalence Matrix</span>
          <div style="display: flex; align-items: center; gap: 12px;">
            <span style="font-size: 12px; color: var(--text-tertiary); font-family: 'IBM Plex Mono', monospace;">Cross-Framework Propagation</span>
            <button class="btn btn-sm btn-secondary" onclick="exportEquivalencesData()">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
              Export
            </button>
          </div>
        </div>
        <div class="card-body" style="padding: 0;">
          ${getEquivalences().map((eq, idx) => `
            <div style="padding: 24px; ${idx < getEquivalences().length - 1 ? 'border-bottom: 1px solid var(--border-light);' : ''} transition: all 0.2s ease; cursor: pointer; position: relative;" onclick="showEquivalenceDetail('${eq.id}')" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='white'" class="equivalence-item">
              <button class="delta-context-btn" onclick="event.stopPropagation(); openDeltaContextById('intersection', '${eq.id}', event)" title="Ask Δtomic AI about this mapping">Δ</button>
              <div style="margin-bottom: 16px;">
                <div style="font-weight: 700; font-size: 15px; margin-bottom: 6px;">
                  ${eq.id} — ${eq.family}
                </div>
                <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">
                  Maps to: ${eq.controlId} (${eq.controlName})
                </div>
                <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 16px;">
                  <span style="padding: 4px 10px; background: var(--green-light); color: var(--green); border-radius: 6px; font-size: 11px; font-weight: 700;">
                    ⚛️ ATOMIC PROPAGATION ENABLED
                  </span>
                  <span style="padding: 4px 10px; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-family: 'IBM Plex Mono', monospace;">
                    Semantic: ${(eq.semanticConfidence * 100).toFixed(0)}%
                  </span>
                  <span style="padding: 4px 10px; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 6px; font-size: 11px; font-family: 'IBM Plex Mono', monospace;">
                    Δ: ${eq.divergenceScore.toFixed(2)}
                  </span>
                </div>
              </div>
              
              <!-- Equivalent Clauses -->
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                ${eq.equivalentClauses.map(clause => `
                  <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; border-left: 3px solid ${getDecayColor(clause.psi)};">
                    <div style="font-size: 11px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 4px;">${clause.framework}</div>
                    <div style="font-size: 13px; font-weight: 700; margin-bottom: 4px;">${clause.clause}</div>
                    <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;">${clause.title}</div>
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                      <div class="operator-glyph phi" style="width: 16px; height: 16px; font-size: 9px;">Φ</div>
                      <span style="font-size: 11px; font-family: 'IBM Plex Mono', monospace; font-weight: 700;">${clause.phi.toFixed(2)}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                      <div class="operator-glyph psi" style="width: 16px; height: 16px; font-size: 9px;">Ψ</div>
                      <span style="font-size: 11px; font-family: 'IBM Plex Mono', monospace; font-weight: 700; color: ${getDecayColor(clause.psi)};">${clause.psi.toFixed(2)}</span>
                      <span style="font-size: 10px; color: var(--text-tertiary);">(${clause.daysOld}d)</span>
                    </div>
                  </div>
                `).join('')}
              </div>
              
              <div style="margin-top: 16px; padding: 12px; background: var(--brand-light); border-radius: 8px;">
                <div style="font-size: 12px; color: var(--brand); font-weight: 700; margin-bottom: 4px;">💡 ATOMIC PROPAGATION</div>
                <div style="font-size: 12px; color: var(--text-secondary);">
                  Vote on any clause above → All ${eq.equivalentClauses.length} equivalents update instantly with same Φ score
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    </div>
  `;
}

// ---- SNAPSHOTS VIEW ----

function renderSnapshots() {
  return `
    <div class="view active">
      <div class="page-header">
        <h1 class="page-title">Snapshots</h1>
        <p class="page-subtitle">${SNAPSHOTS.length} cryptographic snapshots · 100% verified</p>
      </div>
      
      <div class="card">
        <div class="card-header">
          <span class="card-title">Snapshot Timeline</span>
          <button class="btn btn-primary" onclick="createSnapshot()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
              <circle cx="12" cy="13" r="4"/>
            </svg>
            Create Snapshot
          </button>
        </div>
        <div class="card-body" style="padding: 0;">
          ${SNAPSHOTS.map((snap, idx) => `
            <div style="padding: 20px 24px; border-bottom: 1px solid var(--border-light); display: flex; align-items: center; gap: 20px; transition: all 0.2s ease; cursor: pointer;" onmouseover="this.style.background='var(--bg-secondary)'" onmouseout="this.style.background='white'">
              <div style="width: 50px; height: 50px; border-radius: 12px; background: linear-gradient(135deg, var(--deep-navy), var(--ip)); color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: var(--shadow-md);">
                <div style="font-size: 10px; opacity: 0.8; font-weight: 700;">BLOCK</div>
                <div style="font-size: 16px; font-weight: 800; font-family: 'IBM Plex Mono', monospace;">${snap.id}</div>
              </div>
              
              <div style="flex: 1;">
                <div style="font-weight: 700; font-size: 14px; margin-bottom: 4px;">${formatDate(snap.timestamp)}</div>
                <div style="font-size: 12px; color: var(--text-tertiary);">
                  ${snap.controls} controls · ${snap.evidence} evidence items
                </div>
              </div>
              
              <div style="text-align: center;">
                <div style="font-size: 11px; color: var(--text-tertiary); margin-bottom: 4px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.03em;">Trust Score</div>
                <div style="font-size: 28px; font-weight: 800; color: ${getTrustColor(snap.trust)}; font-family: 'IBM Plex Mono', monospace;">${snap.trust.toFixed(2)}</div>
              </div>
              
              <div style="text-align: center;">
                <div style="font-size: 11px; color: var(--text-tertiary); margin-bottom: 4px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.03em;">Merkle Root</div>
                <span class="hash" style="font-size: 12px;">${snap.merkle_root}</span>
              </div>
              
              <button class="btn btn-secondary" onclick="event.stopPropagation(); verifySnapshot(${snap.id})">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                  <polyline points="9,12 11,14 15,10"/>
                </svg>
                Verify
              </button>
            </div>
          `).join('')}
        </div>
      </div>
    </div>
  `;
}

// ---- PLACEHOLDER VIEWS ----

function renderPlaceholder(viewName) {
  return `
    <div class="view active">
      <div class="empty-state" style="padding-top: 120px;">
        <div class="empty-state-icon">🚧</div>
        <div class="empty-state-title">${viewName.charAt(0).toUpperCase() + viewName.slice(1)} View</div>
        <div class="empty-state-description">This view is under construction</div>
        <button class="btn btn-primary" onclick="showView('dashboard')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="7" height="7"/>
            <rect x="14" y="3" width="7" height="7"/>
            <rect x="14" y="14" width="7" height="7"/>
            <rect x="3" y="14" width="7" height="7"/>
          </svg>
          Back to Dashboard
        </button>
      </div>
    </div>
  `;
}

// ---- HELPER FUNCTIONS ----

function getTrustColor(trust) {
  const val = parseFloat(trust);
  if (val >= 0.85) return 'green';
  if (val >= 0.70) return 'amber';
  return 'red';
}

function getStatusColor(status) {
  switch(status) {
    case 'compliant': return 'green';
    case 'at-risk': return 'amber';
    case 'critical': return 'red';
    default: return 'amber';
  }
}

function getStatusLabel(status) {
  switch(status) {
    case 'compliant': return 'Compliant';
    case 'at-risk': return 'At Risk';
    case 'critical': return 'Critical';
    default: return 'Unknown';
  }
}

function formatDate(isoString) {
  const date = new Date(isoString);
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' });
}

function formatRelativeTime(isoString) {
  const now = new Date();
  const then = new Date(isoString);
  const diffMs = now - then;
  const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
  
  if (diffHours < 1) return 'Just now';
  if (diffHours < 24) return `${diffHours}h ago`;
  if (diffDays < 7) return `${diffDays}d ago`;
  return formatDate(isoString);
}

// ---- ANIMATIONS ----

function animateCounters() {
  setTimeout(() => {
    // Animate trust score
    const heroScore = document.getElementById('heroTrustScore');
    if (heroScore) {
      const target = 0.89;
      let current = 0;
      const increment = target / 60;
      const timer = setInterval(() => {
        current += increment;
        if (current >= target) {
          current = target;
          clearInterval(timer);
        }
        heroScore.textContent = current.toFixed(2);
      }, 16);
    }
    
    // Animate stat counters
    ['statControls', 'statCompliant', 'statAtRisk', 'statCritical'].forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        const target = parseInt(el.dataset.target);
        let current = 0;
        const increment = Math.ceil(target / 30);
        const timer = setInterval(() => {
          current += increment;
          if (current >= target) {
            current = target;
            clearInterval(timer);
          }
          el.textContent = current;
        }, 30);
      }
    });
    
    // Animate operator bars
    document.querySelectorAll('.operator-bar-fill[data-width]').forEach(bar => {
      const width = bar.dataset.width;
      setTimeout(() => {
        bar.style.width = width + '%';
      }, 200);
    });
  }, 100);
}

// ---- MODAL FUNCTIONS ----

let previouslyFocusedElement = null;

function openModal(title, body, footer = null) {
  // Save currently focused element for restoration
  previouslyFocusedElement = document.activeElement;
  
  document.getElementById('modalTitle').textContent = title;
  document.getElementById('modalBody').innerHTML = body;
  if (footer) {
    document.getElementById('modalFooter').innerHTML = footer;
  }
  
  const modalOverlay = document.getElementById('modalOverlay');
  modalOverlay.classList.add('active');
  
  // Focus the modal title for screen readers
  setTimeout(() => {
    const closeButton = document.querySelector('.modal-close');
    if (closeButton) closeButton.focus();
  }, 100);
  
  // Add keyboard event listener for ESC key
  document.addEventListener('keydown', handleModalEsc);
}

function closeModal(event) {
  if (event && event.target !== event.currentTarget && event.type === 'click') return;
  
  document.getElementById('modalOverlay').classList.remove('active');
  
  // Remove keyboard listener
  document.removeEventListener('keydown', handleModalEsc);
  
  // Restore focus to previously focused element
  if (previouslyFocusedElement) {
    previouslyFocusedElement.focus();
    previouslyFocusedElement = null;
  }
}

function handleModalEsc(e) {
  if (e.key === 'Escape') {
    closeModal();
  }
}

// ---- OPERATOR INFO MODAL ----

function showOperatorInfo(operatorType) {
  const operatorData = {
    phi: {
      symbol: 'Φ',
      name: 'Zero-Start Truth Convergence',
      color: '#10B981',
      tagline: 'Performance',
      description: 'Every control begins with Φ = 0 (zero trust). Trust increases only as evidence accumulates and is verified. This inverts the credentialism paradigm—we don\'t assume compliance; we prove it from first principles.',
      formula: 'Φ = Σ(evidence_quality × evidence_weight) / total_possible_weight',
      useCase: 'Audit defense: "We started from zero and proved compliance step-by-step."',
      patent: 'U.S. Provisional Patent Application #3 (Nov 19, 2025)',
      innovation: 'True epistemic zero (w=0) versus epsilon smoothing used in prior art'
    },
    psi: {
      symbol: 'Ψ',
      name: 'Credential-Decay Framework',
      color: '#F59E0B',
      tagline: 'Credential Decay',
      description: 'Evidence loses credibility over time using exponential decay. Fresh evidence = high trust. Stale evidence = low trust. This prevents compliance theater and ensures continuous verification.',
      formula: 'Ψ(t) = Φ₀ × e^(-λt)\n\nWhere:\n  Φ₀ = initial trust\n  λ = decay rate (default 0.02/day)\n  t = time since upload (days)',
      useCase: 'Evidence uploaded 45 days ago has decayed. System auto-schedules re-verification.',
      patent: 'U.S. Provisional Patent Application #4 (Nov 19, 2025)',
      innovation: 'Exponential time-weighted trust decay applied to compliance evidence'
    },
    delta: {
      symbol: 'Δ',
      name: 'Byzantine Disagreement Detection',
      color: '#EF4444',
      tagline: 'Divergence',
      description: 'Detects when voters contradict each other on control state. High Δ indicates Byzantine fault—political gridlock, misaligned expectations, or actual security gaps.',
      formula: 'Δ = σ(voter_assessments) / μ(voter_assessments)\n\nWhere:\n  σ = standard deviation\n  μ = mean\n\nΔ > 0.18 triggers alert',
      useCase: 'CISO says compliant, auditor flags as risky. Δ spikes to 0.22, triggering resolution workflow.',
      patent: 'U.S. Provisional Patent Application #5 (Nov 23, 2025)',
      innovation: 'Voter variance detection for distributed governance systems'
    },
    ip: {
      symbol: 'IP',
      name: 'Integrity Proof Engine',
      color: '#1A1A2E',
      tagline: 'Snapshot & Provenance',
      description: 'Cryptographic snapshots using BLAKE3 hashing and Merkle trees. Every state change creates an immutable audit trail. Time travel through historical governance states.',
      formula: '1. Hash all evidence with BLAKE3\n2. Construct Merkle tree\n3. Compute root hash (snapshot)\n4. Chain snapshots cryptographically',
      useCase: 'Auditor asks: "What was your access control posture on Oct 15?" → Drag time slider, export snapshot-backed report.',
      patent: 'U.S. Provisional Patent Application #1 (Nov 14, 2025)',
      innovation: 'Snapshot-based provenance engine with BLAKE3 + Merkle trees for governance'
    },
    trust: {
      symbol: 'T',
      name: 'Trust Composite Score',
      color: '#0F4C75',
      tagline: 'Unified Trust Metric',
      description: 'Weighted combination of all operators into a single trust metric. Ranges from 0.00 (no trust) to 1.00 (full trust). Provides executive-level KPI for compliance health.',
      formula: 'T = α₁Φ + α₂Ψ - β₁Δ + β₂IP\n\nWhere:\n  α₁, α₂ = positive weights\n  β₁ = penalty for divergence\n  β₂ = bonus for integrity proof',
      useCase: 'Executive dashboard shows single trust score of 0.89. CTO understands compliance posture at a glance.',
      patent: 'U.S. Provisional Patent Application #2 (Nov 14, 2025)',
      innovation: 'Unified atomic trust system combining ΦΨΔIP operators'
    }
  };

  const op = operatorData[operatorType];
  
  const body = `
    <div style="text-align: center; margin-bottom: 24px;">
      <div style="display: inline-flex; align-items: center; justify-content: center; width: 80px; height: 80px; border-radius: 16px; background: linear-gradient(135deg, ${op.color} 0%, ${op.color}dd 100%); box-shadow: 0 8px 24px ${op.color}40; margin-bottom: 16px;">
        <span style="font-size: 48px; font-weight: 700; color: white; font-style: italic;">${op.symbol}</span>
      </div>
      <h3 style="margin: 0 0 8px 0; font-size: 22px; font-weight: 700; color: var(--text-primary);">${op.name}</h3>
      <div style="display: inline-block; padding: 4px 12px; background: ${op.color}20; color: ${op.color}; border-radius: 6px; font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">${op.tagline}</div>
    </div>

    <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid ${op.color};">
      <div style="font-size: 14px; line-height: 1.7; color: var(--text-primary); margin-bottom: 16px;">
        ${op.description}
      </div>
    </div>

    <div style="margin-bottom: 20px;">
      <div style="font-size: 12px; font-weight: 700; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px;">Mathematical Formula</div>
      <div style="background: var(--deep-navy); padding: 16px; border-radius: 8px; font-family: 'IBM Plex Mono', monospace; font-size: 13px; color: ${op.color}; line-height: 1.6; white-space: pre-wrap;">${op.formula}</div>
    </div>

    <div style="margin-bottom: 20px;">
      <div style="font-size: 12px; font-weight: 700; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px;">Use Case Example</div>
      <div style="background: var(--bg-secondary); padding: 14px 16px; border-radius: 8px; font-size: 13px; color: var(--text-secondary); font-style: italic; border-left: 3px solid ${op.color};">
        "${op.useCase}"
      </div>
    </div>

    <div style="background: linear-gradient(135deg, ${op.color}10 0%, ${op.color}05 100%); padding: 16px; border-radius: 8px; border: 1px solid ${op.color}30;">
      <div style="font-size: 11px; font-weight: 700; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 6px;">Patent Protection</div>
      <div style="font-size: 13px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">${op.patent}</div>
      <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.5;">
        <strong>Innovation:</strong> ${op.innovation}
      </div>
    </div>
  `;

  const footer = `
    <button class="btn btn-secondary" onclick="closeModal()">Close</button>
    <button class="btn btn-primary" onclick="closeModal(); showView('controls');">
      View Controls with ${op.symbol}
    </button>
  `;

  openModal(`${op.symbol} — ${op.name}`, body, footer);
}

// ---- PDF ATTESTATION CERTIFICATE GENERATION ----

function generateAttestationPDF(attestationId) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  // Find attestation data
  const attestation = {
    id: attestationId,
    control: 'UCP-003',
    controlName: 'Incident Response Plan',
    frameworks: ['SOC2', 'HIPAA', 'NIST'],
    signers: [
      { name: 'Marcus Rivera', role: 'CISO', signedAt: '2025-11-28 14:32:15 UTC', hash: 'blake3:a7f3e9c2d4b8f1a5c7e9d2b4a6c8e1f3' },
      { name: 'Jennifer Kim', role: 'CFO', signedAt: '2025-11-28 16:15:42 UTC', hash: 'blake3:b2c4d1a8e5f7c9b3d6e8a1c4f2b5d7e9' }
    ],
    attestedAt: '2025-11-28',
    snapshotBlock: 846,
    merkleRoot: 'blake3:7d4f2a1b9c8e5f3a6d2e8c4b7a1f9e3d5c8a2b6e4f1d9a7c3e5b8d2f4a6c9e1b7',
    trustScore: 0.87,
    operatorValues: {
      phi: 0.87,
      psi: 0.84,
      delta: 0.02,
      ip: 'blake3:verified',
      t: 0.87
    }
  };
  
  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();
  
  // ===== DEMO WATERMARK =====
  
  doc.setFontSize(60);
  doc.setTextColor(240, 240, 240);
  doc.setFont('helvetica', 'bold');
  doc.text('DEMO', pageWidth/2, pageHeight/2, { 
    align: 'center',
    angle: 45
  });
  
  // ===== HEADER SECTION =====
  
  // Brand blue background rectangle
  doc.setFillColor(50, 130, 184); // --brand color
  doc.rect(0, 0, pageWidth, 40, 'F');
  
  // Delta symbol and title (using "Delta" text instead of symbol)
  doc.setFontSize(24);
  doc.setTextColor(255, 255, 255);
  doc.setFont('helvetica', 'bold');
  doc.text('Atomic Trust™', 15, 20);
  doc.setFontSize(10);
  
  doc.setFontSize(10);
  doc.setFont('helvetica', 'normal');
  doc.text('CRYPTOGRAPHIC ATTESTATION CERTIFICATE', 15, 30);
  
  // Verified badge (top right)
  doc.setFillColor(16, 185, 129); // green
  doc.circle(pageWidth - 20, 20, 10, 'F');
  doc.setFontSize(16);
  doc.setTextColor(255, 255, 255);
  doc.text('V', pageWidth - 23.5, 24);
  
  // Demo disclaimer badge
  doc.setFillColor(245, 158, 11); // amber
  doc.roundedRect(pageWidth - 75, 8, 55, 8, 2, 2, 'F');
  doc.setFontSize(7);
  doc.setTextColor(255, 255, 255);
  doc.setFont('helvetica', 'bold');
  doc.text('SIMULATED DATA', pageWidth - 47.5, 13, { align: 'center' });
  
  // ===== CERTIFICATE INFO =====
  
  doc.setTextColor(0, 0, 0);
  let yPos = 55;
  
  // Certificate ID
  doc.setFontSize(10);
  doc.setTextColor(100, 116, 139);
  doc.text('CERTIFICATE ID', 15, yPos);
  doc.setFontSize(14);
  doc.setTextColor(0, 0, 0);
  doc.setFont('courier', 'bold');
  doc.text(attestation.id, 15, yPos + 6);
  
  // Date
  doc.setFontSize(10);
  doc.setTextColor(100, 116, 139);
  doc.setFont('helvetica', 'normal');
  doc.text('ATTESTATION DATE', pageWidth - 60, yPos);
  doc.setFontSize(12);
  doc.setTextColor(0, 0, 0);
  doc.setFont('helvetica', 'bold');
  doc.text(attestation.attestedAt, pageWidth - 60, yPos + 6);
  
  yPos += 20;
  
  // ===== CONTROL INFORMATION =====
  
  doc.setFillColor(249, 250, 251);
  doc.rect(10, yPos, pageWidth - 20, 30, 'F');
  doc.setDrawColor(226, 232, 240);
  doc.rect(10, yPos, pageWidth - 20, 30, 'S');
  
  yPos += 10;
  doc.setFontSize(9);
  doc.setTextColor(100, 116, 139);
  doc.setFont('helvetica', 'bold');
  doc.text('CONTROL', 15, yPos);
  
  yPos += 5;
  doc.setFontSize(12);
  doc.setTextColor(0, 0, 0);
  doc.setFont('helvetica', 'bold');
  doc.text(`${attestation.control} - ${attestation.controlName}`, 15, yPos);
  
  yPos += 7;
  doc.setFontSize(9);
  doc.setTextColor(100, 116, 139);
  doc.text(`Frameworks: ${attestation.frameworks.join(' | ')}`, 15, yPos);
  
  yPos += 18;
  
  // ===== OPERATOR AUTHENTICATION =====
  
  doc.setFontSize(11);
  doc.setTextColor(50, 130, 184);
  doc.setFont('helvetica', 'bold');
  doc.text('PHIPSIDETAIPT OPERATOR AUTHENTICATION', 15, yPos);
  
  yPos += 2;
  doc.setDrawColor(50, 130, 184);
  doc.setLineWidth(0.5);
  doc.line(15, yPos, pageWidth - 15, yPos);
  
  yPos += 8;
  
  // Operator values in a grid
  const operators = [
    { symbol: 'PHI', name: 'Zero-Start\nTruth', value: attestation.operatorValues.phi.toFixed(2), color: [50, 130, 184] },
    { symbol: 'PSI', name: 'Credential\nDecay', value: attestation.operatorValues.psi.toFixed(2), color: [99, 102, 241] },
    { symbol: 'DELTA', name: 'Divergence', value: attestation.operatorValues.delta.toFixed(2), color: [245, 158, 11] },
    { symbol: 'IP', name: 'Integrity\nProof', value: 'OK', color: [16, 185, 129] },
    { symbol: 'T', name: 'Trust\nComposite', value: attestation.operatorValues.t.toFixed(2), color: [16, 185, 129] }
  ];
  
  let xOffset = 15;
  const boxWidth = 36;
  
  operators.forEach((op, idx) => {
    // Operator box
    doc.setFillColor(op.color[0], op.color[1], op.color[2]);
    doc.roundedRect(xOffset, yPos, boxWidth, 22, 2, 2, 'F');
    
    // Symbol (using text abbreviations instead of unicode)
    doc.setFontSize(10);
    doc.setTextColor(255, 255, 255);
    doc.setFont('helvetica', 'bold');
    doc.text(op.symbol, xOffset + boxWidth/2, yPos + 8, { align: 'center' });
    
    // Value
    doc.setFontSize(12);
    doc.setFont('helvetica', 'bold');
    doc.text(op.value, xOffset + boxWidth/2, yPos + 17, { align: 'center' });
    
    // Name below box
    doc.setFontSize(7);
    doc.setTextColor(100, 116, 139);
    doc.setFont('helvetica', 'normal');
    const nameLines = op.name.split('\n');
    nameLines.forEach((line, lineIdx) => {
      doc.text(line, xOffset + boxWidth/2, yPos + 26 + (lineIdx * 3), { align: 'center' });
    });
    
    xOffset += boxWidth + 2;
  });
  
  yPos += 40;
  
  // ===== DIGITAL SIGNATURES =====
  
  doc.setFontSize(11);
  doc.setTextColor(50, 130, 184);
  doc.setFont('helvetica', 'bold');
  doc.text('MULTI-PARTY DIGITAL SIGNATURES', 15, yPos);
  
  yPos += 2;
  doc.setDrawColor(50, 130, 184);
  doc.line(15, yPos, pageWidth - 15, yPos);
  
  yPos += 10;
  
  attestation.signers.forEach((signer, idx) => {
    // Signer box
    doc.setFillColor(249, 250, 251);
    doc.rect(15, yPos, pageWidth - 30, 24, 'F');
    doc.setDrawColor(226, 232, 240);
    doc.rect(15, yPos, pageWidth - 30, 24, 'S');
    
    // Avatar circle
    doc.setFillColor(16, 185, 129);
    doc.circle(23, yPos + 12, 6, 'F');
    doc.setFontSize(9);
    doc.setTextColor(255, 255, 255);
    doc.setFont('helvetica', 'bold');
    const initials = signer.name.split(' ').map(n => n[0]).join('');
    doc.text(initials, 23, yPos + 14, { align: 'center' });
    
    // Signer info
    doc.setFontSize(11);
    doc.setTextColor(0, 0, 0);
    doc.setFont('helvetica', 'bold');
    doc.text(signer.name, 35, yPos + 10);
    
    doc.setFontSize(8);
    doc.setTextColor(100, 116, 139);
    doc.setFont('helvetica', 'normal');
    doc.text(`${signer.role} | Signed: ${signer.signedAt}`, 35, yPos + 16);
    
    // Hash
    doc.setFontSize(7);
    doc.setFont('courier', 'normal');
    doc.setTextColor(71, 85, 105);
    doc.text(`Hash: ${signer.hash}`, 35, yPos + 21);
    
    yPos += 28;
  });
  
  yPos += 5;
  
  // ===== MERKLE ROOT & SNAPSHOT =====
  
  doc.setFillColor(239, 246, 255);
  doc.rect(15, yPos, pageWidth - 30, 28, 'F');
  doc.setDrawColor(50, 130, 184);
  doc.setLineWidth(2);
  doc.line(15, yPos, 15, yPos + 28);
  
  yPos += 8;
  
  // Shield icon (simplified triangle)
  doc.setFillColor(50, 130, 184);
  doc.triangle(20, yPos, 18, yPos + 8, 22, yPos + 8, 'F');
  
  doc.setFontSize(8);
  doc.setTextColor(50, 130, 184);
  doc.setFont('helvetica', 'bold');
  doc.text('MERKLE ROOT', 30, yPos + 4);
  
  yPos += 8;
  doc.setFontSize(7);
  doc.setFont('courier', 'normal');
  doc.setTextColor(0, 0, 0);
  const merkleLines = doc.splitTextToSize(attestation.merkleRoot, pageWidth - 50);
  doc.text(merkleLines, 20, yPos);
  
  yPos += 10;
  doc.setFontSize(8);
  doc.setFont('helvetica', 'normal');
  doc.setTextColor(100, 116, 139);
  doc.text(`Snapshot Block: ${attestation.snapshotBlock} | Trust Score: ${attestation.trustScore}`, 20, yPos);
  
  yPos += 12;
  
  // ===== FOOTER =====
  
  doc.setFillColor(249, 250, 251);
  doc.rect(0, pageHeight - 35, pageWidth, 35, 'F');
  
  yPos = pageHeight - 22;
  
  // Demo disclaimer in footer
  doc.setFillColor(245, 158, 11);
  doc.roundedRect(pageWidth/2 - 55, yPos - 10, 110, 8, 2, 2, 'F');
  doc.setFontSize(8);
  doc.setTextColor(255, 255, 255);
  doc.setFont('helvetica', 'bold');
  doc.text('SIMULATED DATA — FOR DEMONSTRATION ONLY', pageWidth/2, yPos - 6, { align: 'center' });
  
  yPos += 2;
  doc.setFontSize(7);
  doc.setTextColor(100, 116, 139);
  doc.setFont('helvetica', 'normal');
  doc.text('This certificate demonstrates cryptographic verification capabilities using SIMULATED DATA. All signatures are BLAKE3-hashed', pageWidth/2, yPos, { align: 'center' });
  doc.text('and chained into an immutable Merkle tree. Production certificates will use real attestation data.', pageWidth/2, yPos + 3.5, { align: 'center' });
  doc.text('This document demonstrates mathematical proof capabilities — not a real compliance certificate.', pageWidth/2, yPos + 7, { align: 'center' });
  
  doc.setFontSize(7);
  doc.setFont('helvetica', 'bold');
  doc.setTextColor(50, 130, 184);
  doc.text('Atomic Trust™ - The Git of Governance™ | Trust Decays. Credentials Lie. Delta Catches Both.', pageWidth/2, pageHeight - 5, { align: 'center' });
  
  // Save the PDF
  const filename = `Attestation_${attestationId}_${attestation.attestedAt}_SIMULATED.pdf`;
  doc.save(filename);
  
  // Log to audit trail
  logAuditEntry('PDF_CERTIFICATE_GENERATED', {
    attestationId: attestationId,
    filename: filename,
    timestamp: new Date().toISOString(),
    merkleRoot: attestation.merkleRoot,
    demoMode: true
  });
  
  showToast(`📄 Demo certificate downloaded: ${filename}`, 'success');
}

// ---- ATTESTATION WORKFLOW FUNCTIONS ----

function showAttestNowModal() {
  const body = `
    <div style="text-align: center; margin-bottom: 24px;">
      <div style="width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, var(--brand), var(--brand-dark)); margin: 0 auto 16px; display: flex; align-items: center; justify-content: center;">
        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
          <polyline points="22,4 12,14.01 9,11.01"/>
        </svg>
      </div>
      <h3 style="margin: 0 0 8px 0; font-size: 20px; font-weight: 800;">Attestation Workflow</h3>
      <p style="margin: 0; font-size: 14px; color: var(--text-secondary);">
        Multi-party cryptographic attestation with immutable audit trail
      </p>
    </div>

    <div style="padding: 20px; background: var(--bg-secondary); border-radius: 12px; margin-bottom: 20px;">
      <div style="font-weight: 700; font-size: 14px; margin-bottom: 16px;">Select Control to Attest</div>
      <select style="width: 100%; padding: 12px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px; background: white;">
        <option>UCP-001 — Access Control Policy</option>
        <option>UCP-003 — Incident Response Plan</option>
        <option>UCP-010 — Third-Party Risk Assessment</option>
        <option>UCP-015 — Access Review Process</option>
      </select>
    </div>

    <div style="padding: 20px; background: var(--brand-light); border-radius: 12px; border: 2px solid var(--brand); margin-bottom: 20px;">
      <div style="font-weight: 700; font-size: 13px; margin-bottom: 12px; color: var(--brand);">🔐 CRYPTOGRAPHIC SIGNATURE</div>
      <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.6; margin-bottom: 14px;">
        Your signature will be hashed with BLAKE3 and chained into the Merkle tree. This attestation becomes part of the immutable audit trail.
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 12px;">
        <div>
          <div style="font-weight: 600; color: var(--text-tertiary); margin-bottom: 4px;">Signing As:</div>
          <div style="font-weight: 700;">Sarah Chen (Admin)</div>
        </div>
        <div>
          <div style="font-weight: 600; color: var(--text-tertiary); margin-bottom: 4px;">Snapshot Block:</div>
          <div style="font-weight: 700; font-family: 'IBM Plex Mono', monospace;">847</div>
        </div>
      </div>
    </div>

    <div style="padding: 16px; background: var(--amber-light); border-radius: 8px; border-left: 3px solid var(--amber);">
      <div style="font-size: 11px; font-weight: 700; color: var(--amber); margin-bottom: 4px;">⚠️ ATTESTATION REQUIREMENTS</div>
      <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.6;">
        • You certify that the control is implemented and operating effectively<br>
        • You have reviewed all evidence and found it sufficient<br>
        • Your signature will be cryptographically verified and cannot be revoked
      </div>
    </div>
  `;

  openModal('Attest Control', body, `
    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
    <button class="btn btn-primary" onclick="closeModal(); executeAttestation();">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
        <polyline points="22,4 12,14.01 9,11.01"/>
      </svg>
      Sign Attestation
    </button>
  `);
}

function executeAttestation() {
  // Generate attestation hash
  const attestationHash = generateHash({
    signer: 'Sarah Chen',
    role: 'Administrator',
    control: 'UCP-001',
    timestamp: new Date().toISOString(),
    snapshotBlock: 847
  });

  // Log the attestation
  logAuditEntry('ATTESTATION_SIGNED', {
    control: 'UCP-001',
    signer: 'Sarah Chen',
    role: 'Administrator',
    signatureHash: attestationHash,
    snapshotBlock: 847
  });

  // Show success modal
  const body = `
    <div style="text-align: center;">
      <div style="width: 80px; height: 80px; border-radius: 50%; background: var(--green); margin: 0 auto 16px; display: flex; align-items: center; justify-content: center;">
        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3">
          <polyline points="20,6 9,17 4,12"/>
        </svg>
      </div>
      <h3 style="margin: 0 0 8px 0; font-size: 20px; font-weight: 800; color: var(--green);">Attestation Signed Successfully</h3>
      <p style="margin: 0 0 20px 0; font-size: 14px; color: var(--text-secondary);">
        Your signature has been cryptographically verified and logged to the immutable audit trail
      </p>

      <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 16px; text-align: left;">
        <div style="display: grid; gap: 12px; font-size: 13px;">
          <div style="display: flex; justify-content: space-between;">
            <span style="color: var(--text-tertiary);">Control:</span>
            <span style="font-weight: 700;">UCP-001</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span style="color: var(--text-tertiary);">Signer:</span>
            <span style="font-weight: 700;">Sarah Chen (Admin)</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span style="color: var(--text-tertiary);">Snapshot Block:</span>
            <span style="font-weight: 700; font-family: 'IBM Plex Mono', monospace;">847</span>
          </div>
        </div>
      </div>

      <div style="padding: 14px; background: var(--green-light); border-radius: 8px; border-left: 3px solid var(--green);">
        <div style="font-size: 10px; font-weight: 700; color: var(--green); margin-bottom: 6px; text-transform: uppercase;">Signature Hash</div>
        <div style="font-family: 'IBM Plex Mono', monospace; font-size: 11px; color: var(--text-primary); word-break: break-all; cursor: pointer;" onclick="copyHash('${attestationHash}')" title="Click to copy">
          ${attestationHash}
        </div>
      </div>
    </div>
  `;

  setTimeout(() => {
    openModal('Attestation Complete', body, `
      <button class="btn btn-secondary" onclick="closeModal(); showView('attestations');">View All Attestations</button>
      <button class="btn btn-primary" onclick="closeModal();">Done</button>
    `);
    showToast('✓ Attestation signed and logged', 'success');
  }, 300);
}

function signAttestation(attestationId) {
  // Show signing modal
  const body = `
    <div style="text-align: center; margin-bottom: 20px;">
      <div style="font-size: 18px; font-weight: 800; margin-bottom: 8px;">Sign Attestation</div>
      <div style="font-family: 'IBM Plex Mono', monospace; font-size: 13px; color: var(--brand);">${attestationId}</div>
    </div>

    <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 16px;">
      <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.6;">
        By signing this attestation, you certify that:<br><br>
        ✓ The control is implemented and operating effectively<br>
        ✓ All required evidence has been reviewed and is sufficient<br>
        ✓ The control meets the requirements of applicable frameworks<br><br>
        Your digital signature will be cryptographically hashed and become part of the immutable audit trail.
      </div>
    </div>

    <div style="padding: 14px; background: var(--brand-light); border-radius: 8px; border-left: 3px solid var(--brand);">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 12px;">
        <div>
          <div style="font-weight: 600; color: var(--text-tertiary); margin-bottom: 4px;">Signing As:</div>
          <div style="font-weight: 700;">Sarah Chen</div>
        </div>
        <div>
          <div style="font-weight: 600; color: var(--text-tertiary); margin-bottom: 4px;">Role:</div>
          <div style="font-weight: 700;">Administrator</div>
        </div>
      </div>
    </div>
  `;

  openModal('Digital Signature Required', body, `
    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
    <button class="btn btn-primary" onclick="closeModal(); executeSignature('${attestationId}');">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
      </svg>
      Sign Now
    </button>
  `);
}

function executeSignature(attestationId) {
  const signatureHash = generateHash({
    attestationId,
    signer: 'Sarah Chen',
    timestamp: new Date().toISOString()
  });

  logAuditEntry('ATTESTATION_SIGNATURE_ADDED', {
    attestationId,
    signer: 'Sarah Chen',
    signatureHash
  });

  showToast(`✓ Signature added to ${attestationId}`, 'success');
  
  // Refresh view
  setTimeout(() => showView('attestations'), 500);
}

function verifyAttestation(attestationId) {
  const body = `
    <div style="text-align: center; margin-bottom: 24px;">
      <div style="width: 80px; height: 80px; border-radius: 50%; background: var(--green); margin: 0 auto 16px; display: flex; align-items: center; justify-content: center;">
        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3">
          <polyline points="20,6 9,17 4,12"/>
        </svg>
      </div>
      <h3 style="margin: 0 0 8px 0; font-size: 20px; font-weight: 800; color: var(--green);">Attestation Verified</h3>
      <div style="font-family: 'IBM Plex Mono', monospace; font-size: 13px; color: var(--brand);">${attestationId}</div>
    </div>

    <div style="padding: 16px; background: var(--green-light); border-radius: 8px; border-left: 3px solid var(--green); margin-bottom: 16px;">
      <div style="font-weight: 700; font-size: 13px; color: var(--green); margin-bottom: 8px;">✓ Cryptographic Verification Passed</div>
      <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.6;">
        • All digital signatures verified against Merkle tree<br>
        • Attestation hash matches snapshot state<br>
        • No tampering detected in audit chain<br>
        • Multi-party signatures validated
      </div>
    </div>

    <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
      <div style="font-weight: 700; font-size: 13px; margin-bottom: 12px;">Verification Details</div>
      <div style="display: grid; gap: 10px; font-size: 12px;">
        <div style="display: flex; justify-content: space-between; padding-bottom: 10px; border-bottom: 1px solid var(--border-light);">
          <span style="color: var(--text-tertiary);">Signatures Verified:</span>
          <span style="font-weight: 700; color: var(--green);">2/2 Valid</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding-bottom: 10px; border-bottom: 1px solid var(--border-light);">
          <span style="color: var(--text-tertiary);">Merkle Root:</span>
          <span style="font-weight: 700; font-family: 'IBM Plex Mono', monospace;">Valid</span>
        </div>
        <div style="display: flex; justify-content: space-between; padding-bottom: 10px; border-bottom: 1px solid var(--border-light);">
          <span style="color: var(--text-tertiary);">Snapshot Block:</span>
          <span style="font-weight: 700; font-family: 'IBM Plex Mono', monospace;">846</span>
        </div>
        <div style="display: flex; justify-content: space-between;">
          <span style="color: var(--text-tertiary);">Verification Time:</span>
          <span style="font-weight: 700;">${new Date().toLocaleTimeString()}</span>
        </div>
      </div>
    </div>
  `;

  openModal('Verification Result', body, `
    <button class="btn btn-secondary" onclick="closeModal(); generateAttestationPDF('${attestationId}')">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
        <polyline points="7 10 12 15 17 10"/>
        <line x1="12" y1="15" x2="12" y2="3"/>
      </svg>
      Download PDF Certificate
    </button>
    <button class="btn btn-primary" onclick="closeModal()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="20,6 9,17 4,12"/>
      </svg>
      Verified
    </button>
  `);
}

function showAttestationDetail(attestationId) {
  showToast(`Opening ${attestationId} detail view...`, 'info');
}

// ---- ADVANCED FEATURES MODALS ----

function showCollaboration() {
  const activeUsers = [
    { name: 'Sarah Chen', role: 'Admin', avatar: 'SC', color: 'var(--brand)', action: 'Editing Control UCP-003', lastActive: 'Just now', status: 'active' },
    { name: 'Marcus Rivera', role: 'CISO', avatar: 'MR', color: '#10B981', action: 'Reviewing evidence on UCP-007', lastActive: '2 min ago', status: 'active' },
    { name: 'Elena Petrov', role: 'Compliance Mgr', avatar: 'EP', color: '#F59E0B', action: 'Uploading SOC2 attestation', lastActive: '5 min ago', status: 'idle' }
  ];

  const body = `
    <div style="margin-bottom: 20px;">
      <div style="display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--green-light); border-radius: 12px; border-left: 4px solid var(--green);">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
          <circle cx="9" cy="7" r="4"/>
          <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
          <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
        </svg>
        <div style="flex: 1;">
          <div style="font-weight: 700; color: var(--green); margin-bottom: 2px; font-size: 14px;">Real-Time Collaboration Active</div>
          <div style="font-size: 12px; color: var(--text-secondary);">${activeUsers.length} team members working on governance controls</div>
        </div>
      </div>
    </div>

    <div style="font-size: 14px; font-weight: 700; margin-bottom: 12px;">Active Team Members</div>
    <div style="display: grid; gap: 12px;">
      ${activeUsers.map(user => `
        <div style="padding: 14px; background: var(--bg-secondary); border-radius: 10px; display: flex; align-items: center; gap: 12px; border-left: 3px solid ${user.color};">
          <div style="position: relative;">
            <div style="width: 40px; height: 40px; border-radius: 50%; background: ${user.color}; display: flex; align-items: center; justify-content: center; color: white; font-weight: 800; font-size: 14px;">
              ${user.avatar}
            </div>
            <div style="position: absolute; bottom: 0; right: 0; width: 12px; height: 12px; background: ${user.status === 'active' ? 'var(--green)' : 'var(--amber)'}; border: 2px solid white; border-radius: 50%;"></div>
          </div>
          <div style="flex: 1;">
            <div style="font-weight: 700; font-size: 14px; margin-bottom: 2px;">${user.name}</div>
            <div style="font-size: 11px; color: var(--text-tertiary); margin-bottom: 4px;">${user.role}</div>
            <div style="font-size: 12px; color: var(--text-secondary);">${user.action}</div>
          </div>
          <div style="text-align: right; font-size: 11px; color: var(--text-tertiary);">${user.lastActive}</div>
        </div>
      `).join('')}
    </div>

    <div style="margin-top: 20px; padding: 14px; background: var(--brand-light); border-radius: 8px; border: 1px solid var(--brand)20;">
      <div style="font-size: 12px; font-weight: 600; color: var(--brand); margin-bottom: 6px;">✨ Live Features</div>
      <div style="font-size: 11px; color: var(--text-secondary); line-height: 1.6;">
        • See who's editing in real-time<br>
        • Automatic conflict detection<br>
        • Live cursor tracking<br>
        • Presence indicators<br>
        • Collaborative comments & threads
      </div>
    </div>
  `;

  openModal('Real-Time Collaboration', body, `
    <button class="btn btn-secondary" onclick="closeModal()">Close</button>
    <button class="btn btn-primary" onclick="closeModal(); showToast('Collaboration features enabled', 'success');">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="20,6 9,17 4,12"/>
      </svg>
      Enable Notifications
    </button>
  `);
}

function showConsensus() {
  const llmVotes = [
    { model: 'Claude Sonnet 4.5', vote: 'Compliant', confidence: 0.94, color: 'var(--green)', reasoning: 'All 12 evidence items verified. Policy documentation complete. Implementation matches requirements.' },
    { model: 'GPT-4o', vote: 'Compliant', confidence: 0.91, color: 'var(--green)', reasoning: 'Access controls properly configured. Audit logs enabled. MFA enforced across all systems.' },
    { model: 'Gemini 1.5 Pro', vote: 'Compliant', confidence: 0.93, color: 'var(--green)', reasoning: 'Control objectives met. Evidence freshness acceptable. No gaps identified in coverage.' },
    { model: 'LLaMA 3.1 405B', vote: 'Compliant', confidence: 0.89, color: 'var(--green)', reasoning: 'Technical implementation verified. Policy aligns with SOC2 Type II requirements. Recommendation: refresh Ψ evidence in 30 days.' }
  ];

  const avgConfidence = (llmVotes.reduce((sum, v) => sum + v.confidence, 0) / llmVotes.length).toFixed(3);
  const consensus = llmVotes.every(v => v.vote === 'Compliant') ? 'UNANIMOUS' : 'MAJORITY';

  const body = `
    <div style="margin-bottom: 20px;">
      <div style="text-align: center; padding: 24px; background: linear-gradient(135deg, var(--brand)10, var(--brand)05); border-radius: 12px; border: 2px solid var(--brand);">
        <div style="font-size: 48px; margin-bottom: 12px;">✓</div>
        <div style="font-size: 20px; font-weight: 800; color: var(--brand); margin-bottom: 8px;">${consensus} CONSENSUS</div>
        <div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 16px;">4/4 LLMs agree on control state</div>
        <div style="display: inline-block; padding: 8px 16px; background: var(--brand); color: white; border-radius: 8px; font-family: 'IBM Plex Mono', monospace; font-weight: 700;">
          ${(avgConfidence * 100).toFixed(1)}% Avg Confidence
        </div>
      </div>
    </div>

    <div style="font-size: 14px; font-weight: 700; margin-bottom: 12px;">Multi-LLM Verification Results</div>
    <div style="display: grid; gap: 12px; margin-bottom: 20px;">
      ${llmVotes.map(llm => `
        <div style="padding: 14px; background: var(--bg-secondary); border-radius: 10px; border-left: 3px solid ${llm.color};">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
            <div>
              <div style="font-weight: 700; font-size: 13px; margin-bottom: 4px;">${llm.model}</div>
              <div style="display: flex; align-items: center; gap: 8px;">
                <span style="padding: 3px 10px; background: ${llm.color}20; color: ${llm.color}; border-radius: 6px; font-size: 11px; font-weight: 700; text-transform: uppercase;">${llm.vote}</span>
                <span style="font-size: 12px; font-family: 'IBM Plex Mono', monospace; color: var(--text-tertiary);">${(llm.confidence * 100).toFixed(1)}%</span>
              </div>
            </div>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="${llm.color}" stroke-width="2.5">
              <polyline points="20,6 9,17 4,12"/>
            </svg>
          </div>
          <div style="font-size: 11px; color: var(--text-secondary); line-height: 1.5; font-style: italic;">
            "${llm.reasoning}"
          </div>
        </div>
      `).join('')}
    </div>

    <div style="padding: 14px; background: var(--brand-light); border-radius: 8px; border: 1px solid var(--brand)20;">
      <div style="font-size: 12px; font-weight: 600; color: var(--brand); margin-bottom: 6px;">🤖 Why Multi-LLM Consensus?</div>
      <div style="font-size: 11px; color: var(--text-secondary); line-height: 1.6;">
        • **Byzantine Fault Tolerance**: No single AI can manipulate assessments<br>
        • **Diverse Reasoning**: Different models catch different edge cases<br>
        • **Confidence Calibration**: Agreement across models = higher trust<br>
        • **Bias Reduction**: Multiple AI perspectives reduce individual model bias
      </div>
    </div>
  `;

  openModal('Multi-LLM Consensus Verification', body, `
    <button class="btn btn-secondary" onclick="closeModal()">Close</button>
    <button class="btn btn-primary" onclick="closeModal(); showToast('Consensus logged with hash', 'success');">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
      </svg>
      Export Verification
    </button>
  `);
}

function showByzantineDetector() {
  const divergenceControls = CONTROLS.filter(c => c.delta > 0.15);
  
  const body = `
    <div style="margin-bottom: 20px;">
      <div style="padding: 20px; background: var(--red-light); border-radius: 12px; border: 2px solid var(--red);">
        <div style="display: flex; align-items: center; gap: 12px;">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--red)" stroke-width="2">
            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
            <line x1="12" y1="9" x2="12" y2="13"/>
            <line x1="12" y1="17" x2="12.01" y2="17"/>
          </svg>
          <div style="flex: 1;">
            <h3 style="margin: 0 0 4px 0; font-size: 18px; font-weight: 800; color: var(--red);">${divergenceControls.length} Byzantine Fault${divergenceControls.length > 1 ? 's' : ''} Detected</h3>
            <p style="margin: 0; font-size: 13px; color: var(--text-secondary);">
              Voter disagreement detected (Δ > 0.15) — requires investigation
            </p>
          </div>
        </div>
      </div>
    </div>

    <div style="font-size: 14px; font-weight: 700; margin-bottom: 8px;">What is Byzantine Fault Detection?</div>
    <div style="padding: 14px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 16px;">
      <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.6;">
        When voters disagree significantly on a control's state, it indicates one of three problems:
        <br><br>
        <strong>1. Political Gridlock</strong> — Different stakeholders have conflicting views<br>
        <strong>2. Misaligned Expectations</strong> — Unclear requirements or success criteria<br>
        <strong>3. Actual Security Gap</strong> — Real compliance issue being disputed
        <br><br>
        High Δ (divergence) triggers mandatory resolution workflow.
      </div>
    </div>

    <div style="font-size: 14px; font-weight: 700; margin-bottom: 12px;">Controls Requiring Resolution</div>
    <div style="display: grid; gap: 10px; max-height: 300px; overflow-y: auto;">
      ${divergenceControls.map(c => `
        <div style="padding: 14px; background: ${c.delta > 0.20 ? 'var(--red-light)' : 'var(--amber-light)'}; border-radius: 8px; border-left: 4px solid ${c.delta > 0.20 ? 'var(--red)' : 'var(--amber)'}; cursor: pointer;" onclick="closeModal(); STATE.selectedControl = '${c.id}'; showView('control-detail');">
          <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
            <div>
              <div style="font-weight: 700; font-size: 14px; margin-bottom: 4px;">${c.id} — ${c.name}</div>
              <div style="font-size: 11px; color: var(--text-tertiary);">Frameworks: ${c.frameworks.join(', ')}</div>
            </div>
            <div style="text-align: right;">
              <div style="font-size: 20px; font-weight: 800; font-family: 'IBM Plex Mono', monospace; color: var(--red);">Δ ${c.delta.toFixed(3)}</div>
              <div style="font-size: 10px; color: var(--text-tertiary); text-transform: uppercase;">${c.delta > 0.20 ? 'CRITICAL' : 'HIGH'}</div>
            </div>
          </div>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
            <div style="font-size: 11px;">
              <span style="color: #10B981; font-weight: 700;">Φ</span> ${c.phi.toFixed(2)}
            </div>
            <div style="font-size: 11px;">
              <span style="color: #F59E0B; font-weight: 700;">Ψ</span> ${c.psi.toFixed(2)}
            </div>
            <div style="font-size: 11px;">
              <span style="color: var(--text-secondary); font-weight: 700;">T</span> ${c.trust.toFixed(2)}
            </div>
          </div>
        </div>
      `).join('')}
    </div>

    <div style="margin-top: 16px; padding: 14px; background: var(--brand-light); border-radius: 8px; border: 1px solid var(--brand)20;">
      <div style="font-size: 12px; font-weight: 600; color: var(--brand); margin-bottom: 6px;">⚡ Automatic Resolution Workflow</div>
      <div style="font-size: 11px; color: var(--text-secondary); line-height: 1.6;">
        When Δ > 0.18, system automatically:
        <br>
        • Flags control for stakeholder review<br>
        • Creates discussion thread for voters<br>
        • Schedules resolution meeting<br>
        • Logs disagreement in audit trail<br>
        • Prevents attestation until resolved
      </div>
    </div>
  `;

  openModal('Byzantine Fault Detection', body, `
    <button class="btn btn-secondary" onclick="closeModal()">Close</button>
    <button class="btn btn-primary" onclick="closeModal(); showToast('Resolution workflow initiated', 'success');">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
        <polyline points="14,2 14,8 20,8"/>
      </svg>
      Start Resolution
    </button>
  `);
}

// ---- RBAC ROLE SIMULATION ----

function simulateRoleSwitch(role) {
  const roleNames = {
    'admin': 'Administrator',
    'ciso': 'Chief Information Security Officer',
    'auditor': 'External Auditor',
    'compliance': 'Compliance Manager',
    'analyst': 'Security Analyst',
    'viewer': 'Read-Only Viewer'
  };
  
  const roleEmojis = {
    'admin': '👑',
    'ciso': '🛡️',
    'auditor': '📋',
    'compliance': '✓',
    'analyst': '📊',
    'viewer': '👁️'
  };
  
  // Remove active class from all badges
  document.querySelectorAll('.role-badge').forEach(badge => {
    badge.classList.remove('active');
  });
  
  // Add active class to clicked badge
  event.currentTarget.classList.add('active');
  
  // Update user profile header
  const userRoleElement = document.querySelector('.user-role');
  userRoleElement.textContent = roleNames[role];
  
  // Log the role switch
  logAuditEntry('ROLE_SWITCHED', {
    fromRole: 'Administrator',
    toRole: roleNames[role],
    timestamp: new Date().toISOString(),
    simulated: true
  });
  
  // Show toast notification
  showToast(`Role switched to ${roleNames[role]} ${roleEmojis[role]}`, 'info');
  
  // Show informational modal about what changed
  const body = `
    <div style="text-align: center; padding: 20px;">
      <div style="width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, var(--brand), var(--brand-dark)); margin: 0 auto 20px; display: flex; align-items: center; justify-content: center;">
        <span style="font-size: 40px;">${roleEmojis[role]}</span>
      </div>
      <h3 style="margin: 0 0 12px 0; font-size: 20px; font-weight: 700;">Role Switch Simulation</h3>
      <p style="margin: 0 0 24px 0; font-size: 14px; color: var(--text-secondary);">
        You are now viewing the system as: <strong>${roleNames[role]}</strong>
      </p>
      
      <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; margin-bottom: 20px; text-align: left;">
        <div style="font-size: 11px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 8px; text-transform: uppercase;">In a Production System:</div>
        <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.6;">
          • UI elements would hide based on permissions<br>
          • API calls would enforce server-side authorization<br>
          • Audit logs would track all role-based actions<br>
          • JWT tokens would encode role claims<br>
          • RBAC policies enforced at database level
        </div>
      </div>

      <div style="background: var(--brand-light); padding: 12px; border-radius: 8px; border-left: 3px solid var(--brand);">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--brand)" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
          <circle cx="12" cy="12" r="10"/>
          <line x1="12" y1="16" x2="12" y2="12"/>
          <line x1="12" y1="8" x2="12.01" y2="8"/>
        </svg>
        <span style="font-size: 12px; font-weight: 600; color: var(--brand);">
          This is a demo. In production, role permissions are enforced server-side with cryptographic verification.
        </span>
      </div>
    </div>
  `;
  
  openModal('Role-Based Access Control', body, `
    <button class="btn btn-secondary" onclick="closeModal()">Close</button>
    <button class="btn btn-primary" onclick="closeModal();">
      Continue as ${roleNames[role]}
    </button>
  `);
}

// ---- TOAST NOTIFICATIONS ----

function showToast(message, type = 'info') {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  
  const icon = type === 'success' ? '✓' : type === 'error' ? '✕' : 'ℹ';
  
  toast.innerHTML = `
    <div class="toast-icon">${icon}</div>
    <div class="toast-message">${message}</div>
  `;
  
  container.appendChild(toast);
  
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateX(100px)';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// ---- ACTION FUNCTIONS ----

function createSnapshot() {
  showToast('Creating snapshot...', 'info');
  setTimeout(() => {
    showToast('Snapshot 848 created successfully', 'success');
  }, 1500);
}

function verifySnapshot(id) {
  showToast(`Verifying snapshot ${id}...`, 'info');
  setTimeout(() => {
    showToast(`Snapshot ${id} verified ✓`, 'success');
  }, 1000);
}

function uploadEvidence(controlId) {
  // Use the real upload modal with control pre-selected
  simulateEvidenceUpload(controlId);
}

function addDiscussionEntry(controlId) {
  const input = document.getElementById('discussionInput');
  if (!input || !input.value.trim()) {
    showToast('Please enter a comment', 'error');
    return;
  }
  
  const content = input.value.trim();
  const user = 'Sarah Chen';
  const initials = user.split(' ').map(n => n[0]).join('');
  
  // Create the discussion entry
  const entry = {
    type: 'comment',
    author: user,
    initials: initials,
    content: content,
    time: new Date().toISOString(),
    hash: null
  };
  
  // Generate hash for the entry
  entry.hash = generateHash(entry);
  
  // Add to DISCUSSIONS array (create if not exists)
  if (!DISCUSSIONS[controlId]) {
    DISCUSSIONS[controlId] = [];
  }
  DISCUSSIONS[controlId].push(entry);
  
  // Also add to STATE.comments for persistence
  addComment('control', controlId, content);
  
  // Clear input
  input.value = '';
  
  // Log to audit trail (this will show the commit toast)
  logAuditEntry('COMMENT_ADDED', {
    controlId: controlId,
    commentHash: entry.hash,
    preview: content.substring(0, 50)
  });
  
  // Refresh the control detail view
  showView('control-detail');
}

function generateRecommendations() {
  return [
    {
      id: 'REC-001',
      control: 'UCP-005',
      title: 'Update Vendor Risk Assessments',
      type: 'decay',
      priority: 'high',
      description: 'Vendor security assessments are 180+ days old. Evidence credibility has decayed significantly (Ψ = 0.62).',
      action: 'Request updated SOC2 reports from critical vendors (AWS, Stripe, Okta). Upload to evidence vault.',
      evidence: ['Vendor security questionnaire', 'SOC2 Type II reports', 'Penetration test results'],
      impact: {
        trustGain: 0.23,
        timeEstimate: '3-5 days',
        effort: 'medium'
      }
    },
    {
      id: 'REC-002',
      control: 'UCP-003',
      title: 'Resolve Incident Response Divergence',
      type: 'divergence',
      description: 'Voters disagree on incident response readiness (Δ = 0.18). Some team members report gaps in runbook coverage.',
      action: 'Conduct tabletop exercise to validate runbook. Address identified gaps and re-vote.',
      evidence: ['Tabletop exercise report', 'Updated runbooks', 'Team acknowledgments'],
      impact: {
        trustGain: 0.15,
        timeEstimate: '1 week',
        effort: 'high'
      }
    },
    {
      id: 'REC-003',
      control: 'UCP-001',
      title: 'Refresh Access Review Documentation',
      type: 'evidence',
      description: 'Missing recent access review logs. Current documentation is 45 days old.',
      action: 'Run quarterly access review. Export Okta logs and privilege escalation audit trail.',
      evidence: ['Access review report', 'Okta audit logs', 'Privilege change log'],
      impact: {
        trustGain: 0.08,
        timeEstimate: '1-2 days',
        effort: 'low'
      }
    }
  ];
}

function startRecommendation(recId) {
  const recommendations = generateRecommendations();
  const rec = recommendations.find(r => r.id === recId);
  if (!rec) return;
  
  openModal(`Start: ${rec.title}`, `
    <div style="margin-bottom: 20px;">
      <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 16px;">
        <span class="control-id">${rec.control}</span>
        <span style="padding: 4px 12px; background: ${rec.type === 'divergence' ? 'rgba(0, 212, 170, 0.15)' : 'rgba(50, 130, 184, 0.15)'}; color: ${rec.type === 'divergence' ? 'var(--delta)' : 'var(--psi)'}; border-radius: 6px; font-size: 11px; font-weight: 700; text-transform: uppercase;">${rec.type}</span>
      </div>
      <p style="color: var(--text-secondary); line-height: 1.6; margin-bottom: 20px;">${rec.description}</p>
    </div>
    
    <div style="background: var(--bg-secondary); padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid var(--brand);">
      <div style="font-size: 12px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.05em;">Recommended Action</div>
      <p style="font-size: 13px; line-height: 1.6;">${rec.action}</p>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px;">
      <div style="text-align: center; padding: 16px; background: var(--green-light); border-radius: 12px;">
        <div style="font-size: 24px; font-weight: 800; color: var(--green); margin-bottom: 4px;">+${rec.impact.trustGain.toFixed(2)}</div>
        <div style="font-size: 11px; color: var(--green); font-weight: 700; text-transform: uppercase;">Trust Gain</div>
      </div>
      <div style="text-align: center; padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
        <div style="font-size: 18px; font-weight: 700; margin-bottom: 4px;">${rec.impact.timeEstimate}</div>
        <div style="font-size: 11px; color: var(--text-tertiary); font-weight: 600; text-transform: uppercase;">Time Est.</div>
      </div>
      <div style="text-align: center; padding: 16px; background: var(--bg-secondary); border-radius: 12px;">
        <div style="font-size: 18px; font-weight: 700; margin-bottom: 4px; text-transform: capitalize;">${rec.impact.effort}</div>
        <div style="font-size: 11px; color: var(--text-tertiary); font-weight: 600; text-transform: uppercase;">Effort</div>
      </div>
    </div>
    
    <div style="font-size: 12px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.05em;">Quick Actions</div>
    <div style="display: flex; flex-direction: column; gap: 10px;">
      ${rec.type === 'evidence' || rec.type === 'decay' ? `
        <button class="btn btn-secondary" style="justify-content: flex-start;" onclick="closeModal(); uploadEvidence('${rec.control}')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="17,8 12,3 7,8"/>
            <line x1="12" y1="3" x2="12" y2="15"/>
          </svg>
          Upload Evidence for ${rec.control}
        </button>
      ` : ''}
      <button class="btn btn-secondary" style="justify-content: flex-start;" onclick="closeModal(); viewControl('${rec.control}')">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
          <circle cx="12" cy="12" r="3"/>
        </svg>
        View Control Details
      </button>
    </div>
  `, `
    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
    <button class="btn btn-primary" onclick="closeModal(); showToast('Recommendation marked as in progress', 'success')">Mark as In Progress</button>
  `);
}

function filterRecommendations(filter) {
  document.querySelectorAll('.forecast-filter').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  showToast(`Showing ${filter} recommendations`, 'info');
}

function runForecastSimulation() {
  openModal('Monte Carlo Simulation', `
    <div style="text-align: center; padding: 32px 24px;">
      <div style="font-size: 56px; margin-bottom: 20px;">🔮</div>
      <div style="font-size: 18px; font-weight: 700; margin-bottom: 10px;">Running Trust Forecast</div>
      <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 32px; line-height: 1.6;">
        Analyzing 1,000 possible trust trajectories based on current recommendations...
      </div>
      
      <div style="background: var(--bg-secondary); border-radius: 16px; padding: 28px; margin-bottom: 28px; border: 1px solid var(--border-light);">
        <div style="display: flex; justify-content: space-around;">
          <div>
            <div style="font-size: 11px; color: var(--text-tertiary); margin-bottom: 6px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">P10 (Pessimistic)</div>
            <div style="font-size: 32px; font-weight: 800; color: var(--amber); font-family: 'IBM Plex Mono', monospace;">0.91</div>
          </div>
          <div>
            <div style="font-size: 11px; color: var(--text-tertiary); margin-bottom: 6px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">P50 (Expected)</div>
            <div style="font-size: 32px; font-weight: 800; color: var(--brand); font-family: 'IBM Plex Mono', monospace;">0.94</div>
          </div>
          <div>
            <div style="font-size: 11px; color: var(--text-tertiary); margin-bottom: 6px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;">P90 (Optimistic)</div>
            <div style="font-size: 32px; font-weight: 800; color: var(--green); font-family: 'IBM Plex Mono', monospace;">0.97</div>
          </div>
        </div>
      </div>
      
      <div style="font-size: 14px; color: var(--text-secondary); line-height: 1.6;">
        <strong style="font-weight: 700; color: var(--text-primary);">87% confidence</strong> of reaching target trust (0.95) within 14 days if all high-priority recommendations are completed.
      </div>
    </div>
  `, `
    <button class="btn btn-secondary" onclick="closeModal()">Close</button>
    <button class="btn btn-primary" onclick="closeModal(); showToast('Forecast plan exported', 'success')">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
        <polyline points="7,10 12,15 17,10"/>
        <line x1="12" y1="15" x2="12" y2="3"/>
      </svg>
      Export Plan
    </button>
  `);
}

// ---- EVIDENCE MANAGEMENT FUNCTIONS ----

// Track selected file for upload
let selectedUploadFile = null;

function simulateEvidenceUpload(preselectedControlId = null) {
  selectedUploadFile = null;
  const controls = getControls();

  openModal('Upload Evidence', `
    <div style="padding: 20px;">
      <div style="margin-bottom: 24px;">
        <label style="display: block; font-weight: 700; font-size: 13px; margin-bottom: 8px; color: var(--text-primary);">
          Select File
        </label>
        <input type="file" id="evidenceFileInput" style="display: none;" accept=".pdf,.docx,.doc,.xlsx,.xls,.png,.jpg,.jpeg,.json,.csv,.txt" onchange="handleFileSelect(this)">
        <div id="fileDropZone" style="border: 2px dashed var(--border-light); border-radius: 12px; padding: 40px; text-align: center; background: var(--bg-secondary); cursor: pointer; transition: all 0.2s ease;" onclick="document.getElementById('evidenceFileInput').click()">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--text-tertiary)" stroke-width="2" style="margin: 0 auto 12px;">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="17 8 12 3 7 8"/>
            <line x1="12" y1="3" x2="12" y2="15"/>
          </svg>
          <div id="fileDropText" style="font-weight: 700; font-size: 15px; margin-bottom: 6px; color: var(--text-primary);">Click to browse or drag and drop</div>
          <div id="fileDropSubtext" style="font-size: 13px; color: var(--text-secondary);">PDF, DOCX, PNG, JPG, JSON, CSV (max 50MB)</div>
        </div>
      </div>

      <div style="margin-bottom: 24px;">
        <label style="display: block; font-weight: 700; font-size: 13px; margin-bottom: 8px; color: var(--text-primary);">
          Link to Control <span style="color: var(--red);">*</span>
        </label>
        <select id="uploadControlSelect" style="width: 100%; padding: 12px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px; font-family: 'Inter', sans-serif;">
          <option value="">Select a control...</option>
          ${controls.map(c => `<option value="${c.id}" ${preselectedControlId === c.id ? 'selected' : ''}>${c.id} — ${c.name}</option>`).join('')}
        </select>
      </div>

      <div style="margin-bottom: 24px;">
        <label style="display: block; font-weight: 700; font-size: 13px; margin-bottom: 8px; color: var(--text-primary);">
          Evidence Type <span style="color: var(--red);">*</span>
        </label>
        <select id="uploadTypeSelect" style="width: 100%; padding: 12px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px; font-family: 'Inter', sans-serif;">
          <option value="document">Document</option>
          <option value="screenshot">Screenshot</option>
          <option value="system_export">System Export</option>
          <option value="policy">Policy</option>
          <option value="test_results">Test Results</option>
        </select>
      </div>

      <div style="margin-bottom: 24px;">
        <label style="display: block; font-weight: 700; font-size: 13px; margin-bottom: 8px; color: var(--text-primary);">
          Description
        </label>
        <textarea id="uploadDescription" style="width: 100%; padding: 12px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px; font-family: 'Inter', sans-serif; min-height: 80px; resize: vertical;" placeholder="Describe this evidence..."></textarea>
      </div>

      <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 24px;">
        <div style="font-size: 12px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 8px;">🔒 CRYPTOGRAPHIC VERIFICATION</div>
        <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.6;">
          Upon upload, this file will be:
          <ul style="margin: 8px 0 0 20px; padding: 0;">
            <li>Hashed with BLAKE3 for immutable verification</li>
            <li>Added to Merkle tree for snapshot integrity</li>
            <li>Analyzed by ΦΨΔIPT operators for trust scoring</li>
            <li>Linked to control via cryptographic proof</li>
          </ul>
        </div>
      </div>

      <div id="uploadStatus" style="display: none; padding: 12px; border-radius: 8px; margin-bottom: 16px;"></div>
    </div>
  `, `
    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
    <button id="uploadSubmitBtn" class="btn btn-primary" onclick="submitEvidenceUpload()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
        <polyline points="17 8 12 3 7 8"/>
        <line x1="12" y1="3" x2="12" y2="15"/>
      </svg>
      Upload Evidence
    </button>
  `);

  // Set up drag and drop
  setTimeout(() => {
    const dropZone = document.getElementById('fileDropZone');
    if (dropZone) {
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = 'var(--brand)';
        dropZone.style.background = 'var(--brand-light)';
      });
      dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = 'var(--border-light)';
        dropZone.style.background = 'var(--bg-secondary)';
      });
      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = 'var(--border-light)';
        dropZone.style.background = 'var(--bg-secondary)';
        if (e.dataTransfer.files.length > 0) {
          handleFileSelect({ files: e.dataTransfer.files });
        }
      });
    }
  }, 100);
}

function handleFileSelect(input) {
  const file = input.files[0];
  if (!file) return;

  selectedUploadFile = file;

  // Update UI to show selected file
  const dropText = document.getElementById('fileDropText');
  const dropSubtext = document.getElementById('fileDropSubtext');
  const dropZone = document.getElementById('fileDropZone');

  if (dropText && dropSubtext && dropZone) {
    dropZone.style.borderColor = 'var(--green)';
    dropZone.style.background = 'var(--green-light)';
    dropText.innerHTML = `<span style="color: var(--green);">✓</span> ${file.name}`;
    dropSubtext.textContent = `${(file.size / 1024).toFixed(1)} KB · ${file.type || 'Unknown type'}`;
  }
}

async function submitEvidenceUpload() {
  const controlId = document.getElementById('uploadControlSelect')?.value;
  const evidenceType = document.getElementById('uploadTypeSelect')?.value;
  const description = document.getElementById('uploadDescription')?.value;
  const statusEl = document.getElementById('uploadStatus');
  const submitBtn = document.getElementById('uploadSubmitBtn');

  // Validation
  if (!selectedUploadFile) {
    showUploadStatus('Please select a file to upload', 'error');
    return;
  }
  if (!controlId) {
    showUploadStatus('Please select a control to link this evidence to', 'error');
    return;
  }

  // Show loading state
  if (submitBtn) {
    submitBtn.disabled = true;
    submitBtn.innerHTML = `
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px; animation: spin 1s linear infinite;">
        <circle cx="12" cy="12" r="10" stroke-dasharray="30 70"/>
      </svg>
      Uploading...
    `;
  }
  showUploadStatus('Uploading and hashing file...', 'info');

  // Create FormData
  const formData = new FormData();
  formData.append('file', selectedUploadFile);
  formData.append('control_id', controlId);
  formData.append('type', evidenceType);
  if (description) {
    formData.append('description', description);
  }
  formData.append('date_captured', new Date().toISOString());

  try {
    const response = await fetch(`${CONFIG.apiBase}${CONFIG.endpoints.evidenceUpload}`, {
      method: 'POST',
      body: formData,
      headers: {
        'X-User-Id': 'demo-user'
      }
    });

    const data = await response.json();

    if (response.ok && data.success) {
      showUploadStatus(`Evidence uploaded successfully! ID: ${data.evidence.id}`, 'success');
      
      // Log to audit trail
      logAuditEntry('EVIDENCE_UPLOADED', {
        evidenceId: data.evidence.id,
        controlId: controlId,
        fileName: selectedUploadFile.name,
        fileType: evidenceType,
        hash: data.evidence.hash || generateHash({ file: selectedUploadFile.name, control: controlId })
      });

      // Refresh the evidence cache
      setTimeout(async () => {
        closeModal();

        // Reload API data
        await loadAPIData();

        // Navigate to the control detail view
        viewControl(controlId);
      }, 1500);
    } else {
      throw new Error(data.error || 'Upload failed');
    }
  } catch (err) {
    console.log('[Upload] API unavailable, creating local record');
    
    // Create local evidence record
    const evidenceId = `EV-LOCAL-${Date.now()}`;
    const evidenceHash = generateHash({ file: selectedUploadFile.name, control: controlId, time: Date.now() });
    
    const newEvidence = {
      id: evidenceId,
      title: selectedUploadFile.name,
      name: selectedUploadFile.name,
      type: evidenceType,
      source: 'Local Upload',
      uploadedAt: new Date().toISOString(),
      uploadedBy: 'Sarah Chen',
      hash: `blake3:${evidenceHash.substring(0, 16)}`,
      linkedControls: [controlId],
      controlId: controlId,
      control_id: controlId,
      phi: 0.85,
      psi: 1.0,
      status: 'pending-validation',
      description: description || ''
    };
    
    // Add to EVIDENCE_LIBRARY
    if (typeof EVIDENCE_LIBRARY !== 'undefined') {
      EVIDENCE_LIBRARY.push(newEvidence);
    }
    
    // Add to LIVE_STATE if initialized
    if (window.LIVE_STATE && LIVE_STATE.initialized && LIVE_STATE.evidence) {
      LIVE_STATE.evidence.push({
        ...newEvidence,
        daysOld: 0,
        _original: { phi: newEvidence.phi, psi: newEvidence.psi }
      });
    }
    
    showUploadStatus(`Evidence created locally! ID: ${evidenceId}`, 'success');
    
    // Log to audit trail (this shows the commit toast)
    logAuditEntry('EVIDENCE_UPLOADED', {
      evidenceId: evidenceId,
      controlId: controlId,
      fileName: selectedUploadFile.name,
      fileType: evidenceType,
      hash: newEvidence.hash,
      local: true
    });

    // Refresh UI
    setTimeout(() => {
      closeModal();
      viewControl(controlId);
    }, 1500);
  }
}

function showUploadStatus(message, type) {
  const statusEl = document.getElementById('uploadStatus');
  if (!statusEl) return;

  const colors = {
    info: { bg: 'var(--brand-light)', border: 'var(--brand)', text: 'var(--brand)' },
    success: { bg: 'var(--green-light)', border: 'var(--green)', text: 'var(--green)' },
    error: { bg: 'var(--red-light)', border: 'var(--red)', text: 'var(--red)' }
  };
  const c = colors[type] || colors.info;

  statusEl.style.display = 'block';
  statusEl.style.background = c.bg;
  statusEl.style.borderLeft = `4px solid ${c.border}`;
  statusEl.style.color = c.text;
  statusEl.innerHTML = `<strong>${type === 'error' ? '✗' : type === 'success' ? '✓' : '⋯'}</strong> ${message}`;
}

async function showEvidenceDetail(evidenceId) {
  // Try to find in cached data first, then fetch from API
  let ev = getEvidence().find(e => e.id === evidenceId);

  if (!ev && apiConnected) {
    try {
      const { evidence } = await API.getEvidence(evidenceId);
      ev = evidence;
    } catch (err) {
      console.error('[showEvidenceDetail] API error:', err);
    }
  }

  if (!ev) {
    showToast('Evidence not found', 'error');
    return;
  }

  // Normalize field names for both EVIDENCE_LIBRARY and legacy API data
  const title = ev.title || ev.filename || 'Unknown file';
  const fileType = ev.fileType || ev.mimeType || 'unknown';
  const fileSize = ev.fileSize || ev.sizeKB || 'N/A';
  const uploadedAt = ev.uploadedAt || ev.uploaded_at || new Date().toISOString();
  const uploadedBy = ev.uploadedBy || ev.uploaded_by || 'Unknown';
  const source = ev.source || 'Manual Upload';
  const phi = ev.phi || 0;
  const psi = ev.psi || 0;
  const status = ev.status || (ev.quality === 'high' ? 'validated' : 'needs-review');
  const hash = ev.hash || '';
  const linkedControls = ev.linkedControls || [ev.controlId] || [];
  const linkedFrameworks = ev.linkedFrameworks || [];
  const validatedBy = ev.validatedBy || [];
  const summary = ev.summary || ev.metadata?.description || 'No description';
  const tags = ev.tags || [];
  const type = ev.type || 'document';
  const consensusId = ev.consensusId || null;

  // Color coding for Φ/Ψ scores
  const phiColor = phi >= 0.9 ? 'var(--green)' : (phi >= 0.8 ? 'var(--amber)' : 'var(--red)');
  const psiColor = psi >= 0.9 ? 'var(--green)' : (psi >= 0.8 ? 'var(--amber)' : 'var(--red)');

  // File type icons
  const fileIcons = { 'pdf': '📄', 'json': '📋', 'csv': '📊', 'xlsx': '📈', 'png': '🖼️', 'jpg': '🖼️', 'docx': '📝' };
  const fileIcon = fileIcons[fileType] || '📎';

  // Type badge colors
  const typeBadges = {
    'configuration': { bg: '#e3f2fd', color: '#1565c0' },
    'logs': { bg: '#fce4ec', color: '#c2185b' },
    'policy': { bg: '#f3e5f5', color: '#7b1fa2' },
    'assessment': { bg: '#fff3e0', color: '#e65100' },
    'records': { bg: '#e8f5e9', color: '#2e7d32' }
  };
  const typeBadge = typeBadges[type] || { bg: '#eceff1', color: '#546e7a' };

  openModal(title, `
    <div style="padding: 20px;">
      <!-- Header Info -->
      <div style="display: flex; align-items: start; gap: 20px; margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid var(--border-light);">
        <div style="font-size: 48px;">${fileIcon}</div>
        <div style="flex: 1;">
          <div style="font-weight: 700; font-size: 18px; margin-bottom: 8px;">${title}</div>
          <div style="display: flex; gap: 12px; margin-bottom: 12px; flex-wrap: wrap;">
            <span style="padding: 4px 10px; background: ${typeBadge.bg}; color: ${typeBadge.color}; border-radius: 6px; font-size: 11px; font-weight: 700; text-transform: uppercase;">${type}</span>
            ${status === 'validated'
              ? '<span style="padding: 4px 10px; background: var(--green-light); color: var(--green); border-radius: 6px; font-size: 11px; font-weight: 700;">✓ VALIDATED</span>'
              : '<span style="padding: 4px 10px; background: var(--amber-light); color: var(--amber); border-radius: 6px; font-size: 11px; font-weight: 700;">⚠ NEEDS REVIEW</span>'}
          </div>
          <div style="font-size: 13px; color: var(--text-secondary);">${summary}</div>
        </div>
      </div>

      <!-- Metadata Grid -->
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 24px;">
        <div>
          <div style="font-size: 11px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 6px;">SOURCE</div>
          <div style="font-size: 14px; font-weight: 600; color: var(--text-primary);">${source}</div>
        </div>

        <div>
          <div style="font-size: 11px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 6px;">UPLOADED BY</div>
          <div style="font-size: 14px; font-weight: 600; color: var(--text-primary);">${uploadedBy}</div>
          <div style="font-size: 13px; color: var(--text-secondary);">${new Date(uploadedAt).toLocaleString()}</div>
        </div>

        <div>
          <div style="font-size: 11px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 6px;">FILE INFO</div>
          <div style="font-size: 14px; color: var(--text-primary);">${fileSize}</div>
          <div style="font-size: 13px; color: var(--text-secondary);">.${fileType.toUpperCase()}</div>
        </div>

        <div>
          <div style="font-size: 11px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 6px;">CONSENSUS ID</div>
          <div style="font-size: 14px; font-weight: 600; color: var(--text-primary); font-family: 'IBM Plex Mono', monospace;">${consensusId || 'Not validated'}</div>
        </div>
      </div>

      <!-- Linked Controls -->
      <div style="margin-bottom: 24px;">
        <div style="font-size: 11px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 8px;">LINKED CONTROLS (${linkedControls.length})</div>
        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
          ${linkedControls.map(c => `<span style="padding: 6px 12px; background: var(--brand-light); color: var(--brand); border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;" onclick="closeModal(); viewControl('${c}')">${c}</span>`).join('')}
          <span style="padding: 6px 12px; background: var(--bg-tertiary); color: var(--text-secondary); border-radius: 6px; font-size: 12px; cursor: pointer; border: 1px dashed var(--border-light);" onclick="showLinkControlPicker('${ev.id}')">+ Link Control</span>
        </div>
      </div>

      <!-- Linked Frameworks -->
      <div style="margin-bottom: 24px;">
        <div style="font-size: 11px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 8px;">FRAMEWORKS (${linkedFrameworks.length})</div>
        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
          ${linkedFrameworks.map(f => `<span style="padding: 4px 10px; background: var(--bg-tertiary); color: var(--text-secondary); border-radius: 4px; font-size: 11px; font-weight: 600;">${f}</span>`).join('')}
        </div>
      </div>

      <!-- Tags -->
      ${tags.length > 0 ? `
      <div style="margin-bottom: 24px;">
        <div style="font-size: 11px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 8px;">TAGS</div>
        <div style="display: flex; flex-wrap: wrap; gap: 6px;">
          ${tags.map(t => `<span style="padding: 3px 8px; background: var(--bg-secondary); color: var(--text-secondary); border-radius: 4px; font-size: 11px;">#${t}</span>`).join('')}
        </div>
      </div>
      ` : ''}

      <!-- AI Validation History -->
      <div style="margin-bottom: 24px;">
        <div style="font-size: 11px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 8px;">AI VALIDATION HISTORY</div>
        ${validatedBy.length > 0 ? `
        <div style="padding: 12px; background: var(--green-light); border-radius: 8px; display: flex; align-items: center; gap: 12px;">
          <div style="font-size: 24px;">🤖</div>
          <div>
            <div style="font-size: 13px; font-weight: 600; color: var(--green);">Validated by ${validatedBy.length} AI model${validatedBy.length > 1 ? 's' : ''}</div>
            <div style="font-size: 12px; color: var(--text-secondary);">${validatedBy.join(', ')}</div>
          </div>
        </div>
        ` : `
        <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
          <div style="font-size: 13px; color: var(--text-secondary);">No AI validation yet</div>
        </div>
        `}
      </div>

      <!-- Operator Scores -->
      <div style="padding: 20px; background: var(--bg-secondary); border-radius: 12px; margin-bottom: 24px;">
        <div style="font-size: 13px; font-weight: 700; color: var(--text-primary); margin-bottom: 16px;">ΦΨΔIPT Operator Scores</div>

        <div style="margin-bottom: 16px;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <div class="operator-glyph phi" style="width: 24px; height: 24px; font-size: 13px;">Φ</div>
            <span style="font-size: 14px; font-weight: 600;">Zero-Start Truth</span>
            <span style="margin-left: auto; font-size: 16px; font-weight: 700; font-family: 'IBM Plex Mono', monospace; color: ${phiColor};">${phi.toFixed(2)}</span>
          </div>
          <div style="height: 8px; background: var(--border-light); border-radius: 4px; overflow: hidden;">
            <div style="width: ${(phi * 100).toFixed(0)}%; height: 100%; background: ${phiColor}; border-radius: 4px;"></div>
          </div>
        </div>

        <div>
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <div class="operator-glyph psi" style="width: 24px; height: 24px; font-size: 13px;">Ψ</div>
            <span style="font-size: 14px; font-weight: 600;">Credential-Decay</span>
            <span style="margin-left: auto; font-size: 16px; font-weight: 700; font-family: 'IBM Plex Mono', monospace; color: ${psiColor};">${psi.toFixed(2)}</span>
          </div>
          <div style="height: 8px; background: var(--border-light); border-radius: 4px; overflow: hidden;">
            <div style="width: ${(psi * 100).toFixed(0)}%; height: 100%; background: ${psiColor}; border-radius: 4px;"></div>
          </div>
        </div>
      </div>

      <!-- Cryptographic Hash -->
      <div style="padding: 16px; background: var(--bg-dark); border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
        <div style="font-size: 11px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 8px;">🔒 BLAKE3 CRYPTOGRAPHIC HASH</div>
        <div style="font-family: 'IBM Plex Mono', monospace; font-size: 11px; color: var(--trust-teal); word-break: break-all; line-height: 1.6;">${hash || 'Hash not available'}</div>
        <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 8px;">Immutably stored in Merkle tree • Verified on every snapshot</div>
      </div>
    </div>
  `, `
    <button class="btn btn-secondary" onclick="closeModal()">Close</button>
    <button class="btn btn-secondary" onclick="showLinkControlPicker('${ev.id}')">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
      </svg>
      Link to Control
    </button>
    <button class="btn btn-primary" onclick="closeModal(); validateEvidence('${ev.id}')">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
        <path d="M9 12l2 2 4-4"/>
        <circle cx="12" cy="12" r="10"/>
      </svg>
      Re-validate with AI
    </button>
  `);
}

function viewEvidence(evidenceId) {
  showToast('In production, this would open the evidence file viewer', 'info');
}

function downloadEvidence(evidenceId) {
  const ev = getEvidence().find(e => e.id === evidenceId);
  if (!ev) {
    showToast('Evidence not found', 'error');
    return;
  }
  
  // In demo mode, create a JSON export of evidence metadata
  // In production, this would fetch the actual file from storage
  const exportData = {
    evidenceId: ev.id,
    title: ev.title,
    type: ev.type,
    source: ev.source,
    uploadedAt: ev.uploadedAt,
    uploadedBy: ev.uploadedBy,
    hash: ev.hash,
    linkedControls: ev.linkedControls,
    operators: {
      phi: ev.phi,
      psi: ev.psi,
      daysOld: ev.daysOld
    },
    validation: ev.validation || { status: ev.status, validators: ev.validators },
    exportedAt: new Date().toISOString(),
    note: 'This is evidence metadata. In production, the actual file would be downloaded.'
  };
  
  const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `evidence-${ev.id}-${Date.now()}.json`;
  a.click();
  URL.revokeObjectURL(url);
  
  closeModal();
  showToast(`Downloaded ${ev.title} metadata`, 'success');
}

// =============================================================================
// PDF GENERATION UTILITY - Atomic Trust™ Branded Reports
// =============================================================================

const AtomicPDF = {
  // Brand colors
  colors: {
    brand: [79, 70, 229],      // #4F46E5 - Indigo
    brandLight: [238, 242, 255], // #EEF2FF
    green: [34, 197, 94],      // #22C55E
    amber: [245, 158, 11],     // #F59E0B
    red: [239, 68, 68],        // #EF4444
    text: [26, 26, 46],        // #1A1A2E
    textSecondary: [100, 116, 139], // #64748B
    border: [226, 232, 240],   // #E2E8F0
    phi: [139, 92, 246],       // #8B5CF6
    psi: [6, 182, 212],        // #06B6D4
    delta: [249, 115, 22],     // #F97316
    trust: [20, 184, 166]      // #14B8A6
  },

  // Create a new PDF document
  create(title, orientation = 'portrait') {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({
      orientation: orientation,
      unit: 'mm',
      format: 'a4'
    });
    
    doc._atomicTitle = title;
    doc._pageNum = 1;
    
    return doc;
  },

  // Add header with Atomic Trust™ branding
  addHeader(doc, title, subtitle = null) {
    const pageWidth = doc.internal.pageSize.getWidth();
    
    // Header background
    doc.setFillColor(...this.colors.brand);
    doc.rect(0, 0, pageWidth, 35, 'F');
    
    // Brand name
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(20);
    doc.setFont('helvetica', 'bold');
    doc.text('Atomic Trust\u2122', 15, 15);
    
    // Governance tagline
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    doc.text('GOVERNANCE PHYSICS', 15, 22);
    
    // Report title
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.text(title, 15, 30);
    
    // Date on right side
    doc.setFontSize(9);
    doc.setFont('helvetica', 'normal');
    const dateStr = new Date().toLocaleDateString('en-US', { 
      year: 'numeric', month: 'long', day: 'numeric' 
    });
    doc.text(dateStr, pageWidth - 15, 15, { align: 'right' });
    
    // Block number
    doc.text(`Block #${STATE.currentSnapshot}`, pageWidth - 15, 22, { align: 'right' });
    
    if (subtitle) {
      doc.setTextColor(...this.colors.textSecondary);
      doc.setFontSize(10);
      doc.text(subtitle, pageWidth - 15, 30, { align: 'right' });
    }
    
    return 45; // Return Y position after header
  },

  // Add footer with page numbers
  addFooter(doc, pageNum, totalPages) {
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    
    // Footer line
    doc.setDrawColor(...this.colors.border);
    doc.setLineWidth(0.5);
    doc.line(15, pageHeight - 15, pageWidth - 15, pageHeight - 15);
    
    // Footer text
    doc.setTextColor(...this.colors.textSecondary);
    doc.setFontSize(8);
    doc.setFont('helvetica', 'normal');
    
    doc.text('CONFIDENTIAL - Generated by Atomic Trust™ Governance Platform', 15, pageHeight - 10);
    doc.text(`Page ${pageNum}`, pageWidth - 15, pageHeight - 10, { align: 'right' });
  },

  // Add section title
  addSectionTitle(doc, y, title) {
    doc.setTextColor(...this.colors.brand);
    doc.setFontSize(14);
    doc.setFont('helvetica', 'bold');
    doc.text(title, 15, y);
    
    // Underline
    doc.setDrawColor(...this.colors.brand);
    doc.setLineWidth(0.5);
    doc.line(15, y + 2, 80, y + 2);
    
    return y + 12;
  },

  // Add key metrics box
  addMetricsBox(doc, y, metrics) {
    const pageWidth = doc.internal.pageSize.getWidth();
    const boxWidth = (pageWidth - 40) / metrics.length;
    
    metrics.forEach((metric, i) => {
      const x = 15 + (i * boxWidth) + (i * 5);
      
      // Box background
      doc.setFillColor(...(metric.bgColor || this.colors.brandLight));
      doc.roundedRect(x, y, boxWidth - 5, 25, 3, 3, 'F');
      
      // Label
      doc.setTextColor(...this.colors.textSecondary);
      doc.setFontSize(8);
      doc.setFont('helvetica', 'normal');
      doc.text(metric.label.toUpperCase(), x + 5, y + 8);
      
      // Value
      doc.setTextColor(...(metric.color || this.colors.text));
      doc.setFontSize(16);
      doc.setFont('helvetica', 'bold');
      doc.text(String(metric.value), x + 5, y + 19);
    });
    
    return y + 35;
  },

  // Add operator metrics (Φ, Ψ, Δ, T)
  addOperatorMetrics(doc, y, phi, psi, delta, trust) {
    const pageWidth = doc.internal.pageSize.getWidth();
    const boxWidth = (pageWidth - 50) / 4;
    
    const operators = [
      { symbol: 'Φ', label: 'Zero-Start', value: phi.toFixed(3), color: this.colors.phi },
      { symbol: 'Ψ', label: 'Credential-Decay', value: psi.toFixed(3), color: this.colors.psi },
      { symbol: 'Δ', label: 'Divergence', value: delta.toFixed(3), color: this.colors.delta },
      { symbol: 'T', label: 'Trust', value: trust.toFixed(3), color: this.colors.trust }
    ];
    
    operators.forEach((op, i) => {
      const x = 15 + (i * (boxWidth + 5));
      
      // Box
      doc.setDrawColor(...op.color);
      doc.setLineWidth(1);
      doc.setFillColor(255, 255, 255);
      doc.roundedRect(x, y, boxWidth, 22, 2, 2, 'FD');
      
      // Symbol
      doc.setTextColor(...op.color);
      doc.setFontSize(14);
      doc.setFont('helvetica', 'bold');
      doc.text(op.symbol, x + 5, y + 10);
      
      // Value
      doc.setFontSize(12);
      doc.text(op.value, x + 15, y + 10);
      
      // Label
      doc.setTextColor(...this.colors.textSecondary);
      doc.setFontSize(7);
      doc.setFont('helvetica', 'normal');
      doc.text(op.label, x + 5, y + 18);
    });
    
    return y + 30;
  },

  // Add a data table
  addTable(doc, y, headers, rows, options = {}) {
    const tableStyles = {
      headStyles: {
        fillColor: this.colors.brand,
        textColor: [255, 255, 255],
        fontStyle: 'bold',
        fontSize: 9,
        cellPadding: 4
      },
      bodyStyles: {
        fontSize: 9,
        cellPadding: 3,
        textColor: this.colors.text
      },
      alternateRowStyles: {
        fillColor: [248, 250, 252]
      },
      styles: {
        lineColor: this.colors.border,
        lineWidth: 0.1
      },
      margin: { left: 15, right: 15 },
      startY: y,
      ...options
    };
    
    doc.autoTable({
      head: [headers],
      body: rows,
      ...tableStyles
    });
    
    return doc.lastAutoTable.finalY + 10;
  },

  // Add cryptographic proof box
  addProofBox(doc, y, hash, snapshot, timestamp) {
    const pageWidth = doc.internal.pageSize.getWidth();
    
    // Box background
    doc.setFillColor(248, 250, 252);
    doc.roundedRect(15, y, pageWidth - 30, 25, 3, 3, 'F');
    
    // Lock icon placeholder
    doc.setFillColor(...this.colors.green);
    doc.circle(25, y + 12.5, 5, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(8);
    doc.setFont('helvetica', 'bold');
    doc.text('🔒', 22.5, y + 14);
    
    // Proof details
    doc.setTextColor(...this.colors.text);
    doc.setFontSize(9);
    doc.setFont('helvetica', 'bold');
    doc.text('CRYPTOGRAPHIC PROOF', 35, y + 8);
    
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(8);
    doc.setTextColor(...this.colors.textSecondary);
    doc.text(`Hash: ${hash}`, 35, y + 14);
    doc.text(`Block: ${snapshot} | Generated: ${timestamp}`, 35, y + 20);
    
    return y + 35;
  },

  // Add text paragraph
  addParagraph(doc, y, text, options = {}) {
    doc.setTextColor(...(options.color || this.colors.text));
    doc.setFontSize(options.fontSize || 10);
    doc.setFont('helvetica', options.fontStyle || 'normal');
    
    const pageWidth = doc.internal.pageSize.getWidth();
    const lines = doc.splitTextToSize(text, pageWidth - 30);
    doc.text(lines, 15, y);
    
    return y + (lines.length * 5) + 5;
  },

  // Check if need new page
  checkNewPage(doc, y, neededSpace = 40) {
    const pageHeight = doc.internal.pageSize.getHeight();
    if (y + neededSpace > pageHeight - 25) {
      this.addFooter(doc, doc._pageNum, null);
      doc.addPage();
      doc._pageNum++;
      return 20;
    }
    return y;
  },

  // Finalize and download
  download(doc, filename) {
    // Add footer to last page
    this.addFooter(doc, doc._pageNum, doc._pageNum);
    
    // Save
    doc.save(filename);
    
    // Log audit entry
    logAuditEntry('REPORT_DOWNLOADED', {
      filename: filename,
      type: 'PDF',
      pages: doc._pageNum
    });
  }
};

// =============================================================================
// PDF EXPORT FUNCTIONS
// =============================================================================

// Export all controls data as PDF
function exportControlsData() {
  const controls = getControls();
  const doc = AtomicPDF.create('Controls Report');
  
  // Header
  let y = AtomicPDF.addHeader(doc, 'Controls Inventory Report', `${controls.length} Controls`);
  
  // Summary metrics
  const compliant = controls.filter(c => c.status === 'compliant').length;
  const atRisk = controls.filter(c => c.status === 'at-risk').length;
  const critical = controls.filter(c => c.status === 'critical').length;
  const avgTrust = controls.reduce((sum, c) => sum + (c.trust || 0), 0) / controls.length;
  
  y = AtomicPDF.addMetricsBox(doc, y, [
    { label: 'Total Controls', value: controls.length, color: AtomicPDF.colors.text },
    { label: 'Compliant', value: compliant, color: AtomicPDF.colors.green, bgColor: [220, 252, 231] },
    { label: 'At Risk', value: atRisk, color: AtomicPDF.colors.amber, bgColor: [254, 243, 199] },
    { label: 'Critical', value: critical, color: AtomicPDF.colors.red, bgColor: [254, 226, 226] }
  ]);
  
  // Operator averages
  const avgPhi = controls.reduce((sum, c) => sum + (c.phi || 0), 0) / controls.length;
  const avgPsi = controls.reduce((sum, c) => sum + (c.psi || 0), 0) / controls.length;
  const avgDelta = controls.reduce((sum, c) => sum + (c.delta || 0), 0) / controls.length;
  
  y = AtomicPDF.addSectionTitle(doc, y, 'Aggregate Operator Metrics');
  y = AtomicPDF.addOperatorMetrics(doc, y, avgPhi, avgPsi, avgDelta, avgTrust);
  
  // Controls table
  y = AtomicPDF.addSectionTitle(doc, y, 'Control Details');
  
  const headers = ['ID', 'Name', 'Frameworks', 'Φ', 'Ψ', 'Δ', 'Trust', 'Status'];
  const rows = controls.map(c => [
    c.id,
    c.name.substring(0, 25),
    (c.frameworks || []).join(', '),
    (c.phi || 0).toFixed(2),
    (c.psi || 0).toFixed(2),
    (c.delta || 0).toFixed(2),
    (c.trust || 0).toFixed(2),
    c.status || 'unknown'
  ]);
  
  y = AtomicPDF.addTable(doc, y, headers, rows);
  
  // Proof
  y = AtomicPDF.checkNewPage(doc, y, 45);
  const hash = generateHash({ type: 'controls-export', count: controls.length, timestamp: Date.now() });
  y = AtomicPDF.addProofBox(doc, y, hash.substring(0, 32), STATE.currentSnapshot, new Date().toISOString());
  
  AtomicPDF.download(doc, `atomic-trust-controls-${Date.now()}.pdf`);
  showToast(`Exported ${controls.length} controls as PDF`, 'success');
}

// Export all evidence data as PDF
function exportEvidenceData() {
  const evidence = getEvidence();
  const doc = AtomicPDF.create('Evidence Report');
  
  let y = AtomicPDF.addHeader(doc, 'Evidence Vault Report', `${evidence.length} Items`);
  
  // Summary metrics
  const validated = evidence.filter(e => e.status === 'validated').length;
  const pending = evidence.filter(e => e.status === 'pending-validation').length;
  const avgPhi = evidence.length > 0 ? evidence.reduce((sum, e) => sum + (e.phi || 0), 0) / evidence.length : 0;
  const avgPsi = evidence.length > 0 ? evidence.reduce((sum, e) => sum + (e.psi || 0), 0) / evidence.length : 0;
  
  y = AtomicPDF.addMetricsBox(doc, y, [
    { label: 'Total Evidence', value: evidence.length, color: AtomicPDF.colors.text },
    { label: 'Validated', value: validated, color: AtomicPDF.colors.green, bgColor: [220, 252, 231] },
    { label: 'Pending', value: pending, color: AtomicPDF.colors.amber, bgColor: [254, 243, 199] },
    { label: 'Avg Trust', value: avgPhi.toFixed(2), color: AtomicPDF.colors.trust, bgColor: [204, 251, 241] }
  ]);
  
  // Evidence table
  y = AtomicPDF.addSectionTitle(doc, y, 'Evidence Inventory');
  
  const headers = ['ID', 'Title', 'Type', 'Source', 'Φ', 'Ψ', 'Status'];
  const rows = evidence.map(e => [
    e.id,
    (e.title || e.name || '').substring(0, 30),
    e.type || '',
    (e.source || '').substring(0, 20),
    (e.phi || 0).toFixed(2),
    (e.psi || 0).toFixed(2),
    e.status || 'unknown'
  ]);
  
  y = AtomicPDF.addTable(doc, y, headers, rows);
  
  // Proof
  y = AtomicPDF.checkNewPage(doc, y, 45);
  const hash = generateHash({ type: 'evidence-export', count: evidence.length, timestamp: Date.now() });
  y = AtomicPDF.addProofBox(doc, y, hash.substring(0, 32), STATE.currentSnapshot, new Date().toISOString());
  
  AtomicPDF.download(doc, `atomic-trust-evidence-${Date.now()}.pdf`);
  showToast(`Exported ${evidence.length} evidence items as PDF`, 'success');
}

// Export all clauses data as JSON
// Export all clauses data as PDF
function exportClausesData() {
  const clauses = getClauses();
  const doc = AtomicPDF.create('Clauses Report');
  
  let y = AtomicPDF.addHeader(doc, 'Clause Repository Report', `${clauses.length} Clauses`);
  
  // Group by framework
  const byFramework = {};
  clauses.forEach(c => {
    byFramework[c.framework] = (byFramework[c.framework] || 0) + 1;
  });
  
  const avgPhi = clauses.length > 0 ? clauses.reduce((sum, c) => sum + (c.phi || 0), 0) / clauses.length : 0;
  const avgPsi = clauses.length > 0 ? clauses.reduce((sum, c) => sum + (c.psi || 0), 0) / clauses.length : 0;
  
  // Metrics
  const frameworks = Object.keys(byFramework);
  y = AtomicPDF.addMetricsBox(doc, y, [
    { label: 'Total Clauses', value: clauses.length, color: AtomicPDF.colors.text },
    { label: 'Frameworks', value: frameworks.length, color: AtomicPDF.colors.brand },
    { label: 'Avg Φ', value: avgPhi.toFixed(2), color: AtomicPDF.colors.phi },
    { label: 'Avg Ψ', value: avgPsi.toFixed(2), color: AtomicPDF.colors.psi }
  ]);
  
  // Framework breakdown
  y = AtomicPDF.addSectionTitle(doc, y, 'Coverage by Framework');
  const fwHeaders = ['Framework', 'Clauses', 'Coverage'];
  const fwRows = frameworks.map(fw => [fw, byFramework[fw], `${((byFramework[fw] / clauses.length) * 100).toFixed(1)}%`]);
  y = AtomicPDF.addTable(doc, y, fwHeaders, fwRows);
  
  // Clause details (first 20)
  y = AtomicPDF.checkNewPage(doc, y, 60);
  y = AtomicPDF.addSectionTitle(doc, y, 'Clause Details');
  const headers = ['ID', 'Framework', 'Title', 'Category', 'Φ', 'Ψ'];
  const rows = clauses.slice(0, 30).map(c => [
    c.id || c.clause,
    c.framework,
    (c.title || '').substring(0, 30),
    c.category || '',
    (c.phi || 0).toFixed(2),
    (c.psi || 0).toFixed(2)
  ]);
  y = AtomicPDF.addTable(doc, y, headers, rows);
  
  // Proof
  y = AtomicPDF.checkNewPage(doc, y, 45);
  const hash = generateHash({ type: 'clauses-export', count: clauses.length, timestamp: Date.now() });
  y = AtomicPDF.addProofBox(doc, y, hash.substring(0, 32), STATE.currentSnapshot, new Date().toISOString());
  
  AtomicPDF.download(doc, `atomic-trust-clauses-${Date.now()}.pdf`);
  showToast(`Exported ${clauses.length} clauses as PDF`, 'success');
}

// Export all equivalences data as PDF
function exportEquivalencesData() {
  const equivalences = getEquivalences();
  const doc = AtomicPDF.create('Equivalences Report');
  
  let y = AtomicPDF.addHeader(doc, 'Framework Equivalence Matrix', `${equivalences.length} Mappings`);
  
  const totalClauses = equivalences.reduce((sum, eq) => sum + (eq.equivalentClauses?.length || 0), 0);
  const avgConfidence = equivalences.length > 0 ? 
    equivalences.reduce((sum, eq) => sum + (eq.semanticConfidence || 0), 0) / equivalences.length : 0;
  const avgDivergence = equivalences.length > 0 ?
    equivalences.reduce((sum, eq) => sum + (eq.divergenceScore || 0), 0) / equivalences.length : 0;
  
  // Metrics
  y = AtomicPDF.addMetricsBox(doc, y, [
    { label: 'Equivalence Groups', value: equivalences.length, color: AtomicPDF.colors.text },
    { label: 'Total Clauses', value: totalClauses, color: AtomicPDF.colors.brand },
    { label: 'Avg Confidence', value: (avgConfidence * 100).toFixed(0) + '%', color: AtomicPDF.colors.green },
    { label: 'Avg Divergence', value: avgDivergence.toFixed(2), color: AtomicPDF.colors.delta }
  ]);
  
  // Equivalence mappings
  y = AtomicPDF.addSectionTitle(doc, y, 'Equivalence Mappings');
  const headers = ['Control', 'Family', 'Frameworks', 'Confidence', 'Δ'];
  const rows = equivalences.map(eq => [
    eq.controlId || eq.id,
    eq.family || '',
    (eq.equivalentClauses || []).map(c => c.framework).join(', ').substring(0, 30),
    ((eq.semanticConfidence || 0) * 100).toFixed(0) + '%',
    (eq.divergenceScore || 0).toFixed(2)
  ]);
  y = AtomicPDF.addTable(doc, y, headers, rows);
  
  // Proof
  y = AtomicPDF.checkNewPage(doc, y, 45);
  const hash = generateHash({ type: 'equivalences-export', count: equivalences.length, timestamp: Date.now() });
  y = AtomicPDF.addProofBox(doc, y, hash.substring(0, 32), STATE.currentSnapshot, new Date().toISOString());
  
  AtomicPDF.download(doc, `atomic-trust-equivalences-${Date.now()}.pdf`);
  showToast(`Exported ${equivalences.length} equivalence mappings as PDF`, 'success');
}

function filterEvidence(searchTerm) {
  // In production, this would filter the evidence list
  console.log('Filtering evidence:', searchTerm);
}

function filterEvidenceByQuality(quality) {
  // In production, this would filter by quality
  console.log('Filtering by quality:', quality);
}

function filterEvidenceByType(type) {
  // In production, this would filter by type
  console.log('Filtering by type:', type);
}

// ---- KERNEL INTEGRATION FUNCTIONS ----

/**
 * Validate evidence using AI via the Kernel API
 * Calls the Multi-LLM Consensus Engine at localhost:3009
 */
async function validateEvidence(evidenceId) {
  const evidence = EVIDENCE_LIBRARY.find(e => e.id === evidenceId);
  if (!evidence) {
    showToast('Evidence not found', 'error');
    return;
  }

  showToast(`Validating ${evidence.title} with AI...`, 'info');

  try {
    // Get the first linked control for validation context
    const controlId = evidence.linkedControls[0] || 'general';

    // Call the Multi-LLM Consensus endpoint
    const response = await fetch('http://localhost:3009/consensus', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        target_id: `evidence-${evidenceId}`,
        control: `Verify that evidence "${evidence.title}" adequately supports control ${controlId}`,
        evidence: evidence.summary,
        stakes: 1.0
      })
    });

    if (!response.ok) {
      throw new Error('Consensus API error');
    }

    const result = await response.json();

    // Update evidence with kernel results
    evidence.phi = result.consensus?.phi || evidence.phi;
    evidence.psi = result.consensus?.psi || evidence.psi;
    evidence.status = result.consensus?.phi >= 0.8 ? 'validated' : 'needs-review';

    // Track which AI models validated
    if (result.votes) {
      const validators = result.votes
        .filter(v => v.vote === 'AFFIRM')
        .map(v => v.agent_id);
      evidence.validatedBy = [...new Set([...evidence.validatedBy, ...validators])];
    }

    // Store consensus ID
    if (result.kernel_snapshot_id) {
      evidence.consensusId = result.kernel_snapshot_id;
    }

    // Re-render the evidence view
    const mainEl = document.getElementById('main');
    if (mainEl && currentView === 'evidence') {
      mainEl.innerHTML = renderEvidence();
    }

    showToast(`Evidence validated: Φ=${evidence.phi.toFixed(2)} (${result.consensus?.decision || 'ASSESSED'})`, 'success');

  } catch (error) {
    console.error('[validateEvidence] Error:', error);

    // Fallback to kernel simulation if consensus service unavailable
    try {
      const response = await fetch('http://localhost:8000/demo/simulate-vote', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          target_id: `evidence-${evidenceId}`,
          agent_id: 'evidence-validator',
          stakes: 1.0
        })
      });

      if (response.ok) {
        const result = await response.json();
        evidence.phi = result.phi || evidence.phi;
        evidence.psi = result.psi || evidence.psi;
        evidence.status = evidence.phi >= 0.8 ? 'validated' : 'needs-review';

        const mainEl = document.getElementById('main');
        if (mainEl && currentView === 'evidence') {
          mainEl.innerHTML = renderEvidence();
        }

        showToast(`Evidence validated via Kernel: Φ=${evidence.phi.toFixed(2)}`, 'success');
      } else {
        showToast('Kernel unavailable - using simulated validation', 'warning');
        // Simulate validation
        evidence.phi = Math.min(1, evidence.phi + 0.05);
        evidence.status = evidence.phi >= 0.8 ? 'validated' : 'needs-review';
        if (!evidence.validatedBy.includes('local')) {
          evidence.validatedBy.push('local');
        }

        const mainEl = document.getElementById('main');
        if (mainEl && currentView === 'evidence') {
          mainEl.innerHTML = renderEvidence();
        }

        showToast(`Simulated validation: Φ=${evidence.phi.toFixed(2)}`, 'info');
      }
    } catch (kernelError) {
      console.error('[validateEvidence] Kernel fallback error:', kernelError);
      showToast('Validation service unavailable', 'error');
    }
  }
}

/**
 * Link evidence to a control and submit to kernel
 */
async function linkEvidenceToControl(evidenceId, controlId) {
  const evidence = EVIDENCE_LIBRARY.find(e => e.id === evidenceId);
  if (!evidence) {
    showToast('Evidence not found', 'error');
    return;
  }

  // Check if already linked
  if (evidence.linkedControls.includes(controlId)) {
    showToast(`Already linked to ${controlId}`, 'info');
    return;
  }

  // Add the link locally
  evidence.linkedControls.push(controlId);

  try {
    // Submit vote to kernel
    const response = await fetch('http://localhost:8000/votes', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        agent_id: 'evidence-linker',
        target_id: controlId,
        direction: 'affirm',
        content: `Evidence ${evidenceId} supports control ${controlId}`
      })
    });

    if (response.ok) {
      showToast(`Evidence linked to ${controlId} - vote submitted to kernel`, 'success');
    } else {
      showToast(`Evidence linked to ${controlId} (kernel vote pending)`, 'info');
    }
  } catch (error) {
    console.error('[linkEvidenceToControl] Kernel error:', error);
    showToast(`Evidence linked to ${controlId}`, 'success');
  }

  // Refresh evidence view
  const mainEl = document.getElementById('main');
  if (mainEl && currentView === 'evidence') {
    mainEl.innerHTML = renderEvidence();
  }
}

/**
 * Show control picker modal for linking evidence
 */
function showLinkControlPicker(evidenceId) {
  const evidence = EVIDENCE_LIBRARY.find(e => e.id === evidenceId);
  if (!evidence) {
    showToast('Evidence not found', 'error');
    return;
  }

  // Get available controls
  const controls = getControls();
  const availableControls = controls.filter(c => !evidence.linkedControls.includes(c.id));

  // Common NIST controls for quick linking
  const commonControls = ['AC-2', 'AC-3', 'AU-2', 'AU-6', 'CA-8', 'CP-9', 'IA-2', 'IR-4', 'RA-5', 'SC-7', 'SC-8', 'SC-13', 'SI-2'];

  openModal('Link to Control', `
    <div style="padding: 20px;">
      <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 20px;">
        Select a control to link "${evidence.title}" to:
      </p>

      <!-- Quick Link Section -->
      <div style="margin-bottom: 24px;">
        <div style="font-size: 11px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 8px;">COMMON NIST CONTROLS</div>
        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
          ${commonControls.filter(c => !evidence.linkedControls.includes(c)).map(c => `
            <button class="btn btn-sm btn-secondary" onclick="closeModal(); linkEvidenceToControl('${evidenceId}', '${c}')" style="padding: 6px 12px;">
              ${c}
            </button>
          `).join('')}
        </div>
      </div>

      <!-- Existing Controls -->
      ${availableControls.length > 0 ? `
      <div>
        <div style="font-size: 11px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 8px;">EXISTING CONTROLS IN SYSTEM</div>
        <div style="max-height: 200px; overflow-y: auto;">
          ${availableControls.map(c => `
            <div style="padding: 12px; margin-bottom: 8px; background: var(--bg-secondary); border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: space-between;"
                 onclick="closeModal(); linkEvidenceToControl('${evidenceId}', '${c.id}')"
                 onmouseover="this.style.background='var(--brand-light)'"
                 onmouseout="this.style.background='var(--bg-secondary)'">
              <div>
                <div style="font-weight: 600; font-size: 13px;">${c.id}</div>
                <div style="font-size: 12px; color: var(--text-secondary);">${c.name}</div>
              </div>
              <div style="font-size: 12px; font-weight: 600; color: ${c.phi >= 0.9 ? 'var(--green)' : c.phi >= 0.8 ? 'var(--amber)' : 'var(--red)'};">Φ ${c.phi.toFixed(2)}</div>
            </div>
          `).join('')}
        </div>
      </div>
      ` : `
      <div style="padding: 20px; text-align: center; color: var(--text-secondary);">
        All available controls are already linked
      </div>
      `}

      <!-- Manual Input -->
      <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-light);">
        <div style="font-size: 11px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 8px;">MANUAL CONTROL ID</div>
        <div style="display: flex; gap: 8px;">
          <input type="text" id="manualControlId" placeholder="e.g., AC-2, SC-13" style="flex: 1; padding: 10px 12px; border: 1px solid var(--border-light); border-radius: 6px; font-size: 14px;">
          <button class="btn btn-primary" onclick="const id = document.getElementById('manualControlId').value.trim().toUpperCase(); if(id) { closeModal(); linkEvidenceToControl('${evidenceId}', id); }">
            Link
          </button>
        </div>
      </div>
    </div>
  `, `
    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
  `);
}

// ---- RFP ANALYZER FUNCTIONS ----

function simulateRFPUpload() {
  openModal('Import RFP Document', `
    <div style="padding: 20px;">
      <div style="margin-bottom: 24px;">
        <label style="display: block; font-weight: 700; font-size: 13px; margin-bottom: 8px; color: var(--text-primary);">
          Upload RFP Document
        </label>
        <div style="border: 2px dashed var(--border-light); border-radius: 12px; padding: 40px; text-align: center; background: var(--bg-secondary); cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.borderColor='var(--brand)'; this.style.background='var(--brand-light)';" onmouseout="this.style.borderColor='var(--border-light)'; this.style.background='var(--bg-secondary)';" onclick="alert('In production, file picker would open here')">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--text-tertiary)" stroke-width="2" style="margin: 0 auto 12px;">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14,2 14,8 20,8"/>
            <line x1="12" y1="18" x2="12" y2="12"/>
            <line x1="9" y1="15" x2="15" y2="15"/>
          </svg>
          <div style="font-weight: 700; font-size: 15px; margin-bottom: 6px; color: var(--text-primary);">Click to browse or drag and drop</div>
          <div style="font-size: 13px; color: var(--text-secondary);">PDF, DOCX (RFP documents)</div>
        </div>
      </div>
      
      <div style="margin-bottom: 24px;">
        <label style="display: block; font-weight: 700; font-size: 13px; margin-bottom: 8px; color: var(--text-primary);">
          RFP Type
        </label>
        <select style="width: 100%; padding: 12px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px; font-family: 'Inter', sans-serif;">
          <option value="govcloud">Government/FedRAMP</option>
          <option value="finance">Financial Services</option>
          <option value="healthcare">Healthcare/HIPAA</option>
          <option value="certification">ISO/SOC Certification</option>
          <option value="other">Other</option>
        </select>
      </div>
      
      <div style="margin-bottom: 24px;">
        <label style="display: block; font-weight: 700; font-size: 13px; margin-bottom: 8px; color: var(--text-primary);">
          Client Name
        </label>
        <input type="text" placeholder="Enter client name..." style="width: 100%; padding: 12px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px; font-family: 'Inter', sans-serif;">
      </div>
      
      <div style="margin-bottom: 24px;">
        <label style="display: block; font-weight: 700; font-size: 13px; margin-bottom: 8px; color: var(--text-primary);">
          Due Date
        </label>
        <input type="date" style="width: 100%; padding: 12px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px; font-family: 'Inter', sans-serif;">
      </div>
      
      <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 24px;">
        <div style="font-size: 12px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 8px;">🤖 AI-POWERED ANALYSIS</div>
        <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.6;">
          Upon upload, the RFP will be:
          <ul style="margin: 8px 0 0 20px; padding: 0;">
            <li>Parsed with multi-LLM consensus (GPT-4, Claude, Gemini)</li>
            <li>Clauses automatically extracted and categorized</li>
            <li>Mapped to existing controls via semantic matching</li>
            <li>Gaps identified with remediation recommendations</li>
            <li>Coverage scored with ΦΨΔIPT operators</li>
          </ul>
        </div>
      </div>
    </div>
  `, `
    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
    <button class="btn btn-primary" onclick="closeModal(); showToast('✓ RFP uploaded and analysis started', 'success')">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
        <polyline points="17 8 12 3 7 8"/>
        <line x1="12" y1="3" x2="12" y2="15"/>
      </svg>
      Import & Analyze
    </button>
  `);
}

function showRFPDetail(rfpId) {
  const rfp = RFPS.find(r => r.id === rfpId);
  if (!rfp) return;
  
  const coveragePercent = (rfp.coverage * 100).toFixed(0);
  const coverageColor = rfp.coverage >= 0.9 ? 'var(--green)' : rfp.coverage >= 0.7 ? 'var(--amber)' : 'var(--red)';
  
  // Group clauses by status
  const compliantClauses = rfp.clauses.filter(c => c.status === 'compliant');
  const gapClauses = rfp.clauses.filter(c => c.status === 'gap');
  
  openModal(`${rfp.id}: ${rfp.title}`, `
    <div style="padding: 20px;">
      <!-- Header Info -->
      <div style="margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid var(--border-light);">
        <div style="display: flex; gap: 12px; margin-bottom: 12px;">
          ${rfp.frameworks.map(f => `<span class="framework-chip">${f}</span>`).join('')}
        </div>
        <div style="font-size: 15px; color: var(--text-secondary); margin-bottom: 12px;">
          <strong>Client:</strong> ${rfp.client}
        </div>
        <div style="font-size: 15px; color: var(--text-secondary);">
          <strong>Due Date:</strong> ${new Date(rfp.dueDate).toLocaleDateString()} • <strong>Assigned to:</strong> ${rfp.assignedTo}
        </div>
      </div>
      
      <!-- Coverage Summary -->
      <div style="padding: 20px; background: var(--bg-secondary); border-radius: 12px; margin-bottom: 24px;">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
          <div>
            <div style="font-size: 13px; font-weight: 700; color: var(--text-primary); margin-bottom: 4px;">Coverage Analysis</div>
            <div style="font-size: 13px; color: var(--text-secondary);">
              ${rfp.mappedClauses} of ${rfp.totalClauses} clauses mapped to controls
            </div>
          </div>
          <div style="font-size: 32px; font-weight: 700; font-family: 'IBM Plex Mono', monospace; color: ${coverageColor};">${coveragePercent}%</div>
        </div>
        <div style="height: 10px; background: var(--border-light); border-radius: 5px; overflow: hidden;">
          <div style="width: ${coveragePercent}%; height: 100%; background: ${coverageColor}; border-radius: 5px;"></div>
        </div>
      </div>
      
      <!-- Compliant Clauses -->
      ${compliantClauses.length > 0 ? `
        <div style="margin-bottom: 24px;">
          <div style="font-size: 14px; font-weight: 700; color: var(--green); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12"/>
            </svg>
            Compliant Requirements (${compliantClauses.length})
          </div>
          ${compliantClauses.slice(0, 3).map(clause => `
            <div style="padding: 12px; background: var(--green-light); border-left: 3px solid var(--green); border-radius: 6px; margin-bottom: 8px;">
              <div style="font-weight: 700; font-size: 13px; margin-bottom: 4px; color: var(--green);">${clause.id} — ${clause.title}</div>
              <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 6px;">${clause.requirement}</div>
              <div style="font-size: 11px; color: var(--text-tertiary);">
                <strong>Mapped to:</strong> ${clause.mappedControl}
              </div>
            </div>
          `).join('')}
          ${compliantClauses.length > 3 ? `<div style="font-size: 12px; color: var(--text-secondary); text-align: center; padding: 8px;">And ${compliantClauses.length - 3} more compliant clauses...</div>` : ''}
        </div>
      ` : ''}
      
      <!-- Gap Clauses -->
      ${gapClauses.length > 0 ? `
        <div style="margin-bottom: 24px;">
          <div style="font-size: 14px; font-weight: 700; color: var(--amber); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
            </svg>
            Gaps Requiring Remediation (${gapClauses.length})
          </div>
          ${gapClauses.map(clause => `
            <div style="padding: 12px; background: var(--amber-light); border-left: 3px solid var(--amber); border-radius: 6px; margin-bottom: 8px;">
              <div style="font-weight: 700; font-size: 13px; margin-bottom: 4px; color: var(--amber);">${clause.id} — ${clause.title}</div>
              <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 6px;">${clause.requirement}</div>
              <div style="font-size: 11px; color: var(--text-tertiary); margin-bottom: 6px;">
                <strong>Mapped to:</strong> ${clause.mappedControl}
              </div>
              <div style="padding: 8px; background: white; border-radius: 4px; font-size: 12px; color: var(--text-primary);">
                <strong style="color: var(--amber);">Gap:</strong> ${clause.gap}
              </div>
            </div>
          `).join('')}
        </div>
      ` : ''}
    </div>
  `, `
    <button class="btn btn-secondary" onclick="closeModal()">Close</button>
    <button class="btn btn-primary" onclick="closeModal(); exportRFPReport('${rfp.id}')">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
        <polyline points="7 10 12 15 17 10"/>
        <line x1="12" y1="15" x2="12" y2="3"/>
      </svg>
      Export Full Report
    </button>
  `);
}

function analyzeRFP(rfpId) {
  showToast('Running multi-LLM analysis on RFP...', 'info');
  setTimeout(() => {
    showToast('✓ Analysis complete - clauses mapped to controls', 'success');
  }, 1500);
}

function exportRFPReport(rfpId) {
  const rfp = RFPS.find(r => r.id === rfpId);
  if (!rfp) {
    showToast('RFP not found', 'error');
    return;
  }
  
  const doc = AtomicPDF.create('RFP Gap Analysis');
  const controls = getControls();
  
  // Header
  let y = AtomicPDF.addHeader(doc, 'RFP Gap Analysis Report', rfp.client);
  
  // RFP Details
  y = AtomicPDF.addSectionTitle(doc, y, 'RFP Overview');
  y = AtomicPDF.addParagraph(doc, y, `Client: ${rfp.client}`, { fontStyle: 'bold' });
  y = AtomicPDF.addParagraph(doc, y, `Type: ${rfp.type} | Deadline: ${rfp.deadline} | Status: ${rfp.status}`);
  y += 5;
  
  // Metrics
  const completionPercent = ((rfp.mapped / rfp.requirements) * 100).toFixed(0);
  y = AtomicPDF.addMetricsBox(doc, y, [
    { label: 'Total Requirements', value: rfp.requirements, color: AtomicPDF.colors.text },
    { label: 'Mapped', value: rfp.mapped, color: AtomicPDF.colors.green, bgColor: [220, 252, 231] },
    { label: 'Gaps', value: rfp.gaps, color: AtomicPDF.colors.amber, bgColor: [254, 243, 199] },
    { label: 'Confidence', value: rfp.confidence, color: AtomicPDF.colors.trust, bgColor: [204, 251, 241] }
  ]);
  
  // Coverage bar (as text representation)
  y = AtomicPDF.addSectionTitle(doc, y, 'Gap Analysis Summary');
  y = AtomicPDF.addParagraph(doc, y, `Coverage: ${completionPercent}% of requirements mapped to existing controls`);
  y += 5;
  
  // Mapped controls
  y = AtomicPDF.addSectionTitle(doc, y, 'Relevant Controls');
  const ctrlHeaders = ['Control ID', 'Name', 'Trust', 'Frameworks', 'Relevance'];
  const ctrlRows = controls.slice(0, 8).map(c => [
    c.id, c.name.substring(0, 25), (c.trust || 0).toFixed(2),
    (c.frameworks || []).join(', ').substring(0, 20), 'High'
  ]);
  y = AtomicPDF.addTable(doc, y, ctrlHeaders, ctrlRows);
  
  // Recommendations
  y = AtomicPDF.checkNewPage(doc, y, 60);
  y = AtomicPDF.addSectionTitle(doc, y, 'Recommendations');
  y = AtomicPDF.addParagraph(doc, y, `• Address ${rfp.gaps} identified gaps before submission deadline`);
  y = AtomicPDF.addParagraph(doc, y, '• Focus on high-priority requirements with Δ > 0.15');
  y = AtomicPDF.addParagraph(doc, y, '• Upload additional evidence for partially mapped controls');
  
  // Proof
  y = AtomicPDF.checkNewPage(doc, y, 45);
  const hash = generateHash({ type: 'rfp-report', rfpId: rfp.id, timestamp: Date.now() });
  y = AtomicPDF.addProofBox(doc, y, hash.substring(0, 32), STATE.currentSnapshot, new Date().toISOString());
  
  AtomicPDF.download(doc, `atomic-trust-rfp-${rfp.id}-${Date.now()}.pdf`);
  showToast(`Gap analysis report for ${rfp.client} exported as PDF`, 'success');
}

// ---- FORENSICS CASES FUNCTIONS ----

function createForensicsCase() {
  openModal('Create Investigation Case', `
    <div style="padding: 20px;">
      <div style="margin-bottom: 24px;">
        <label style="display: block; font-weight: 700; font-size: 13px; margin-bottom: 8px; color: var(--text-primary);">
          Case Title
        </label>
        <input type="text" placeholder="Brief description of the incident..." style="width: 100%; padding: 12px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px; font-family: 'Inter', sans-serif;">
      </div>
      
      <div style="margin-bottom: 24px;">
        <label style="display: block; font-weight: 700; font-size: 13px; margin-bottom: 8px; color: var(--text-primary);">
          Case Type
        </label>
        <select style="width: 100%; padding: 12px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px; font-family: 'Inter', sans-serif;">
          <option value="security_incident">Security Incident</option>
          <option value="policy_violation">Policy Violation</option>
          <option value="compliance_drift">Compliance Drift</option>
          <option value="compliance_violation">Compliance Violation</option>
          <option value="other">Other</option>
        </select>
      </div>
      
      <div style="margin-bottom: 24px;">
        <label style="display: block; font-weight: 700; font-size: 13px; margin-bottom: 8px; color: var(--text-primary);">
          Severity
        </label>
        <select style="width: 100%; padding: 12px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px; font-family: 'Inter', sans-serif;">
          <option value="critical">🔴 Critical</option>
          <option value="high">🟠 High</option>
          <option value="medium" selected>🟡 Medium</option>
          <option value="low">🟢 Low</option>
        </select>
      </div>
      
      <div style="margin-bottom: 24px;">
        <label style="display: block; font-weight: 700; font-size: 13px; margin-bottom: 8px; color: var(--text-primary);">
          Affected Systems
        </label>
        <input type="text" placeholder="e.g., Production Database, API Gateway..." style="width: 100%; padding: 12px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px; font-family: 'Inter', sans-serif;">
      </div>
      
      <div style="margin-bottom: 24px;">
        <label style="display: block; font-weight: 700; font-size: 13px; margin-bottom: 8px; color: var(--text-primary);">
          Initial Description
        </label>
        <textarea style="width: 100%; padding: 12px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px; font-family: 'Inter', sans-serif; min-height: 100px; resize: vertical;" placeholder="What happened? When was it detected? What evidence exists?"></textarea>
      </div>
      
      <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 24px;">
        <div style="font-size: 12px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 8px;">🔒 CRYPTOGRAPHIC AUDIT TRAIL</div>
        <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.6;">
          This case will be:
          <ul style="margin: 8px 0 0 20px; padding: 0;">
            <li>Assigned a unique immutable case ID</li>
            <li>Timeline events hashed with BLAKE3</li>
            <li>All actions logged to append-only audit trail</li>
            <li>Evidence linked with cryptographic proofs</li>
            <li>Complete chain of custody maintained</li>
          </ul>
        </div>
      </div>
    </div>
  `, `
    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
    <button class="btn btn-primary" onclick="closeModal(); showToast('✓ Case created and investigation started', 'success')">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
        <path d="M12 5v14M5 12h14"/>
      </svg>
      Create Case
    </button>
  `);
}

function showForensicsDetail(caseId) {
  const forensicsCase = FORENSICS_CASES.find(c => c.id === caseId);
  if (!forensicsCase) return;
  
  openModal(`${forensicsCase.id}: ${forensicsCase.title}`, `
    <div style="padding: 20px;">
      <!-- Header Info -->
      <div style="margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid var(--border-light);">
        <div style="display: flex; gap: 12px; margin-bottom: 12px; align-items: center;">
          ${forensicsCase.status === 'resolved' ? '<span style="padding: 4px 10px; background: var(--green-light); color: var(--green); border-radius: 6px; font-size: 11px; font-weight: 700;">✓ RESOLVED</span>' : ''}
          ${forensicsCase.status === 'active' ? '<span style="padding: 4px 10px; background: var(--red-light); color: var(--red); border-radius: 6px; font-size: 11px; font-weight: 700;">⚡ ACTIVE</span>' : ''}
          ${forensicsCase.status === 'investigating' ? '<span style="padding: 4px 10px; background: var(--amber-light); color: var(--amber); border-radius: 6px; font-size: 11px; font-weight: 700;">🔍 INVESTIGATING</span>' : ''}
          ${forensicsCase.severity === 'critical' ? '<span style="padding: 4px 10px; background: var(--red-light); color: var(--red); border-radius: 6px; font-size: 11px; font-weight: 700;">🔴 CRITICAL</span>' : ''}
          ${forensicsCase.severity === 'high' ? '<span style="padding: 4px 10px; background: var(--amber-light); color: var(--amber); border-radius: 6px; font-size: 11px; font-weight: 700;">🟠 HIGH</span>' : ''}
          ${forensicsCase.severity === 'medium' ? '<span style="padding: 4px 10px; background: var(--brand-light); color: var(--brand); border-radius: 6px; font-size: 11px; font-weight: 700;">🟡 MEDIUM</span>' : ''}
        </div>
        <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">
          <strong>Opened:</strong> ${new Date(forensicsCase.openedAt).toLocaleString()} by ${forensicsCase.openedBy}
        </div>
        <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">
          <strong>Assigned to:</strong> ${forensicsCase.assignedTo} • <strong>Priority:</strong> ${forensicsCase.priority.toUpperCase()}
        </div>
        ${forensicsCase.resolvedAt ? `
          <div style="font-size: 13px; color: var(--green); font-weight: 700;">
            ✓ Resolved: ${new Date(forensicsCase.resolvedAt).toLocaleString()}
          </div>
        ` : ''}
      </div>
      
      <!-- Metrics -->
      ${forensicsCase.metrics ? `
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 24px;">
          <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
            <div style="font-size: 11px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 4px;">DETECTION TIME</div>
            <div style="font-size: 18px; font-weight: 700; font-family: 'IBM Plex Mono', monospace;">${Math.floor(forensicsCase.metrics.detectionTime / 60)}m ${forensicsCase.metrics.detectionTime % 60}s</div>
          </div>
          <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
            <div style="font-size: 11px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 4px;">RESPONSE TIME</div>
            <div style="font-size: 18px; font-weight: 700; font-family: 'IBM Plex Mono', monospace;">${Math.floor(forensicsCase.metrics.responseTime / 60)}m ${forensicsCase.metrics.responseTime % 60}s</div>
          </div>
          ${forensicsCase.metrics.containmentTime ? `
            <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
              <div style="font-size: 11px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 4px;">CONTAINMENT TIME</div>
              <div style="font-size: 18px; font-weight: 700; font-family: 'IBM Plex Mono', monospace;">${Math.floor(forensicsCase.metrics.containmentTime / 86400)}d ${Math.floor((forensicsCase.metrics.containmentTime % 86400) / 3600)}h</div>
            </div>
          ` : ''}
          <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
            <div style="font-size: 11px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 4px;">SEVERITY SCORE</div>
            <div style="font-size: 18px; font-weight: 700; font-family: 'IBM Plex Mono', monospace; color: ${forensicsCase.metrics.severityScore >= 7 ? 'var(--red)' : forensicsCase.metrics.severityScore >= 4 ? 'var(--amber)' : 'var(--green)'};">${forensicsCase.metrics.severityScore.toFixed(1)}/10</div>
          </div>
        </div>
      ` : ''}
      
      <!-- Timeline -->
      <div style="margin-bottom: 24px;">
        <div style="font-size: 14px; font-weight: 700; color: var(--text-primary); margin-bottom: 16px;">
          Investigation Timeline (${forensicsCase.timeline.length} events)
        </div>
        <div style="position: relative; padding-left: 24px;">
          <div style="position: absolute; left: 7px; top: 0; bottom: 0; width: 2px; background: var(--border-light);"></div>
          ${forensicsCase.timeline.map((event, idx) => `
            <div style="position: relative; margin-bottom: ${idx < forensicsCase.timeline.length - 1 ? '20px' : '0'};">
              <div style="position: absolute; left: -20px; top: 4px; width: 12px; height: 12px; border-radius: 50%; background: ${event.severity === 'critical' ? 'var(--red)' : event.severity === 'high' ? 'var(--amber)' : event.severity === 'medium' ? 'var(--brand)' : 'var(--green)'}; border: 2px solid white;"></div>
              <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; border-left: 3px solid ${event.severity === 'critical' ? 'var(--red)' : event.severity === 'high' ? 'var(--amber)' : event.severity === 'medium' ? 'var(--brand)' : 'var(--green)'};">
                <div style="font-size: 11px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 4px;">
                  ${new Date(event.timestamp).toLocaleString()} • ${event.type.replace('_', ' ').toUpperCase()}
                </div>
                <div style="font-size: 13px; color: var(--text-primary); font-weight: 600; margin-bottom: 4px;">
                  ${event.event}
                </div>
                <div style="font-size: 12px; color: var(--text-secondary);">
                  ${event.actor}
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      </div>
      
      <!-- Findings -->
      ${forensicsCase.findings ? `
        <div style="padding: 20px; background: var(--bg-secondary); border-radius: 12px; margin-bottom: 24px;">
          <div style="font-size: 14px; font-weight: 700; color: var(--text-primary); margin-bottom: 16px;">Investigation Findings</div>
          
          <div style="margin-bottom: 16px;">
            <div style="font-size: 12px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 6px;">ROOT CAUSE</div>
            <div style="font-size: 13px; color: var(--text-primary);">${forensicsCase.findings.rootCause}</div>
          </div>
          
          <div style="margin-bottom: 16px;">
            <div style="font-size: 12px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 6px;">IMPACT ASSESSMENT</div>
            <div style="font-size: 13px; color: var(--text-primary);">${forensicsCase.findings.impactAssessment}</div>
          </div>
          
          <div>
            <div style="font-size: 12px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 8px;">RECOMMENDATIONS</div>
            <ul style="margin: 0; padding-left: 20px;">
              ${forensicsCase.findings.recommendations.map(rec => `
                <li style="font-size: 13px; color: var(--text-primary); margin-bottom: 6px;">${rec}</li>
              `).join('')}
            </ul>
          </div>
        </div>
      ` : ''}
      
      <!-- Affected Items -->
      <div style="margin-bottom: 24px;">
        <div style="font-size: 14px; font-weight: 700; color: var(--text-primary); margin-bottom: 12px;">Affected Systems & Controls</div>
        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
          ${forensicsCase.affectedSystems.map(sys => `
            <span style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 6px; font-size: 12px;">
              💻 ${sys}
            </span>
          `).join('')}
          ${forensicsCase.affectedControls.map(ctrl => `
            <span style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 6px; font-size: 12px;">
              🛡️ ${ctrl}
            </span>
          `).join('')}
        </div>
      </div>
    </div>
  `, `
    <button class="btn btn-secondary" onclick="closeModal()">Close</button>
    ${forensicsCase.status !== 'resolved' ? `
      <button class="btn btn-primary" onclick="closeModal(); showToast('Case marked as resolved', 'success')">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
          <polyline points="20 6 9 17 4 12"/>
        </svg>
        Mark Resolved
      </button>
    ` : `
      <button class="btn btn-primary" onclick="closeModal(); exportCaseReport('${forensicsCase.id}')">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
          <polyline points="7 10 12 15 17 10"/>
          <line x1="12" y1="15" x2="12" y2="3"/>
        </svg>
        Export Report
      </button>
    `}
  `);
}

function analyzeCase(caseId) {
  showToast('Running forensic analysis on case timeline...', 'info');
  setTimeout(() => {
    showToast('✓ Analysis complete - anomalies detected and timeline verified', 'success');
  }, 1500);
}

function exportCaseReport(caseId) {
  const forensicsCase = FORENSICS_CASES.find(c => c.id === caseId);
  if (!forensicsCase) {
    showToast('Case not found', 'error');
    return;
  }
  
  const doc = AtomicPDF.create('Forensic Investigation');
  
  // Header with CONFIDENTIAL badge
  let y = AtomicPDF.addHeader(doc, 'Forensic Investigation Report', 'CONFIDENTIAL');
  
  // Case info
  y = AtomicPDF.addSectionTitle(doc, y, 'Case Information');
  
  const severityColor = forensicsCase.severity === 'critical' ? AtomicPDF.colors.red :
                        forensicsCase.severity === 'high' ? AtomicPDF.colors.amber : AtomicPDF.colors.text;
  
  y = AtomicPDF.addMetricsBox(doc, y, [
    { label: 'Case ID', value: forensicsCase.id, color: AtomicPDF.colors.text },
    { label: 'Severity', value: forensicsCase.severity.toUpperCase(), color: severityColor },
    { label: 'Status', value: forensicsCase.status.toUpperCase(), color: forensicsCase.status === 'closed' ? AtomicPDF.colors.green : AtomicPDF.colors.amber },
    { label: 'Assigned To', value: forensicsCase.assignedTo?.split(' ')[0] || 'Unassigned', color: AtomicPDF.colors.brand }
  ]);
  
  // Case details
  y = AtomicPDF.addParagraph(doc, y, `Title: ${forensicsCase.title}`, { fontStyle: 'bold', fontSize: 12 });
  y = AtomicPDF.addParagraph(doc, y, `Type: ${forensicsCase.type} | Opened: ${forensicsCase.dateOpened}`);
  y = AtomicPDF.addParagraph(doc, y, `Affected Systems: ${(forensicsCase.affectedSystems || []).join(', ')}`);
  y += 5;
  
  // Timeline
  if (forensicsCase.timeline && forensicsCase.timeline.length > 0) {
    y = AtomicPDF.checkNewPage(doc, y, 60);
    y = AtomicPDF.addSectionTitle(doc, y, 'Investigation Timeline');
    const tlHeaders = ['Timestamp', 'Event', 'Status'];
    const tlRows = forensicsCase.timeline.map(t => [t.timestamp || '', t.event || '', t.status || '']);
    y = AtomicPDF.addTable(doc, y, tlHeaders, tlRows);
  }
  
  // Snapshots as findings
  if (forensicsCase.snapshots && forensicsCase.snapshots.length > 0) {
    y = AtomicPDF.checkNewPage(doc, y, 60);
    y = AtomicPDF.addSectionTitle(doc, y, 'Related Snapshots');
    const snapHeaders = ['Date', 'Block', 'Description', 'Hash'];
    const snapRows = forensicsCase.snapshots.map(s => [
      s.date || '', s.block || '', (s.description || '').substring(0, 30), (s.hash || '').substring(0, 8)
    ]);
    y = AtomicPDF.addTable(doc, y, snapHeaders, snapRows);
  }
  
  // Recommendations
  y = AtomicPDF.checkNewPage(doc, y, 60);
  y = AtomicPDF.addSectionTitle(doc, y, 'Recommendations');
  y = AtomicPDF.addParagraph(doc, y, '• Review access logs for affected systems during incident window');
  y = AtomicPDF.addParagraph(doc, y, '• Verify cryptographic chain integrity on all related controls');
  y = AtomicPDF.addParagraph(doc, y, '• Update incident response documentation based on findings');
  
  // Confidentiality notice
  y = AtomicPDF.checkNewPage(doc, y, 50);
  doc.setFillColor(254, 226, 226);
  doc.roundedRect(15, y, doc.internal.pageSize.getWidth() - 30, 20, 3, 3, 'F');
  doc.setTextColor(...AtomicPDF.colors.red);
  doc.setFontSize(10);
  doc.setFont('helvetica', 'bold');
  doc.text('⚠ CONFIDENTIAL - INTERNAL USE ONLY', 20, y + 13);
  y += 30;
  
  // Proof
  const hash = generateHash({ type: 'forensic-report', caseId: caseId, timestamp: Date.now() });
  y = AtomicPDF.addProofBox(doc, y, hash.substring(0, 32), STATE.currentSnapshot, new Date().toISOString());
  
  AtomicPDF.download(doc, `atomic-trust-forensic-${caseId}-${Date.now()}.pdf`);
  showToast(`Forensic report for ${caseId} exported as PDF`, 'success');
}

// ---- FRAMEWORK MAPPER FUNCTIONS (MGF PATENT #2) ----

// Track selected file for ingestion
let selectedIngestFile = null;
let selectedIngestContent = '';

function ingestFramework(frameworkId = null) {
  const fw = frameworkId ? FRAMEWORKS.find(f => f.id === frameworkId) : null;
  const title = fw ? `Ingest ${fw.name}` : 'Ingest New Framework';
  selectedIngestFile = null;
  selectedIngestContent = '';

  openModal(title, `
    <div style="padding: 20px;">
      <div style="margin-bottom: 20px;">
        <label style="display: block; font-weight: 700; font-size: 13px; margin-bottom: 8px; color: var(--text-primary);">
          Framework Name
        </label>
        <input type="text" id="ingestFrameworkName" placeholder="e.g., PCI DSS 4.0, HIPAA, State Policy" style="width: 100%; padding: 12px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px;">
      </div>

      <div style="margin-bottom: 20px;">
        <label style="display: block; font-weight: 700; font-size: 13px; margin-bottom: 8px; color: var(--text-primary);">
          Description
        </label>
        <textarea id="ingestFrameworkDesc" placeholder="Brief description of the framework..." rows="2" style="width: 100%; padding: 12px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 14px; resize: vertical;"></textarea>
      </div>

      <div style="margin-bottom: 24px;">
        <label style="display: block; font-weight: 700; font-size: 13px; margin-bottom: 8px; color: var(--text-primary);">
          Framework Content
        </label>
        <div id="ingestDropZone" style="border: 2px dashed var(--border-light); border-radius: 12px; padding: 30px; text-align: center; background: var(--bg-secondary); cursor: pointer; transition: all 0.2s ease;" onclick="document.getElementById('ingestFileInput').click()">
          <input type="file" id="ingestFileInput" accept=".txt,.json,.md,.csv,.xml" style="display: none;" onchange="handleIngestFileSelect(this)">
          <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="var(--text-tertiary)" stroke-width="2" style="margin: 0 auto 12px;">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14,2 14,8 20,8"/>
            <line x1="12" y1="18" x2="12" y2="12"/>
            <line x1="9" y1="15" x2="15" y2="15"/>
          </svg>
          <div id="ingestFileName" style="font-weight: 700; font-size: 14px; margin-bottom: 6px; color: var(--text-primary);">Click to Upload or Paste Below</div>
          <div style="font-size: 12px; color: var(--text-secondary);">TXT, JSON, MD, CSV (framework text)</div>
        </div>
        <div style="margin-top: 12px; text-align: center; font-size: 12px; color: var(--text-tertiary);">OR</div>
        <textarea id="ingestContentText" placeholder="Paste framework text here...

1.1 Access Control - Organizations must implement access control mechanisms...
1.2 Authentication - Multi-factor authentication required for...
2.1 Data Encryption - All data at rest must be encrypted using..." rows="6" style="width: 100%; margin-top: 12px; padding: 12px; border: 1px solid var(--border-light); border-radius: 8px; font-size: 12px; font-family: 'IBM Plex Mono', monospace; resize: vertical;"></textarea>
      </div>

      <div style="padding: 16px; background: var(--green-light); border-radius: 8px; margin-bottom: 24px;">
        <div style="font-size: 12px; font-weight: 700; color: var(--green); margin-bottom: 8px;">⚛️ MULTI-LLM CONSENSUS INGESTION</div>
        <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.6;">
          Upon ingestion, the system will:
          <ol style="margin: 8px 0 0 16px; padding: 0; font-size: 11px;">
            <li>Extract controls via Claude, GPT-4o, and Gemini consensus</li>
            <li>Calculate ΦΨΔIPT operator scores for each extracted control</li>
            <li>Match semantically to existing NIST 800-53 controls</li>
            <li>Create cross-framework equivalence relationships</li>
            <li>Discover emergent operators (Τ, Β, Ι) between frameworks</li>
          </ol>
        </div>
      </div>

      <div id="ingestStatus" style="display: none; padding: 16px; border-radius: 8px; margin-bottom: 16px;"></div>
    </div>
  `, `
    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
    <button class="btn btn-primary" onclick="submitFrameworkIngestion()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
        <polyline points="17 8 12 3 7 8"/>
        <line x1="12" y1="3" x2="12" y2="15"/>
      </svg>
      Ingest via Multi-LLM Consensus
    </button>
  `);

  // Set up drag-and-drop
  setTimeout(() => {
    const dropZone = document.getElementById('ingestDropZone');
    if (dropZone) {
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = 'var(--brand)';
        dropZone.style.background = 'var(--brand-light)';
      });
      dropZone.addEventListener('dragleave', () => {
        dropZone.style.borderColor = 'var(--border-light)';
        dropZone.style.background = 'var(--bg-secondary)';
      });
      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = 'var(--border-light)';
        dropZone.style.background = 'var(--bg-secondary)';
        if (e.dataTransfer.files.length > 0) {
          handleIngestFileSelect({ files: e.dataTransfer.files });
        }
      });
    }
  }, 100);
}

function handleIngestFileSelect(input) {
  const file = input.files[0];
  if (!file) return;

  selectedIngestFile = file;
  const fileNameEl = document.getElementById('ingestFileName');
  if (fileNameEl) {
    fileNameEl.innerHTML = `<span style="color: var(--green);">✓</span> ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
  }

  // Read file content
  const reader = new FileReader();
  reader.onload = (e) => {
    selectedIngestContent = e.target.result;
    const textArea = document.getElementById('ingestContentText');
    if (textArea) {
      textArea.value = selectedIngestContent.substring(0, 5000) + (selectedIngestContent.length > 5000 ? '\n...[truncated for preview]' : '');
    }
  };
  reader.readAsText(file);
}

async function submitFrameworkIngestion() {
  const name = document.getElementById('ingestFrameworkName')?.value?.trim();
  const description = document.getElementById('ingestFrameworkDesc')?.value?.trim();
  const pastedContent = document.getElementById('ingestContentText')?.value?.trim();

  // Use pasted content or file content
  const content = pastedContent || selectedIngestContent;

  if (!name) {
    showToast('Please enter a framework name', 'error');
    return;
  }

  if (!content || content.length < 50) {
    showToast('Please provide framework content (file or text)', 'error');
    return;
  }

  // Show loading status
  const statusEl = document.getElementById('ingestStatus');
  if (statusEl) {
    statusEl.style.display = 'block';
    statusEl.style.background = 'var(--brand-light)';
    statusEl.innerHTML = `
      <div style="display: flex; align-items: center; gap: 12px;">
        <div class="loading-spinner" style="width: 20px; height: 20px; border: 2px solid var(--brand); border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <div>
          <div style="font-weight: 700; color: var(--brand);">Ingesting Framework...</div>
          <div style="font-size: 11px; color: var(--text-secondary);" id="ingestProgress">Running multi-LLM consensus extraction...</div>
        </div>
      </div>
    `;
  }

  // Progress updates
  setTimeout(() => {
    const prog = document.getElementById('ingestProgress');
    if (prog) prog.textContent = 'Claude, GPT-4o, Gemini analyzing controls...';
  }, 1000);
  setTimeout(() => {
    const prog = document.getElementById('ingestProgress');
    if (prog) prog.textContent = 'Computing ΦΨΔIPT operator scores...';
  }, 2500);

  try {
    const result = await API.ingestFramework(name, description || `Framework: ${name}`, content, 'text');

    if (result.success && result.framework) {
      closeModal();

      // Refresh framework data
      await loadFrameworkData();

      // Show success with details
      showToast(`✓ "${name}" ingested: ${result.framework.controls_extracted} controls extracted`, 'success');

      // Show detailed result modal
      setTimeout(() => {
        showIngestionResult(result.framework);
      }, 500);

      // Refresh the view
      if (currentView === 'frameworks') {
        showView('frameworks');
      }
    } else {
      throw new Error(result.error || 'Ingestion failed');
    }
  } catch (err) {
    if (statusEl) {
      statusEl.style.background = 'var(--red-light)';
      statusEl.innerHTML = `
        <div style="color: var(--red); font-weight: 700;">❌ Ingestion Failed</div>
        <div style="font-size: 12px; color: var(--text-secondary);">${err.message}</div>
      `;
    }
    showToast(`Ingestion error: ${err.message}`, 'error');
  }
}

function showIngestionResult(framework) {
  const phi = framework.operators?.phi?.toFixed(3) || '0.000';
  const psi = framework.operators?.psi?.toFixed(3) || '0.000';
  const delta = framework.operators?.delta?.toFixed(3) || '0.000';
  const trust = framework.operators?.trust?.toFixed(3) || '0.000';

  openModal('Framework Ingested Successfully', `
    <div style="padding: 20px;">
      <div style="text-align: center; margin-bottom: 24px;">
        <div style="font-size: 48px; margin-bottom: 12px;">✅</div>
        <div style="font-size: 18px; font-weight: 700; margin-bottom: 4px;">${framework.name}</div>
        <div style="font-size: 14px; color: var(--text-secondary);">${framework.controls_extracted} controls extracted via multi-LLM consensus</div>
      </div>

      <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 24px;">
        <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
          <div class="operator-glyph phi" style="width: 28px; height: 28px; font-size: 14px; margin: 0 auto 8px;">Φ</div>
          <div style="font-size: 20px; font-weight: 700; font-family: 'IBM Plex Mono', monospace;">${phi}</div>
          <div style="font-size: 10px; color: var(--text-tertiary);">Consensus</div>
        </div>
        <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
          <div class="operator-glyph psi" style="width: 28px; height: 28px; font-size: 14px; margin: 0 auto 8px;">Ψ</div>
          <div style="font-size: 20px; font-weight: 700; font-family: 'IBM Plex Mono', monospace;">${psi}</div>
          <div style="font-size: 10px; color: var(--text-tertiary);">Freshness</div>
        </div>
        <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
          <div class="operator-glyph delta" style="width: 28px; height: 28px; font-size: 14px; margin: 0 auto 8px;">Δ</div>
          <div style="font-size: 20px; font-weight: 700; font-family: 'IBM Plex Mono', monospace;">${delta}</div>
          <div style="font-size: 10px; color: var(--text-tertiary);">Divergence</div>
        </div>
        <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
          <div class="operator-glyph trust" style="width: 28px; height: 28px; font-size: 14px; margin: 0 auto 8px;">T</div>
          <div style="font-size: 20px; font-weight: 700; font-family: 'IBM Plex Mono', monospace;">${trust}</div>
          <div style="font-size: 10px; color: var(--text-tertiary);">Trust</div>
        </div>
      </div>

      ${framework.model_responses ? `
        <div style="margin-bottom: 24px;">
          <div style="font-size: 13px; font-weight: 700; margin-bottom: 12px;">Model Responses</div>
          ${framework.model_responses.map(m => `
            <div style="display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; background: var(--bg-secondary); border-radius: 6px; margin-bottom: 6px;">
              <span style="font-size: 12px; font-weight: 600;">${m.model}</span>
              <span style="font-size: 12px; font-family: 'IBM Plex Mono', monospace;">${m.controls_extracted} controls · ${(m.confidence * 100).toFixed(0)}% conf</span>
            </div>
          `).join('')}
        </div>
      ` : ''}

      <div style="padding: 16px; background: var(--green-light); border-radius: 8px;">
        <div style="font-size: 12px; font-weight: 700; color: var(--green); margin-bottom: 8px;">🔗 READY FOR INTERSECTION</div>
        <div style="font-size: 12px; color: var(--text-secondary);">
          This framework can now be compared with SOC2, ISO27001, NIST CSF, and other ingested frameworks to discover semantic mappings and emergent operators.
        </div>
      </div>
    </div>
  `, `
    <button class="btn btn-secondary" onclick="closeModal()">Close</button>
    <button class="btn btn-primary" onclick="closeModal(); compareWithFramework('${framework.id}')">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
        <circle cx="11" cy="11" r="8"/>
        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
      </svg>
      Find Intersections
    </button>
  `);
}

async function compareWithFramework(frameworkId) {
  showToast('Finding framework intersections...', 'info');

  // Compare with SOC2 by default
  const result = await API.findFrameworkIntersections(frameworkId, 'SOC2', 0.3);

  if (result.total_intersections > 0) {
    showToast(`Found ${result.total_intersections} intersections with SOC2`, 'success');
    // Could show detailed intersection view here
  } else {
    showToast('No strong intersections found (try lower similarity threshold)', 'info');
  }
}

// Legacy simulation function (kept for backwards compatibility)
function simulateIngestion(frameworkId) {
  ingestFramework(frameworkId);
}

// Show detail for ingested framework (from API)
async function showIngestedFrameworkDetail(frameworkId) {
  showToast('Loading framework details...', 'info');

  try {
    const result = await API.getIngestedFramework(frameworkId);

    if (!result.framework) {
      // Fall back to cached data
      const fw = FRAMEWORK_DATA.ingested.find(f => f.id === frameworkId);
      if (!fw) {
        showToast('Framework not found', 'error');
        return;
      }
      showIngestedFrameworkModal(fw);
    } else {
      showIngestedFrameworkModal(result.framework, result.summary);
    }
  } catch (err) {
    showToast(`Error loading framework: ${err.message}`, 'error');
  }
}

function showIngestedFrameworkModal(fw, summary = null) {
  const phi = fw.operators?.phi?.toFixed(3) || (fw.extraction_phi ? parseFloat(fw.extraction_phi).toFixed(3) : '0.000');
  const psi = fw.operators?.psi?.toFixed(3) || (fw.extraction_psi ? parseFloat(fw.extraction_psi).toFixed(3) : '0.000');
  const delta = fw.operators?.delta?.toFixed(3) || (fw.extraction_delta ? parseFloat(fw.extraction_delta).toFixed(3) : '0.000');
  const trust = fw.operators?.trust?.toFixed(3) || (fw.extraction_trust ? parseFloat(fw.extraction_trust).toFixed(3) : '0.000');
  const controlCount = fw.controls_count || fw.controls?.length || 0;
  const categories = summary?.categories || [];

  openModal(`${fw.name}`, `
    <div style="padding: 20px;">
      <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 24px;">
        <span style="padding: 4px 12px; background: var(--green-light); color: var(--green); border-radius: 6px; font-size: 12px; font-weight: 700;">INGESTED VIA MULTI-LLM CONSENSUS</span>
        <span style="padding: 4px 12px; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 6px; font-size: 12px; font-family: 'IBM Plex Mono', monospace;">${fw.source_type?.toUpperCase() || 'TEXT'}</span>
      </div>

      <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 24px;">
        ${fw.description || 'No description provided'}
      </div>

      <!-- Stats -->
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 24px;">
        <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
          <div style="font-size: 11px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 4px;">EXTRACTED CONTROLS</div>
          <div style="font-size: 24px; font-weight: 700; font-family: 'IBM Plex Mono', monospace;">${controlCount}</div>
        </div>
        <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
          <div style="font-size: 11px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 4px;">CATEGORIES</div>
          <div style="font-size: 24px; font-weight: 700; font-family: 'IBM Plex Mono', monospace;">${categories.length || 'N/A'}</div>
        </div>
      </div>

      <!-- ΦΨΔIPT Operators -->
      <div style="margin-bottom: 24px;">
        <div style="font-size: 13px; font-weight: 700; margin-bottom: 12px;">ΦΨΔIPT Operator Scores</div>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
          <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
            <div class="operator-glyph phi" style="width: 24px; height: 24px; font-size: 12px; margin: 0 auto 6px;">Φ</div>
            <div style="font-size: 16px; font-weight: 700; font-family: 'IBM Plex Mono', monospace;">${phi}</div>
          </div>
          <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
            <div class="operator-glyph psi" style="width: 24px; height: 24px; font-size: 12px; margin: 0 auto 6px;">Ψ</div>
            <div style="font-size: 16px; font-weight: 700; font-family: 'IBM Plex Mono', monospace;">${psi}</div>
          </div>
          <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
            <div class="operator-glyph delta" style="width: 24px; height: 24px; font-size: 12px; margin: 0 auto 6px;">Δ</div>
            <div style="font-size: 16px; font-weight: 700; font-family: 'IBM Plex Mono', monospace;">${delta}</div>
          </div>
          <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; text-align: center;">
            <div class="operator-glyph trust" style="width: 24px; height: 24px; font-size: 12px; margin: 0 auto 6px;">T</div>
            <div style="font-size: 16px; font-weight: 700; font-family: 'IBM Plex Mono', monospace;">${trust}</div>
          </div>
        </div>
      </div>

      ${categories.length > 0 ? `
        <div style="margin-bottom: 24px;">
          <div style="font-size: 13px; font-weight: 700; margin-bottom: 12px;">Control Categories</div>
          <div style="display: flex; flex-wrap: wrap; gap: 8px;">
            ${categories.map(cat => `
              <span style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 6px; font-size: 12px;">${cat}</span>
            `).join('')}
          </div>
        </div>
      ` : ''}

      <div style="padding: 16px; background: var(--brand-light); border-radius: 8px;">
        <div style="font-size: 12px; font-weight: 700; color: var(--brand); margin-bottom: 8px;">🔗 INTERSECTION ANALYSIS</div>
        <div style="font-size: 12px; color: var(--text-secondary);">
          Compare this framework with SOC2, ISO27001, NIST CSF, or other ingested frameworks to discover semantic mappings and emergent operators.
        </div>
      </div>
    </div>
  `, `
    <button class="btn btn-secondary" onclick="closeModal()">Close</button>
    <button class="btn btn-primary" onclick="closeModal(); compareWithFramework('${fw.id}')">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
        <circle cx="11" cy="11" r="8"/>
        <line x1="21" y1="21" x2="16.65" y2="16.65"/>
      </svg>
      Find Intersections
    </button>
  `);
}

function showFrameworkDetail(frameworkId) {
  const fw = FRAMEWORKS.find(f => f.id === frameworkId);
  if (!fw) return;
  
  const coveragePercent = (fw.coverage * 100).toFixed(0);
  const coverageColor = fw.coverage >= 0.9 ? 'var(--green)' : fw.coverage >= 0.8 ? 'var(--trust-teal)' : 'var(--amber)';
  
  openModal(`${fw.name} (${fw.version})`, `
    <div style="padding: 20px;">
      <!-- Stats -->
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px;">
        <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
          <div style="font-size: 11px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 4px;">TOTAL CLAUSES</div>
          <div style="font-size: 20px; font-weight: 700; font-family: 'IBM Plex Mono', monospace;">${fw.totalClauses}</div>
        </div>
        <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
          <div style="font-size: 11px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 4px;">MAPPED</div>
          <div style="font-size: 20px; font-weight: 700; font-family: 'IBM Plex Mono', monospace; color: ${coverageColor};">${fw.mappedClauses}</div>
        </div>
        <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px;">
          <div style="font-size: 11px; font-weight: 700; color: var(--text-tertiary); margin-bottom: 4px;">COVERAGE</div>
          <div style="font-size: 20px; font-weight: 700; font-family: 'IBM Plex Mono', monospace; color: ${coverageColor};">${coveragePercent}%</div>
        </div>
      </div>
      
      <!-- Decay Status -->
      <div style="padding: 20px; background: var(--bg-secondary); border-radius: 12px; margin-bottom: 24px; border-left: 3px solid ${fw.psi >= 0.9 ? 'var(--green)' : fw.psi >= 0.8 ? 'var(--trust-teal)' : fw.psi >= 0.7 ? 'var(--amber)' : 'var(--red)'};">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
          <div>
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
              <div class="operator-glyph psi" style="width: 24px; height: 24px; font-size: 13px;">Ψ</div>
              <span style="font-size: 14px; font-weight: 700;">Credential-Decay Status</span>
            </div>
            <div style="font-size: 13px; color: var(--text-secondary);">
              Last reviewed: ${new Date(fw.lastReviewed).toLocaleDateString()} (${fw.daysOld} days ago)
            </div>
          </div>
          <div style="font-size: 32px; font-weight: 700; font-family: 'IBM Plex Mono', monospace; color: ${fw.psi >= 0.9 ? 'var(--green)' : fw.psi >= 0.8 ? 'var(--trust-teal)' : fw.psi >= 0.7 ? 'var(--amber)' : 'var(--red)'};">${fw.psi.toFixed(2)}</div>
        </div>
        <div style="height: 8px; background: var(--border-light); border-radius: 4px; overflow: hidden; margin-bottom: 12px;">
          <div style="width: ${(fw.psi * 100).toFixed(0)}%; height: 100%; background: ${fw.psi >= 0.9 ? 'var(--green)' : fw.psi >= 0.8 ? 'var(--trust-teal)' : fw.psi >= 0.7 ? 'var(--amber)' : 'var(--red)'}; border-radius: 4px;"></div>
        </div>
        <div style="font-size: 12px; color: var(--text-secondary);">
          ${fw.psi >= 0.9 ? '✓ Fresh mapping - high confidence in equivalence relationships' : 
            fw.psi >= 0.8 ? '⚠ Moderate decay - mappings aging, consider review within 30 days' :
            fw.psi >= 0.7 ? '⚠ Significant decay - review recommended within 2 weeks' :
            '🔴 Critical decay - mappings stale, immediate review required'}
        </div>
      </div>
      
      <!-- Transparency -->
      <div style="padding: 16px; background: var(--brand-light); border-radius: 8px; margin-bottom: 24px;">
        <div style="font-size: 13px; font-weight: 700; color: var(--brand); margin-bottom: 8px;">📊 FRESHNESS TRANSPARENCY</div>
        <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.6;">
          • Framework ingested: ${new Date(new Date(fw.lastReviewed).getTime() - (fw.daysOld * 86400000) + 86400000).toLocaleDateString()}<br>
          • Last validated: ${new Date(fw.lastReviewed).toLocaleDateString()}<br>
          • Days since review: ${fw.daysOld}<br>
          • Decay rate: ${((1 - fw.psi) * 100).toFixed(1)}% loss of confidence<br>
          • Recommended re-review: ${fw.psi >= 0.9 ? '90 days' : fw.psi >= 0.8 ? '30 days' : '7 days'}
        </div>
      </div>
      
      <!-- Actions -->
      <div style="display: flex; gap: 12px;">
        <button class="btn btn-sm btn-primary" onclick="closeModal(); validateFrameworkMappings('${fw.id}')" style="flex: 1;">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
          Re-Validate Mappings
        </button>
        <button class="btn btn-sm btn-secondary" onclick="closeModal(); exportFrameworkReport('${fw.id}')" style="flex: 1;">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 4px;">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" y1="15" x2="12" y2="3"/>
          </svg>
          Export Coverage Report
        </button>
      </div>
    </div>
  `, `
    <button class="btn btn-secondary" onclick="closeModal()">Close</button>
  `);
}

function showEquivalenceDetail(equivalenceId) {
  const eq = getEquivalences().find(e => e.id === equivalenceId);
  if (!eq) return;
  
  openModal(`${eq.id}: ${eq.family} Family`, `
    <div style="padding: 20px;">
      <!-- Header -->
      <div style="margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid var(--border-light);">
        <div style="font-size: 15px; color: var(--text-secondary); margin-bottom: 12px;">
          <strong>Maps to Control:</strong> ${eq.controlId} (${eq.controlName})
        </div>
        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
          <span style="padding: 6px 12px; background: var(--green-light); color: var(--green); border-radius: 6px; font-size: 12px; font-weight: 700;">
            ⚛️ ATOMIC PROPAGATION ENABLED
          </span>
          <span style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 6px; font-size: 12px; font-family: 'IBM Plex Mono', monospace;">
            Semantic Confidence: ${(eq.semanticConfidence * 100).toFixed(0)}%
          </span>
          <span style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 6px; font-size: 12px; font-family: 'IBM Plex Mono', monospace;">
            Divergence (Δ): ${eq.divergenceScore.toFixed(2)}
          </span>
        </div>
      </div>
      
      <!-- Equivalent Clauses -->
      <div style="margin-bottom: 24px;">
        <div style="font-size: 14px; font-weight: 700; margin-bottom: 12px;">Equivalent Clauses (${eq.equivalentClauses.length})</div>
        ${eq.equivalentClauses.map(clause => `
          <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 12px; border-left: 3px solid ${clause.psi >= 0.9 ? 'var(--green)' : clause.psi >= 0.8 ? 'var(--trust-teal)' : 'var(--amber)'};">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
              <div style="font-size: 12px; font-weight: 700; color: var(--text-tertiary);">${clause.framework}</div>
              <div style="font-size: 11px; color: var(--text-secondary);">Last validated ${clause.daysOld} days ago</div>
            </div>
            <div style="font-size: 14px; font-weight: 700; margin-bottom: 4px;">${clause.clause} — ${clause.title}</div>
            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 12px;">${clause.requirement}</div>
            <div style="display: flex; gap: 16px;">
              <div style="display: flex; align-items: center; gap: 6px;">
                <div class="operator-glyph phi" style="width: 18px; height: 18px; font-size: 10px;">Φ</div>
                <span style="font-size: 12px; font-family: 'IBM Plex Mono', monospace; font-weight: 700;">${clause.phi.toFixed(2)}</span>
              </div>
              <div style="display: flex; align-items: center; gap: 6px;">
                <div class="operator-glyph psi" style="width: 18px; height: 18px; font-size: 10px;">Ψ</div>
                <span style="font-size: 12px; font-family: 'IBM Plex Mono', monospace; font-weight: 700; color: ${clause.psi >= 0.9 ? 'var(--green)' : clause.psi >= 0.8 ? 'var(--trust-teal)' : 'var(--amber)'};">${clause.psi.toFixed(2)}</span>
              </div>
            </div>
          </div>
        `).join('')}
      </div>
      
      <!-- Atomic Propagation Demo -->
      <div style="padding: 20px; background: var(--brand-light); border-radius: 12px;">
        <div style="font-size: 14px; font-weight: 700; color: var(--brand); margin-bottom: 12px;">⚛️ Atomic Propagation Demo</div>
        <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 16px;">
          Vote on any of the ${eq.equivalentClauses.length} clauses above and watch atomic cross-framework propagation:
        </div>
        <button class="btn btn-primary" onclick="closeModal(); demoAtomicPropagation('${eq.id}')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
            <path d="M17 3a2.83 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>
          </svg>
          Simulate Vote → See Propagation
        </button>
      </div>
    </div>
  `, `
    <button class="btn btn-secondary" onclick="closeModal()">Close</button>
  `);
}

function validateFrameworkMappings(frameworkId) {
  showToast('Running semantic re-validation on all mappings...', 'info');
  setTimeout(() => {
    showToast('Multi-LLM consensus: 97% confidence maintained', 'info');
  }, 1500);
  setTimeout(() => {
    showToast('✓ Framework mappings validated and Ψ scores refreshed', 'success');
  }, 2500);
}

function exportFrameworkReport(frameworkId) {
  const frameworks = getAllFrameworks();
  const fw = frameworks.find(f => f.id === frameworkId);
  if (!fw) {
    showToast('Framework not found', 'error');
    return;
  }
  
  const equivalences = getEquivalences();
  const controls = getControls();
  const doc = AtomicPDF.create('Framework Coverage');
  
  // Header
  let y = AtomicPDF.addHeader(doc, 'Framework Coverage Report', fw.name);
  
  // Framework overview
  y = AtomicPDF.addSectionTitle(doc, y, 'Framework Overview');
  y = AtomicPDF.addParagraph(doc, y, `${fw.name} ${fw.version || ''}`, { fontStyle: 'bold', fontSize: 14 });
  y = AtomicPDF.addParagraph(doc, y, `Status: ${fw.status || 'Active'} | Last Reviewed: ${fw.lastReviewed || 'N/A'}`);
  y += 5;
  
  // Coverage metrics
  const coveragePercent = fw.totalClauses > 0 ? ((fw.mappedClauses / fw.totalClauses) * 100).toFixed(0) : 0;
  const freshness = (fw.psi || 1) > 0.9 ? 'Fresh' : (fw.psi || 1) > 0.8 ? 'Good' : 'Aging';
  
  y = AtomicPDF.addMetricsBox(doc, y, [
    { label: 'Total Clauses', value: fw.totalClauses || 0, color: AtomicPDF.colors.text },
    { label: 'Mapped', value: fw.mappedClauses || 0, color: AtomicPDF.colors.green, bgColor: [220, 252, 231] },
    { label: 'Coverage', value: coveragePercent + '%', color: AtomicPDF.colors.brand },
    { label: 'Freshness', value: freshness, color: AtomicPDF.colors.psi, bgColor: [207, 250, 254] }
  ]);
  
  // Credential decay
  y = AtomicPDF.addSectionTitle(doc, y, 'Credential Status');
  y = AtomicPDF.addOperatorMetrics(doc, y, fw.phi || 1.0, fw.psi || 1.0, fw.delta || 0, fw.trust || 0.95);
  
  // Find related equivalences
  const relatedEquivalences = equivalences.filter(eq => 
    eq.equivalentClauses?.some(c => c.framework?.toLowerCase().includes(fw.name.split(' ')[0].toLowerCase()))
  );
  
  // Equivalence mappings
  if (relatedEquivalences.length > 0) {
    y = AtomicPDF.checkNewPage(doc, y, 60);
    y = AtomicPDF.addSectionTitle(doc, y, 'Cross-Framework Mappings');
    const eqHeaders = ['Family', 'Control', 'Clauses', 'Confidence', 'Δ'];
    const eqRows = relatedEquivalences.slice(0, 10).map(eq => [
      eq.family || '', eq.controlId || '',
      (eq.equivalentClauses?.length || 0).toString(),
      ((eq.semanticConfidence || 0) * 100).toFixed(0) + '%',
      (eq.divergenceScore || 0).toFixed(2)
    ]);
    y = AtomicPDF.addTable(doc, y, eqHeaders, eqRows);
  }
  
  // Linked controls
  const linkedControls = controls.filter(c => c.frameworks?.some(f => 
    f.toLowerCase().includes(fw.name.split(' ')[0].toLowerCase())
  ));
  
  if (linkedControls.length > 0) {
    y = AtomicPDF.checkNewPage(doc, y, 60);
    y = AtomicPDF.addSectionTitle(doc, y, 'Linked Controls');
    const ctrlHeaders = ['ID', 'Name', 'Trust', 'Status'];
    const ctrlRows = linkedControls.slice(0, 10).map(c => [
      c.id, c.name.substring(0, 30), (c.trust || 0).toFixed(2), c.status || ''
    ]);
    y = AtomicPDF.addTable(doc, y, ctrlHeaders, ctrlRows);
  }
  
  // Proof
  y = AtomicPDF.checkNewPage(doc, y, 45);
  const hash = generateHash({ type: 'framework-report', frameworkId: fw.id, timestamp: Date.now() });
  y = AtomicPDF.addProofBox(doc, y, hash.substring(0, 32), STATE.currentSnapshot, new Date().toISOString());
  
  const safeName = fw.name.toLowerCase().replace(/[^a-z0-9]+/g, '-');
  AtomicPDF.download(doc, `atomic-trust-framework-${safeName}-${Date.now()}.pdf`);
  showToast(`Coverage report for ${fw.name} exported as PDF`, 'success');
}

function demoAtomicPropagation(equivalenceId) {
  const eq = getEquivalences().find(e => e.id === equivalenceId);
  if (!eq) return;
  
  showToast(`Vote registered on ${eq.equivalentClauses[0].framework} ${eq.equivalentClauses[0].clause}`, 'info');
  setTimeout(() => {
    showToast('⚛️ Atomic propagation in progress...', 'info');
  }, 500);
  setTimeout(() => {
    showToast(`✓ ${eq.equivalentClauses.length} equivalent clauses updated across ${new Set(eq.equivalentClauses.map(c => c.framework)).size} frameworks`, 'success');
  }, 1500);
}

// ---- CLAUSE REPOSITORY FUNCTIONS ----

function importFrameworkClauses() {
  openModal('Import Framework Clauses', `
    <div style="padding: 20px;">
      <div style="margin-bottom: 24px;">
        <label style="display: block; font-weight: 700; font-size: 13px; margin-bottom: 8px; color: var(--text-primary);">
          Framework Definition (JSON/XML)
        </label>
        <div style="border: 2px dashed var(--border-light); border-radius: 12px; padding: 40px; text-align: center; background: var(--bg-secondary); cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.borderColor='var(--brand)'; this.style.background='var(--brand-light)';" onmouseout="this.style.borderColor='var(--border-light)'; this.style.background='var(--bg-secondary)';" onclick="alert('In production, file picker would open here')">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--text-tertiary)" stroke-width="2" style="margin: 0 auto 12px;">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14,2 14,8 20,8"/>
            <line x1="12" y1="18" x2="12" y2="12"/>
            <line x1="9" y1="15" x2="15" y2="15"/>
          </svg>
          <div style="font-weight: 700; font-size: 15px; margin-bottom: 6px; color: var(--text-primary);">Upload Framework Clauses</div>
          <div style="font-size: 13px; color: var(--text-secondary);">JSON, XML, CSV with clause definitions</div>
        </div>
      </div>
      
      <div style="padding: 16px; background: var(--brand-light); border-radius: 8px; margin-bottom: 24px;">
        <div style="font-size: 12px; font-weight: 700; color: var(--brand); margin-bottom: 8px;">🔍 SEMANTIC INDEXING PIPELINE</div>
        <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.6;">
          Imported clauses will be:
          <ol style="margin: 8px 0 0 20px; padding: 0;">
            <li>Parsed and validated against schema</li>
            <li>Embedded using sentence transformers</li>
            <li>Indexed in semantic vector space</li>
            <li>Matched to existing clauses (cosine similarity)</li>
            <li>Added to equivalence relationships (>90% match)</li>
            <li>Hashed with BLAKE3 for immutability</li>
          </ol>
        </div>
      </div>
      
      <div style="padding: 16px; background: var(--green-light); border-radius: 8px;">
        <div style="font-size: 12px; font-weight: 700; color: var(--green); margin-bottom: 8px;">⚛️ AUTOMATIC PROPAGATION</div>
        <div style="font-size: 13px; color: var(--text-secondary);">
          Once indexed, new clauses automatically participate in atomic cross-framework propagation. Votes on equivalent clauses will propagate instantly.
        </div>
      </div>
    </div>
  `, `
    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
    <button class="btn btn-primary" onclick="closeModal(); simulateClauseImport()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
        <polyline points="17 8 12 3 7 8"/>
        <line x1="12" y1="3" x2="12" y2="15"/>
      </svg>
      Import & Index
    </button>
  `);
}

function simulateClauseImport() {
  showToast('Parsing clause definitions...', 'info');
  setTimeout(() => {
    showToast('Generating semantic embeddings...', 'info');
  }, 1000);
  setTimeout(() => {
    showToast('Finding equivalence matches...', 'info');
  }, 2000);
  setTimeout(() => {
    showToast('✓ 362 clauses imported and indexed with 214 equivalence links', 'success');
  }, 3500);
}

function showClauseDetail(clauseId) {
  const clause = getClauses().find(c => c.id === clauseId);
  if (!clause) return;
  
  openModal(`${clause.id}: ${clause.title}`, `
    <div style="padding: 20px;">
      <!-- Header Info -->
      <div style="margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid var(--border-light);">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
          <span style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 6px; font-size: 12px; font-weight: 700;">
            ${clause.frameworkFull}
          </span>
          <span style="padding: 6px 12px; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 6px; font-size: 12px; font-weight: 700;">
            ${clause.category}
          </span>
          ${clause.daysOld <= 7 ? '<span style="padding: 4px 10px; background: var(--green-light); color: var(--green); border-radius: 6px; font-size: 11px; font-weight: 700;">🟢 FRESH</span>' :
            clause.daysOld <= 30 ? '<span style="padding: 4px 10px; background: var(--trust-teal-light); color: var(--trust-teal); border-radius: 6px; font-size: 11px; font-weight: 700;">🔵 GOOD</span>' :
            clause.daysOld <= 60 ? '<span style="padding: 4px 10px; background: var(--amber-light); color: var(--amber); border-radius: 6px; font-size: 11px; font-weight: 700;">🟡 AGING</span>' :
            '<span style="padding: 4px 10px; background: var(--red-light); color: var(--red); border-radius: 6px; font-size: 11px; font-weight: 700;">🔴 STALE</span>'}
        </div>
        <div style="font-size: 15px; color: var(--text-secondary); margin-bottom: 12px;">
          <strong>Requirement:</strong>
        </div>
        <div style="font-size: 14px; color: var(--text-primary); line-height: 1.7; padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
          ${clause.requirement}
        </div>
      </div>
      
      <!-- Operator Scores -->
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 24px;">
        <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <div class="operator-glyph phi" style="width: 24px; height: 24px; font-size: 13px;">Φ</div>
            <span style="font-size: 12px; font-weight: 700; color: var(--text-tertiary);">ZERO-START TRUTH</span>
          </div>
          <div style="font-size: 32px; font-weight: 700; font-family: 'IBM Plex Mono', monospace;">${clause.phi.toFixed(2)}</div>
        </div>
        <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px; border-left: 3px solid ${clause.psi >= 0.9 ? 'var(--green)' : clause.psi >= 0.8 ? 'var(--trust-teal)' : 'var(--amber)'};">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <div class="operator-glyph psi" style="width: 24px; height: 24px; font-size: 13px;">Ψ</div>
            <span style="font-size: 12px; font-weight: 700; color: var(--text-tertiary);">CREDENTIAL-DECAY</span>
          </div>
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="font-size: 32px; font-weight: 700; font-family: 'IBM Plex Mono', monospace; color: ${clause.psi >= 0.9 ? 'var(--green)' : clause.psi >= 0.8 ? 'var(--trust-teal)' : 'var(--amber)'};">${clause.psi.toFixed(2)}</div>
            <div style="font-size: 13px; color: var(--text-secondary);">(${clause.daysOld} days old)</div>
          </div>
        </div>
      </div>
      
      <!-- Freshness Details -->
      <div style="padding: 16px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 24px;">
        <div style="font-size: 13px; font-weight: 700; color: var(--text-primary); margin-bottom: 8px;">Freshness Transparency</div>
        <div style="font-size: 12px; color: var(--text-secondary); line-height: 1.6;">
          • Last reviewed: ${new Date(clause.lastReviewed).toLocaleDateString()}<br>
          • Days since review: ${clause.daysOld}<br>
          • Decay factor: ${((1 - clause.psi) * 100).toFixed(1)}% confidence loss<br>
          • BLAKE3 hash: <span style="font-family: 'IBM Plex Mono', monospace;">${clause.hash}</span>
        </div>
      </div>
      
      <!-- Mapped Control -->
      <div style="margin-bottom: 24px;">
        <div style="font-size: 14px; font-weight: 700; margin-bottom: 12px;">Mapped Control</div>
        <div style="padding: 12px; background: var(--brand-light); border-radius: 8px; border-left: 3px solid var(--brand);">
          <div style="font-size: 13px; font-weight: 700; color: var(--brand);">${clause.mappedControl}</div>
          <div style="font-size: 12px; color: var(--text-secondary);">This clause satisfies the requirements of the mapped control</div>
        </div>
      </div>
      
      <!-- Semantic Equivalents -->
      ${clause.semanticMatches.length > 0 ? `
        <div style="margin-bottom: 24px;">
          <div style="font-size: 14px; font-weight: 700; margin-bottom: 12px;">Semantic Equivalents (${clause.semanticMatches.length})</div>
          ${clause.semanticMatches.map(match => `
            <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 8px;">
              <div style="display: flex; justify-content: between; align-items: center;">
                <div style="flex: 1;">
                  <div style="font-size: 13px; font-weight: 700; font-family: 'IBM Plex Mono', monospace; margin-bottom: 4px;">${match.clauseId}</div>
                  <div style="font-size: 12px; color: var(--text-secondary);">
                    Semantic similarity: ${(match.similarity * 100).toFixed(1)}% (cosine distance)
                  </div>
                </div>
                <div style="width: 60px; height: 6px; background: var(--border-light); border-radius: 3px; overflow: hidden;">
                  <div style="width: ${(match.similarity * 100).toFixed(0)}%; height: 100%; background: var(--brand); border-radius: 3px;"></div>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      ` : ''}
      
      <!-- Usage Statistics -->
      <div style="padding: 16px; background: var(--green-light); border-radius: 8px;">
        <div style="font-size: 13px; font-weight: 700; color: var(--green); margin-bottom: 8px;">Usage Across System</div>
        <div style="display: flex; gap: 20px; font-size: 12px; color: var(--text-secondary);">
          <span>📋 ${clause.usageCount.rfps} RFPs</span>
          <span>✓ ${clause.usageCount.attestations} attestations</span>
          <span>🛡️ ${clause.usageCount.controls} control mapping</span>
        </div>
      </div>
    </div>
  `, `
    <button class="btn btn-secondary" onclick="closeModal()">Close</button>
    <button class="btn btn-primary" onclick="closeModal(); viewEquivalenceGraph('${clause.id}')">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 6px;">
        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
        <path d="M2 17l10 5 10-5"/>
      </svg>
      View Equivalence Graph
    </button>
  `);
}

function filterClauses(searchTerm) {
  const items = document.querySelectorAll('.clause-item');
  const term = searchTerm.toLowerCase();
  
  items.forEach(item => {
    const text = item.textContent.toLowerCase();
    item.style.display = text.includes(term) ? 'block' : 'none';
  });
}

function filterClausesByFramework(framework) {
  const items = document.querySelectorAll('.clause-item');
  
  items.forEach(item => {
    if (framework === 'all') {
      item.style.display = 'block';
    } else {
      item.style.display = item.dataset.framework === framework ? 'block' : 'none';
    }
  });
}

function filterClausesByCategory(category) {
  const items = document.querySelectorAll('.clause-item');
  
  items.forEach(item => {
    if (category === 'all') {
      item.style.display = 'block';
    } else {
      item.style.display = item.dataset.category === category ? 'block' : 'none';
    }
  });
}

function findSemanticMatches(clauseId) {
  showToast('Running semantic similarity search...', 'info');
  setTimeout(() => {
    showToast('Comparing embeddings across 847 clauses...', 'info');
  }, 500);
  setTimeout(() => {
    showToast('✓ Found 12 clauses with >85% semantic similarity', 'success');
  }, 1500);
}

function viewEquivalenceGraph(clauseId) {
  const clause = getClauses().find(c => c.id === clauseId);
  if (!clause) return;
  
  showToast(`Opening equivalence graph for ${clauseId} with ${clause.equivalents.length} linked clauses...`, 'info');
}

// ---- INITIALIZATION ----

document.addEventListener('DOMContentLoaded', () => {
  // Initialize API connection check
  if (CONFIG.useRealAPI) {
    console.log('[API] Checking backend health...');
    
    // Check legacy gateway
    checkBackendHealth().then(connected => {
      console.log(`[API] Legacy Gateway ${connected ? 'CONNECTED' : 'OFFLINE'}`);
      if (connected) {
        loadAPIData();
        loadFrameworkData();
      }
    });
    
    // Check new SDK API (GRC module)
    GRC_API.checkHealth().then(async (result) => {
      console.log(`[GRC] SDK ${result.connected ? 'CONNECTED' : 'OFFLINE'}`, result);
      
      if (result.connected) {
        // Load GRC data from SDK API
        showToast('Loading data from Atomic Trust SDK...', 'info');
        
        try {
          // Load all GRC data in parallel
          const [controls, evidence, frameworks, equivalences, stats] = await Promise.all([
            GRC_API.getControls(),
            GRC_API.getEvidence(),
            GRC_API.getFrameworks(),
            GRC_API.getEquivalences(),
            GRC_API.getStats()
          ]);
          
          // Update API_DATA cache for existing functions
          if (controls && controls.length > 0) {
            API_DATA.controls = controls;
            console.log(`[GRC] Loaded ${controls.length} controls`);
          }
          
          if (evidence && evidence.length > 0) {
            API_DATA.evidence = evidence;
            console.log(`[GRC] Loaded ${evidence.length} evidence items`);
          }
          
          // Store in window for direct access
          window.GRC_FRAMEWORKS = frameworks;
          window.GRC_EQUIVALENCES = equivalences;
          window.GRC_STATS = stats;
          
          // Update status
          apiConnected = true;
          updateApiStatus();
          
          // Refresh current view if on controls or evidence
          if (STATE.currentView === 'controls' || STATE.currentView === 'evidence') {
            showView(STATE.currentView);
          }
          
          showToast(`SDK connected: ${stats.total_controls || 0} controls, ${stats.total_evidence || 0} evidence`, 'success');
          
        } catch (err) {
          console.warn('[GRC] Failed to load some data:', err);
          showToast('Using local demo data', 'info');
        }
      } else {
        console.log('[GRC] SDK offline, using static demo data');
      }
    });
    
  } else {
    updateApiStatus();
  }

  showView('dashboard');
  
  // Time travel slider - ACTUALLY CHANGES DATA
  const slider = document.getElementById('timeSlider');
  const display = document.getElementById('timeDisplay');
  const snapshotBadge = document.getElementById('snapshotBadge');
  
  slider.addEventListener('input', (e) => {
    const val = parseInt(e.target.value);
    STATE.timeTravel = val;
    
    // Map slider value (0-100) to timeline snapshots (0-3)
    let snapshotIndex;
    if (val >= 90) {
      snapshotIndex = 3;  // Nov 29 - Current
    } else if (val >= 60) {
      snapshotIndex = 2;  // Nov 28 - Near Complete
    } else if (val >= 30) {
      snapshotIndex = 1;  // Nov 20 - Partial Fixes
    } else {
      snapshotIndex = 0;  // Nov 15 - Pre-Remediation
    }
    
    const snapshot = TIMELINE_SNAPSHOTS[snapshotIndex];
    STATE.currentSnapshot = snapshot.id;
    STATE.currentTimelineIndex = snapshotIndex;
    
    // Update display
    display.textContent = snapshot.label + (snapshotIndex === 3 ? ' · Now' : '');
    
    // Update snapshot badge
    snapshotBadge.innerHTML = `
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
      </svg>
      Block ${snapshot.id}
    `;
    
    // Log the time travel action
    logAuditEntry('TIME_TRAVEL', {
      fromSnapshot: STATE.currentSnapshot,
      toSnapshot: snapshot.id,
      toDate: snapshot.date,
      sliderValue: val
    });
    
    // Refresh dashboard if we're on it
    if (STATE.currentView === 'dashboard') {
      showView('dashboard');
    }
    
    // Show toast notification
    if (snapshotIndex !== 3) {
      showToast(`⏰ Viewing snapshot from ${snapshot.date}`, 'info');
    }
  });
  
  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    // Cmd/Ctrl + K for search (future)
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
      e.preventDefault();
      showToast('Search coming soon', 'info');
    }
    
    // Esc to close modal
    if (e.key === 'Escape') {
      closeModal();
    }
  });
});

// =============================================================================
// KERNEL UI FUNCTIONS
// =============================================================================

function showKernelPanel() {
  const conservation = ATOMIC.conservation() || { conserved: true, sum: 1, K: 1, delta: 0 };
  const state = window.LIVE_STATE || {};
  
  // Remove existing modal
  const existing = document.getElementById('kernelModal');
  if (existing) existing.remove();
  
  const modal = document.createElement('div');
  modal.id = 'kernelModal';
  modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:10000;';
  
  const controlSample = (state.controls || []).slice(0, 5).map(c => 
    `<tr><td style="padding:4px 8px;font-family:IBM Plex Mono;font-size:11px;">${c.id}</td>` +
    `<td style="padding:4px 8px;color:var(--phi);">${(c.phi||0).toFixed(2)}</td>` +
    `<td style="padding:4px 8px;color:var(--psi);">${(c.psi||0).toFixed(2)}</td>` +
    `<td style="padding:4px 8px;color:var(--delta);">${(c.delta||0).toFixed(2)}</td>` +
    `<td style="padding:4px 8px;color:var(--trust);">${(c.trust||0).toFixed(2)}</td></tr>`
  ).join('');
  
  modal.innerHTML = `
    <div style="background:white;border-radius:12px;padding:24px;max-width:700px;width:95%;max-height:85vh;overflow-y:auto;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;border-bottom:1px solid var(--border-light);padding-bottom:12px;">
        <h2 style="margin:0;font-size:18px;">Δtomic Kernel State</h2>
        <button onclick="document.getElementById('kernelModal').remove()" style="background:none;border:none;font-size:24px;cursor:pointer;color:var(--text-secondary);">&times;</button>
      </div>
      
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;">
        <div style="padding:16px;background:var(--bg-secondary);border-radius:8px;border:1px solid var(--border-light);">
          <div style="font-size:11px;color:var(--text-tertiary);margin-bottom:4px;">Conservation Law</div>
          <div style="font-family:'IBM Plex Mono';font-size:24px;color:${conservation.conserved ? 'var(--green)' : 'var(--red)'};">
            Σω = ${conservation.sum.toFixed(6)}
          </div>
          <div style="font-size:11px;color:var(--text-secondary);margin-top:4px;">K=${conservation.K.toFixed(6)} | Δ=${conservation.delta.toExponential(2)}</div>
        </div>
        <div style="padding:16px;background:var(--bg-secondary);border-radius:8px;border:1px solid var(--border-light);">
          <div style="font-size:11px;color:var(--text-tertiary);margin-bottom:4px;">Reference Date</div>
          <div style="font-family:'IBM Plex Mono';font-size:18px;">
            ${state.referenceDate ? state.referenceDate.toISOString().split('T')[0] : 'Not set'}
          </div>
          <div style="font-size:11px;color:var(--text-secondary);margin-top:4px;">For daysOld & Ψ decay computation</div>
        </div>
      </div>
      
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:20px;">
        <div style="text-align:center;padding:12px;background:var(--bg-secondary);border-radius:6px;">
          <div style="font-size:20px;font-weight:700;color:var(--phi);">${state.controls?.length || 0}</div>
          <div style="font-size:10px;color:var(--text-tertiary);">Controls</div>
        </div>
        <div style="text-align:center;padding:12px;background:var(--bg-secondary);border-radius:6px;">
          <div style="font-size:20px;font-weight:700;color:var(--psi);">${state.evidence?.length || 0}</div>
          <div style="font-size:10px;color:var(--text-tertiary);">Evidence</div>
        </div>
        <div style="text-align:center;padding:12px;background:var(--bg-secondary);border-radius:6px;">
          <div style="font-size:20px;font-weight:700;color:var(--delta);">${state.frameworks?.length || 0}</div>
          <div style="font-size:10px;color:var(--text-tertiary);">Frameworks</div>
        </div>
        <div style="text-align:center;padding:12px;background:var(--bg-secondary);border-radius:6px;">
          <div style="font-size:20px;font-weight:700;color:var(--trust);">${state.equivalences?.length || 0}</div>
          <div style="font-size:10px;color:var(--text-tertiary);">Equivalences</div>
        </div>
      </div>
      
      <div style="margin-bottom:20px;">
        <div style="font-weight:600;font-size:13px;margin-bottom:8px;">Time Advancement (applies Ψ decay)</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button onclick="advanceLiveTime(1);showKernelPanel();" class="btn btn-ghost">+1 Day</button>
          <button onclick="advanceLiveTime(7);showKernelPanel();" class="btn btn-ghost">+1 Week</button>
          <button onclick="advanceLiveTime(30);showKernelPanel();" class="btn btn-ghost">+1 Month</button>
          <button onclick="advanceLiveTime(90);showKernelPanel();" class="btn btn-ghost">+1 Quarter</button>
          <button onclick="advanceLiveTime(365);showKernelPanel();" class="btn btn-ghost">+1 Year</button>
        </div>
      </div>
      
      <div style="margin-bottom:20px;">
        <div style="font-weight:600;font-size:13px;margin-bottom:8px;">Actions</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button onclick="recomputeAllOperators();showToast('All operators recomputed','success');showKernelPanel();" class="btn btn-secondary">Recompute All</button>
          <button onclick="exportKernelStateJSON();" class="btn btn-secondary">Export JSON</button>
          <button onclick="ATOMIC.runEpoch().then(r=>{console.log('Epoch:',r);showToast('Epoch complete','success');});" class="btn btn-primary">Run Epoch</button>
        </div>
      </div>
      
      <div>
        <div style="font-weight:600;font-size:13px;margin-bottom:8px;">Live Control Values</div>
        <div style="overflow-x:auto;">
          <table style="width:100%;border-collapse:collapse;font-size:12px;">
            <thead>
              <tr style="background:var(--bg-tertiary);">
                <th style="padding:8px;text-align:left;">Control</th>
                <th style="padding:8px;text-align:left;color:var(--phi);">Φ</th>
                <th style="padding:8px;text-align:left;color:var(--psi);">Ψ</th>
                <th style="padding:8px;text-align:left;color:var(--delta);">Δ</th>
                <th style="padding:8px;text-align:left;color:var(--trust);">Trust</th>
              </tr>
            </thead>
            <tbody>${controlSample}</tbody>
          </table>
        </div>
      </div>
    </div>
  `;
  
  modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
  document.body.appendChild(modal);
}

function exportKernelStateJSON() {
  const state = {
    exportedAt: new Date().toISOString(),
    version: '2.0.0',
    referenceDate: LIVE_STATE.referenceDate?.toISOString(),
    conservation: ATOMIC.conservation(),
    data: {
      controls: LIVE_STATE.controls,
      evidence: LIVE_STATE.evidence,
      frameworks: LIVE_STATE.frameworks,
      equivalences: LIVE_STATE.equivalences
    }
  };
  
  const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'atomic-kernel-state-' + Date.now() + '.json';
  a.click();
  URL.revokeObjectURL(url);
  showToast('Kernel state exported', 'success');
}

function updateTopConservation() {
  const sumEl = document.getElementById('topSum');
  const statusEl = document.getElementById('topStatus');
  if (!sumEl || !statusEl) return;
  
  const c = ATOMIC.conservation();
  if (!c) return;
  
  sumEl.textContent = c.sum.toFixed(2);
  statusEl.textContent = c.conserved ? '✓' : '✗';
  statusEl.style.color = c.conserved ? 'var(--green)' : 'var(--red)';
}

setInterval(updateTopConservation, 2000);

// Extend ATOMIC
window.ATOMIC.showPanel = showKernelPanel;
window.ATOMIC.exportState = exportKernelStateJSON;

console.log('[Kernel UI] Ready. Click Kernel button or run ATOMIC.showPanel()');

  </script>


</body></html>

